[{"title":"åœ¨Macä¸‹ç”¨Xcode8ç¼–è¯‘libtorrentåº“","date":"2017-03-15T02:28:43.000Z","path":"2017/03/15/åœ¨Macä¸‹ç”¨Xcodeç¼–è¯‘libtorrentåº“/","text":"å‰è¨€å’Œå¾€å¸¸ä¸€æ ·æ¯æ¬¡æ¥è§¦æ–°çš„çŸ¥è¯†ï¼Œç¬¬ä¸€æ­¥å®‰è£…ç¼–è¯‘å°±ä¼šå¡ä¸ªåŠå¤©ï¼Œæ„Ÿè§‰åˆ«äººé‡åˆ°çš„æ‰€æœ‰é—®é¢˜éƒ½ç»å†è¿‡ä¸€éä¸€æ ·ï¼Œä½†åŸºæœ¬æœ€åéƒ½è§£å†³äº†ï¼Œè¿˜æ˜¯ä»¬è®©äººæ¬£æ…°çš„ã€‚ä¸è¿‡ç°åœ¨æ›´å–œæ¬¢æŠŠè¿™äº›ä¸œè¥¿è®°å½•ä¸‹æ¥ï¼Œä»¥åå›é¡¾èµ·æ¥ä¹Ÿæ–¹ä¾¿ï¼Œä¹Ÿæ–¹ä¾¿åˆ«äººã€‚ ä»Šå¤©è¦ç¼–è¯‘çš„æ˜¯rasterbarçš„libtorrent githubæµè¡Œçš„æœ‰ä¸¤ä¸ªä¸åŒçš„libtorrentåº“ï¼Œå…·ä½“çš„åŒºåˆ«å¯è§ğŸ‘‡çš„blogï¼š ä¸¤ä¸ªlibtorrentåº“çš„åŒºåˆ« å‡†å¤‡å·¥ä½œlibtorrentæœ¬èº«ä¾èµ–OpenSSLã€boostä¸¤ä¸ªåº“ï¼Œæ‰€ä»¥è¦ç¼–è¯‘è¿™ä¸¤ä¸ªåº“ ç¼–è¯‘OpenSSL ç›´æ¥ä¸Šgithubï¼Œä¸‹è½½æºç ï¼šOpenSSLï¼Œæˆ‘è¿™é‡Œä¸‹è½½çš„æ˜¯OpenSSL-1.1.1ç‰ˆæœ¬ å¦‚æœä¸æ˜¯cloneçš„è¯ï¼Œä¸‹è½½çš„æ˜¯å‹ç¼©åŒ…éœ€è¦è§£å‹ ç»ˆç«¯cdåˆ°ä¸‹è½½ä¸‹æ¥çš„æ–‡ä»¶å¤¹ç›®å½•å†… ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ 1234$ ./Configure darwin64-x86_64-cc $ make$ make test$ make install è¿™äº›æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­ä¹Ÿå‡ºç°è¿‡é”™è¯¯ï¼Œä½†å½“æ—¶å¾ˆå¿«å°±è§£å†³äº†ï¼Œæ‰€ä»¥æ²¡æˆªå±è®°ä¸‹æ¥ï¼Œè¦æ˜¯æœ‰é—®é¢˜çš„å¯ä»¥åœ¨ä¸‹é¢ç•™è¨€ã€‚ ç¼–è¯‘boostbooståº“å…¶å®å·²ç»ä¸æ˜¯ç¬¬ä¸€æ¬¡ç”¨åˆ°äº†ï¼ŒC++çš„ä¸€ä¸ªå¾ˆç‰›é€¼çš„åº“ï¼Œå…‰çœ‹å¤§å°å°±å¾ˆç‰›é€¼ï¼Œæºä»£ç å°±ä¸Šç™¾Mï¼Œæ‰§è¡Œå®Œç¼–è¯‘æŒ‡ä»¤ï¼Œæ‰“åŒ…åº“ç­‰æ“ä½œä¹‹åæ–‡ä»¶å¤¹ä¸Š1ç‚¹å¤šGï¼Œæ‰€ä»¥åœ¨é¡¹ç›®ä¸­è¦ä½¿ç”¨åˆ°boostçš„è¯ï¼Œèƒ½åˆ†ç¦»ä»£ç å°±åˆ†ç¦»å§ã€‚ å…¶å®ç¼–è¯‘boostæœ‰å¾ˆå¤šæ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡brewæˆ–è€…Macportç­‰å·¥å…·æ¥æï¼Œæˆ‘è¿™é‡Œå…¶å®ä¹Ÿæ˜¯å¯¹æºç æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œæ‰€ä»¥ç‰¹æ„ç”¨æ¯”è¾ƒåŸå§‹çš„æ–¹æ³•ï¼š ç›´æ¥ä¸‹è½½booståº“ï¼Œæˆ‘è¿™é‡Œä¸‹è½½çš„æ˜¯1.63ç‰ˆæœ¬ ä¸‹è½½å®Œåè§£å‹ æ‰“å¼€ç»ˆç«¯cdåˆ°å¯¹åº”çš„ç›®å½• æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆéœ€è¦çš„æ—¶é—´æœ‰ç‚¹ä¹…ï¼Œå¯ä»¥å–æ¯å’–å•¡å…ˆï¼‰ 123$ ./bootstrap.sh$ ./b2$ sudo ./b2 install å¦‚æœä¸å‡ºæ„å¤–ï¼Œå®‰è£…æˆåŠŸçš„è¯ï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ 1$ open usr/local ç„¶åä¼šæ‰“å¼€ä¸€ä¸ªFinderæ–‡ä»¶å¤¹ æ‰¾åˆ°includeç›®å½•ï¼Œçœ‹ä¸‹æœ‰æ²¡æœ‰boostã€opensslè¿™ä¸¤ä¸ªæ–‡ä»¶ç›®å½• æ‰¾åˆ°libç›®å½•ï¼Œçœ‹ä¸‹æœ‰æ²¡æœ‰libboost_xxxç›¸å…³çš„.aæ–‡ä»¶ å¦‚æœéƒ½æ­£å¸¸çš„è¯ï¼Œåº”è¯¥æ²¡ä»€ä¹ˆå¤§é—®é¢˜ è¿˜æœ‰ä¸€ç§æ¯”è¾ƒé€šç”¨çš„æ£€æŸ¥æ–¹å¼ï¼š 1$ open usr/local/opt è¿™é‡Œé¢å®‰è£…äº†æ‰€æœ‰ä½ ç¼–è¯‘è¿‡çš„åº“ï¼Œè¿™å°±åŒ…æ‹¬äº†boostã€opensslä»¥åŠåé¢ç¼–è¯‘æˆåŠŸçš„libtorrentï¼Œä»¥åä½ å¦‚æœè¦ç¼–è¯‘åˆ«çš„åº“æ¯”å¦‚protobufè¿™ç±»çš„åº“ä¹Ÿæ˜¯éœ€è¦å„ç§ä¾èµ–ï¼Œä½ å°±å¯ä»¥æ¥è¿™ä¸ªç›®å½•æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰ç¼–è¯‘è¿‡ï¼Œä¸ç„¶å°±åªèƒ½å‚»å‚»åœ°ä¸€ä¸ªä¸ªè¯• libtorrentç¼–è¯‘ ä¸Šå®˜ç½‘ä¸‹è½½libtorrent ä¸‹è½½å®Œæˆåç›´æ¥è§£å‹ æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ 1234$ ./configure --disable-debug$ make clean$ make$ sudo make install å¦‚æœä¸å‡ºæ„å¤–çš„è¯ç°åœ¨å°±å¯ä»¥ç”¨ä»¥ä¸Šçš„æ–¹æ³•æŸ¥çœ‹åˆ°libtorrentçš„èº«å½± libtorrentä¸‹çš„Hello world æ–°å»ºä¸€ä¸ªXcode C++çš„Command Line Toolé¡¹ç›® ç„¶åç‚¹å‡»é¡¹ç›®å·¥ç¨‹-Build Settings æ‰¾åˆ°ä»¥ä¸‹å­—æ®µæ·»åŠ ä¸€æ¡è®°å½• 12HEADER_SEARCH_PATHS = /usr/local/includeLIBRARY_SEARCH_PATHS = /usr/local/lib ï¼ˆç‰¹æ„å†™æˆ.xconfigçš„æ ¼å¼ï¼Œæ–¹ä¾¿ä½¿ç”¨xconfigç®¡ç†ç³»ç»Ÿé…ç½®é¡¹çš„åŒå¿—ä»¬ï¼‰ æŠŠlibtorrentçš„examplesç›®å½•ä¸‹çš„æ–‡ä»¶æ‹–è¿›æ¥ç¼–è¯‘ â€¦ç½‘ä¸Šå¤§å¤šçš„èµ„æ–™åŸºæœ¬å†™åˆ°è¿™å°±å®Œäº†ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„é”™è¯¯å•Šâ€¦..boostçš„libtorrentçš„â€¦è¿™é‡Œä¸»è¦è®²ä¸‹æˆ‘é‡åˆ°çš„å‡ ä¸ªé”™è¯¯ é”™è¯¯åˆ†æ boostçš„systemå‡½æ•°æ²¡æ‰¾åˆ° 1234567891011121314151617181920Undefined symbols for architecture x86_64: \"boost::system::system_category()\", referenced from: boost::asio::error::get_system_category() in http_seed_connection.o ___cxx_global_var_init.5 in http_seed_connection.o boost::asio::error::get_system_category() in metadata_transfer.o ___cxx_global_var_init.2 in metadata_transfer.o boost::asio::error::get_system_category() in gzip.o boost::system::error_code::clear() in gzip.o ___cxx_global_var_init.2 in gzip.o ... \"boost::system::generic_category()\", referenced from: ___cxx_global_var_init.3 in http_seed_connection.o ___cxx_global_var_init.4 in http_seed_connection.o ___cxx_global_var_init in metadata_transfer.o ___cxx_global_var_init.1 in metadata_transfer.o ___cxx_global_var_init in gzip.o ___cxx_global_var_init.1 in gzip.o ___cxx_global_var_init in disk_io_job.o ...ld: symbol(s) not found for architecture x86_64 è§£å†³æ–¹æ³•ï¼š åˆšåˆšç¼–è¯‘å¥½çš„boostç›®å½•ä¸‹æœ‰ä¸ªstageç›®å½•ï¼Œç„¶ååœ¨libä¸‹æ‰¾åˆ°libboost_system.aï¼Œç›´æ¥é€šè¿‡Linked Frameworks and Libraries - add anotheræ·»åŠ è¿›é¡¹ç›®ä¸­ libtorrentçš„å‡½æ•°æ²¡æ‰¾åˆ° 123456789101112131415161718192021222324252627282930313233343536Undefined symbols for architecture x86_64: \"libtorrent::print_entry(libtorrent::bdecode_node const&amp;, bool, int)\", referenced from: _main in dump_torrent.o \"libtorrent::bdecode_node::clear()\", referenced from: _main in dump_torrent.o \"libtorrent::bdecode_node::bdecode_node()\", referenced from: _main in dump_torrent.o \"libtorrent::torrent_info::torrent_info(libtorrent::bdecode_node const&amp;, boost::system::error_code&amp;, int)\", referenced from: _main in dump_torrent.o \"libtorrent::torrent_info::~torrent_info()\", referenced from: _main in dump_torrent.o \"libtorrent::make_magnet_uri(libtorrent::torrent_info const&amp;)\", referenced from: _main in dump_torrent.o \"libtorrent::to_hex(char const*, int, char*)\", referenced from: _main in dump_torrent.o \"libtorrent::to_hex(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;)\", referenced from: _main in dump_torrent.o \"libtorrent::bdecode(char const*, char const*, libtorrent::bdecode_node&amp;, boost::system::error_code&amp;, int*, int, int)\", referenced from: _main in dump_torrent.o \"libtorrent::file_storage::file_flags(int) const\", referenced from: _main in dump_torrent.o \"libtorrent::file_storage::file_offset(int) const\", referenced from: _main in dump_torrent.o \"libtorrent::file_storage::hash(int) const\", referenced from: _main in dump_torrent.o \"libtorrent::file_storage::mtime(int) const\", referenced from: _main in dump_torrent.o \"libtorrent::file_storage::symlink(int) const\", referenced from: _main in dump_torrent.o \"libtorrent::file_storage::map_file(int, long long, int) const\", referenced from: _main in dump_torrent.o \"libtorrent::file_storage::file_path(int, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;) const\", referenced from: _main in dump_torrent.o \"libtorrent::file_storage::file_size(int) const\", referenced from: _main in dump_torrent.old: symbol(s) not found for architecture x86_64 è§£å†³æ–¹æ³•ï¼š å…¶å®æˆ‘æ„Ÿè§‰åº”è¯¥æ˜¯æˆ‘ä¹‹å‰çš„æµç¨‹å‡ºç°é—®é¢˜ï¼Œä¸è¿‡ä¸å…¶å»æ£€æŸ¥æ¯ä¸ªæŠ¥é”™ä»¥åŠä¹‹å‰çš„ç¼–è¯‘æµç¨‹ï¼Œç½‘ä¸Šå¾ˆå¤šè§£é‡Šéƒ½æ˜¯åŸºäºwindowsä¸‹VSçš„ã€å¾ˆå°‘åŸºäºmacä¸‹Xcodeçš„èµ„æ–™ï¼Œæœ‰çš„è¯ä¹Ÿå› ä¸ºä¸åŒåº“ç¼–è¯‘ç‰ˆæœ¬ä¸åŒäº§ç”Ÿçš„ä¸åŒé”™è¯¯ã€‚ æˆ‘è¿™é‡Œè§£å†³æ–¹æ¡ˆæ˜¯å€’ä¸å¦‚ç›´æ¥æŠŠæºç æ·»åŠ åˆ°å·¥ç¨‹é‡Œå»ï¼Œè¿™æ ·ä¹Ÿæ–¹ä¾¿å­¦ä¹ ã€æºç çš„é˜…è¯»ã€‚ ä¸»è¦æ˜¯æŠŠ3ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„ä»£ç æ·»åŠ è¿›å·¥ç¨‹é‡Œå»ï¼š include/libtorrentä¸‹çš„ä»£ç ï¼ˆä¸»è¦æ˜¯å¤´æ–‡ä»¶hppï¼‰ srcä¸‹çš„ä»£ç ï¼ˆä¸»è¦æ˜¯å†…éƒ¨æºç æ–‡ä»¶cppï¼‰ ed25519/srcä¸‹çš„ä»£ç ï¼ˆcppã€hppï¼‰ æ³¨ï¼š è¿è¡Œè¿‡ä¹‹å‰çš„å‘½ä»¤ä¹‹åï¼Œä¸Šè¿°æºç ç›®å½•ä¼šç”Ÿæˆä¸€å †.loã€.oæ–‡ä»¶ï¼Œè¿™äº›éƒ½æ˜¯ä¸éœ€è¦çš„ï¼Œæœ€å¥½ç›´æ¥é‡æ–°è§£å‹ä¸€ä»½æºç ï¼Œå–å‡ºéœ€è¦çš„ç›®å½•æ·»åŠ åˆ°å·¥ç¨‹ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯æœ€å¥½å…ˆé‡æ–°å‘½å¥½åä¹‹åå†copyè¿›é¡¹ç›®é‡Œï¼Œä¸ç„¶ä¸¤ä¸ªsrcæ‹–è¿›å·¥ç¨‹é‡Œå»ä¼šäº§ç”Ÿå†²çª â€‹ æˆªè‡³ç›®å‰ï¼Œå…¶å®ç¼–è¯‘å·¥ä½œå°±åŸºæœ¬å®Œæˆçš„äº†ã€‚ è¿è¡ŒXcodeï¼Œè¾“å‡ºç³»ç»Ÿè‡ªå¸¦çš„Hello worldï¼Œå·¥ä½œå®Œæˆã€‚ å¯ä»¥æŠŠåŸç”Ÿçš„main.cppæ–¹æ³•æ”¹æˆexamplesç›®å½•ä¸‹çš„å…¶ä»–cppæ–‡ä»¶è¿›è¡Œå­¦ä¹  æ€»ç»“è¿™é‡Œä¸»è¦é’ˆå¯¹ç»å†è¿‡æœ€åè¿™ä¸¤ç±»é”™è¯¯çš„äººï¼Œå¦‚æœå‰é¢æ­¥éª¤æœ¬èº«æ²¡é—®é¢˜çš„è¯ï¼Œå¤§å¯ä»¥å¿½ç•¥æ‰æˆ‘åé¢çš„é”™è¯¯å¤„ç†ã€‚å¦‚æœä¸€æ ·é‡åˆ°æˆ‘è¿™æ ·çš„é—®é¢˜ï¼Œå¯ä»¥æŒ‰ç…§æˆ‘çš„æ­¥éª¤å»åšã€‚ åŸç†å‘¢å¤§è‡´å¦‚ä¸‹ï¼š é¦–å…ˆä¸çŸ¥é“booståº“æŒ‡ä»¤ç¼–è¯‘è¿‡ç¨‹åˆ°åº•å“ªé‡Œå‡ºé—®é¢˜ï¼Œsystemçš„åº“æ— æ³•è¯†åˆ«ï¼Œåªèƒ½æ‰‹åŠ¨æ·»åŠ è¿›å·¥ç¨‹é‡Œ libtorrentå› ä¸ºæ²¡é“¾æ¥æˆåŠŸï¼Œè¿™é‡Œç›´æ¥æ”¾åˆ°ç¨‹åºé‡Œä¸€èµ·ç¼–è¯‘ é‚£ä¹ˆXcodeä¸Šé…ç½®çš„header pathã€library pathé“¾æ¥çš„ä¸»è¦å°±æ˜¯boostå…¶ä»–çš„åº“ è¿™ä¸ªå·¥ç¨‹æœ‰å¯èƒ½å¹¶ä¸å®Œç¾ï¼Œæˆ‘æ²¡æœ‰å»è§£å†³ç³»ç»Ÿæˆ–è€…æŒ‡ä»¤çš„ä¸€äº›å†²çªé—®é¢˜ï¼Œä½†ç°åœ¨è¿™æ ·ä¹Ÿç‰¹åˆ«é€‚åˆå­¦ä¹ ï¼Œé¦–å…ˆboostã€opensslè¿™äº›åº“æˆ‘ä»¬å¯ä»¥ä¸ç”¨å…¨éƒ¨ä»£ç æ‹‰è¿›å·¥ç¨‹é‡Œå»ç¼–è¯‘ï¼ˆç›´æ¥Xcodeç¼–è¯‘boostè¦å¾ˆä¹…ï¼Œå¾ˆä¸å¥½ç®¡ç†ï¼Œè°è¯•è°çŸ¥é“ï¼‰ï¼ŒåŒæ—¶libtorrentä½œä¸ºæˆ‘ä»¬ä¸»è¦ä½¿ç”¨çš„åº“ï¼Œæˆ‘å¯ä»¥ç›´æ¥æ”¾åœ¨å·¥ç¨‹é‡Œï¼Œéšæ—¶æŸ¥çœ‹å†…éƒ¨çš„å®ç°æˆ–è€…å‘ï¼Œæ”¹èµ·æ¥ä¹Ÿæ¯”è¾ƒå®¹æ˜“ã€‚ éœ€è¦å­¦ä¹ çš„è¦æºç çš„å¯ä»¥è¯„è®ºä¸‹ï¼Œåç»­æœ‰æ—¶é—´æˆ‘ä¼šæŠŠä»£ç æäº¤åˆ°githubä¸Šï¼Œä¹‹å‰æ¸…è¿‡ä¸€égithubæ‰€ä»¥æ¯”è¾ƒç©ºï¼Œåç»­è€ƒè™‘é‡æ–°æèµ·æ¥ â€”â€”Nothing is true, Everything is permitted (åŸè°…æˆ‘æœ€è¿‘è¢«Assassins Creedç”µå½±åœˆç²‰äº†â€¦â€¦.hhh)","tags":[{"name":"C/C++","slug":"C-C","permalink":"http://alfredzhenyu.github.io/tags/C-C/"}]},{"title":"CoreFoundationæºç è§£è¯»ä¹‹CFArray","date":"2017-02-07T13:10:17.000Z","path":"2017/02/07/CoreFoundationæºç è§£è¯»ä¹‹CFArray/","text":"å‰è¨€ç®—æ˜¯CoreFoundationæºç è§£æçš„ç¬¬ä¸€ç¯‡å§ï¼Œä¹‹åæœ‰æœºä¼šå¸Œæœ›èƒ½åšæ›´å¤šçš„æºç è§£æï¼Œå…¶å®åšè¿™å—çš„åŸå› å¾ˆç®€å•ï¼Œå…³äºè¿™å—çš„è§£æè¿˜æ˜¯è›®å°‘ï¼Œè€Œä½œä¸ºä¸€åiOSçš„å¼€å‘å·¥ç¨‹å¸ˆï¼Œæ²¡æœ‰æ¯”å­¦ä¹ å®˜æ–¹æºç çš„æ–¹å¼æ›´ç®€å•ç²—æš´ï¼Œå¯ä»¥ä»ä¸­å¸å–åˆ°å¾ˆå¤šå†…éƒ¨çš„ä»£ç é£æ ¼ï¼Œä¸ä»£ç çš„æŠ€å·§ã€‚ ä»¥ä¸‹å†…å®¹æˆ‘ä¼šåˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š ç®€å•ä»‹ç»ä¸‹ä»ç½‘ä¸ŠæŸ¥åˆ°çš„èµ„æ–™ åˆ†ææºç ï¼Œä»‹ç»ä»æºç ä¸­è·å–åˆ°çš„æœ‰ç”¨çŸ¥è¯† CFArrayçš„å‘å±•æœ€å¼€å§‹ï¼ˆCF-635.15ä»¥å‰ï¼‰ CFArrayæ˜¯ç”±ä¸¤ç§æ•°æ®ç»“æ„å®ç°çš„ Double-ended queue ï¼šæ•°ç»„é•¿åº¦è¾ƒå°æ—¶ä½¿ç”¨(&lt;262040) ï¼Œç›´æ¥ä½¿ç”¨CFArrayDequeå®ç°ï¼Œæ­¤æ—¶åœ¨å¤´å°¾æ’å…¥åˆ é™¤æ€§èƒ½é«˜ï¼Œä½†æ˜¯åœ¨ä¸­é—´æ’å…¥åˆ é™¤æ—¶ï¼Œå°±éœ€è¦ memmove æ¥æŒªåŠ¨å†…å­˜äº†ï¼Œæ€§èƒ½å°±ä¼šé™ä¸‹æ¥ balanced treeï¼šæ•°ç»„é•¿åº¦è¾ƒå¤§æ—¶ä½¿ç”¨ï¼ˆ&gt;=262040ï¼‰ï¼Œæ”¹æˆä½¿ç”¨CFStorageå®ç°ï¼Œåˆ©ç”¨balanced tree å®ç°äº†å¤§æ•°é‡çš„æ•°å€¼çš„å­˜å‚¨å’Œç¼–è¾‘ï¼Œå¹¶ä¸”åœ¨æ’å…¥å’Œåˆ é™¤æ—¶æœ‰å¾ˆå¥½çš„æ€§èƒ½ å¤‡æ³¨ï¼šå‡†ç¡®ç‚¹æ¥è¯´æ˜¯ä¸‰ç§ï¼Œè¿˜æœ‰ä¸€ç§å°±æ˜¯æ™®é€šçš„å¼€è¾Ÿä¸€æ®µè¿ç»­ç©ºé—´å­˜å‚¨ä¸å¯å˜æ•°ç»„CFArrayRefï¼Œä½†è¿™é‡Œä¸»è¦è®¨è®ºçš„æ˜¯CFMutableArrayRefï¼Œæ‰€ä»¥æŠŠå®ƒå¿½ç•¥æ‰ ä¹‹åï¼ˆCF-635.15 ~ CF-1153.18ï¼‰ å»æ‰äº†CFStorageéƒ¨åˆ†ï¼Œåœ¨LONG_MAXä»¥å†…éƒ½æ˜¯ç”¨deque æœ€æ–°(CF-1153.18ä»¥å) æ®è¯´æ”¹æˆäº†circular bufferï¼Œä½†æœ€æ–°çš„ä»£ç ä¸€ç›´éƒ½æ˜¯coming soon! å¯¹æ¯”NSArrayè¿™é‡Œå€¼çš„ä¸€æçš„æ˜¯è™½ç„¶CFArrayæ˜¯å¼€æºï¼Œä½†NSArrayæ˜¯é—­æºçš„ã€‚ä½†å°½ç®¡å¦‚æ­¤ï¼Œè¿˜æ˜¯æœ‰äººé€†å‘å»æ¢ç´¢NSArrayçš„å®ç°ï¼Œå¤§å®¶æœ‰å…´è¶£çš„è¯å¯ä»¥çœ‹ä¸‹å›½å¤–çš„å¤§ç‰›æ˜¯æ€ä¹ˆæ¢ç´¢çš„Exposing NSMutableArrayï¼Œæˆ‘è¿™é‡Œå°±ä¸ç­é—¨å¼„æ–§äº†ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºçš„ç»“è®ºæ˜¯ï¼š NSMutableArrayå®é™…ä¸Šä¹Ÿæ˜¯ç”¨circular bufferï¼ˆç¯å½¢ç¼“å†²å™¨ï¼‰æ¥å®ç°çš„ è€Œè¿™ç¯‡æ–‡ç« çš„çš„æœ€åä¹ŸæŒ‡å‡ºï¼šç°åœ¨å¼€æºçš„æœ€æ–°ç‰ˆæœ¬(CF-635.15 ~ CF-1153.18)çš„å·¥ä½œåŸç†å…¶å®å’Œç¯å½¢ç¼“å†²å™¨ç›¸ä¼¼ï¼Œä½†æœ¬è´¨ä¸Šå¹¶ä¸æ˜¯ç¯å½¢ç¼“å†²å™¨ï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹ä¸‹å½“å‰å¼€æºç‰ˆæœ¬æ˜¯æ€ä¹ˆç›¸ä¼¼æ³• Basically, CFArray moves the memory around to accommodate the changes in the most efficient fashion, similarly to how __NSArrayM does its job. However, the CFArray does not use a circular buffer! Instead it has a larger buffer padded with zeros from both ends which makes enumeration and fetching the correct object much easier. Adding elements at either end simply eats up the remaining padding. CFArrayæºç è§£è¯»é¦–å…ˆä¸Šå®˜ç½‘æŠŠæºç ä¸‹è½½ä¸‹æ¥ï¼šCF-1153.18 ï¼Œæ‰¾åˆ°CFArray.c/.hï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è¦é˜…è¯»çš„æºç  å¼€å¯ä»¥çœ‹åˆ°ä»£ç é‡å¾ˆå¤šè€Œä¸”æ¯”è¾ƒä¹±ï¼Œæˆ‘è¿™é‡ŒæŒ‰ç…§åŠŸèƒ½æ•´ç†äº†ä¸€ä¸‹ï¼š ä»¥ä¸‹æ˜¯æˆ‘åˆ†ç±»çš„ç›®å½•ï¼š æœ€åæˆ‘ä¼šæŠŠæˆ‘æ•´ç†è¿‡çš„ä»£ç ä¸Šä¼ ä¸Šå»ä¸Šå»ï¼Œæœ‰éœ€è¦çš„å¯ä»¥è‡ªè¡Œä¸‹è½½ æ•°ç»„çš„å£°æ˜â€”â€”å¤§è‡´äº†è§£æ•°ç»„çš„ç»“æ„å…ˆæ¥çœ‹ä¸‹æ•°ç»„çš„ç»“æ„ä½“å£°æ˜ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748/** æ‰€æœ‰çš„è¿™äº›æšä¸¾å€¼ä¼šå†™è¿›ä¸€ä¸ª32ä½çš„æ•´æ•°é‡Œï¼Œé€šè¿‡äºŒè¿›åˆ¶é‡Œbitsä½æ¥æ ‡è¯† *///åˆ†åˆ«ä»£è¡¨ä¸¤ç§ç±»å‹çš„æ•°ç»„__kCFArrayImmutableä¸ºCFArray//åˆ†åˆ«ä»£è¡¨ä¸¤ç§ç±»å‹çš„æ•°ç»„__kCFArrayImmutableä¸ºCFMutableArray/* Flag bits */enum &#123; /* Bits 0-1 */ __kCFArrayImmutable = 0, __kCFArrayDeque = 2,&#125;;enum &#123; /* Bits 2-3 */ __kCFArrayHasNullCallBacks = 0, __kCFArrayHasCFTypeCallBacks = 1, __kCFArrayHasCustomCallBacks = 3 /* callbacks are at end of header */&#125;;/* Bits 4 &amp; 5 are reserved for GC use. Bit 4, if set, indicates that the array is weak. Bit 5 marks whether finalization has occured and, thus, whether to continue to do special retain/release processing of elements. */struct __CFArray &#123; // CFRuntimeBaseåœ¨CFRuntime.hä¸­å®šä¹‰ // typedef struct __CFRuntimeBase &#123; // uintptr_t _cfisa; // uint8_t _cfinfo[4]; // #if __LP64__ // uint32_t _rc; // #endif // &#125; CFRuntimeBase; CFRuntimeBase _base; //è¿™ä¸ªæ˜¯ç”¨æ¥å­˜æ•°ç»„å…ƒç´ æ•°é‡çš„ CFIndex _count; /* number of objects */ CFIndex _mutations; //åˆå§‹åŒ–ä¸º1 int32_t _mutInProgress; //åˆå§‹åŒ–ä¸º0 //è¿™ä¸ªæ˜¯ç”¨æ¥å­˜æ•°ç»„å…ƒç´ çš„,__kCFArrayDequeç±»å‹ä¸‹ï¼Œ_storeå°±æ˜¯__CFArrayDeque __strong void *_store; //åˆå§‹ä¸ºç©ºï¼ŒMutableåŠ å…ƒç´ çš„æ—¶å€™æ‰ä¼šåˆ›å»º /* can be NULL when MutableDeque */&#125;;struct __CFArrayDeque &#123; uintptr_t _leftIdx; uintptr_t _capacity; /* struct __CFArrayBucket buckets follow here */&#125;;struct __CFArrayBucket &#123; const void *_item;&#125;; é¦–å…ˆæ•°ç»„åˆ†ç±»ä¸¤ç±»ï¼š __kCFArrayImmutableä¸å¯å˜æ•°ç»„ __kCFArrayDequeå¯å˜æ•°ç»„ ä½†å®é™…ä¸­ä¸¤è€…éƒ½ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªç»“æ„ä½“ï¼š__CFArrayï¼ˆåªæ˜¯ç±»å‹ä¸åŒï¼Œä»¥åŠå­˜å‚¨æ–¹å¼ä¸ä¸€æ ·ï¼Œåé¢ä¼šè®²åˆ°ï¼‰ __CFArrayç»“æ„ä½“ï¼š CFRuntimeBase _baseï¼šå…¶å®ä¸æ­¢è¿™ä¸¤ä¸ªæ•°ç»„åŒ…å«è¿™ä¸ªç»“æ„ä½“ï¼Œåº”è¯¥è¯´æ‰€æœ‰CFç±»å‹çš„ç»“æ„ä½“éƒ½ä¼šåŒ…å«è¿™ä¸ªç»“æ„ä½“ï¼Œä¸»è¦ä½œç”¨æ˜¯æ–¹ä¾¿runtimeç»Ÿä¸€è°ƒåº¦ç®¡ç†ã€‚åœ¨æœ¬æ¬¡ä»‹ç»ä¸­ä¸»è¦æ¶‰åŠåˆ°çš„æ˜¯__cfinfoçš„CF_INFO_BITSä½ï¼ˆç¬¬0ä½ï¼‰å®ƒä¸»è¦å­˜å‚¨äº†æ•°ç»„çš„æ‰€æœ‰çŠ¶æ€ CFIndex _countï¼šè®°å½•æ•°ç»„æ•°é‡ CFIndex _mutationsï¼š è®°å½•æ•°ç»„çš„æ“ä½œæ¬¡æ•°ï¼Œæ¯æ¬¡æ“ä½œæ•°ç»„ååŠ 1ï¼Œåˆå§‹åˆ›å»ºæ—¶å°±ä¸º1 int32_t _mutInProgressï¼šç”¨äºæ£€æµ‹æ­¤æ—¶æ˜¯å¦æ­£åœ¨æ“ä½œæ•°ç»„ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒä¸€æ—¶é—´æ“ä½œåŒä¸€ä¸ªæ•°ç»„ __strong void *_storeï¼šè¿™æ˜¯ä¸¤ç§ç±»å‹æ•°ç»„çš„ä¸€ä¸ªå…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒå¤§çš„åŒºåˆ«ï¼š ä¸å¯å˜æ•°ç»„ï¼šä¸€èˆ¬ä¸ºNULL å¯å˜æ•°ç»„ï¼šåœ¨æ•°ç»„å…ƒç´ ä¸ºç©ºçš„æ—¶å€™ä¹Ÿä¸ºNULLï¼Œæœ‰æ•°æ®çš„æ—¶å€™_storeæŒ‡å‘__CFArrayDequeç»“æ„ä½“ __CFArrayBucketç»“æ„ä½“ï¼š è¿™ä¸ªç»“æ„ä½“é‡Œé¢å°±åªæœ‰ä¸€ä¸ªæˆå‘˜const void *_item const void itemï¼šä¹Ÿæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œ**å®é™…ä¸ŠCFArrayä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½å¯¹åº”ä¸€ä¸ª\\_CFArrayBucket,è€Œ__CFArrayBucketé‡Œçš„_itemæŒ‡é’ˆå”¯ä¸€æŒ‡å‘å¯¹åº”çš„è¿™ä¸ªå…ƒç´ * å…³äº__CFArrayDequeçš„ç»“æ„ä½“ï¼Œæˆ‘ä¼šæ”¾åˆ°åé¢è·Ÿç€æºç ä¸€èµ·æ¥ä»‹ç»ã€‚ æ•°ç»„çš„åˆ›å»ºâ€”â€”åˆ†æä¸å¯å˜æ•°ç»„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼123456789101112#define DEFINE_CREATION_METHODS 1#if DEFINE_CREATION_METHODS///å¯¹å¤–Arrayåˆ›å»ºæ–¹æ³•CFArrayRef CFArrayCreate(CFAllocatorRef allocator, const void **values, CFIndex numValues, const CFArrayCallBacks *callBacks) &#123; return __CFArrayCreate0(allocator, values, numValues, callBacks);&#125;///å¯¹å¤–MutableArrayåˆ›å»ºæ–¹æ³•CFMutableArrayRef CFArrayCreateMutable(CFAllocatorRef allocator, CFIndex capacity, const CFArrayCallBacks *callBacks) &#123; return __CFArrayCreateMutable0(allocator, capacity, callBacks);&#125;#endif æ•°ç»„å¯¹å¤–çš„åˆ›å»ºä¸»è¦æœ‰ä¸¤ä¸ª CFArrayCreate è°ƒç”¨__CFArrayCreate0æ–¹æ³•åˆ›å»º CFArrayCreateMutableè°ƒç”¨__CFArrayCreateMutable0æ–¹æ³•åˆ›å»º å†æ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªå†…éƒ¨æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768// åˆ›å»ºä¸€ä¸ªCFArrayRefä¸å¯å˜æ•°ç»„// @param allocator æ˜¯ä½¿ç”¨å·²æœ‰çš„ç©ºé—´è¿˜æ˜¯å¼€è¾Ÿæ–°çš„ç©ºé—´æ¥åˆ›å»ºæ•°ç»„. ä¼  NULL æˆ–è€… kCFAllocatorDefault ä½¿ç”¨é»˜è®¤çš„allocator// @param values cè¯­è¨€æ•°ç»„æŒ‡é’ˆ// @param numValues æ•°ç»„ä¸ªæ•°// @param callBacks ä¸€ä¸ª CFArrayCallBacksçš„ç»“æ„æŒ‡é’ˆ//CFArrayRef å†…éƒ¨åˆ›å»ºæ–¹æ³•ï¼Œè°ƒç”¨__CFArrayInitCF_PRIVATE CFArrayRef __CFArrayCreate0(CFAllocatorRef allocator, const void **values, CFIndex numValues, const CFArrayCallBacks *callBacks) &#123; CFArrayRef result; const CFArrayCallBacks *cb; struct __CFArrayBucket *buckets; CFAllocatorRef bucketsAllocator; void* bucketsBase; CFIndex idx; CFAssert2(0 &lt;= numValues, __kCFLogAssertion, \"%s(): numValues (%d) cannot be less than zero\", __PRETTY_FUNCTION__, numValues); //__CFArrayInitåˆå§‹åŒ– result = __CFArrayInit(allocator, __kCFArrayImmutable, numValues, callBacks); //è·å–callback cb = __CFArrayGetCallBacks(result); //æ¯ä¸ªæ•°ç»„å…ƒç´ éƒ½ç”¨ä¸€ä¸ªbucketè£…ç€ï¼Œé€šè¿‡ç»“æ„ä½“æŒ‡é’ˆæ¥ç´¢å¼•ï¼Œç»“æ„ä½“æŒ‡é’ˆé¡ºåºå­˜å‚¨ï¼Œé€šè¿‡æŒ‡é’ˆ+1æ¥è·å–å¯¹åº”bucketæŒ‡é’ˆï¼Œä»è€Œåˆ©ç”¨itemç´¢å¼•å¯¹åº”çš„å…ƒç´  buckets = __CFArrayGetBucketsPtr(result); bucketsAllocator = isStrongMemory(result) ? allocator : kCFAllocatorNull; bucketsBase = CF_IS_COLLECTABLE_ALLOCATOR(bucketsAllocator) ? (void *)auto_zone_base_pointer(objc_collectableZone(), buckets) : NULL; if (NULL != cb-&gt;retain) &#123; for (idx = 0; idx &lt; numValues; idx++) &#123; // åœ¨CFInternal.hé‡Œå®šä¹‰ // CF_INLINE void __CFAssignWithWriteBarrier(void **location, void *value) &#123; // if (kCFUseCollectableAllocator) &#123; // objc_assign_strongCast((id)value, (id *)location); // &#125; else &#123; // *location = value; // &#125; // &#125; //__CFAssignWithWriteBarrier((void **)&amp;buckets-&gt;_item, (void *)(cb-&gt;retain)(allocator, *values)); __CFAssignWithWriteBarrier((void **)&amp;buckets-&gt;_item, (void *)INVOKE_CALLBACK2(cb-&gt;retain, allocator, *values)); values++; buckets++; &#125; &#125; else &#123; for (idx = 0; idx &lt; numValues; idx++) &#123; __CFAssignWithWriteBarrier((void **)&amp;buckets-&gt;_item, (void *)*values); values++; buckets++; &#125; &#125; //è®¾ç½®__CFArrayç»“æ„ä½“çš„æ•°ç»„å¤§å° __CFArraySetCount(result, numValues); return result;&#125;/** åˆ›å»ºä¸€ä¸ªCFMutableArrayRefå¯å˜æ•°ç»„ *///CFMutableArrayRef å†…éƒ¨åˆ›å»ºæ–¹æ³•ï¼ˆç›´æ¥è°ƒç”¨__CFArrayInitåˆå§‹åŒ–å³å¯ï¼‰CF_PRIVATE CFMutableArrayRef __CFArrayCreateMutable0(CFAllocatorRef allocator, CFIndex capacity, const CFArrayCallBacks *callBacks) &#123; //æ–­è¨€ CFAssert2(0 &lt;= capacity, __kCFLogAssertion, \"%s(): capacity (%d) cannot be less than zero\", __PRETTY_FUNCTION__, capacity); CFAssert2(capacity &lt;= LONG_MAX / sizeof(void *), __kCFLogAssertion, \"%s(): capacity (%d) is too large for this architecture\", __PRETTY_FUNCTION__, capacity); //__CFArrayInitåˆå§‹åŒ– return (CFMutableArrayRef)__CFArrayInit(allocator, __kCFArrayDeque, capacity, callBacks);&#125; ä»__CFArrayCreate0é‡Œå¯¹bucketsçš„æ“ä½œå…¶å®å°±å¯ä»¥æ¨æ–­å‡ºä¸å¯å˜çš„æ•°ç»„æ•°æ®ç»“æ„äº†ï¼Œä¸ºäº†ç¡®ä¿æ¨æ–­æ— è¯¯ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸‹ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè°ƒç”¨åŸºç¡€æ–¹æ³•__CFArrayInit ä»¥ä¸‹æ˜¯__CFArrayInitçš„æºç : (æ³¨é‡Šé‡Œå†™äº†ä¸€äº›ä½¿ç”¨åˆ°çš„ï¼Œåœ¨åˆ«çš„æ–‡ä»¶ä¸­å®šä¹‰çš„ç›¸å…³å®ï¼Œä»¥ä¾›å‚è€ƒ) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596// /** åˆå§‹åŒ–ä¸€ä¸ªCFArrayRefæ•°ç»„// * @param allocator æ˜¯ä½¿ç”¨å·²æœ‰çš„ç©ºé—´è¿˜æ˜¯æ–°çš„ç©ºé—´æ¥åˆ›å»ºæ•°ç»„. ä¼  NULL æˆ–è€… kCFAllocatorDefault ä½¿ç”¨é»˜è®¤çš„allocator// * @param flags æ•°ç»„ç±»å‹ï¼š__kCFArrayImmutable ä¸å¯å˜æ•°ç»„/__kCFArrayDeque å¯å˜æ•°ç»„// * @param capacity æ•°ç»„å¤§å°// * @param callBacks ä¸€ä¸ª CFArrayCallBacksçš„ç»“æ„æŒ‡é’ˆ// *////#if (TARGET_OS_MAC &amp;&amp; !(TARGET_OS_EMBEDDED || TARGET_OS_IPHONE))///#define CF_IS_COLLECTABLE_ALLOCATOR(allocator) (kCFUseCollectableAllocator &amp;&amp; (NULL == (allocator) || kCFAllocatorSystemDefault == (allocator) || 0))///#else 0///#endif///#define INVOKE_CALLBACK2(P, A, B) (P)(A, B)///#define __CFBitfieldGetValue(V, N1, N2) (((V) &amp; __CFBitfieldMask(N1, N2)) &gt;&gt; (N2))///#define __CFBitfieldMask(N1, N2) ((((UInt32)~0UL) &lt;&lt; (31UL - (N1) + (N2))) &gt;&gt; (31UL - N1))///#define __CFBitfieldSetValue(V, N1, N2, X) ((V) = ((V) &amp; ~__CFBitfieldMask(N1, N2)) | (((X) &lt;&lt; (N2)) &amp; __CFBitfieldMask(N1, N2)))static CFArrayRef __CFArrayInit(CFAllocatorRef allocator, UInt32 flags, CFIndex capacity, const CFArrayCallBacks *callBacks) &#123; struct __CFArray *memory; UInt32 size; //å¯¹äºUint32ä½çš„flagsï¼Œå–å‡º2~31ä½çš„æ•°è®¾ç½®æˆ0 __CFBitfieldSetValue(flags, 31, 2, 0); if (CF_IS_COLLECTABLE_ALLOCATOR(allocator))//ALLOCATOR = NULL æ—¶ä¸ºNO &#123; if (!callBacks || (callBacks-&gt;retain == NULL &amp;&amp; callBacks-&gt;release == NULL)) &#123; __CFBitfieldSetValue(flags, 4, 4, 1); // setWeak &#125; &#125; //åˆ©ç”¨2-3ä½æ¥æ ‡è¯†callbackç±»å‹ if (__CFArrayCallBacksMatchNull(callBacks)) &#123; __CFBitfieldSetValue(flags, 3, 2, __kCFArrayHasNullCallBacks); &#125; else if (__CFArrayCallBacksMatchCFType(callBacks)) &#123; __CFBitfieldSetValue(flags, 3, 2, __kCFArrayHasCFTypeCallBacks); &#125; else &#123; __CFBitfieldSetValue(flags, 3, 2, __kCFArrayHasCustomCallBacks); &#125; //size =__CFArrayç»“æ„ä½“å¤§å°+ callBackç»“æ„ä½“å¤§å°ï¼ˆå¦‚æœæœ‰è‡ªå®šä¹‰çš„è¯ï¼‰- CFRuntimeBaseç»“æ„ä½“å¤§å° size = __CFArrayGetSizeOfType(flags) - sizeof(CFRuntimeBase); //åˆ©ç”¨0-1ä½æ¥æ ‡è¯†æ•°ç»„ç±»å‹æ˜¯__kCFArrayImmutableè¿˜æ˜¯__kCFArrayDeque //size =__CFArrayç»“æ„ä½“å¤§å°+ callBackç»“æ„ä½“å¤§å°ï¼ˆå¦‚æœæœ‰è‡ªå®šä¹‰çš„è¯ï¼‰- CFRuntimeBaseç»“æ„ä½“å¤§å° + ä¸ªæ•° * __CFArrayBucketç»“æ„ä½“å¤§å° switch (__CFBitfieldGetValue(flags, 1, 0)) &#123; case __kCFArrayImmutable: size += capacity * sizeof(struct __CFArrayBucket); break; case __kCFArrayDeque: break; &#125; //Runtimeåˆ›å»ºç©ºé—´ï¼Œæ³¨æ„_CFRuntimeCreateInstanceéœ€è¦çš„å‚æ•°æ˜¯extraBytesï¼Œéœ€è¦é™¤å»CFRuntimeBaseå¤§å°ã€‚ å°±æ˜¯ä¸Šé¢çš„sizeï¼Œäº‹å®ä¸Šå¯ä»¥é€šè¿‡æŸ¥çœ‹_CFRuntimeCreateInstanceçš„æºç çŸ¥é“CFRuntimeBaseæ˜¯å†…éƒ¨åˆ›å»ºçš„ï¼Œå¤–éƒ¨å¹¶ä¸éœ€è¦ç®¡ memory = (struct __CFArray*)_CFRuntimeCreateInstance(allocator, CFArrayGetTypeID(), size, NULL); if (NULL == memory) &#123; return NULL; &#125; //åˆå§‹åŒ–CFRuntimeBaseç»“æ„ä½“å‚æ•° //æŠŠflagsä¿¡æ¯å­˜è¿›ç»“æ„ä½“ä¸­ __CFBitfieldSetValue(memory-&gt;_base._cfinfo[CF_INFO_BITS], 6, 0, flags); //åˆå§‹åŒ–ç»“æ„ä½“çš„æ•°ç»„å¤§å° __CFArraySetCount((CFArrayRef)memory, 0); //åˆ©ç”¨0-1ä½æ¥æ ‡è¯†æ•°ç»„ç±»å‹æ˜¯__kCFArrayImmutableè¿˜æ˜¯__kCFArrayDeque switch (__CFBitfieldGetValue(flags, 1, 0)) &#123; case __kCFArrayImmutable: if (isWeakMemory(memory)) &#123; // if weak, don't scan auto_zone_set_unscanned(objc_collectableZone(), memory); &#125; if (__CFOASafe) __CFSetLastAllocationEventName(memory, \"CFArray (immutable)\"); break; case __kCFArrayDeque: if (__CFOASafe) __CFSetLastAllocationEventName(memory, \"CFArray (mutable-variable)\"); ((struct __CFArray *)memory)-&gt;_mutations = 1; ((struct __CFArray *)memory)-&gt;_mutInProgress = 0; ((struct __CFArray*)memory)-&gt;_store = NULL; break; &#125; //è®¾ç½®callback if (__kCFArrayHasCustomCallBacks == __CFBitfieldGetValue(flags, 3, 2)) &#123; CFArrayCallBacks *cb = (CFArrayCallBacks *)__CFArrayGetCallBacks((CFArrayRef)memory); *cb = *callBacks; FAULT_CALLBACK((void **)&amp;(cb-&gt;retain)); FAULT_CALLBACK((void **)&amp;(cb-&gt;release)); FAULT_CALLBACK((void **)&amp;(cb-&gt;copyDescription)); FAULT_CALLBACK((void **)&amp;(cb-&gt;equal)); &#125; return (CFArrayRef)memory;&#125; __CFArrayInitæœ€ä¸»è¦èŒè´£æ˜¯å¼€è¾Ÿå¯¹åº”çš„ç©ºé—´ï¼Œç„¶åè®¾ç½®æ•°ç»„çš„CallBacksã€çŠ¶æ€ä½ï¼ŒæŠŠçŠ¶æ€ä½å†™è¿›_base._cfinfo[CF_INFO_BITS]é‡Œã€‚ è¿™é‡Œæ€»ç»“å‡ºä¸ªæœ‰ç”¨çš„æŠ€å·§ï¼š å½“ä¸€ä¸ªå¯¹è±¡æœ‰å¾ˆå¤šçŠ¶æ€éœ€è¦æ ‡è¯†çš„æ—¶å€™ï¼Œæœ€å¥½çš„æ–¹æ³•ä¸æ˜¯è®¾ç½®å¤šä¸ªå¸ƒå°”å±æ€§ã€æšä¸¾å±æ€§ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ä¸€ä¸ª32ï¼ˆæˆ–è€…16ï¼‰ä½çš„æ•´å½¢æ•°æ¥å­˜å‚¨æ‰€æœ‰çŠ¶æ€ï¼Œå°†è¿™ä¸ªæ•´å½¢æ•°è½¬æ¢æˆäºŒè¿›åˆ¶ï¼Œåˆ©ç”¨ä¸åŒä½æ•°ä»£è¡¨çš„ä¸åŒçŠ¶æ€ã€‚ å°ç»“â€”â€”ä¸å¯å˜æ•°ç»„åœ¨å†…å­˜çš„å­˜å‚¨æ–¹å¼ä»ä»¥ä¸Šçš„ä»£ç å°±å¯ä»¥å¤§è‡´åˆ†æå‡ºä¸å¯å˜æ•°ç»„çš„æ•°æ®ç»“æ„ï¼Œå¦‚ä¸‹ï¼š ç”±äºå¯å˜æ•°ç»„åœ¨æ•´ä¸ªåˆ›å»ºè¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œæ“ä½œï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥é˜…è¯»å¯å˜æ•°ç»„å¯¹æ•°æ®çš„å¢åˆ æ”¹æŸ¥æ¥è¿›ä¸€æ­¥äº†è§£å¯å˜æ•°ç»„çš„å­˜å‚¨æ–¹å¼ã€‚ æ•°ç»„çš„å¢åˆ æ”¹æŸ¥â€”â€”åˆ†æå¯å˜æ•°ç»„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼å¢ï¼šä¸ºå¯å˜æ•°ç»„æ·»åŠ å…ƒç´ 123456789101112131415161718192021222324252627282930//æ·»åŠ #pragma mark add//åœ¨æ•°ç»„idxä½ç½®ä¸­æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼ˆè°ƒç”¨_CFArrayReplaceValuesï¼‰void CFArrayInsertValueAtIndex(CFMutableArrayRef array, CFIndex idx, const void *value) &#123; CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), void, (NSMutableArray *)array, insertObject:(id)value atIndex:(NSUInteger)idx); __CFGenericValidateType(array, CFArrayGetTypeID()); CFAssert1(__CFArrayGetType(array) != __kCFArrayImmutable, __kCFLogAssertion, \"%s(): array is immutable\", __PRETTY_FUNCTION__); CFAssert2(0 &lt;= idx &amp;&amp; idx &lt;= __CFArrayGetCount(array), __kCFLogAssertion, \"%s(): index (%d) out of bounds\", __PRETTY_FUNCTION__, idx); CHECK_FOR_MUTATION(array); _CFArrayReplaceValues(array, CFRangeMake(idx, 0), &amp;value, 1);&#125;//åœ¨æ•°ç»„çš„æœ€åæ’å…¥ä¸€ä¸ªå…ƒç´ ï¼ˆè°ƒç”¨_CFArrayReplaceValuesï¼‰void CFArrayAppendValue(CFMutableArrayRef array, const void *value) &#123; CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), void, (NSMutableArray *)array, addObject:(id)value); __CFGenericValidateType(array, CFArrayGetTypeID()); CFAssert1(__CFArrayGetType(array) != __kCFArrayImmutable, __kCFLogAssertion, \"%s(): array is immutable\", __PRETTY_FUNCTION__); CHECK_FOR_MUTATION(array); _CFArrayReplaceValues(array, CFRangeMake(__CFArrayGetCount(array), 0), &amp;value, 1);&#125;//åœ¨æ•°ç»„çš„æœ€åæ’å…¥ä¸€ä¸ªæ•°ç»„ï¼ˆè°ƒç”¨CFArrayAppendValueï¼‰void CFArrayAppendArray(CFMutableArrayRef array, CFArrayRef otherArray, CFRange otherRange) &#123; __CFArrayValidateRange(otherArray, otherRange, __PRETTY_FUNCTION__); // implemented abstractly, careful! for (CFIndex idx = otherRange.location; idx &lt; otherRange.location + otherRange.length; idx++) &#123; CFArrayAppendValue(array, CFArrayGetValueAtIndex(otherArray, idx)); &#125;&#125; åˆ ï¼šä¸ºå¯å˜æ•°ç»„åˆ é™¤å…ƒç´ 12345678910111213141516171819202122232425#pragma mark array delete//åˆ é™¤æ•°ç»„idxä½ç½®çš„å…ƒç´ ï¼ˆè°ƒç”¨_CFArrayReplaceValuesï¼‰void CFArrayRemoveValueAtIndex(CFMutableArrayRef array, CFIndex idx) &#123; CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), void, (NSMutableArray *)array, removeObjectAtIndex:(NSUInteger)idx); __CFGenericValidateType(array, CFArrayGetTypeID()); CFAssert1(__CFArrayGetType(array) != __kCFArrayImmutable, __kCFLogAssertion, \"%s(): array is immutable\", __PRETTY_FUNCTION__); CFAssert2(0 &lt;= idx &amp;&amp; idx &lt; __CFArrayGetCount(array), __kCFLogAssertion, \"%s(): index (%d) out of bounds\", __PRETTY_FUNCTION__, idx); CHECK_FOR_MUTATION(array); _CFArrayReplaceValues(array, CFRangeMake(idx, 1), NULL, 0);&#125;//åˆ é™¤æ•°ç»„ä¸­æ‰€æœ‰çš„å…ƒç´ ï¼ˆè°ƒç”¨_CFArrayReplaceValuesï¼‰void CFArrayRemoveAllValues(CFMutableArrayRef array) &#123; CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), void, (NSMutableArray *)array, removeAllObjects); __CFGenericValidateType(array, CFArrayGetTypeID()); CFAssert1(__CFArrayGetType(array) != __kCFArrayImmutable, __kCFLogAssertion, \"%s(): array is immutable\", __PRETTY_FUNCTION__); CHECK_FOR_MUTATION(array); BEGIN_MUTATION(array); __CFArrayReleaseValues(array, CFRangeMake(0, __CFArrayGetCount(array)), true); __CFArraySetCount(array, 0); array-&gt;_mutations++; END_MUTATION(array);&#125; æ”¹ï¼šä¸ºå¯å˜æ•°ç»„æ›´æ”¹å…ƒç´ 123456789101112131415161718192021222324252627282930313233343536373839404142434445//ä¿®æ”¹//å°†ç¬¬idxä½ç½®çš„å…ƒç´ ä¿®æ”¹æˆå¯¹åº”çš„å€¼ï¼ˆè°ƒç”¨_CFArrayReplaceValuesï¼‰void CFArraySetValueAtIndex(CFMutableArrayRef array, CFIndex idx, const void *value) &#123; CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), void, (NSMutableArray *)array, setObject:(id)value atIndex:(NSUInteger)idx); __CFGenericValidateType(array, CFArrayGetTypeID()); CFAssert1(__CFArrayGetType(array) != __kCFArrayImmutable, __kCFLogAssertion, \"%s(): array is immutable\", __PRETTY_FUNCTION__); CFAssert2(0 &lt;= idx &amp;&amp; idx &lt;= __CFArrayGetCount(array), __kCFLogAssertion, \"%s(): index (%d) out of bounds\", __PRETTY_FUNCTION__, idx); CHECK_FOR_MUTATION(array); if (idx == __CFArrayGetCount(array)) &#123; _CFArrayReplaceValues(array, CFRangeMake(idx, 0), &amp;value, 1); &#125; else &#123; BEGIN_MUTATION(array); const void *old_value; const CFArrayCallBacks *cb = __CFArrayGetCallBacks(array); CFAllocatorRef allocator = __CFGetAllocator(array); struct __CFArrayBucket *bucket = __CFArrayGetBucketAtIndex(array, idx); if (NULL != cb-&gt;retain &amp;&amp; !hasBeenFinalized(array)) &#123; value = (void *)INVOKE_CALLBACK2(cb-&gt;retain, allocator, value); &#125; old_value = bucket-&gt;_item; __CFAssignWithWriteBarrier((void **)&amp;bucket-&gt;_item, (void *)value); // GC: handles deque/CFStorage cases. if (NULL != cb-&gt;release &amp;&amp; !hasBeenFinalized(array)) &#123; INVOKE_CALLBACK2(cb-&gt;release, allocator, old_value); &#125; array-&gt;_mutations++; END_MUTATION(array); &#125;&#125;//ç”¨æ–°çš„æ•°ç»„ä»£æ›¿æ—§æ•°ç»„éƒ¨åˆ†å…ƒç´ ï¼ˆè°ƒç”¨_CFArrayReplaceValuesï¼‰void CFArrayReplaceValues(CFMutableArrayRef array, CFRange range, const void **newValues, CFIndex newCount) &#123; CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), void, (NSMutableArray *)array, replaceObjectsInRange:NSMakeRange(range.location, range.length) withObjects:(id *)newValues count:(NSUInteger)newCount); __CFGenericValidateType(array, CFArrayGetTypeID()); __CFArrayValidateRange(array, range, __PRETTY_FUNCTION__); CFAssert1(__CFArrayGetType(array) != __kCFArrayImmutable, __kCFLogAssertion, \"%s(): array is immutable\", __PRETTY_FUNCTION__); CFAssert2(0 &lt;= newCount, __kCFLogAssertion, \"%s(): newCount (%d) cannot be less than zero\", __PRETTY_FUNCTION__, newCount); CHECK_FOR_MUTATION(array); return _CFArrayReplaceValues(array, range, newValues, newCount);&#125; æŸ¥ï¼šè¯»å–å¯å˜æ•°ç»„çš„å…ƒç´ 12345678//è·å–idxä½ç½®çš„æ•°å€¼ï¼ˆè°ƒç”¨__CFArrayGetBucketAtIndexï¼‰const void *CFArrayGetValueAtIndex(CFArrayRef array, CFIndex idx) &#123; CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), const void *, (NSArray *)array, objectAtIndex:idx); __CFGenericValidateType(array, CFArrayGetTypeID()); CFAssert2(0 &lt;= idx &amp;&amp; idx &lt; __CFArrayGetCount(array), __kCFLogAssertion, \"%s(): index (%d) out of bounds\", __PRETTY_FUNCTION__, idx); CHECK_FOR_MUTATION(array); return __CFArrayGetBucketAtIndex(array, idx)-&gt;_item;&#125; åˆ†æå¯å˜æ•°ç»„å­˜å‚¨æ–¹å¼ä»â€œå¢åˆ æ”¹â€ä¸‰ä¸ªæ“ä½œé‡Œå¯ä»¥çœ‹å‡ºæ•´ä¸ªå¯å˜æ•°ç»„æ“ä½œçš„æ ¸å¿ƒæ–¹æ³•å°±æ˜¯ï¼š_CFArrayReplaceValues è€Œâ€œæŸ¥â€åŒ…æ‹¬â€œæ”¹â€åˆ™æ¶‰åŠå…³äºbucketsçš„æ“ä½œæ¯”å¦‚ï¼š__CFArrayGetBucketAtIndexã€__CFArrayGetBucketsPtr å…ˆæ¥çœ‹ä¸‹bucketsç›¸å…³çš„æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829// /** è£…è½½å…ƒç´ æŒ‡é’ˆbucketçš„æ•´å—åŒºåŸŸéƒ½æ˜¯è¿ç»­çš„ï¼Œå› ä¸ºæ— è®ºImmutableè¿˜æ˜¯Dequeéƒ½æ»¡è¶³ï¼šç¬¬idxä¸ªæŒ‡é’ˆç­‰äºç¬¬ä¸€ä¸ªbucketæŒ‡é’ˆ+idxï¼Œåªæ˜¯å¯å˜æ•°ç»„å’Œä¸å¯å˜æ•°ç»„çš„ç¬¬ä¸€ä¸ªbucketæŒ‡é’ˆçš„ä½ç½®ä¸ä¸€æ · */// /* Only applies to immutable and mutable-deque-using arrays;// * Returns the bucket holding the left-most real value in the latter case. *///è·å–ç¬¬ä¸€ä¸ªå…ƒç´ Bucketsçš„æŒ‡é’ˆCF_INLINE struct __CFArrayBucket *__CFArrayGetBucketsPtr(CFArrayRef array) &#123; switch (__CFArrayGetType(array)) &#123; //æ¯ä¸ªæ•°ç»„å…ƒç´ éƒ½ç”¨ä¸€ä¸ªbucketè£…ç€ï¼Œé€šè¿‡ç»“æ„ä½“æŒ‡é’ˆæ¥ç´¢å¼•ï¼Œé€šè¿‡æŒ‡é’ˆ+1æ¥è·å–å¯¹åº”bucketè£…ç€çš„å…ƒç´ ï¼ˆitemï¼‰ case __kCFArrayImmutable: //ç¬¬ä¸€ä¸ªå…ƒç´ çš„BucketæŒ‡é’ˆä½ç½®ï¼šarrayçš„æŒ‡é’ˆ + ç©ºæ•°ç»„å¤§å° return (struct __CFArrayBucket *)( (uint8_t *)array + __CFArrayGetSizeOfType(((CFRuntimeBase *)array)-&gt;_cfinfo[CF_INFO_BITS])); case __kCFArrayDeque: &#123; //è·å–é˜Ÿåˆ—ç»“æ„ä½“çš„æŒ‡é’ˆ struct __CFArrayDeque *deque = (struct __CFArrayDeque *)array-&gt;_store; //é˜Ÿåˆ—ç»“æ„ä½“çš„æŒ‡é’ˆ + é˜Ÿåˆ—ç»“æ„ä½“å¤§å° + é˜Ÿåˆ—å·¦å€¼*bucketå¤§å° return (struct __CFArrayBucket *)((uint8_t *)deque + sizeof(struct __CFArrayDeque) + deque-&gt;_leftIdx * sizeof(struct __CFArrayBucket)); &#125; &#125; return NULL;&#125;/* This shouldn't be called if the array count is 0. *///è·å–ç¬¬idxä¸ªå…ƒç´ Bucketsçš„æŒ‡é’ˆCF_INLINE struct __CFArrayBucket *__CFArrayGetBucketAtIndex(CFArrayRef array, CFIndex idx) &#123; switch (__CFArrayGetType(array)) &#123; case __kCFArrayImmutable: case __kCFArrayDeque: return __CFArrayGetBucketsPtr(array) + idx; &#125; return NULL;&#125; é‡è¦çš„ç»“è®ºï¼šè£…è½½å…ƒç´ æŒ‡é’ˆbucketçš„æ•´å—åŒºåŸŸéƒ½æ˜¯è¿ç»­çš„ï¼Œå› ä¸ºæ— è®ºå¯å˜è¿˜æ˜¯ä¸å¯å˜éƒ½æ»¡è¶³ï¼šç¬¬idxä¸ªæŒ‡é’ˆç­‰äºç¬¬ä¸€ä¸ªbucketæŒ‡é’ˆ+idxï¼Œåªæ˜¯å¯å˜æ•°ç»„å’Œä¸å¯å˜æ•°ç»„çš„ç¬¬ä¸€ä¸ªbucketæŒ‡é’ˆçš„ä½ç½®ä¸ä¸€æ · æœ‰ç”¨çš„ä¿¡æ¯æœ‰ï¼š å¯å˜æ•°ç»„æ•°æ®å­˜å‚¨ä¹Ÿæ˜¯è¿ç»­çš„ å¯å˜æ•°ç»„çš„å…ƒç´ æ˜¯å­˜åœ¨__CFArrayDequeåé¢ï¼Œä¸å¯å˜æ•°ç»„çš„å…ƒç´ æ˜¯ç›´æ¥æ”¾åœ¨__CFArrayåé¢çš„ å¯å˜æ•°ç»„å¹¶ä¸æ˜¯ç›´æ¥å°†æ•°ç»„è·Ÿåœ¨__CFArrayDequeåé¢çš„ï¼Œè€Œæ˜¯åç§»äº†_leftIdxä½çš„ æœ€åä¸€ç‚¹æ¯”è¾ƒéš¾ç†è§£ï¼Œæˆ‘ä»¬å›å¤´çœ‹ä¸€ä¸‹__CFArrayDequeè¿™ä¸ªç»“æ„ä½“ï¼š 12345struct __CFArrayDeque &#123; uintptr_t _leftIdx; uintptr_t _capacity; /* struct __CFArrayBucket buckets follow here */&#125;; è¿™é‡Œé¢æœ‰ä¸¤ä¸ªæˆå‘˜ï¼š uintptr_t _capacityï¼šå®¹é‡ uintptr_t _leftIdxï¼šåç§»é‡ å¦‚æœè¯´å•çº¯æ ‡è®°æ•°ç»„å…ƒç´ å…ƒç´ çš„è¯ç”¨_countè¶³å¤Ÿäº†ï¼Œå®Œå…¨æ²¡å¿…è¦åŠ _capacityè¿™ä¸ªæˆå‘˜ï¼ŒåŠ ä¸Šåˆšåˆšçš„æçš„åç§»äº†_leftIdxä½ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£è¿™ä¸ª_capacityæ˜¯ä¸€ä¸ªå¤§äºå…ƒç´ ä¸ªæ•°çš„å®¹å™¨ï¼Œè€Œæ•°ç»„å…ƒç´ åªå­˜åœ¨å®¹å™¨å†…çš„ä¸€éƒ¨åˆ†ã€‚ è€Œä¸_capacityç›¸å…³çš„ä¸»è¦å°±ä¸€ä¸ªæ–¹æ³•ï¼š 123456789101112131415enum &#123; __CF_MAX_BUCKETS_PER_DEQUE = LONG_MAX&#125;;// capacity &lt; 4 =&gt; è¿”å›4// __CF_MAX_BUCKETS_PER_DEQUE &gt; capacity &gt;= 4 =&gt; capacity-&gt;2è¿›åˆ¶ï¼Œè·å–ä½æ•°nï¼Œè¿”å› 2^n// capacity &gt;= __CF_MAX_BUCKETS_PER_DEQUE =&gt; è¿”å›__CF_MAX_BUCKETS_PER_DEQUE// egï¼š// 1~3 =&gt; 4// 4~7 =&gt; 8// 8~15 =&gt; 16//flsl: return the position of the first bit set, or 0 if no bits are set in value.CF_INLINE CFIndex __CFArrayDequeRoundUpCapacity(CFIndex capacity) &#123; if (capacity &lt; 4) return 4; return __CFMin((1 &lt;&lt; flsl(capacity)), __CF_MAX_BUCKETS_PER_DEQUE);&#125; è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯æ ¹æ®æ•°ç»„çš„å…ƒç´ ä¸ªæ•°æ¥è·å–è¿™ä¸ª_capacityå¤§å°ã€‚ è¿™é‡Œä¸»è¦ä¹Ÿæ˜¯é‡‡ç”¨äºŒè¿›åˆ¶æ¥è¿ç®—çš„ï¼Œå¯èƒ½å¤§å®¶çœ‹èµ·æ¥æœ‰ç‚¹å›°éš¾ï¼Œå…¶å®ç”¨åè¿›åˆ¶æ¥æè¿°å°±ååˆ†æ¸…æ¥šï¼š 0-9 =&gt; 10 10-99 =&gt;100 100-999 =&gt; 1000 â€¦. ç›¸å½“äºæ€»æ˜¯ç”¨æ¯”è¿™ä¸ªæ•°å¤šä¸€ä½çš„æ•°æ¥ä½œä¸ºå®¹å™¨çš„å®¹é‡ã€‚ ä½†åŒæ ·æ˜¯ä¸ºäº†åŠ å¿«æ•ˆç‡ï¼Œè‹¹æœæ˜¯ç”¨äºŒè¿›åˆ¶æ¥å¤„ç†çš„ï¼š 0-11 =&gt; 100 å³ 0-3 =&gt; 4 100-111 =&gt; 1000 å³4~7 =&gt; 8 1000-1111 =&gt; 10000 å³8~15 =&gt; 16 â€¦ ç†è§£äº†è¿™ä¸€ç‚¹ä¹‹åï¼Œå…¶å®åªç”¨ç†è§£_leftIdxçš„å«ä¹‰å°±å¯ä»¥åˆ†æå‡ºå¯å˜æ•°ç»„æ˜¯æ€ä¹ˆå­˜çš„äº†ï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹_CFArrayReplaceValuesã€‚ ç”±äºæˆ‘ä»¬é‡ç‚¹æ˜¯äº†è§£å¦‚ä½•å¾€__CFArrayDequeå†™æ•°æ®çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä»¥ç›´æ¥å¯¹ä¸€ä¸ªç©ºæ•°ç»„ä¸€æ¬¡æ€§æ·»åŠ 4ä¸ªå…ƒç´ æ¥æ“ä½œï¼Œè¿™æ—¶å€™æˆ‘ä»¬å‘ç°__CFArrayDequeæ˜¯åœ¨ä»¥ä¸‹ä»£ç ä¸‹è¢«åˆå§‹åŒ–çš„ï¼š 12345678910111213141516171819202122if (0) &#123;&#125; else if (NULL == array-&gt;_store) &#123; //æ–°æ•°ç»„æˆ–è€…è¢«æ¸…ç©ºçš„æ•°ç»„ä¼šè¿›æ¥ if (0) &#123; &#125; else if (0 &lt;= futureCnt) &#123; // å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—å¯¹è±¡ struct __CFArrayDeque *deque; // æ ¹æ®å…ƒç´ æ€»æ•°ç¡®å®šå®¹å™¨å¯è½½å…ƒç´ æ€»æ•° CFIndex capacity = __CFArrayDequeRoundUpCapacity(futureCnt); // æ ¹æ®å®¹å™¨åˆ†é…ç©ºé—´å¤§å° CFIndex size = sizeof(struct __CFArrayDeque) + capacity * sizeof(struct __CFArrayBucket); // åˆå§‹åŒ–dequeï¼ŒåŠ è¿›_storeé‡Œ deque = (struct __CFArrayDeque *)CFAllocatorAllocate((allocator), size, isStrongMemory(array) ? __kCFAllocatorGCScannedMemory : 0); if (__CFOASafe) __CFSetLastAllocationEventName(deque, \"CFArray (store-deque)\"); deque-&gt;_leftIdx = (capacity - newCount) / 2;//ä½¿å¾—æ·»åŠ äº†ç›®æ ‡å…ƒç´ ä¹‹åä¸Šä¸‹å‰©ä½™çš„ç©ºé—´æ˜¯ç›¸åŒçš„ï¼Œè¿™æ—¶å€™ä»å¤´å’Œå°¾æ·»åŠ å°‘é‡å…ƒç´ æ—¶éƒ½ä¸éœ€è¦é‡æ–°å¼€è¾Ÿç©ºé—´ deque-&gt;_capacity = capacity; __CFAssignWithWriteBarrier((void **)&amp;array-&gt;_store, (void *)deque); if (CF_IS_COLLECTABLE_ALLOCATOR(allocator)) auto_zone_release(objc_collectableZone(), deque); // GC: now safe to unroot the array body. &#125; &#125; else &#123; //...&#125; æ³¨é‡Šå·²ç»å†™çš„å¾ˆæ¸…æ¥šäº†ï¼Œé»˜è®¤æƒ…å†µä¸‹æ•°ç»„çš„å…ƒç´ æ˜¯ä¼šæ”¾åœ¨è¿™ä¸ªå®¹å™¨çš„ä¸­é—´çš„ï¼Œä¸Šä¸‹éƒ½ä¿ç•™ç›¸ç­‰çš„ç©ºé—´ã€‚ è€Œä½œç”¨å‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆæ˜æ˜¾â€”â€”å°±æ˜¯æ–¹ä¾¿å‰åå…ƒç´ çš„å¢åˆ æ“ä½œçš„ å°ç»“â€”â€”å¯å˜æ•°ç»„åœ¨å†…å­˜çš„å­˜å‚¨æ–¹å¼è‡³æ­¤æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹å¯å˜æ•°ç»„çš„å­˜å‚¨æ–¹å¼ï¼š __CFArrayç»“æ„ä½“å’Œä¸å¯å˜æ•°ç»„ä¸€æ ·ï¼Œæ ¹æ®æ˜¯å¦æœ‰è®¾ç½®è‡ªå®šä¹‰CallBackï¼Œæ¥åˆ¤æ–­æ˜¯å¦åœ¨ç»“æ„ä½“åé¢å¼€è¾Ÿå†…å­˜æ¥å­˜å–CFArrayCallBacksï¼Œè€ŒçœŸæ­£æ•°ç»„å…ƒç´ æ˜¯å­˜åœ¨é€šè¿‡_storeç´¢å¼•çš„ä¸€ä¸ª__CFArrayDequeç»“æ„ä½“åé¢çš„ä¸€å—å†…å­˜ç©ºé—´çš„ï¼Œè€Œä¸”å‰åè¿˜ä¿ç•™äº†ä¸€äº›ç©ºä½ï¼Œä»¥ä¾›å…ƒç´ çš„å¢åˆ æ“ä½œ _CFArrayReplaceValuesâ€”â€”è¯¦ç»†è§£è¯»å¯å˜æ•°ç»„çš„æ“ä½œè¿‡ç¨‹ç›´æ¥ä¸Šæºç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798// /**// * @param array:è¦æ“ä½œçš„æ•°ç»„// * @param range:è¦æ“ä½œçš„èŒƒå›´ï¼šrange.locationè¡¨ç¤ºä»åŸæ•°ç»„çš„å“ªä½å¼€å§‹æ“ä½œï¼Œrange.lengthè¡¨ç¤ºåŸæ•°ç»„ä¸­éœ€è¦æ“ä½œçš„æ•°é‡// * @param newValues:æ“ä½œçš„æ–°æ•°å€¼æ•°ç»„// * @param newCount:æ–°æ•°å€¼çš„æ•°é‡// */// This function does no ObjC dispatch or argument checking;// It should only be called from places where that dispatch and check has already been done, or NSCFArrayvoid _CFArrayReplaceValues(CFMutableArrayRef array, CFRange range, const void **newValues, CFIndex newCount) &#123; CHECK_FOR_MUTATION(array); BEGIN_MUTATION(array); //cb: callback //idx: å¾ªç¯å†…çš„ä¸´æ—¶å˜é‡ //cnt: æ•°ç»„å˜åŒ–ä¹‹å‰çš„å…ƒç´ ä¸ªæ•° //futureCnt: æ•°ç»„å˜åŒ–ä¹‹åçš„å…ƒç´ ä¸ªæ•° //newv: æ–°å€¼æ•°ç»„ï¼Œçº³å…¥Allocatorç®¡ç† //buffer: 256ä¸ªæŒ‡é’ˆå…ƒç´ çš„æ•°ç»„,å¤§å°ä¸º256X8=2048bit const CFArrayCallBacks *cb; CFIndex idx, cnt, futureCnt; const void **newv, *buffer[256]; cnt = __CFArrayGetCount(array); futureCnt = cnt - range.length + newCount; CFAssert1(newCount &lt;= futureCnt, __kCFLogAssertion, \"%s(): internal error 1\", __PRETTY_FUNCTION__); cb = __CFArrayGetCallBacks(array); CFAllocatorRef allocator = __CFGetAllocator(array); //åˆ¤æ–­æ˜¯å¦éœ€è¦retain /* Retain new values if needed, possibly allocating a temporary buffer for them */ if (NULL != cb-&gt;retain &amp;&amp; !hasBeenFinalized(array)) &#123; //ä¸ªæ•°å°äº256ï¼Œå°±ç›´æ¥ç”¨ä¸ªæ•°ä¸º256çš„cæ•°ç»„ï¼Œå¦åˆ™Allocatoræ¥ç®¡ç†å†…å­˜ newv = (newCount &lt;= 256) ? (const void **)buffer : (const void **)CFAllocatorAllocate(kCFAllocatorSystemDefault, newCount * sizeof(void *), 0); // GC OK if (newv != buffer &amp;&amp; __CFOASafe) __CFSetLastAllocationEventName(newv, \"CFArray (temp)\"); for (idx = 0; idx &lt; newCount; idx++) &#123; ///#define INVOKE_CALLBACK2(P, A, B) (P)(A, B) newv[idx] = (void *)INVOKE_CALLBACK2(cb-&gt;retain, allocator, (void *)newValues[idx]); &#125; &#125; else &#123; newv = newValues; &#125; array-&gt;_mutations++; // å°†ä¸€ä¸ªæ•°ç»„çš„å…ƒç´ åŒºåŸŸåˆ†æˆäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½å¯èƒ½ä¸ºç©º // A: ä»ç´¢å¼•ä¸‹æ ‡é›¶çš„ä½ç½®åˆ°å°äº range.location çš„åŒºåŸŸ // B: ä¼ å…¥çš„ range.location åŒºåŸŸ // C: ä» range.location + range.length åˆ°æ•°ç»„æœ«å°¾ //å¹²æ‰BåŒºåŸŸæ•°æ® if (0 &lt; range.length) &#123; __CFArrayReleaseValues(array, range, false); &#125; if (0) &#123; &#125; else if (NULL == array-&gt;_store) &#123; //æ–°æ•°ç»„æˆ–è€…è¢«æ¸…ç©ºçš„æ•°ç»„ä¼šè¿›æ¥ if (0) &#123; &#125; else if (0 &lt;= futureCnt) &#123; // å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—å¯¹è±¡ struct __CFArrayDeque *deque; // æ ¹æ®å…ƒç´ æ€»æ•°ç¡®å®šå®¹å™¨å¯è½½å…ƒç´ æ€»æ•° CFIndex capacity = __CFArrayDequeRoundUpCapacity(futureCnt); // æ ¹æ®å®¹å™¨åˆ†é…ç©ºé—´å¤§å° CFIndex size = sizeof(struct __CFArrayDeque) + capacity * sizeof(struct __CFArrayBucket); // åˆå§‹åŒ–dequeï¼ŒåŠ è¿›_storeé‡Œ deque = (struct __CFArrayDeque *)CFAllocatorAllocate((allocator), size, isStrongMemory(array) ? __kCFAllocatorGCScannedMemory : 0); if (__CFOASafe) __CFSetLastAllocationEventName(deque, \"CFArray (store-deque)\"); deque-&gt;_leftIdx = (capacity - newCount) / 2;//åŸå› ï¼šä½¿å¾—æ·»åŠ äº†ç›®æ ‡å…ƒç´ ä¹‹åä¸Šä¸‹å‰©ä½™çš„ç©ºé—´æ˜¯ç›¸åŒçš„ï¼Œè¿™æ—¶å€™ä»å¤´å’Œå°¾æ·»åŠ å°‘é‡å…ƒç´ æ—¶éƒ½ä¸éœ€è¦é‡æ–°å¼€è¾Ÿç©ºé—´ deque-&gt;_capacity = capacity; __CFAssignWithWriteBarrier((void **)&amp;array-&gt;_store, (void *)deque); if (CF_IS_COLLECTABLE_ALLOCATOR(allocator)) auto_zone_release(objc_collectableZone(), deque); // GC: now safe to unroot the array body. &#125; &#125; else &#123; // Deque //dequeå·²ç»åˆ›å»ºå‡ºæ¥ï¼Œå…ƒç´ ä¸ªæ•°ä¸ä¸ºç©º if (0) &#123; &#125; else if (range.length != newCount) &#123; //æ ¹æ®BåŒºåŸŸå…ƒç´ ä¸ªæ•°ï¼ŒæŒªåŠ¨Aã€CåŒºåŸŸ __CFArrayRepositionDequeRegions(array, range, newCount); &#125; &#125; //ä»¥ä¸Šæ“ä½œåªæ˜¯å¼€è¾Ÿæ–°ç©ºé—´ï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰æŠŠæ–°çš„å…ƒç´ å¼„è¿›æ•°ç»„é‡Œï¼Œä¸‹é¢æŠŠå…ƒç´ ç§»è¿›æ•°ç»„é‡Œ // copy in new region B elements if (0 &lt; newCount) &#123; if (0) &#123; &#125; else &#123; // Deque struct __CFArrayDeque *deque = (struct __CFArrayDeque *)array-&gt;_store; struct __CFArrayBucket *raw_buckets = (struct __CFArrayBucket *)((uint8_t *)deque + sizeof(struct __CFArrayDeque)); ///TODOï¼šobjc_memmove_collectable??? objc_memmove_collectable(raw_buckets + deque-&gt;_leftIdx + range.location, newv, newCount * sizeof(struct __CFArrayBucket)); &#125; &#125; __CFArraySetCount(array, futureCnt); if (newv != buffer &amp;&amp; newv != newValues) CFAllocatorDeallocate(kCFAllocatorSystemDefault, newv); END_MUTATION(array);&#125; ä»£ç é‡å¾ˆå¤§ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹æ•´ä¸ªReplaceçš„æ­¥éª¤ å¯¹newValuesè¿›è¡Œretainå¤„ç† æ¸…é™¤åŸæ•°ç»„ä¸­è¦è¢«æ›¿ä»£çš„rangeå†…çš„å…ƒç´  æ ¹æ®æ–°å¢ä¸ªæ•°å¯¹åŸæ¥å†…å­˜çš„å…ƒç´ è¿›è¡Œå…ƒç´ æŒªåŠ¨ï¼ˆå¯èƒ½è¿˜ä¼šä¸ºæ–°æ•°ç»„å¼€è¾Ÿç©ºä»¶ï¼‰ æŠŠæ–°å¢å…ƒç´ æ·»åŠ åˆ°å¯¹åº”çš„dequeçš„ä½ç½® å…¶ä¸­1ã€2ã€4æ­¥éª¤éƒ½ç›´æ¥å±•ç¤ºå‡ºæ¥çš„ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç†è§£ä¸Šçš„å›°éš¾ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹ç¬¬3æ­¥ï¼Œç¬¬ä¸‰æ­¥æ˜¯é€šè¿‡__CFArrayRepositionDequeRegionså®ç°çš„ï¼Œè¿™ä¹Ÿæ˜¯ç†è§£æ•´ä¸ªæ•°ç»„å…ƒç´ æ“ä½œçš„é‡è¦ä¸€æ­¥ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100// may move deque storage, as it may need to grow dequestatic void __CFArrayRepositionDequeRegions(CFMutableArrayRef array, CFRange range, CFIndex newCount) &#123; // newCount elements are going to replace the range, and the result will fit in the deque struct __CFArrayDeque *deque = (struct __CFArrayDeque *)array-&gt;_store; struct __CFArrayBucket *buckets; CFIndex cnt, futureCnt, numNewElems; CFIndex L, A, B, C, R; buckets = (struct __CFArrayBucket *)((uint8_t *)deque + sizeof(struct __CFArrayDeque)); cnt = __CFArrayGetCount(array); futureCnt = cnt - range.length + newCount; L = deque-&gt;_leftIdx; // length of region to left of deque A = range.location; // length of region in deque to left of replaced range B = range.length; // length of replaced range C = cnt - B - A; // length of region in deque to right of replaced range R = deque-&gt;_capacity - cnt - L; // length of region to right of deque numNewElems = newCount - B; // deque-&gt;_capacityä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯2^nè¿™é‡Œæ˜¯è®©n-17, CFIndex wiggle = deque-&gt;_capacity &gt;&gt; 17; // so: äºŒè¿›åˆ¶ä½æ•°å°äº20ä½æˆ–è€…åè¿›åˆ¶å°äº131072ï¼Œwiggle = 4ï¼Œ å¦åˆ™ wiggle = 2^(n-17) if (wiggle &lt; 4) wiggle = 4; if (deque-&gt;_capacity &lt; (uint32_t)futureCnt || (cnt &lt; futureCnt &amp;&amp; L + R &lt; wiggle)) &#123; //æ­¤æ—¶ä¸€å®šè¦å¼€è¾Ÿæ–°çš„ç©ºé—´ï¼Œå¤§äºå¯æŠ–åŠ¨èŒƒå›´ï¼Œä¸èƒ½é€šè¿‡æŒªåŠ¨æ•°æ®å®Œæˆæ“ä½œ /** * å¼€è¾Ÿæ–°çš„ä¸€æ•´å—çš„è¿ç»­ç©ºé—´ï¼ˆåŒ…æ‹¬dequeç»“æ„ä½“ï¼‰ï¼Œè®¡ç®—æ–°çš„æ•°æ®å—ï¼ˆAã€Cï¼‰åœ¨æ–°ç©ºé—´çš„ä½ç½®ï¼Œmemoveç§»æ¤è¿‡å»ï¼Œ */ // must be inserting or space is tight, reallocate and re-center everything CFIndex capacity = __CFArrayDequeRoundUpCapacity(futureCnt + wiggle); CFIndex size = sizeof(struct __CFArrayDeque) + capacity * sizeof(struct __CFArrayBucket); CFAllocatorRef allocator = __CFGetAllocator(array); Boolean collectableMemory = CF_IS_COLLECTABLE_ALLOCATOR(allocator); struct __CFArrayDeque *newDeque = (struct __CFArrayDeque *)CFAllocatorAllocate(allocator, size, isStrongMemory(array) ? __kCFAllocatorGCScannedMemory : 0); if (__CFOASafe) __CFSetLastAllocationEventName(newDeque, \"CFArray (store-deque)\"); struct __CFArrayBucket *newBuckets = (struct __CFArrayBucket *)((uint8_t *)newDeque + sizeof(struct __CFArrayDeque)); CFIndex oldL = L; CFIndex newL = (capacity - futureCnt) / 2; CFIndex oldC0 = oldL + A + B; CFIndex newC0 = newL + A + newCount; newDeque-&gt;_leftIdx = newL; newDeque-&gt;_capacity = capacity; if (0 &lt; A) objc_memmove_collectable(newBuckets + newL, buckets + oldL, A * sizeof(struct __CFArrayBucket)); if (0 &lt; C) objc_memmove_collectable(newBuckets + newC0, buckets + oldC0, C * sizeof(struct __CFArrayBucket)); __CFAssignWithWriteBarrier((void **)&amp;array-&gt;_store, (void *)newDeque); if (!collectableMemory &amp;&amp; deque) CFAllocatorDeallocate(allocator, deque); if (CF_IS_COLLECTABLE_ALLOCATOR(allocator)) auto_zone_release(objc_collectableZone(), newDeque); //printf(\"3: array %p store is now %p (%lx)\\n\", array, array-&gt;_store, *(unsigned long *)(array-&gt;_store)); return; &#125;// /**// * numNewElems &lt; 0 è¯´æ˜æ•°æ®å˜å°‘äº†ï¼Œçœ‹æ˜¯Aå°è¿˜æ˜¯Cå°ï¼Œmemmoveä¸¤è€…å°çš„é‚£å—åŒºåŸŸå³å¯// * numNewElems &gt; 0 è¯´æ˜æ•°æ®å˜å¤šäº†ï¼Œå¦‚æœA &gt; C ä¸” Cä¸‹é¢çš„RåŒºåŸŸå¤Ÿå¤§å°±memmove CåŒºåŸŸå³å¯ï¼Œ C &lt; A ä¸”ä¸Šé¢çš„LåŒºåŸŸå¤Ÿå¤§å°±memmove AåŒºåŸŸå³å¯// * numNewElems &gt; 0 ä¸”ä¸ç¬¦åˆä¸Šè¿°è§„åˆ™ï¼Œ éœ€è¦æ ¹æ®å…·ä½“æƒ…å†µåŒæ—¶ç§»åŠ¨Aã€CåŒºåŸŸ// */ if ((numNewElems &lt; 0 &amp;&amp; C &lt; A) || (numNewElems &lt;= R &amp;&amp; C &lt; A)) &#123; // move C // deleting: C is smaller // inserting: C is smaller and R has room CFIndex oldC0 = L + A + B; CFIndex newC0 = L + A + newCount; if (0 &lt; C) objc_memmove_collectable(buckets + newC0, buckets + oldC0, C * sizeof(struct __CFArrayBucket)); // GrP GC: zero-out newly exposed space on the right, if any if (oldC0 &gt; newC0) memset(buckets + newC0 + C, 0, (oldC0 - newC0) * sizeof(struct __CFArrayBucket)); &#125; else if ((numNewElems &lt; 0) || (numNewElems &lt;= L &amp;&amp; A &lt;= C)) &#123; // move A // deleting: A is smaller or equal (covers remaining delete cases) // inserting: A is smaller and L has room CFIndex oldL = L; CFIndex newL = L - numNewElems; deque-&gt;_leftIdx = newL; if (0 &lt; A) objc_memmove_collectable(buckets + newL, buckets + oldL, A * sizeof(struct __CFArrayBucket)); // GrP GC: zero-out newly exposed space on the left, if any if (newL &gt; oldL) memset(buckets + oldL, 0, (newL - oldL) * sizeof(struct __CFArrayBucket)); &#125; else &#123; // now, must be inserting, and either: // A&lt;=C, but L doesn't have room (R might have, but don't care) // C&lt;A, but R doesn't have room (L might have, but don't care) // re-center everything CFIndex oldL = L; CFIndex newL = (L + R - numNewElems) / 2; newL = newL - newL / 2; CFIndex oldC0 = oldL + A + B; CFIndex newC0 = newL + A + newCount; deque-&gt;_leftIdx = newL; if (newL &lt; oldL) &#123; if (0 &lt; A) objc_memmove_collectable(buckets + newL, buckets + oldL, A * sizeof(struct __CFArrayBucket)); if (0 &lt; C) objc_memmove_collectable(buckets + newC0, buckets + oldC0, C * sizeof(struct __CFArrayBucket)); // GrP GC: zero-out newly exposed space on the right, if any if (oldC0 &gt; newC0) memset(buckets + newC0 + C, 0, (oldC0 - newC0) * sizeof(struct __CFArrayBucket)); &#125; else &#123; if (0 &lt; C) objc_memmove_collectable(buckets + newC0, buckets + oldC0, C * sizeof(struct __CFArrayBucket)); if (0 &lt; A) objc_memmove_collectable(buckets + newL, buckets + oldL, A * sizeof(struct __CFArrayBucket)); // GrP GC: zero-out newly exposed space on the left, if any if (newL &gt; oldL) memset(buckets + oldL, 0, (newL - oldL) * sizeof(struct __CFArrayBucket)); &#125; &#125; &#125; å¯ä»¥çœ‹å‡ºè‹¹æœåœ¨è¿™å—è¿˜æ˜¯æœ‰åšæ¯”è¾ƒå¤šçš„ä¼˜åŒ–çš„ï¼Œå¤§è‡´è®²ä¸‹çš„æ€è·¯ï¼š é¦–å…ˆæ ¹æ®æ˜¯å¦è¦åˆ›å»ºç©ºé—´åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼šéœ€è¦åˆ†é…æ–°å†…å­˜ã€ä¸éœ€è¦åˆ†é…æ–°å†…å­˜ éœ€è¦åˆ†é…æ–°å†…å­˜ï¼šé‡æ–°å¼€è¾Ÿä¸€æ•´ä¸ªèƒ½å®¹å¾—ä¸‹æ–°æ•°ç»„çš„å®¹å™¨ã€‚æŒ‰ç…§ä¹‹å‰çš„è§„åˆ™ï¼ˆæŠŠæ•°æ®æ”¾åˆ°ä¸­é—´ï¼‰æŠŠå¯¹åº”åŒºåŸŸçš„æ•°æ®æ‹·åˆ°ç›¸åº”çš„ä½ç½®ä¸­å» ä¸éœ€è¦åˆ†é…æ–°å†…å­˜ï¼šåˆ¤æ–­æ˜¯å¢åŠ æ•°æ®è¿˜æ˜¯å‡å°‘æ•°æ® å‡å°‘æ•°æ®ï¼šåˆ¤æ–­æ˜¯AåŒºåŸŸå°è¿˜æ˜¯CåŒºåŸŸå° AåŒºåŸŸå°ï¼šç§»åŠ¨AåŒºåŸŸï¼Œé‡ç½®æ²¡ç”¨çš„å†…å­˜ç©ºé—´ CåŒºåŸŸå°ï¼šç§»åŠ¨CåŒºåŸŸï¼Œé‡ç½®æ²¡ç”¨çš„å†…å­˜ç©ºé—´ å¢åŠ æ•°æ®ï¼šåˆ¤æ–­ä¸¤è€…åŒºåŸŸå…³ç³»ä»¥åŠä¸Šä¸‹æ˜¯å¦æœ‰è¶³å¤Ÿçš„å®¹é‡ Aæ¯”Cå°ï¼Œä¸”ä¸Šé¢çš„LåŒºåŸŸæ¯”å¢åŠ çš„ä¸ªæ•°å¤§ï¼šç§»åŠ¨AåŒºåŸŸï¼Œé‡ç½®æ²¡ç”¨çš„å†…å­˜ç©ºé—´ Cæ¯”Aå°ï¼Œä¸”ä¸‹é¢çš„RåŒºåŸŸæ¯”å¢åŠ çš„ä¸ªæ•°å¤§ï¼šç§»åŠ¨CåŒºåŸŸï¼Œé‡ç½®æ²¡ç”¨çš„å†…å­˜ç©ºé—´ å…¶ä»–æƒ…å†µï¼šæŒ‰ç…§ä¹‹å‰çš„è§„åˆ™ï¼ˆæŠŠæ•°æ®æ”¾åˆ°ä¸­é—´ï¼‰åŒæ—¶ç§»åŠ¨Aã€CåŒºåŸŸï¼Œæ¸…é™¤æ²¡ç”¨æ•°æ® ï¼ˆå®ç°å’Œæˆ‘åˆ†æçš„å¯èƒ½éƒ¨åˆ†é¡ºåºä¸Šæœ‰ä¸åŒï¼Œä½†æ€è·¯ç›¸åŒï¼‰ å…³äºLã€Aã€Bã€Cã€RåŒºåŸŸçš„åˆ’åˆ†å¯ä»¥å‚ç…§ä¸‹å›¾ï¼šé¡ºä¾¿ä¸¾äº†å‡ ä¸ªä¾‹å­ï¼š ä¸éœ€è¦åˆ›å»ºå†…å­˜ç©ºé—´ï¼Œåªç§»åŠ¨Aï¼ˆCï¼‰ä¸€å—åŒºåŸŸï¼š ä¸éœ€è¦åˆ›å»ºå†…å­˜ç©ºé—´ï¼Œä½†æ˜¯è¦ç§»åŠ¨Aã€Cä¸¤å—åŒºåŸŸï¼š éœ€è¦åˆ›å»ºå†…å­˜ç©ºé—´ï¼ŒåŒæ—¶ç§»åŠ¨Aã€Cä¸¤å—åŒºåŸŸ","tags":[{"name":"iOS","slug":"iOS","permalink":"http://alfredzhenyu.github.io/tags/iOS/"},{"name":"Objc","slug":"Objc","permalink":"http://alfredzhenyu.github.io/tags/Objc/"},{"name":"æºç è§£æ","slug":"æºç è§£æ","permalink":"http://alfredzhenyu.github.io/tags/æºç è§£æ/"}]},{"title":"2017å¹´çš„æ–°å¹´å¯„è¯­","date":"2017-02-07T12:59:48.000Z","path":"2017/02/07/2017å¹´çš„æ–°å¹´å¯„è¯­/","text":"â€‹ è¿™æ˜¯2017å¹´è¿‡å®Œå†œå†æ–°å¹´çš„ç¬¬ä¸€ç¯‡blogï¼Œè¿‡å¹´ç»™è‡ªå·±æ”¾äº†ä¸ªå°å‡ï¼Œä¼‘æ¯äº†ä¸€æ®µæ—¶é—´ã€‚åˆšè¿‡å®Œå¹´ï¼Œä¸æƒ³å†™å¤ªå¤šæŠ€æœ¯æ€§çš„ä¸œè¥¿ã€‚æ‰€è°“æ–°å¹´æ–°å¸Œæœ›æ–°ç›®æ ‡ï¼Œåœ¨è¿™é‡Œä¹Ÿæƒ³ç»™è‡ªå·±å®šä¸ªæ–°çš„ç›®æ ‡ï¼Œç®—æ˜¯ç»™è‡ªå·±å®šéœ€æ±‚ï¼Œç£ä¿ƒä¸‹è‡ªå·±å§ã€‚ 2017çš„â€œå°ç›®æ ‡â€ è¿›ä¸€æ­¥äº†è§£ä¸€äº›iOSçš„åº•å±‚å®ç° CF Objc-runtime å¦‚æœæœ‰æœºä¼šçš„è¯å¯ä»¥æ¥è§¦ä¸‹JavaScriptCoreã€WebKitè¿™ç±»ç½‘ç»œæ¡†æ¶ äº†è§£ä¸‹iOS8ã€9ã€10çš„ä¸€äº›æ–°ç‰¹æ€§ æ·±å…¥å»å­¦ä¹ iOSçš„åŠ¨æ€éƒ¨ç½²æ–¹æ¡ˆ äº†è§£ä¸‹æ€ä¹ˆæ ·åœ¨iOSä¸Šé¢è·‘Luaï¼Œå¦‚æœæ–¹æ¡ˆå¯è¡Œçš„è¯å¯ä»¥è€ƒè™‘æ·±å…¥å­¦ä¹ ä¸‹luaï¼Œæœ‰æœºä¼šåº”ç”¨åœ¨å·¥ç¨‹é‡Œå» æ·±å…¥ç†è§£RNåº•å±‚çš„å®ç°åŸç†ï¼Œäº‰å–èƒ½åšåˆ°æŠŠä¹‹å‰å­¦çš„RNåº”ç”¨åˆ°é¡¹ç›®ä¸­å» æ·±å…¥å­¦ä¹ OpenGL æ¸¸æˆå¼€å‘ï¼ˆä»OpenGLå…¥é—¨è¿‡æ¸¡åˆ°3Dæ¸¸æˆçš„å¼€å‘ï¼Œå­¦ä¹ ä¸€ä¸ªæ¸¸æˆå¼•æ“ï¼‰ SpiritKitï¼ˆæœ‰æœºä¼šå¯ä»¥é¡ºå¸¦äº†è§£ä¸‹Metalï¼‰ Unity3d/unrealè¿˜æ²¡çº ç»“å¥½é€‰å“ªä¸ª ç®—æ³•çš„ç§¯ç´¯ï¼ˆå¸Œæœ›æœ‰æœºä¼šèƒ½æ²‰æ·€ä¸‹ï¼‰ äº†è§£ä¸‹è§†é¢‘ç›´æ’­æŠ€æœ¯ï¼Œå¸Œæœ›æœ‰æœºä¼šèƒ½å‚ä¸å…¶ä¸­ æ€»ç»“æš‚æ—¶å°±è¿™ä¹ˆå¤šå•¦â€¦.å…¶å®æˆ‘è§‰å¾—å·²ç»ä¸æ˜¯å‡ ä¸ªâ€å°ç›®æ ‡â€è¿™ä¹ˆç®€å•äº†ï¼Œèƒ½å®Œæˆä¼°è®¡ä¼šæœ‰å¦å¤–ä¸€ä¸ªé£è·ƒå§ã€‚ å…±å‹‰ï¼ï¼ï¼","tags":[{"name":"ç”Ÿæ´»","slug":"ç”Ÿæ´»","permalink":"http://alfredzhenyu.github.io/tags/ç”Ÿæ´»/"}]},{"title":"iOSå¼€å‘é»‘ç§‘æŠ€ä¹‹Xcodeå¤šTargetå¼€å‘","date":"2017-01-13T02:39:45.000Z","path":"2017/01/13/iOSå¼€å‘é»‘ç§‘æŠ€ä¹‹Xcodeå¤šTargetå¼€å‘/","text":"å‰è¨€å¾ˆå¤šæ—¶å€™ä¼šå‡ºç°ä¸€ç§æƒ…å†µï¼šåŒä¸€ä¸ªå·¥ç¨‹æ–‡ä»¶éœ€è¦ç”Ÿæˆå¤šä¸ªç›¸ä¼¼çš„app æ¯”å¦‚ï¼š åŒä¸€ä¸ªappçš„Proã€Liteã€Freeç‰ˆ åŒä¸€ä¸ªæ¨¡æ¿å·¥ç¨‹åº”ç”¨äºä¸åŒapp åŒä¸€ä¸ªappçš„iPadã€iPhoneç‰ˆ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±éœ€è¦åœ¨ä¸€ä¸ªXcodeå·¥ç¨‹ä¸‹æ·»åŠ å¤šä¸ªTargetæ¥å®ç°ï¼Œè¿™é‡Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹ï¼Œå¦‚ä½•åœ¨ä¸€ä¸ªå·¥ç¨‹ä¸‹è¿›è¡Œå¤šTargetå¼€å‘ Targetçš„åˆ›å»ºå¤åˆ¶ä¸€ä¸ªæ–°Target ç‚¹å‡»å·¥ç¨‹-æ‰¾åˆ°æ§åˆ¶çª—å£çš„ä¾§è¾¹æ é‡Œæ‰¾åˆ°TARGETS-å³é”®å‘¼å‡ºèœå•ç‚¹å‡»Duplicate å¯ä»¥çœ‹åˆ° æˆ‘ä»¬å‘ç°å›¾ç‰‡ç®­å¤´åœ°æ–¹å¤šäº†æ–°çš„Copy Targetï¼Œä½†é€šå¸¸è¿™ä¸ªåå­—æ˜¾å¾—æœ‰ç‚¹ä¸å¤ªä¸“ä¸šï¼Œå¹¶ä¸æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œæ”¹å æ›´æ”¹Targetåå­—ç›´æ¥åŒå‡»æ§åˆ¶æ é‡Œçš„ä¾§è¾¹æ çš„Targetï¼Œæ›´æ”¹åå­—å¦‚å›¾ï¼š æ›´æ”¹Schemeåå­—ç‚¹å‡»æœ€ä¸Šæ–¹åœ¨æ›´æ”¹å½“å‰ç¼–è¯‘çš„Targetä½ç½®é‡Œç‚¹å‡»edit schemeé€‰é¡¹ï¼Œå‡ºç°å¦‚å›¾æ§åˆ¶çª— ç‚¹å‡»Manage Scemesæ‰¾åˆ°éœ€è¦æ›´æ”¹åå­—çš„Sceme,åŒå‡»é‡å‘½å æ›´æ”¹.plistæ–‡ä»¶ååŒå‡»éœ€è¦æ›´æ”¹çš„plistæ–‡ä»¶åï¼Œè¾“å…¥æ–‡ä»¶åå³å¯ï¼Œå¦‚å›¾ ä½†å‘ç°æ›´æ”¹åå­—åå·¥ç¨‹æ— æ³•è¯†åˆ«ï¼Œå¯ä»¥æ‰¾åˆ°å¯¹åº”Targetçš„Build Settingæ‰¾åˆ°ä¸€ä¸ªé€‰é¡¹Info.plist Fileï¼Œæ›´æ”¹æˆå¯¹åº”è·¯å¾„å³å¯ å¤šTargetå¼€å‘å®é™…é¡¹ç›®ä¸­é€šå¸¸ä¼šå‡ºç°ä¸åŒçš„Targetä½¿ç”¨ä¸åŒçš„èµ„æºã€ä»£ç  è¿™é‡Œï¼Œæˆ‘æ¥è®²è®²æˆ‘åœ¨è¿™å—çš„ä¸€äº›ç»éªŒï¼š ä¸åŒTargetä¸åŒèµ„æºçš„å¤„ç†åœ¨èµ„æºæ–‡ä»¶å¤¹ä¸­æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹TargetDiffç”¨äºè£…ä¸åŒTargetä¸ä¸€æ ·çš„èµ„æºï¼Œè¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼Œå°±æ˜¯åœ¨TargetDiffæ–‡ä»¶å¤¹ä¸‹å»ºå¤šä¸ªæ–‡ä»¶å¤¹ä»¥å¯¹åº”ä¸åŒçš„Targetï¼Œç„¶åå†æ¯ä¸ªTargetæ–‡ä»¶å¤¹ä¸‹å¯¹äºåŒä¸€ç§èµ„æºå–ç›¸åŒçš„åå­—ï¼Œå¦‚å›¾ï¼š å¯ä»¥çœ‹åˆ°ä¸åŒçš„Targetï¼šBemewingså’ŒBemetoyä¸‹éƒ½æœ‰Logo.bundleç„¶åä¸‹é¢æœ‰login_logo.pngç­‰ç­‰çš„åŒåèµ„æº è¿™æ—¶å€™æˆ‘ä»¬åªè¦åœ¨å³ä¾§æ›´æ”¹å…¶å¯¹åº”çš„Target Membershipï¼Œé€‰æ‹©ä¸åŒçš„Targetï¼Œè¿™æ—¶å€™ä¸åŒTargetç¼–è¯‘çš„æ—¶å€™ï¼Œåªæœ‰åœ¨membershipä¹‹å†…çš„èµ„æºæ‰ä¼šæ‰“åŒ…è¿›appå†…ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°åªå†™ä¸€å¥—åŠ è½½èµ„æºçš„ä»£ç ï¼Œå°±å¯ä»¥ç´¢å¼•åˆ°å¯¹åº”Targetçš„èµ„æºï¼Œä»è€Œåº”ç”¨åœ¨ä¸åŒçš„Targetä¸Š ä¸åŒTargetä¸åŒä»£ç çš„å¤„ç†Targetæ ‡è¯†ç¬¦æ‰“å¼€ä¸åŒTargetä¸‹çš„Build Settingï¼Œæ‰¾åˆ°ä¸‹é¢è¿™ä¸€ç±»ï¼š æŠŠEnable Foundation Assertionsè®¾ç½®ä¸ºYES åœ¨Preprocessor Macrosä¸‹çš„æ¯ä¸€ä¸ªé€‰é¡¹éƒ½æ·»åŠ ä¸€ä¸ªå®ç”¨äºæ ‡è¯†å¯¹åº”çš„Target åœ¨è¿™é‡Œæˆ‘æ·»åŠ äº†ä¸€ä¸ªBEMEWINGSä»¥å¯¹åº”æˆ‘çš„Bemewingsçš„Target è¿™æ—¶å€™å¯ä»¥åœ¨AppDelegateé‡Œå°±å¯ä»¥åŠ å…¥ä»¥ä¸‹ä»£ç æ¥å®ç°ä¸åŒTargetä¸åŒå¤„ç†ï¼š User-Definedæ ‡è¯†ä¸Šé¢çš„é‚£ç§æ–¹æ³•åªæ˜¯ç®€å•çš„è¯†åˆ«æ˜¯å¦æ˜¯æŸä¸ªTargetï¼Œä½†æ˜¯å®é™…å¼€å‘ä¸­ä¼šå‡ºç°è¿™æ ·çš„éœ€æ±‚ï¼š å‡è®¾æœ‰ä¸‰å››ä¸ªç›¸ä¼¼çš„appï¼ˆTargetï¼‰å¯èƒ½å…¶ä¸­æœ‰ä¸€ä¸¤ä¸ªä½¿ç”¨åˆ°è¿™ä¸ªåŠŸèƒ½æ¨¡å—ï¼Œè¿è¡Œäº†è¿™æ®µä»£ç ï¼Œè€Œå…¶ä»–åˆ™æ²¡æœ‰ï¼Œé‚£ä¹ˆå°±éœ€è¦ç”¨åˆ°User-Definedæ¥å°†ä»£ç æ¨¡å—åŠŸèƒ½åŒ–ï¼Œé€šè¿‡Xcodeçš„é€‰é¡¹æ¥æ§åˆ¶ä¸åŒTargetã€ç”šè‡³ä¸åŒç¼–è¯‘ç‰ˆæœ¬æ˜¯å¦å¼€å¯å…³é—­è¿™ä¸ªåŠŸèƒ½: å…ˆä¸Šå›¾ï¼š ä»¥å­—æ®µ_BM_SHELLSCORE_ENABLEä¸ºä¾‹ æ³¨ï¼š å‰é¢åŠ ä¸‹åˆ’çº¿æ˜¯å› ä¸ºè¿™æ˜¯ä¸ªç§æœ‰å˜é‡ï¼Œå…¶å®å¤–ç•Œæ˜¯è®¿é—®ä¸åˆ°è¿™ä¸ªçš„ å¦å¤–è¿™é‡Œçš„å€¼å†™YESã€NOæˆ–è€…ä»»æ„å­—ç¬¦ä¸²éƒ½æ˜¯å¯ä»¥çš„ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå®ï¼ŒçœŸæ­£å€¼æ˜¯å•¥å–å†³äºåé¢çš„æ“ä½œï¼š è®¾ç½®å…¨å±€å®ï¼š å¦‚å›¾ï¼š åœ¨å¯¹åº”çš„æ·»åŠ å®å®šä¹‰ æŠŠ_BM_SHELLSCORE_ENABLEå½“å€¼æ—¶ï¼Œå¯ä»¥è¿™æ ·å®šä¹‰ 1-D&apos;BM_SHELLSCORE_ENABLE=$(_BM_SHELLSCORE_ENABLE)&apos; æŠŠ_BM_SHELLSCORE_ENABLEå½“å­—ç¬¦ä¸²æ—¶ï¼Œå¯ä»¥è¿™æ ·å®šä¹‰ 1-D&apos;BM_SHELLSCORE_OPEN_INFO=@&quot;$(_BM_SHELLSCORE_ENABLE)&quot;&apos; æ³¨ï¼š BM_SHELLSCORE_ENABLEæ˜¯çœŸçœŸæ­£æ­£èƒ½ä»£ç ä¸­ä½¿ç”¨çš„å® $(_BM_SHELLSCORE_ENABLE)è¡¨ç¤ºå–_BM_SHELLSCORE_ENABLEçš„å€¼ è®¾ç½®å±€éƒ¨å®ï¼š ç‚¹å‡»Target-Build Phases-ç‚¹å‡»éœ€è¦å®çš„æ–‡ä»¶-æ·»åŠ Compiler Flagsï¼Œè¾“å…¥ä¸Šé¢ä¸€æ ·çš„çš„å®å®šä¹‰å³å¯ æ³¨æ„ï¼š å®šä¹‰å¤šä¸ªå®æ—¶ï¼Œä¸€å®šè¦æ¢è¡Œï¼Œæ¢è¡Œçš„æ–¹å¼æ˜¯Option+enteré”®ï¼Œä¸èƒ½ç›´æ¥enter åŠŸèƒ½æ¨¡å—æ§åˆ¶ï¼š å¯¹äºåŠŸèƒ½æ¨¡å—çš„ä»£ç ç»Ÿä¸€åŠ å…¥å®: 12345#if BM_SHELLSCORE_ENABLE//code here#else//code here#endif è¿™æ—¶å€™ï¼Œä½ å°±å¯ä»¥é€šè¿‡æ›´æ”¹å·¥ç¨‹æ–‡ä»¶-Targeté‡ŒBuild Settingé‡Œçš„User-Deifinedå€¼æ¥æ§åˆ¶æ˜¯å¦å¼€å¯è¿™é¡¹åŠŸèƒ½ User-Definedæ‰©å±•è€Œå¯¹äºStringç±»å‹çš„å®æ›´å¤šç”¨äºåœ¨ä¸åŒç¼–è¯‘ç‰ˆæœ¬ä¸‹è®¾ç½®ä¸åŒçš„URLï¼Œå› ä¸ºä¸€èˆ¬æ¥è¯´æµ‹è¯•ç¯å¢ƒä¸æ­£å¼ç¯å¢ƒè®¿é—®çš„åœ°å€ï¼ŒåŸŸåéƒ½ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡User-Definedé‡Œä¸€ä¸ªå­—æ®µä¸‹é¢çš„Debugã€Releaseè®¾ç½®ä¸åŒçš„URLï¼Œå°±å¯ä»¥å®ç°åŒä¸€æ®µä»£ç è®¿é—®åŒä¸€ä¸ªå®ï¼Œå®é™…ä½¿ç”¨çš„æ˜¯ä¸åŒå€¼çš„æƒ…å†µ","tags":[{"name":"iOS","slug":"iOS","permalink":"http://alfredzhenyu.github.io/tags/iOS/"},{"name":"Xcode","slug":"Xcode","permalink":"http://alfredzhenyu.github.io/tags/Xcode/"}]},{"title":"Objcçš„Runtimeæºç è§£è¯»ï¼ˆä¸‰ï¼‰ä¹‹æ¶ˆæ¯ï¼ˆMessagingï¼‰æœºåˆ¶","date":"2017-01-11T08:54:46.000Z","path":"2017/01/11/Objcçš„Runtimeæºç è§£è¯»ï¼ˆä¸‰ï¼‰ä¹‹æ¶ˆæ¯ï¼ˆMessagingï¼‰æœºåˆ¶/","text":"ç›®å½•ï¼š æ¶ˆæ¯ä¼ é€’æœºåˆ¶ â€‹ æ¶ˆæ¯ä¼ é€’(Messaging) Iâ€™m sorry that I long ago coined the term â€œobjectsâ€ for this topic because it gets many people to focus on the lesser idea. The big idea is â€œmessagingâ€ â€“ that is what the kernal[sic] of Smalltalk is all aboutâ€¦ The key in making great and growable systems is much more to design how its modules communicate rather than what their internal properties and behaviors should be.","tags":[{"name":"iOS","slug":"iOS","permalink":"http://alfredzhenyu.github.io/tags/iOS/"},{"name":"Objc","slug":"Objc","permalink":"http://alfredzhenyu.github.io/tags/Objc/"},{"name":"æºç è§£æ","slug":"æºç è§£æ","permalink":"http://alfredzhenyu.github.io/tags/æºç è§£æ/"}]},{"title":"Objcçš„Runtimeæºç è§£è¯»ï¼ˆäºŒï¼‰ä¹‹æ–¹æ³•çš„å­˜å‚¨","date":"2017-01-09T08:50:25.000Z","path":"2017/01/09/Objcçš„Runtimeæºç è§£è¯»ï¼ˆäºŒï¼‰ä¹‹æ–¹æ³•çš„å­˜å‚¨/","text":"ç›®å½•ï¼š æ–¹æ³•çš„å­˜å‚¨ class_data_bitsç»“æ„ä½“ class_rw_tå’Œclass_ro_tç»“æ„ä½“ ä»realizeClassçœ‹æ–¹æ³•çš„å­˜å‚¨ ç›¸å…³æºç  class_data_bits ç»“æ„ä½“æ­£å¦‚ä¸Šç¯‡æ–‡ç« æåˆ°çš„ä¸€æ ·ï¼Œæ–¹æ³•å‚¨å­˜åœ¨obj_classçš„class_data_bitsç±»å‹çš„ç»“æ„ä½“é‡Œ 123456struct objc_class : objc_object &#123; isa_t isa; Class superclass; cache_t cache; // formerly cache pointer and vtable class_data_bits_t bits; // class_rw_t * plus custom rr/alloc flags&#125;; class_data_bits ç»“æ„ä½“ï¼š 123struct class_data_bits_t &#123; uintptr_t bits;&#125; ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™é‡Œçš„bitsæ¯ä¸€ä½çš„å«ä¹‰ï¼š æ³¨æ„åˆ°åœ¨objc_classæ³¨é‡Šé‡Œå†™çš„ class_data_bits_t ç›¸å½“äº class_rw_t æŒ‡é’ˆåŠ ä¸Š rr/alloc çš„æ ‡å¿—ã€‚è€Œåœ¨class_data_bits_tçš„æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™ä¸ªæ–¹æ³•ä¾¿æ·çš„è¿”å›class_rw_t * æŒ‡é’ˆ 12345// data pointer#define FAST_DATA_MASK 0x00007ffffffffff8ULclass_rw_t* data() &#123; return (class_rw_t *)(bits &amp; FAST_DATA_MASK);&#125; å¯ä»¥çœ‹å‡º class_rw_t * æŒ‡é’ˆçš„åœ°å€ä»ç¬¬3åˆ°ç¬¬47ä½ è€Œbitsçš„å…¶ä»–ä½ï¼š 1234#define FAST_IS_SWIFT (1UL&lt;&lt;0)#define FAST_HAS_DEFAULT_RR (1UL&lt;&lt;1)#define FAST_REQUIRES_RAW_ISA (1UL&lt;&lt;2)#define FAST_DATA_MASK 0x00007ffffffffff8UL isSwift()``FAST_IS_SWIFT ç”¨äºåˆ¤æ–­ Swift ç±» hasDefaultRR()``FAST_HAS_DEFAULT_RR å½“å‰ç±»æˆ–è€…çˆ¶ç±»å«æœ‰é»˜è®¤çš„ retain/release/autorelease/retainCount/_tryRetain/_isDeallocating/retainWeakReference/allowsWeakReference æ–¹æ³• requiresRawIsa()``FAST_REQUIRES_RAW_ISA å½“å‰ç±»çš„å®ä¾‹éœ€è¦ raw isa æ³¨ï¼šé€šè¿‡ objc_class ä¸­çš„ data() æ–¹æ³•å’Œ class_data_bits_t ä¸­çš„ data() æ–¹æ³•è¿”å›çš„æ˜¯åŒä¸€ä¸ªclass_rw_t *æŒ‡é’ˆ class_rw_tå’Œclass_ro_tç»“æ„ä½“class_rw_tæºç 12345678910111213struct class_rw_t &#123; uint32_t flags; uint32_t version; const class_ro_t *ro; method_array_t methods; property_array_t properties; protocol_array_t protocols; Class firstSubclass; Class nextSiblingClass;&#125;; å¯ä»¥çœ‹åˆ°: è¿™é‡Œé¢å­˜å‚¨ç€å±æ€§(properties)ã€æ–¹æ³•(methods)ã€éµå¾ªçš„åè®®(protocols) åŒæ—¶è¿™å†…éƒ¨è¿˜æœ‰ä¸€ä¸ªæŒ‡é’ˆå«åšroï¼Œç±»å‹ä¸ºclass_ro_t æˆ‘ä»¬å†æ¥çœ‹ä¸‹class_ro_tçš„æºç  class_ro_tæºç 12345678910111213141516struct class_ro_t &#123; uint32_t flags; uint32_t instanceStart; uint32_t instanceSize; uint32_t reserved; const uint8_t * ivarLayout; const char * name; method_list_t * baseMethodList; protocol_list_t * baseProtocols; const ivar_list_t * ivars; const uint8_t * weakIvarLayout; property_list_t *baseProperties;&#125;; å‘ç°è¿™ä¸¤ä¸ªæœ‰ç‚¹åƒä¹Ÿæœ‰å±æ€§ã€æ–¹æ³•ã€åè®® ä»å­—é¢ä¸Šå°±å¯ä»¥ç†è§£è¿™ä¸¤ä¸ªçš„å·®åˆ«ï¼š roï¼šread onlyã€‚å­˜å‚¨çš„æ˜¯å½“å‰ç±»åœ¨ç¼–è¯‘æœŸé—´å°±å·²ç»ç¡®å®šçš„å±æ€§(baseProperties)ã€æ–¹æ³•(baseMethodList)ä»¥åŠéµå¾ªçš„åè®®(baseProtocols) rwï¼šread writeã€‚å­˜å‚¨çš„æ˜¯ä¸€äº›è‡ªå·±å®ç°çš„æ–¹æ³•ï¼ˆåŒ…æ‹¬åˆ†ç±»ï¼‰(methods)ã€å±æ€§(properties)ã€ä»¥åŠéµå¾ªçš„åè®®(protocols) è¦æƒ³æ·±å…¥ç†è§£æ–¹æ³•çš„å­˜å‚¨å¯ä»¥çœ‹ä¸‹class_ro_tå’Œ class_rw_tåœ¨åŠ è½½ObjCè¿è¡Œæ—¶æ˜¯æ€ä¹ˆè°ƒç”¨çš„ï¼Œå¯ä»¥æ‰¾åˆ° realizeClass è¿™ä¸ªæ–¹æ³• ä»realizeClassçœ‹æ–¹æ³•çš„å­˜å‚¨ä¸»è¦çœ‹ä¸‹æ–¹æ³•å†…éƒ¨class_ro_tå’Œ class_rw_tç›¸å…³çš„éƒ¨åˆ†ï¼š 12345const class_ro_t *ro = (const class_ro_t *)cls-&gt;data();class_rw_t *rw = (class_rw_t *)calloc(sizeof(class_rw_t), 1);rw-&gt;ro = ro;rw-&gt;flags = RW_REALIZED|RW_REALIZING;cls-&gt;setData(rw); ä¸»è¦çš„æ­¥éª¤ï¼š ä» class_data_bits_t è°ƒç”¨ data æ–¹æ³•ï¼Œå°†ç»“æœä» class_rw_t å¼ºåˆ¶è½¬æ¢ä¸º class_ro_t æŒ‡é’ˆ åˆå§‹åŒ–ä¸€ä¸ª class_rw_t ç»“æ„ä½“ è®¾ç½®ç»“æ„ä½“ ro çš„å€¼ä»¥åŠ flag æœ€åè®¾ç½®æ­£ç¡®çš„ dataã€‚ ä»è¿™é‡Œå¯ä»¥getåˆ°ï¼š realizeClass æ–¹æ³•æ‰§è¡Œå‰ realizeClass æ–¹æ³•æ‰§è¡Œå å®é™…ä¸Šï¼š åœ¨ç¼–è¯‘æœŸé—´ç±»çš„ç»“æ„ä¸­çš„ class_data_bits_t *data æŒ‡å‘çš„æ˜¯ä¸€ä¸ª class_ro_t * æŒ‡é’ˆ åœ¨åŠ è½½è¿è¡Œæ—¶ä»£ç è¿è¡ŒrealizeClass ä¹‹åï¼Œclass_data_bits_t *data æ‰æŒ‡å‘ class_rw_t æŒ‡é’ˆã€‚ ä½†æ­¤æ—¶æ–¹æ³•ï¼Œå±æ€§ä»¥åŠåè®®åˆ—è¡¨å‡ä¸ºç©ºã€‚è¿™æ—¶éœ€è¦ realizeClass è°ƒç”¨ methodizeClass æ–¹æ³•æ¥å°†ç±»è‡ªå·±å®ç°çš„æ–¹æ³•ï¼ˆåŒ…æ‹¬åˆ†ç±»ï¼‰ã€å±æ€§å’Œéµå¾ªçš„åè®®åŠ è½½åˆ° methodsã€ properties å’Œ protocols åˆ—è¡¨ä¸­ å¤‡æ³¨ï¼š realizeClassä¸»è¦ä½œç”¨æ˜¯å¯¹ç±»è¿›è¡Œç¬¬ä¸€æ¬¡åˆå§‹åŒ–åŒ…æ‹¬ åˆ†é…å¯è¯»å†™æ•°æ®ç©ºé—´ï¼ˆclass_rw_tï¼‰ è¿”å›çœŸæ­£çš„ç±»ç»“æ„ï¼ˆClassï¼‰ 1static Class realizeClass(Class cls) ç›¸å…³æºç  TODO:è¡¥å……ç›¸å…³ä»£ç è§£ææ³¨é‡Š æ–¹æ³•ç»“æ„ä½“12345struct method_t &#123; SEL name;//æ–¹æ³•å const char *types;//åœ¨ObjCä¸­å«åšç±»å‹ç¼–ç (Type Encoding) IMP imp;//å®ç°çš„æŒ‡é’ˆ&#125;; å±æ€§ç»“æ„ä½“1234struct property_t &#123; const char *name; const char *attributes;&#125;; åè®®ç»“æ„ä½“1234567891011121314151617struct protocol_t : objc_object &#123; const char *mangledName; struct protocol_list_t *protocols; method_list_t *instanceMethods; method_list_t *classMethods; method_list_t *optionalInstanceMethods; method_list_t *optionalClassMethods; property_list_t *instanceProperties; uint32_t size; // sizeof(protocol_t) uint32_t flags; // Fields below this point are not always present on disk. const char **_extendedMethodTypes; const char *_demangledName; property_list_t *_classProperties; const char *demangledName();&#125;; â€‹ å‚è€ƒèµ„æ–™ Dravenessçš„github Classes and Metaclasses Tagged Pointer ç±»å‹ç¼–ç  Type Encodings","tags":[{"name":"iOS","slug":"iOS","permalink":"http://alfredzhenyu.github.io/tags/iOS/"},{"name":"Objc","slug":"Objc","permalink":"http://alfredzhenyu.github.io/tags/Objc/"},{"name":"æºç è§£æ","slug":"æºç è§£æ","permalink":"http://alfredzhenyu.github.io/tags/æºç è§£æ/"}]},{"title":"Objcçš„Runtimeæºç è§£è¯»ï¼ˆä¸€ï¼‰ä¹‹isaæŒ‡é’ˆ","date":"2017-01-09T02:22:43.000Z","path":"2017/01/09/Objcçš„Runtimeæºç è§£è¯»ï¼ˆä¸€ï¼‰ä¹‹isaæŒ‡é’ˆ/","text":"ç›®å½•ï¼š isaæŒ‡é’ˆ objc_objectå’Œobjc_classç»“æ„ä½“ isaæŒ‡é’ˆçš„ä½œç”¨ isa_tç»“æ„ä½“ objc_objectå’Œobjc_classç»“æ„ä½“ ObjCéƒ½æ˜¯Cè¯­è¨€ç»“æ„ä½“ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½åŒ…å«ä¸€ä¸ªç±»å‹ä¸ºisa_tçš„isaæŒ‡é’ˆ 123struct objc_object &#123; isa_t isa;&#125;; æ‰€æœ‰ç»§æ‰¿è‡ªNSObjectçš„ç±»çš„å®ä¾‹åŒ–åçš„å¯¹è±¡éƒ½ä¼šåŒ…å«ä¸€ä¸ªç±»å‹ä¸ºisa_tçš„ç»“æ„ä½“â€‹ åœ¨ObjCçš„Classå®šä¹‰ä¸ºä¸€ä¸ªåä¸ºobjc_class çš„ç»“æ„ä½“ï¼š 123456struct objc_class : objc_object &#123; isa_t isa; Class superclass; cache_t cache; class_data_bits_t bits;&#125;; å¯ä»¥çœ‹å‡ºobjc_class ç»“æ„ä½“æ˜¯ç»§æ‰¿è‡ª objc_object çš„ï¼Œæ‰€æœ‰çš„ç±»ä¹Ÿæœ‰ä¸€ä¸ªisaï¼Œæ‰€ä»¥Objcä¸­çš„ç±»æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ isaæŒ‡é’ˆçš„ä½œç”¨é¦–å…ˆå¯¹è±¡çš„æ–¹æ³•ï¼ˆå®ä¾‹æ–¹æ³•ã€ç±»æ–¹æ³•ï¼‰æ˜¯ä¸å­˜å‚¨åœ¨å¯¹è±¡çš„ç»“æ„ä½“ä¸­çš„ï¼Œä¸ç„¶åˆ›å»ºåŒä¸€ä¸ªç±»çš„ä¸åŒå¯¹è±¡ä¼šé€ æˆå†…å­˜çš„å†—ä½™ï¼Œæ‰€ä»¥ï¼š å½“å®ä¾‹æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šé€šè¿‡å¯¹è±¡çš„isaæ¥æŸ¥æ‰¾å¯¹åº”çš„ç±»ï¼Œç„¶ååœ¨class_data_bits_t ç»“æ„ä½“ä¸­æŸ¥æ‰¾å¯¹åº”æ–¹æ³•çš„å®ç°ï¼ŒåŒæ—¶ä½¿ç”¨ super_class æ¥æŸ¥æ‰¾ç»§æ‰¿çš„ç±»ï¼Œè¿›è€Œæ‰¾åˆ°ç»§æ‰¿çš„æ–¹æ³• å½“ç±»æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šé€šè¿‡ç±»çš„isaæ¥æŸ¥æ‰¾å¯¹åº”çš„å…ƒç±»ï¼Œç„¶ååœ¨å…ƒç±»æŸ¥æ‰¾å¯¹åº”ç±»æ–¹æ³•çš„å®ç°ï¼Œä»¥ä¿è¯é€šè¿‡ç›¸åŒçš„æœºåˆ¶æ¥æŸ¥æ‰¾æ–¹æ³•çš„å®ç° 1//TODO:å…ƒç±»å’Œç±»å…±ç”¨ä¸€å¥—å®ç°ä»£ç ï¼Œæ€æ ·é€šè¿‡ç±»æ–¹æ³•æŸ¥æ‰¾ç±»æ–¹æ³•çš„ ä¸Šå›¾æ˜¯å„ä¸ªå¯¹è±¡çš„isaçš„æŒ‡å‘å›¾ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨64ä½ä»¥åæ‰æœ‰çš„isa_tç±»å‹è¿™ä¸ªç»“æ„ä½“ï¼Œéœ€è¦é€šè¿‡ä¸€å®šçš„å¤„ç†æ‰èƒ½å¾—åˆ°ä»–éœ€è¦æŒ‡å‘çš„å¯¹è±¡ï¼Œè€Œåœ¨64ä½ä»¥å‰æ˜¯isaç±»å‹ï¼Œå•çº¯çš„æŒ‡å‘å®ƒéœ€è¦çš„å¯¹è±¡ï¼Œä¸‹é¢ä¼šè®²åˆ°ã€‚ â€‹ isa_tç»“æ„ä½“ æºç å®šä¹‰ï¼š x86_64: 12345678910111213141516171819202122232425#define ISA_MASK 0x00007ffffffffff8ULL#define ISA_MAGIC_MASK 0x001f800000000001ULL#define ISA_MAGIC_VALUE 0x001d800000000001ULL#define RC_ONE (1ULL&lt;&lt;56)#define RC_HALF (1ULL&lt;&lt;7)union isa_t &#123; isa_t() &#123; &#125; isa_t(uintptr_t value) : bits(value) &#123; &#125; Class cls; uintptr_t bits; struct &#123; uintptr_t indexed : 1; uintptr_t has_assoc : 1; uintptr_t has_cxx_dtor : 1; uintptr_t shiftcls : 44; uintptr_t magic : 6; uintptr_t weakly_referenced : 1; uintptr_t deallocating : 1; uintptr_t has_sidetable_rc : 1; uintptr_t extra_rc : 8; &#125;;&#125;; arm64: 123456789101112131415161718192021222324#define ISA_MASK 0x0000000ffffffff8ULL#define ISA_MAGIC_MASK 0x000003f000000001ULL#define ISA_MAGIC_VALUE 0x000001a000000001ULL#define RC_ONE (1ULL&lt;&lt;45)#define RC_HALF (1ULL&lt;&lt;18)union isa_t &#123; isa_t() &#123; &#125; isa_t(uintptr_t value) : bits(value) &#123; &#125; Class cls; uintptr_t bits; struct &#123; uintptr_t indexed : 1; uintptr_t has_assoc : 1; uintptr_t has_cxx_dtor : 1; uintptr_t shiftcls : 33; uintptr_t magic : 6; uintptr_t weakly_referenced : 1; uintptr_t deallocating : 1; uintptr_t has_sidetable_rc : 1; uintptr_t extra_rc : 19; &#125;;&#125;; ï¼ˆMacOSï¼Œè™šæ‹Ÿæœºæ˜¯x86_64ï¼Œè€ŒiOSæ˜¯arm64ï¼‰ å¯ä»¥çœ‹å‡ºä¸åŒçš„æ¶æ„ä¸Šï¼Œå­—æ®µæ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ä½æ•°å’Œå®ç°ä¸Šæœ‰äº›å·®åˆ«ï¼Œè¿™é‡Œç»Ÿä¸€ç”¨x86çš„æ¥è®²è§£ isa_t æ˜¯ä¸€ä¸ª union ç±»å‹çš„ç»“æ„ä½“ã€‚å…¶ä¸­çš„ isa_tã€clsã€ bits è¿˜æœ‰ç»“æ„ä½“å…±ç”¨åŒä¸€å—åœ°å€ç©ºé—´ã€‚è€Œå®é™…ä¸Š isa æ€»å…±ä¼šå æ® 64 ä½çš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥ä»bitsçœ‹å‡ºæ¥ ä¸‹é¢æˆ‘ä»¬ä»åˆå§‹åŒ–çš„è¿‡ç¨‹æ¥çœ‹è¿™64ä½æ¯ä¸€ä½çš„æ„ä¹‰ï¼š 1234567891011121314151617inline void objc_object::initInstanceIsa(Class cls, bool hasCxxDtor)&#123; initIsa(cls, true, hasCxxDtor);&#125;inline void objc_object::initIsa(Class cls, bool indexed, bool hasCxxDtor) &#123; if (!indexed) &#123; isa.cls = cls; &#125; else &#123; isa.bits = ISA_MAGIC_VALUE; isa.has_cxx_dtor = hasCxxDtor; isa.shiftcls = (uintptr_t)cls &gt;&gt; 3; &#125;&#125; å¯¹æ•´ä¸ª isa çš„å€¼ bits è¿›è¡Œè®¾ç½®ï¼Œä¼ å…¥ ISA_MAGIC_VALUEï¼š 1#define ISA_MAGIC_VALUE 0x001d800000000001ULL å¯ä»¥çœ‹å‡ºå®é™…ä¸Šè®¾ç½®çš„æ˜¯indexedä»¥åŠmagicè¿™ä¸¤ä¸ªå­—æ®µ indexedè¡¨ç¤ºisa_tç±»å‹ï¼š 0åœ¨è¿ç§»åˆ°64ä½ä¹‹å‰çš„æ—¶å€™ä½¿ç”¨ï¼Œè¿™æ—¶å€™çš„isaæ˜¯æ²¡æœ‰structéƒ¨åˆ†ï¼Œé€šè¿‡object-&gt;isaå¾—åˆ°çš„æ˜¯clsçš„æŒ‡é’ˆï¼ˆé‚£æ—¶ä¸æ˜¯isa_tç±»å‹ï¼Œè€Œæ˜¯isaç±»å‹ï¼‰ 1åœ¨è¿ç§»åˆ°64ä½ä¹‹åçš„æ—¶å€™ä½¿ç”¨ï¼Œè¿™æ—¶å€™çš„isaå¢åŠ äº†structéƒ¨åˆ†ï¼Œé€šè¿‡object-&gt;isaå¾—åˆ°çš„æ˜¯64ä½çš„bitså€¼ï¼ˆéœ€è¦ç”¨shiftclsä½çš„åç§»æ¥è·å–clsçš„æŒ‡é’ˆï¼‰ magicçš„å€¼ä¸º0x3bç”¨äºè°ƒè¯•å™¨åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯çœŸçš„å¯¹è±¡è¿˜æ˜¯æ²¡åˆå§‹åŒ–çš„ç©ºé—´ TODO: magicå€¼å…·ä½“æ€ä¹ˆåˆ¤æ–­å½“å‰å¯¹è±¡çš„ has_cxx_dtorå®é™…ä¸Šä¹Ÿæ˜¯64ä½ä¸­çš„1ä½ï¼Œè¡¨ç¤ºå½“å‰å¯¹è±¡æ—¶å€™æœ‰C++ã€ObjCçš„ææ„å™¨ shiftclså°±æ˜¯ç±»æŒ‡é’ˆï¼Œå› ä¸ºç±»æŒ‡é’ˆè§„å®šè¦æŒ‰ç…§å­—èŠ‚ï¼ˆ8bitï¼‰å¯¹é½å†…å­˜ï¼Œæ‰€ä»¥åä¸‰ä½bitä¸º000ï¼ˆå¯ä»¥è¾“å‡º[NSObject class]æŒ‡é’ˆçœ‹ä¸‹ï¼‰ï¼Œè¿™é‡Œä¸ºäº†å‡å°å†…å­˜æ¶ˆè€—ï¼Œç‰¹æ„å³ç§»3ä½å†™è¿›shiftclså†…ï¼Œè¿™ä¸ªå­—æ®µå°±ç›¸å½“äº64ä½ä»¥å‰çš„isaç±»å‹æŒ‡é’ˆï¼Œéµå¾ªä¸Šé¢çš„æŒ‡å‘å›¾ ã€åŒæ—¶å¯ä»¥æ‰“å°å¯¹è±¡æŒ‡é’ˆï¼Œå¯ä»¥å‘ç°å¯¹è±¡å†…å­˜åœ°å€çš„åå››ä½éƒ½æ˜¯0ï¼Œè¯´æ˜ObjCåœ¨åˆå§‹åŒ–å†…å­˜æ—¶æ˜¯ä»¥16å­—èŠ‚å¯¹é½çš„ï¼Œåˆ†é…çš„å†…å­˜åœ°å€åå››ä½éƒ½æ˜¯0ã€‘ æ³¨æ„ï¼š ç”±äºæ”¹ç‰ˆè‡³64ä½ï¼Œä¸å¯ä»¥é€šè¿‡object-&gt;isaç›´æ¥è·å–clsæŒ‡é’ˆï¼Œæ‰€ä»¥æ–°å¢äº†ISA()æ–¹æ³•æ¥è·å– 123456#define ISA_MASK 0x00007ffffffffff8ULLinline Class objc_object::ISA() &#123; return (Class)(isa.bits &amp; ISA_MASK);&#125; â€‹ å…¶ä»–bits åœ¨ isa_t ä¸­ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€äº›æ²¡æœ‰ä»‹ç»çš„å…¶å®ƒ bitsï¼Œåœ¨è¿™ä¸ªå°ç»“å°±ç®€å•ä»‹ç»ä¸‹è¿™äº› bits çš„ä½œç”¨ has_assocå¯¹è±¡å«æœ‰æˆ–è€…æ›¾ç»å«æœ‰å…³è”å¼•ç”¨ï¼Œæ²¡æœ‰å…³è”å¼•ç”¨çš„å¯ä»¥æ›´å¿«åœ°é‡Šæ”¾å†…å­˜ weakly_referencedå¯¹è±¡è¢«æŒ‡å‘æˆ–è€…æ›¾ç»æŒ‡å‘ä¸€ä¸ª ARC çš„å¼±å˜é‡ï¼Œæ²¡æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡å¯ä»¥æ›´å¿«é‡Šæ”¾ deallocatingå¯¹è±¡æ­£åœ¨é‡Šæ”¾å†…å­˜ has_sidetable_rcå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¤ªå¤§äº†ï¼Œå­˜ä¸ä¸‹ extra_rcå¯¹è±¡çš„å¼•ç”¨è®¡æ•°è¶…è¿‡ 1ï¼Œä¼šå­˜åœ¨è¿™ä¸ªè¿™ä¸ªé‡Œé¢ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°ä¸º 10ï¼Œextra_rc çš„å€¼å°±ä¸º 9 å‚è€ƒèµ„æ–™ Dravenessçš„github Objective-C Runtime Programming Guide What is a meta-class in Objective-C? objc_explain_Classes_and_metaclasses Storing things in isa Why do we need C Unions? objc_explain_Non-pointer_isa Tagged Pointer ARM64 and You 64ä½ä¸Tagged Pointer â€‹","tags":[{"name":"iOS","slug":"iOS","permalink":"http://alfredzhenyu.github.io/tags/iOS/"},{"name":"Objc","slug":"Objc","permalink":"http://alfredzhenyu.github.io/tags/Objc/"},{"name":"æºç è§£æ","slug":"æºç è§£æ","permalink":"http://alfredzhenyu.github.io/tags/æºç è§£æ/"}]},{"title":"ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆäº”ï¼‰","date":"2017-01-04T02:07:00.000Z","path":"2017/01/04/ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆäº”ï¼‰/","text":"ç›®å½•ï¼š ç¬¬ä¸‰éƒ¨åˆ† HTTP ç¬¬åäºŒç«  HTTP 2.x ç¬¬åä¸‰ç«  ä¼˜åŒ–åº”ç”¨çš„äº¤ä»˜ ç¬¬ä¸‰éƒ¨åˆ† HTTPç¬¬åäºŒç«  HTTP 2.xäºŒè¿›åˆ¶åˆ†å¸§å±‚äºŒè¿›åˆ¶åˆ†å±‚æŒ‡çš„æ˜¯ä½äºå¥—æ¥å­—æ¥å£ä¸åº”ç”¨å¯è§çš„é«˜å±‚HTTP APIä¹‹é—´çš„ä¸€ä¸ªæ–°æœºåˆ¶ï¼šHTTP 1.xæ˜¯ä»¥æ¢è¡Œç¬¦ä½œä¸ºçº¯æ–‡æœ¬çš„åˆ†éš”ç¬¦ï¼Œè€ŒHTTP2.0åˆ™å°†æ‰€æœ‰ä¼ è¾“çš„ä¿¡æ¯åˆ†å‰²ä¸ºæ›´å°çš„æ¶ˆæ¯å’Œå¸§ï¼Œå¹¶å¯¹å®ƒä»¬é‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼çš„ç¼–ç ã€‚ æµã€æ¶ˆæ¯ã€å¸§ä¸ºäº†ç†è§£äºŒè¿›åˆ¶åˆ†å±‚å¼•å…¥ä¸€ä¸‹å‡ ä¸ªæ–°æ¦‚å¿µï¼š æµï¼šå·²å»ºç«‹çš„è¿æ¥ä¸Šçš„åŒå‘å­—èŠ‚æµã€‚ æ¶ˆæ¯ï¼šä¸é€»è¾‘æ¶ˆæ¯å¯¹åº”çš„å®Œæ•´çš„ä¸€ç³»åˆ—æ•°æ®å¸§ã€‚ å¸§ï¼šHTTP 2.0 é€šä¿¡çš„æœ€å°å•ä½ï¼Œæ¯ä¸ªå¸§åŒ…å«å¸§é¦–éƒ¨ï¼Œè‡³å°‘ä¹Ÿä¼šæ ‡è¯†å‡ºå½“å‰å¸§æ‰€å±çš„æµã€‚ æ‰€æœ‰ HTTP 2.0 é€šä¿¡éƒ½åœ¨ä¸€ä¸ªTCPè¿æ¥ä¸Šå®Œæˆï¼Œè¿™ä¸ªè¿æ¥å¯ä»¥æ‰¿è½½ä»»æ„æ•°é‡çš„åŒå‘æ•°æ®æµã€‚ç›¸åº”åœ°ï¼Œæ¯ä¸ªæ•°æ®æµï¼ˆè¯·æ±‚ã€å“åº”ï¼‰ä»¥æ¶ˆæ¯çš„å½¢å¼å‘é€ï¼Œè€Œæ¶ˆæ¯ç”±ä¸€æˆ–å¤šä¸ªå¸§ç»„æˆï¼Œè¿™äº›å¸§å¯ä»¥ä¹±åºå‘é€ï¼Œç„¶åå†æ ¹æ®æ¯ä¸ªå¸§é¦–éƒ¨çš„æµæ ‡è¯†ç¬¦é‡æ–°ç»„è£…ã€‚è¿™æ ·ï¼ŒHTTP 2.0 æŠŠ HTTP åè®®é€šä¿¡çš„åŸºæœ¬å•ä½ç¼©å°ä¸ºä¸€ä¸ªä¸€ä¸ªçš„å¸§ï¼Œè¿™äº›å¸§å¯¹åº”ç€é€»è¾‘æµä¸­çš„æ¶ˆæ¯ã€‚ç›¸åº”åœ°ï¼Œå¾ˆå¤šæµå¯ä»¥å¹¶è¡Œåœ°åœ¨åŒä¸€ä¸ª TCP è¿æ¥ä¸Šäº¤æ¢æ¶ˆæ¯ã€‚ ä¸¾ä¸ªä¾‹å­ï¼šå›¾ 12-3 ä¸­åŒ…å«äº†åŒä¸€ä¸ªè¿æ¥ä¸Šå¤šä¸ªä¼ è¾“ä¸­çš„æ•°æ®æµ:å®¢æˆ·ç«¯æ­£åœ¨å‘æœåŠ¡å™¨ä¼ è¾“ä¸€ä¸ª DATA å¸§(stream 5)ï¼Œä¸æ­¤åŒæ—¶ï¼ŒæœåŠ¡å™¨æ­£å‘å®¢æˆ·ç«¯ä¹±åºå‘é€ stream 1 å’Œ stream 3 çš„ä¸€ç³»åˆ—å¸§ã€‚æ­¤æ—¶ï¼Œä¸€ä¸ªè¿æ¥ä¸Šæœ‰ 3 ä¸ªè¯·æ±‚ / å“åº”å¹¶è¡Œäº¤æ¢! è¿™æ ·åšçš„ä¼˜åŠ¿ï¼š å¯ä»¥å¹¶è¡Œäº¤é”™åœ°å‘é€è¯·æ±‚ï¼Œè¯·æ±‚ä¹‹é—´äº’ä¸å½±å“; å¯ä»¥å¹¶è¡Œäº¤é”™åœ°å‘é€å“åº”ï¼Œå“åº”ä¹‹é—´äº’ä¸å¹²æ‰°; åªä½¿ç”¨ä¸€ä¸ªè¿æ¥å³å¯å¹¶è¡Œå‘é€å¤šä¸ªè¯·æ±‚å’Œå“åº”; æ¶ˆé™¤ä¸å¿…è¦çš„å»¶è¿Ÿï¼Œä»è€Œå‡å°‘é¡µé¢åŠ è½½çš„æ—¶é—´; ä¸å¿…å†ä¸ºç»•è¿‡ HTTP 1.x é™åˆ¶è€Œå¤šåšå¾ˆå¤šå·¥ä½œ; è¯·æ±‚ä¼˜å…ˆçº§æŠŠ HTTP æ¶ˆæ¯åˆ†è§£ä¸ºå¾ˆå¤šç‹¬ç«‹çš„å¸§çš„å¦å¤–ä¸€ä¸ªä¼˜åŠ¿ï¼šå¯ä»¥é€šè¿‡ä¼˜åŒ–è¿™äº›å¸§çš„äº¤é”™å’Œä¼ è¾“é¡ºåºï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚HTTP2.0é€šè¿‡å¾€æ¯ä¸ªæµä¸­åŠ å…¥ä¸€ä¸ª31bitçš„ä¼˜å…ˆçº§å­—æ®µ 0 è¡¨ç¤ºæœ€é«˜ä¼˜å…ˆçº§ 231-1 è¡¨ç¤ºæœ€ä½ä¼˜å…ˆçº§ è¿™æ ·ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å°±å¯ä»¥åœ¨å¤„ç†ä¸åŒçš„æµæ—¶é‡‡å–ä¸åŒçš„ç­–ç•¥ï¼Œä»¥æœ€ä¼˜çš„æ–¹å¼å‘é€æµã€æ¶ˆæ¯å’Œå¸§ã€‚å…·ä½“æ¥è®²ï¼ŒæœåŠ¡å™¨å¯ä»¥æ ¹æ®æµçš„ä¼˜å…ˆçº§ï¼Œæ§åˆ¶èµ„æºåˆ†é…(CPUã€å†…å­˜ã€å¸¦å®½)ï¼Œè€Œåœ¨å“åº”æ•°æ®å‡†å¤‡å¥½ä¹‹åï¼Œä¼˜å…ˆå°†æœ€é«˜ä¼˜å…ˆçº§çš„å¸§å‘é€ç»™å®¢æˆ·ç«¯ã€‚ æ¯ä¸ªæ¥æºä¸€ä¸ªè¿æ¥æ–°çš„åˆ†å¸§æœºåˆ¶å¸¦æ¥çš„å¦ä¸€ä¸ªå¥½å¤„å°±æ˜¯ä¸ç”¨ä¾èµ–äºå¤šä¸ªTCPè¿æ¥æˆ–è€…å¤šåŸŸåæ¥å®ç°å¹¶è¡Œæœºåˆ¶ï¼Œæ­¤æ—¶æ‰€æœ‰çš„HTTP2.0è¿æ¥éƒ½æ˜¯æŒä¹…åŒ–çš„ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´åªéœ€è¦ä¸€ä¸ªè¿æ¥å³å¯ æµé‡æ§åˆ¶HTTP2.0ä¸ºæ•°æ®æµå’Œè¿æ¥æä¾›ä¸€ä¸ªç®€å•çš„æµé‡æ§åˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶å®é™…ä¸Šå’ŒTCPçš„æµé‡æ§åˆ¶æ˜¯ä¸€æ ·çš„ã€‚ç„¶è€Œï¼Œç”±äº TCP æµé‡æ§åˆ¶ä¸èƒ½å¯¹åŒä¸€æ¡ HTTP 2.0 è¿æ¥å†…çš„å¤šä¸ªæµå®æ–½å·®å¼‚åŒ–ç­–ç•¥ï¼Œå› æ­¤å…‰æœ‰TCPçš„æµé‡æ§åˆ¶æ˜¯ä¸å¤Ÿçš„ã€‚è¿™æ­£æ˜¯ HTTP 2.0 æµé‡æ§åˆ¶æœºåˆ¶å‡ºå°çš„åŸå› ã€‚ HTTP 2.0 æ ‡å‡†æ²¡æœ‰è§„å®šä»»ä½•ç‰¹å®šçš„ç®—æ³•ã€å€¼ï¼Œæˆ–è€…ä»€ä¹ˆæ—¶å€™å‘é€ WINDOW_UPDATE å¸§ã€‚ å› æ­¤ï¼Œå®ç°å¯ä»¥é€‰æ‹©è‡ªå·±çš„ç®—æ³•ä»¥åŒ¹é…è‡ªå·±çš„åº”ç”¨åœºæ™¯ï¼Œä»è€Œæ±‚å¾—æœ€ä½³æ€§èƒ½ã€‚ TODOï¼šè¿›ä¸€æ­¥äº†è§£HTTP2.0å¦‚ä½•å®ç°æµé‡æ§åˆ¶çš„ æœåŠ¡å™¨æ¨é€HTTP 2.0 æ–°å¢çš„ä¸€ä¸ªå¼ºå¤§çš„æ–°åŠŸèƒ½ï¼Œå°±æ˜¯æœåŠ¡å™¨å¯ä»¥å¯¹ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚å‘é€å¤šä¸ªå“åº”ã€‚æ¢å¥è¯è¯´ï¼Œé™¤äº†å¯¹æœ€åˆè¯·æ±‚çš„å“åº”å¤–ï¼ŒæœåŠ¡å™¨è¿˜å¯ä»¥é¢å¤–å‘å®¢æˆ·ç«¯æ¨é€èµ„æºï¼Œè€Œæ— éœ€å®¢æˆ·ç«¯æ˜ç¡®åœ°è¯·æ±‚ã€‚å»ºç«‹ HTTP 2.0 è¿æ¥åï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨äº¤æ¢ SETTINGS å¸§ï¼Œå€Ÿæ­¤å¯ä»¥é™å®šåŒå‘å¹¶å‘çš„æµçš„æœ€å¤§æ•°é‡ã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯å¯ä»¥é™å®šæ¨é€æµçš„æ•°é‡ï¼Œæˆ–è€…é€šè¿‡æŠŠè¿™ä¸ªå€¼è®¾ç½®ä¸º 0 è€Œå®Œå…¨ç¦ç”¨æœåŠ¡å™¨æ¨é€ã€‚ é¦–éƒ¨å‹ç¼©åœ¨HTTP1.xä¸­ç”±äºå…ƒæ•°æ®éƒ½æ˜¯ä»¥çº¯æ–‡æœ¬æ–¹å¼ï¼Œé€šå¸¸ä¼šç»™æ¯ä¸ªè¯·æ±‚å¢åŠ 500~800å­—èŠ‚çš„è´Ÿè·ï¼Œä¸ºæé«˜æ€§èƒ½ï¼ŒHTTP 2.0ä¼šå‹ç¼©é¦–éƒ¨å…ƒæ•°æ®ï¼šå‹ç¼©é‡‡ç”¨çš„æ˜¯é¦–éƒ¨çš„å·®å¼‚åŒ–ç¼–ç çš„æ–¹å¼å®ç°çš„ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…±åŒç»´æŠ¤ä¸€å¼ â€œé¦–éƒ¨è¡¨â€æ¥è·Ÿè¸ªå’Œå­˜å‚¨ä¹‹å‰çš„é”®-å€¼å¯¹ï¼Œåœ¨åŒä¸€è¿æ¥ä¸­å§‹ç»ˆå­˜åœ¨ï¼Œæœ‰å®¢æˆ·ç«¯ã€æœåŠ¡å™¨å…±åŒæ¸è¿›åœ°æ›´æ–°ï¼Œæ¯ä¸ªæ–°çš„é¦–éƒ¨é”®-å€¼è¦ä¹ˆè¿½åŠ åˆ°å½“å‰è¡¨çš„æœ«å°¾ã€è¦ä¹ˆæ›¿æ¢å½“å‰çš„å€¼ã€‚è€Œå¯¹äºç›¸åŒçš„æ•°æ®ï¼Œä¸å†åœ¨æ¯æ¬¡è¯·æ±‚å’Œå“åº”ä¸­å‘é€ï¼Œä¸¾ä¸ªä¾‹å­ï¼šç¬¬äºŒä¸ªè¯·æ±‚åªéœ€è¦å‘é€å˜åŒ–äº†çš„è·¯å¾„é¦–éƒ¨(:path)ï¼Œå…¶ä»–é¦–éƒ¨æ²¡æœ‰å˜åŒ–ï¼Œä¸ç”¨å†å‘é€ã€‚è¿™æ ·å°±å¯ä»¥é¿å…ä¼ è¾“å†—ä½™çš„é¦–éƒ¨ï¼Œä»è€Œæ˜¾è‘—å‡å°‘æ¯ä¸ªè¯·æ±‚çš„å¼€é”€ã€‚ HTTP2.0å‡çº§å‡çº§HTTP 2.0éœ€è¦ä½¿ç”¨åˆ°HTTPçš„Upgradeæœºåˆ¶ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š å‘èµ·å¸¦æœ‰ HTTP 2.0 Upgrade é¦–éƒ¨çš„ HTTP 1.1 è¯·æ±‚ å¦‚æœæœåŠ¡å™¨ä¸æ”¯æŒ HTTP 2.0ï¼Œå°±ç«‹å³è¿”å› HTTP 1.1 å“åº”/æœåŠ¡å™¨å°±ä¼šä»¥ HTTP 1.1 æ ¼å¼è¿”å› 101 Switching Protocols å“åº”ï¼Œç„¶åç«‹å³åˆ‡æ¢åˆ° HTTP 2.0 å¹¶ä½¿ç”¨æ–°çš„äºŒè¿›åˆ¶åˆ†å¸§åè®®è¿”å›å“åº” åˆ†å¸§é¦–éƒ¨ 16 ä½çš„é•¿åº¦å‰ç¼€æ„å‘³ç€ä¸€å¸§å¤§çº¦å¯ä»¥æºå¸¦ 64 KB æ•°æ®ï¼Œä¸åŒ…æ‹¬ 8 å­—èŠ‚é¦–éƒ¨ã€‚ 8 ä½çš„å¸§ç±»å‹å­—æ®µå†³å®šå¦‚ä½•è§£é‡Šå¸§å…¶ä½™éƒ¨åˆ†çš„å†…å®¹ã€‚ 8 ä½çš„æ ‡å¿—å­—æ®µå…è®¸ä¸åŒçš„å¸§ç±»å‹å®šä¹‰ç‰¹å®šäºå¸§çš„æ¶ˆæ¯æ ‡å¿—ã€‚ 1 ä½çš„ä¿ç•™å­—æ®µå§‹ç»ˆç½®ä¸º 0ã€‚ 31 ä½çš„æµæ ‡è¯†ç¬¦å”¯ä¸€æ ‡è¯† HTTP 2.0 çš„æµã€‚ å¸§ç±»å‹å­—æ®µï¼š DATA:ç”¨äºä¼ è¾“ HTTP æ¶ˆæ¯ä½“ã€‚ HEADERS:ç”¨äºä¼ è¾“å…³äºæµçš„é¢å¤–çš„é¦–éƒ¨å­—æ®µã€‚ PRIORITY:ç”¨äºæŒ‡å®šæˆ–é‡æ–°æŒ‡å®šå¼•ç”¨èµ„æºçš„ä¼˜å…ˆçº§ã€‚ RST_STREAM:ç”¨äºé€šçŸ¥æµçš„éæ­£å¸¸ç»ˆæ­¢ã€‚ SETTINGS:ç”¨äºé€šçŸ¥ä¸¤ç«¯é€šä¿¡æ–¹å¼çš„é…ç½®æ•°æ®ã€‚ PUSH_PROMISE:ç”¨äºå‘å‡ºåˆ›å»ºæµå’ŒæœåŠ¡å™¨å¼•ç”¨èµ„æºçš„è¦çº¦ã€‚ PING:ç”¨äºè®¡ç®—å¾€è¿”æ—¶é—´ï¼Œæ‰§è¡Œâ€œæ´»æ€§â€æ£€æŸ¥ã€‚ GOAWAY:ç”¨äºé€šçŸ¥å¯¹ç«¯åœæ­¢åœ¨å½“å‰è¿æ¥ä¸­åˆ›å»ºæµã€‚ WINDOW_UPDATE:ç”¨äºé’ˆå¯¹ä¸ªåˆ«æµæˆ–ä¸ªåˆ«è¿æ¥å®ç°æµé‡æ§åˆ¶ã€‚ CONTINUATION:ç”¨äºç»§ç»­ä¸€ç³»åˆ—é¦–éƒ¨å—ç‰‡æ®µã€‚ å‘èµ·æ–°æµHTTP 2.0 åè®®è§„å®šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½å¯ä»¥å‘èµ·æ–°æµï¼šå®¢æˆ·ç«¯æ–°æµï¼šå®¢æˆ·ç«¯é€šè¿‡å‘é€ç±»å‹ä¸ºHEADERSçš„å¸§å‘èµ·æ–°æµï¼Œæ–°æµåŒ…å«å¸¦æœ‰æ–°æµIDï¼Œå¯é€‰çš„31ä½ä¼˜å…ˆå€¼ä»¥åŠHTTPé”®-å€¼å¯¹é¦–éƒ¨æœåŠ¡ç«¯æ–°æµï¼šæœåŠ¡ç«¯é€šè¿‡å‘é€ç±»å‹ä¸ºPUSH_PROMISEå¸§æ¥å‘èµ·æ¨é€æµï¼Œè¿™ä¸ªå¸§ä¸HEADERSç­‰æ•ˆï¼Œä½†å®ƒæ²¡æœ‰ä¼˜å…ˆå€¼ç”±äºä¸¤ç«¯éƒ½å¯ä»¥å‘èµ·æ–°æµï¼Œæµè®¡æ•°å™¨éœ€è¦ä¸€å®šè§„åˆ™:å®¢æˆ·ç«¯å‘èµ·çš„æµå…·æœ‰å¶æ•°IDï¼ŒæœåŠ¡å™¨å‘èµ·çš„æµå…·æœ‰å¥‡æ•°IDã€‚è¿™æ ·ï¼Œä¸¤ç«¯çš„æµIDä¸ä¼šå†²çªï¼Œè€Œä¸”å„è‡ªæŒæœ‰ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ï¼Œæ¯æ¬¡å‘èµ·æ–°æµæ—¶é€’å¢IDå³å¯ã€‚ å‘èµ·åº”ç”¨æ•°æ®åˆ›å»ºæ–°æµå¹¶å‘é€HTTPé¦–éƒ¨ä¹‹åï¼Œä¹‹ååˆ©ç”¨DATAå¸§å‘é€åº”ç”¨æ•°æ®ï¼Œä¸€å—åº”ç”¨æ•°æ®å¯ä»¥åˆ†ä¸ºå¤šä¸ªDATAå¸§ï¼Œæœ€åä¸€å¸§è¦ç¿»è½¬å¸§é¦–éƒ¨çš„END_STREAMå­—æ®µï¼ˆHTTP2.0æ ‡å‡†è¦æ±‚å•å¸§æ•°æ®ä¸èƒ½è¶…è¿‡2^14-1(16383)å­—èŠ‚ï¼‰ ç¬¬åä¸‰ç«  ä¼˜åŒ–åº”ç”¨çš„äº¤ä»˜ å‡å°‘DNSæŸ¥æ‰¾ é‡ç”¨TCPè¿æ¥ å‡å°‘HTTPé‡å®šå‘ ä½¿ç”¨CDN å»æ‰ä¸å¿…è¦çš„è¯·æ±‚ å®¢æˆ·ç«¯ç¼“å­˜èµ„æº ä¼ è¾“å‹ç¼©è¿‡çš„å†…å®¹ å‡å°‘ä¸å¿…è¦çš„è¯·æ±‚å¼€é”€ å¹¶è¡Œå¤„ç†è¯·æ±‚å’Œå“åº” å®¢æˆ·ç«¯ç¼“å­˜èµ„æºHTTPä¼ è¾“ä¸‹å¯ä»¥ä½¿ç”¨é¦–éƒ¨å­—æ®µæ¥å®ç°ç¼“å­˜ï¼š Cache-Control é¦–éƒ¨ç”¨äºæŒ‡å®šç¼“å­˜æ—¶é—´ï¼› Last-Modified å’Œ ETag é¦–éƒ¨æä¾›éªŒè¯æœºåˆ¶ æ³¨æ„ä¸¤è€…ç¼ºä¸€ä¸å¯ï¼šå¦‚æœæ²¡æœ‰æŒ‡å®šéªŒè¯ï¼šå¯¼è‡´æ¯æ¬¡éƒ½åœ¨æ²¡æœ‰æ›´æ–°çš„æƒ…å†µä¸‹é‡å‘ç›¸åŒå†…å®¹å¦‚æœæ²¡æœ‰æŒ‡å®šç¼“å­˜æ—¶é—´ï¼šå¯¼è‡´æ¯æ¬¡ä½¿ç”¨èµ„æºæ—¶éƒ½å¤šä½™åœ°æ‰§è¡ŒéªŒè¯æ£€æŸ¥","tags":[{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://alfredzhenyu.github.io/tags/ç½‘ç»œ/"},{"name":"HTTP","slug":"HTTP","permalink":"http://alfredzhenyu.github.io/tags/HTTP/"}]},{"title":"ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆå››ï¼‰","date":"2016-12-26T03:59:41.000Z","path":"2016/12/26/ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆå››ï¼‰/","text":"ç›®å½•ï¼š ç¬¬ä¸‰éƒ¨åˆ† HTTP ç¬¬ä¹ç«  HTTPç®€å² ç¬¬åç«  Webæ€§èƒ½è¦ç‚¹ ç¬¬åä¸€ç«  HTTP 1.x ç¬¬ä¸‰éƒ¨åˆ† HTTPç¬¬ä¹ç«  HTTPç®€å²HTTP 0.9ï¼šåªæœ‰ä¸€è¡Œçš„åè®®+æ‚„ç„¶èµ·æ­¥HTTP 1.0ï¼šå‚è€ƒæ€§RFC+è¿…é€Ÿå‘å±•HTTP 1.1ï¼šæ­£å¼çº³å…¥RFC+æ ‡å‡†åŒ–HTTP 2.0ï¼šæ€§èƒ½æ”¹è¿›+ä¼˜åŒ– ç¬¬åç«  Webæ€§èƒ½è¦ç‚¹æµè§ˆå™¨ä¼˜åŒ–ç­–ç•¥ åŸºäºæ–‡æ¡£çš„ä¼˜åŒ–ï¼šç†Ÿæ‚‰ç½‘ç»œåè®®ï¼Œäº†è§£æ–‡æ¡£ã€CSS å’Œ JavaScript è§£æç®¡é“ï¼Œå‘ç°å’Œä¼˜å…ˆå®‰æ’å…³é”®ç½‘ ç»œèµ„æºï¼Œå°½æ—©åˆ†æ´¾è¯·æ±‚å¹¶å–å¾—é¡µé¢ï¼Œä½¿å…¶å°½å¿«è¾¾åˆ°å¯äº¤äº’çš„çŠ¶æ€ã€‚ä¸»è¦æ–¹æ³•æ˜¯ä¼˜ å…ˆè·å–èµ„æºã€æå‰è§£æç­‰ã€‚ *æ¨æµ‹æ€§ä¼˜åŒ–ï¼šæµè§ˆå™¨å¯ä»¥å­¦ä¹ ç”¨æˆ·çš„å¯¼èˆªæ¨¡å¼ï¼Œæ‰§è¡Œæ¨æµ‹æ€§ä¼˜åŒ–ï¼Œå°è¯•é¢„æµ‹ç”¨æˆ·çš„ä¸‹ä¸€æ¬¡æ“ ä½œã€‚ç„¶åï¼Œé¢„å…ˆè§£æ DNSã€é¢„å…ˆè¿æ¥å¯èƒ½çš„ç›®æ ‡ã€‚ æµè§ˆå™¨é‡‡ç”¨çš„æŠ€æœ¯ï¼š èµ„æºé¢„å–å’Œæ’å®šä¼˜å…ˆæ¬¡åºï¼šæ–‡æ¡£ã€CSS å’Œ JavaScript è§£æå™¨å¯ä»¥ä¸ç½‘ç»œåè®®å±‚æ²Ÿé€šï¼Œå£°æ˜æ¯ç§èµ„æºçš„ä¼˜å…ˆ çº§:åˆå§‹æ¸²æŸ“å¿…éœ€çš„é˜»å¡èµ„æºå…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼Œè€Œä½ä¼˜å…ˆçº§çš„è¯·æ±‚å¯èƒ½ä¼šè¢«ä¸´æ—¶ ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­ã€‚ DNSé¢„è§£æï¼šå¯¹å¯èƒ½çš„åŸŸåè¿›è¡Œæå‰è§£æï¼Œé¿å…å°†æ¥ HTTP è¯·æ±‚æ—¶çš„ DNS å»¶è¿Ÿã€‚é¢„è§£æå¯ä»¥ é€šè¿‡å­¦ä¹ å¯¼èˆªå†å²ã€ç”¨æˆ·çš„é¼ æ ‡æ‚¬åœï¼Œæˆ–å…¶ä»–é¡µé¢ä¿¡å·æ¥è§¦å‘ã€‚ TCPé¢„è¿æ¥ï¼šDNS è§£æä¹‹åï¼Œæµè§ˆå™¨å¯ä»¥æ ¹æ®é¢„æµ‹çš„ HTTP è¯·æ±‚ï¼Œæ¨æµ‹æ€§åœ°æ‰“å¼€ TCP è¿æ¥ã€‚ å¦‚æœçŒœå¯¹çš„è¯ï¼Œåˆ™å¯ä»¥èŠ‚çœä¸€æ¬¡å®Œæ•´çš„å¾€è¿”(TCP æ¡æ‰‹)æ—¶é—´ã€‚ é¡µé¢é¢„æ¸²æŸ“ï¼šæŸäº›æµè§ˆå™¨å¯ä»¥è®©æˆ‘ä»¬æç¤ºä¸‹ä¸€ä¸ªå¯èƒ½çš„ç›®æ ‡ï¼Œä»è€Œåœ¨éšè—çš„æ ‡ç­¾é¡µä¸­é¢„å…ˆæ¸²æŸ“ æ•´ä¸ªé¡µé¢ã€‚è¿™æ ·ï¼Œå½“ç”¨æˆ·çœŸçš„è§¦å‘å¯¼èˆªæ—¶ï¼Œå°±èƒ½ç«‹å³åˆ‡æ¢è¿‡æ¥ã€‚ å…³äºç½‘ç«™å»ºè®¾ä¸­çš„ä¼˜åŒ–å»ºè®®ï¼š å‡å°‘DNSæŸ¥è¯¢ï¼šæ¯æ¬¡åŸŸåè§£æéƒ½éœ€è¦ä¸€æ¬¡ç½‘ç»œå¾€è¿”ï¼Œå¢åŠ è¯·æ±‚çš„å»¶è¿Ÿï¼Œåœ¨æŸ¥è¯¢æœŸé—´ä¼šé˜»å¡è¯·æ±‚ã€‚ *å‡å°‘HTTPè¯·æ±‚ï¼šä»»ä½•è¯·æ±‚éƒ½ä¸å¦‚æ²¡æœ‰è¯·æ±‚æ›´å¿«ï¼Œå› æ­¤è¦å»æ‰é¡µé¢ä¸Šæ²¡æœ‰å¿…è¦çš„èµ„æº ä½¿ç”¨CDNï¼šä»åœ°ç†ä¸ŠæŠŠæ•°æ®æ”¾åˆ°æ¥è¿‘å®¢æˆ·ç«¯çš„åœ°æ–¹ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘æ¯æ¬¡ TCP è¿æ¥çš„ç½‘ç»œå»¶ è¿Ÿï¼Œå¢åŠ ååé‡ã€‚ æ·»åŠ Expiresé¦–éƒ¨å¹¶é…ç½®ETagæ ‡ç­¾ï¼šç›¸å…³èµ„æºåº”è¯¥ç¼“å­˜ï¼Œä»¥é¿å…é‡å¤è¯·æ±‚æ¯ä¸ªé¡µé¢ä¸­ç›¸åŒçš„èµ„æºã€‚Expires é¦–éƒ¨å¯ç”¨ äºæŒ‡å®šç¼“å­˜æ—¶é—´ï¼Œåœ¨è¿™ä¸ªæ—¶é—´å†…å¯ä»¥ç›´æ¥ä»ç¼“å­˜å–å¾—èµ„æºï¼Œå®Œå…¨é¿å… HTTP è¯· æ±‚ã€‚ETag åŠ Last-Modified é¦–éƒ¨æä¾›äº†ä¸€ä¸ªä¸ç¼“å­˜ç›¸å…³çš„æœºåˆ¶ï¼Œç›¸å½“äºæœ€åä¸€æ¬¡ æ›´æ–°çš„æŒ‡çº¹æˆ–æ—¶é—´æˆ³ã€‚ Gzipèµ„æºï¼šæ‰€æœ‰æ–‡æœ¬èµ„æºéƒ½åº”è¯¥ä½¿ç”¨ Gzip å‹ç¼©ï¼Œç„¶åå†åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é—´ä¼ è¾“ã€‚ä¸€èˆ¬æ¥ è¯´ï¼ŒGzip å¯ä»¥å‡å°‘ 60%~80% çš„æ–‡ä»¶å¤§å°ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç›¸å¯¹ç®€å•(åªè¦åœ¨æœåŠ¡å™¨ä¸Š é…ç½®ä¸€ä¸ªé€‰é¡¹)ï¼Œä½†ä¼˜åŒ–æ•ˆæœè¾ƒå¥½çš„ä¸¾æªã€‚ *é¿å…HTTPé‡å®šå‘ï¼šHTTP é‡å®šå‘æå…¶è€—æ—¶ï¼Œç‰¹åˆ«æ˜¯æŠŠå®¢æˆ·ç«¯å®šå‘åˆ°ä¸€ä¸ªå®Œå…¨ä¸åŒçš„åŸŸåçš„æƒ…å†µä¸‹ï¼Œ è¿˜ä¼šå¯¼è‡´é¢å¤–çš„ DNS æŸ¥è¯¢ã€TCP è¿æ¥å»¶è¿Ÿï¼Œç­‰ç­‰ã€‚ ç¬¬åä¸€ç«  HTTP 1.xå¯¹äºHTTP1.0çš„ä¼˜åŒ–ç­–ç•¥ï¼šå‡çº§HTTP1.1 HTTP1.1ç‰¹æ€§ï¼š æŒä¹…åŒ–è¿æ¥ä»¥æ”¯æŒè¿æ¥é‡ç”¨ åˆ†å—ä¼ è¾“ç¼–ç ä»¥æ”¯æŒæµå¼å“åº” è¯·æ±‚ç®¡é“+æ”¯æŒå¹¶è¡Œè¯·æ±‚å¤„ç† å­—èŠ‚æœåŠ¡ä»¥æ”¯æŒåŸºäºèŒƒå›´çš„èµ„æºè¯·æ±‚ æ”¹è¿›çš„ç¼“å­˜æœºåˆ¶ æŒä¹…åŒ–è¿æ¥éæŒä¹…åŒ–è¿æ¥ æŒä¹…åŒ–è¿æ¥ æŒä¹… HTTP å¯ä»¥è®©æˆ‘ä»¬é‡ç”¨å·²æœ‰çš„è¿æ¥æ¥å®Œæˆå¤šæ¬¡åº”ç”¨è¯·æ±‚ï¼Œä½†å¤šæ¬¡è¯·æ±‚å¿…é¡»ä¸¥æ ¼æ»¡è¶³å…ˆè¿›å…ˆå‡º(FIFO)çš„é˜Ÿåˆ—é¡ºåº:å‘é€è¯·æ±‚ï¼Œç­‰å¾…å“åº”å®Œæˆï¼Œå†å‘é€å®¢æˆ·ç«¯é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼ŒHTTPç®¡é“æ˜¯ä¸€ä¸ªå¾ˆå°ä½†å¯¹ä¸Šè¿°å·¥ä½œæµå´éå¸¸é‡è¦çš„ä¸€æ¬¡ä¼˜åŒ–ã€‚ç®¡é“å¯ä»¥è®©æˆ‘ä»¬æŠŠFIFOé˜Ÿåˆ—ä»å®¢æˆ·ç«¯(è¯·æ±‚é˜Ÿåˆ—)è¿ç§»åˆ°æœåŠ¡å™¨(å“åº”é˜Ÿåˆ—)ã€‚ HTTPç®¡é“HTTPç®¡é“ä¼˜åŒ– æœåŠ¡å™¨å¹¶è¡Œå¤„ç†ä¼˜åŒ– HTML å’Œ CSS è¯·æ±‚åŒæ—¶åˆ°è¾¾ï¼Œä½†å…ˆå¤„ç†çš„æ˜¯ HTML è¯·æ±‚; æœåŠ¡å™¨å¹¶è¡Œå¤„ç†ä¸¤ä¸ªè¯·æ±‚ï¼Œå…¶ä¸­å¤„ç† HTML ç”¨æ—¶ 40 msï¼Œå¤„ç† CSS ç”¨æ—¶ 20 ms; CSS è¯·æ±‚å…ˆå¤„ç†å®Œæˆï¼Œä½†è¢«ç¼“å†²èµ·æ¥ä»¥ç­‰å€™å‘é€ HTML å“åº”;* å‘é€å®Œ HTML å“åº”åï¼Œå†å‘é€æœåŠ¡å™¨ç¼“å†²ä¸­çš„ CSS å“åº”ã€‚HTTP 1.xåªèƒ½ä¸¥æ ¼ä¸²è¡Œåœ°è¿”å›å“åº”ã€‚ç‰¹åˆ«æ˜¯ï¼ŒHTTP 1.x ä¸å…è®¸ä¸€ä¸ªè¿æ¥ä¸Šçš„å¤šä¸ªå“åº”æ•°æ®äº¤é”™åˆ°è¾¾(å¤šè·¯å¤ç”¨)ï¼Œå› è€Œä¸€ä¸ªå“åº”å¿…é¡»å®Œå…¨è¿”å›åï¼Œä¸‹ä¸€ä¸ªå“åº”æ‰ä¼šå¼€å§‹ä¼ è¾“ã€‚ è¿™ä¸ªä¼šé€ æˆçš„é—®é¢˜ï¼š ä¸€ä¸ªæ…¢å“åº”å°±ä¼šé˜»å¡æ‰€æœ‰åç»­è¯·æ±‚; å¹¶è¡Œå¤„ç†è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨å¿…é¡»ç¼“å†²ç®¡é“ä¸­çš„å“åº”ï¼Œä»è€Œå ç”¨æœåŠ¡å™¨èµ„æºï¼Œå¦‚æœæœ‰ä¸ªå“åº”éå¸¸å¤§ï¼Œåˆ™å¾ˆå®¹æ˜“å½¢æˆæœåŠ¡å™¨çš„å—æ”»å‡»é¢; å“åº”å¤±è´¥å¯èƒ½ç»ˆæ­¢ TCP è¿æ¥ï¼Œä»é¡µå¼ºè¿«å®¢æˆ·ç«¯é‡æ–°å‘é€å¯¹æ‰€æœ‰åç»­èµ„æºçš„è¯·æ±‚ï¼Œå¯¼è‡´é‡å¤å¤„ç†; ç”±äºå¯èƒ½å­˜åœ¨ä¸­é—´ä»£ç†ï¼Œå› æ­¤æ£€æµ‹ç®¡é“å…¼å®¹æ€§ï¼Œç¡®ä¿å¯é æ€§å¾ˆé‡è¦; å¦‚æœä¸­é—´ä»£ç†ä¸æ”¯æŒç®¡é“ï¼Œé‚£å®ƒå¯èƒ½ä¼šä¸­æ–­è¿æ¥ï¼Œä¹Ÿå¯èƒ½ä¼šæŠŠæ‰€æœ‰è¯·æ±‚ä¸²è”èµ·æ¥ã€‚ æ³¨æ„ï¼šHTTP ç®¡é“æŠ€æœ¯çš„åº”ç”¨éå¸¸æœ‰é™ï¼Œè™½ç„¶å…¶ä¼˜ç‚¹æ¯‹åº¸ç½®ç–‘ã€‚ä»Šå¤©ï¼Œä¸€äº›æ”¯æŒç®¡é“çš„æµè§ˆå™¨ï¼Œé€šå¸¸éƒ½å°†å…¶ä½œä¸ºä¸€ä¸ªé«˜çº§é…ç½®é€‰é¡¹ï¼Œä½†å¤§å¤šæ•°æµè§ˆå™¨éƒ½ä¼šç¦ç”¨å®ƒã€‚ï¼ˆä½†å¦‚æœå¯¹æœåŠ¡å™¨å’Œåˆ»ç”»æ®µæ‹¥æœ‰å®Œå…¨æ§åˆ¶çš„æƒé™ï¼Œè¿˜æ˜¯å»ºè®®å¼€å¯ï¼Œå…¶ä¸­iTuneså°±åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œå®ç°æ€§èƒ½çš„ä¼˜åŒ–ï¼‰ å¤šä¸ªTCPè¿æ¥ç”±äºä¸æ”¯æŒå¤šè·¯å¤ç”¨ï¼Œæµè§ˆå™¨é‡‡ç”¨å…è®¸å¹¶è¡Œå»ºç«‹å¤šä¸ªTCPè¿æ¥çš„æ–¹å¼æ¥è§£å†³ã€‚ç°å®ä¸­ï¼Œå¤§å¤šæ•°ç°ä»£æµè§ˆå™¨ï¼ŒåŒ…æ‹¬æ¡Œé¢å’Œç§»åŠ¨æµè§ˆå™¨ï¼Œéƒ½æ”¯æŒæ¯ä¸ªä¸»æœºæ‰“å¼€ 6 ä¸ªè¿æ¥ã€‚è¿™ä¸ªéœ€è¦çš„ä»£ä»·ï¼š æ›´å¤šçš„å¥—æ¥å­—ä¼šå ç”¨å®¢æˆ·ç«¯ã€æœåŠ¡å™¨ä»¥åŠä»£ç†çš„èµ„æºï¼ŒåŒ…æ‹¬å†…å­˜ç¼“å†²åŒºå’Œ CPU æ—¶é’Ÿå‘¨æœŸ; å¹¶è¡Œ TCP æµä¹‹é—´ç«äº‰å…±äº«çš„å¸¦å®½; ç”±äºå¤„ç†å¤šä¸ªå¥—æ¥å­—ï¼Œå®ç°å¤æ‚æ€§æ›´é«˜;* å³ä½¿å¹¶è¡Œ TCP æµï¼Œåº”ç”¨çš„å¹¶è¡Œèƒ½åŠ›ä¹Ÿå—é™åˆ¶ã€‚å®è·µä¸­ï¼ŒCPU å’Œå†…å­˜å ç”¨å¹¶éå¾®ä¸è¶³é“ï¼Œç”±æ­¤ä¼šå¯¼è‡´å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„èµ„æºå ç”¨é‡ä¸Šå‡ï¼Œè¿ç»´æˆæœ¬æé«˜ã€‚ç±»ä¼¼åœ°ï¼Œç”±äºå®¢æˆ·ç«¯å®ç°çš„å¤æ‚æ€§æé«˜ï¼Œå¼€å‘æˆæœ¬ä¹Ÿä¼šæé«˜ã€‚æœ€åï¼Œè¯´åˆ°åº”ç”¨çš„å¹¶è¡Œæ€§ï¼Œè¿™ç§æ–¹å¼æä¾›çš„å¥½å¤„è¿˜æ˜¯éå¸¸æœ‰é™çš„ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªé•¿æœŸçš„æ–¹æ¡ˆã€‚ åŸŸååˆ†åŒºå’Œä¸Šé¢çš„åŸç†æ–¹æ³•ä¸€æ ·ï¼Œé€šè¿‡æ‰‹å·¥æŠŠèµ„æºåˆ†æ•£åˆ°å¤šä¸ªå­åŸŸåä¸Šï¼Œç”±äºåŸŸåä¸ä¸€æ ·ï¼Œå¯ä»¥çªç ´æµè§ˆå™¨çš„è¿æ¥é™åˆ¶ï¼Œå®ç°æ›´é«˜çš„å¹¶è¡Œçš„èƒ½åŠ›ï¼ŒåŸŸååˆ†åŒºä½¿ç”¨çš„è¶Šå¤šï¼Œå¹¶è¡Œèƒ½åŠ›è¶Šå¼ºè¿™ä¸ªéœ€è¦çš„ä»£ä»·ï¼š ä¸€æ¬¡é¢å¤–çš„ DNS æŸ¥è¯¢ æ¯å¤šä¸€ä¸ªå¥—æ¥å­—éƒ½ä¼šå¤šæ¶ˆè€—ä¸¤ç«¯çš„ä¸€äº›èµ„æº ç«™ç‚¹å¿…é¡»æ‰‹å·¥åˆ†ç¦»è¿™äº›èµ„æºï¼Œå¹¶åˆ†åˆ«æŠŠå®ƒä»¬æ‰˜ç®¡åˆ°å¤šä¸ªä¸»æœºä¸Šã€‚åŸŸååˆ†åŒºæ˜¯ä¸€ç§åˆç†ä½†åˆä¸å®Œç¾çš„ä¼˜åŒ–æ‰‹æ®µã€‚ç°å®å½“ä¸­ï¼ŒçœŸæ­£å› åŒæ—¶æ‰“å¼€åå‡ ä¸ªè¿æ¥è€Œæå‡æ€§èƒ½çš„ç«™ç‚¹å¹¶ä¸å¤šï¼Œå¦‚æœä½ æœ€ç»ˆä½¿ç”¨äº†å¾ˆå¤šåˆ†åŒºï¼Œé‚£ä¹ˆä½ ä¼šå‘ç°å‡å°‘èµ„æºæ•°é‡æˆ–è€…å°†å®ƒä»¬åˆå¹¶ä¸ºæ›´å°‘çš„è¯·æ±‚ï¼Œåè€Œèƒ½å¸¦æ¥æ›´å¤§çš„å¥½å¤„ã€‚ è¿æ¥ä¸æ‹¼åˆæœ€å¿«çš„è¯·æ±‚æ˜¯ä¸ç”¨è¯·æ±‚ã€‚å‡å°‘è¯·æ±‚æ¬¡æ•°æ€»æ˜¯æœ€å¥½çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µã€‚å¦‚æœä½ æ— è®ºå¦‚ä½•ä¹Ÿæ— æ³•å‡å°‘è¯·æ±‚ï¼Œé‚£ä¹ˆå¯¹ HTTP 1.x è€Œè¨€ï¼Œå¯ä»¥è€ƒè™‘æŠŠå¤šä¸ªèµ„æºæ†ç»‘æ‰“åŒ…åˆ°ä¸€å—ï¼Œé€šè¿‡ä¸€æ¬¡ç½‘ç»œè¯·æ±‚è·å–: è¿æ¥ æŠŠå¤šä¸ª JavaScript æˆ– CSS æ–‡ä»¶ç»„åˆä¸ºä¸€ä¸ªæ–‡ä»¶ã€‚* æ‹¼åˆ æŠŠå¤šå¼ å›¾ç‰‡ç»„åˆä¸ºä¸€ä¸ªæ›´å¤§çš„å¤åˆçš„å›¾ç‰‡ã€‚ä¼˜åŠ¿ï¼š å‡å°‘åè®®å¼€é”€ï¼šé€šè¿‡æŠŠæ–‡ä»¶ç»„åˆæˆä¸€ä¸ªèµ„æºï¼Œå¯ä»¥æ¶ˆé™¤ä¸æ–‡ä»¶ç›¸å…³çš„åè®®å¼€é”€ã€‚* åº”ç”¨å±‚ç®¡é“ï¼šè¿™ä¸¤ç§æŠ€æœ¯çš„æ•ˆæœéƒ½å¥½åƒæ˜¯å¯ç”¨äº† HTTP ç®¡é“:å¤šä¸ªå“åº”çš„æ•°æ®å‰åç›¸ç»§åœ°è¿æ¥åœ¨ä¸€èµ·ï¼Œæ¶ˆé™¤äº†é¢å¤–çš„ç½‘ç»œå»¶è¿Ÿã€‚å®é™…ä¸Šï¼Œå°±æ˜¯æŠŠç®¡é“æé«˜äº†ä¸€å±‚ï¼Œç½®å…¥äº†åº”ç”¨ä¸­ã€‚é—®é¢˜ï¼š æŠŠæ‰€æœ‰èµ„æºéƒ½ç»„åˆåˆ°ä¸€ä¸ªæ–‡ä»¶ç»å¸¸ä¼šå¯¼è‡´å¤„ç†å’ŒåŠ è½½ä¸å¿…è¦çš„å­—èŠ‚ã€‚è™½ç„¶å¯ ä»¥æŠŠå®ƒçœ‹æˆä¸€ç§é¢„è·å–ï¼Œä½†ä»£ä»·åˆ™æ˜¯é™ä½äº†åˆå§‹å¯åŠ¨çš„é€Ÿåº¦ã€‚ å‡å¦‚æ‰“åŒ…èµ„æºå˜åŠ¨é¢‘ç‡è¿‡é«˜ï¼Œæˆ–æ˜¯èµ„æºåŒ…è¿‡å¤§çš„æƒ…å†µä¸‹ï¼Œä¼šå¾—ä¸å¿å¤±ã€‚ å†…å­˜å ç”¨ï¼šå³ä¾¿å®é™…ä¸Š åªæ˜¾ç¤ºäº†å…¶ä¸­çš„ä¸€å°å—ï¼Œä¹Ÿè¦å§‹ç»ˆæŠŠæ•´ä¸ªå›¾ç‰‡éƒ½ä¿å­˜åœ¨å†…å­˜ä¸­ åµŒå…¥èµ„æºåµŒå…¥èµ„æºæ˜¯å¦ä¸€ç§éå¸¸æµè¡Œçš„ä¼˜åŒ–æ–¹æ³•ï¼ŒæŠŠèµ„æºåµŒå…¥æ–‡æ¡£å¯ä»¥å‡å°‘è¯·æ±‚çš„æ¬¡æ•°ã€‚æ¯”å¦‚ï¼ŒJavaScript å’Œ CSS ä»£ç ï¼Œé€šè¿‡é€‚å½“çš„ script å’Œ style å—å¯ä»¥ç›´æ¥æ”¾åœ¨é¡µé¢ä¸­ï¼Œè€Œå›¾ç‰‡ç”šè‡³éŸ³é¢‘æˆ– PDF æ–‡ä»¶ï¼Œéƒ½å¯ä»¥é€šè¿‡æ•°æ®URIçš„æ–¹å¼åµŒå…¥åˆ°é¡µé¢ä¸­ï¼ˆå®é™…ä¸Šï¼Œå¸¸è§çš„ä¸€ä¸ªç»éªŒè§„åˆ™æ˜¯åªè€ƒè™‘åµŒå…¥ 1~2 KB ä»¥ä¸‹çš„èµ„æºï¼Œå› ä¸ºå°äºè¿™ä¸ªæ ‡å‡†çš„èµ„æºç»å¸¸ä¼šå¯¼è‡´æ¯”å®ƒè‡ªèº«æ›´é«˜çš„ HTTP å¼€é”€ã€‚ç„¶è€Œï¼Œå¦‚æœåµŒå…¥çš„èµ„æºé¢‘ç¹å˜æ›´ï¼Œ åˆä¼šå¯¼è‡´å®¿ä¸»æ–‡æ¡£çš„æ— æ•ˆç¼“å­˜ç‡å‡é«˜ï¼‰","tags":[{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://alfredzhenyu.github.io/tags/ç½‘ç»œ/"},{"name":"HTTP","slug":"HTTP","permalink":"http://alfredzhenyu.github.io/tags/HTTP/"}]},{"title":"ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆä¸‰ï¼‰","date":"2016-12-26T02:51:14.000Z","path":"2016/12/26/ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆä¸‰ï¼‰/","text":"ç›®å½•ï¼š ç¬¬ä¸€éƒ¨åˆ† ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ ç¬¬å››ç«  ä¼ è¾“å±‚å®‰å…¨ï¼ˆTLSï¼‰ ç¬¬å››ç«  ä¼ è¾“å±‚å®‰å…¨ä¸ªäººçš„ç†è§£ï¼šHTTPS = TLS + HTTPsoï¼šç†è§£TLSï¼Œåœ¨ç†è§£HTTPSä¸­æä¸ºé‡è¦ TLSä¸SSLSSLï¼ˆSecure Sockets Layerï¼Œå®‰å…¨å¥—æ¥å­—ï¼‰æœ€åˆæ˜¯ä¸ºäº†ä¿è¯ç½‘ä¸Šäº¤æ˜“å®‰å…¨è€Œå¼€å‘çš„ä¸€å¥—å®‰å…¨åè®®ï¼Œåè®®é€šè¿‡åŠ å¯†ä¿æŠ¤å®¢æˆ·ä¸ªäººèµ„æ–™ï¼Œé€šè¿‡è®¤è¯å’Œå®Œæ•´æ€§æ£€æŸ¥æ¥ç¡®ä¿äº¤æ˜“å®‰å…¨ï¼ŒSSLä¸ä¼šå½±å“ä¸Šå±‚åè®®ï¼Œä½†èƒ½ä¿è¯ä¸Šå±‚åè®®çš„ç½‘ç»œé€šä¿¡å®‰å…¨ï¼ˆHTTPã€ç”µå­é‚®ä»¶ã€å³æ—¶é€šè®¯ï¼‰TLSï¼ˆTransport Layer Securityï¼Œ ä¼ è¾“å±‚å®‰å…¨ï¼‰ï¼šåæ¥è¢«IETFæ ‡å‡†åŒ–SSLä¹‹åæ”¹äº†åå­—ï¼Œå®é™…ä¸Šä¸¤è€…æŒ‡çš„æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œåªæ˜¯åœ¨ä¸åŒæ—¶é—´æ®µï¼ŒæŒ‡ä»£ä¸åŒçš„åè®®ç‰ˆæœ¬ã€TLSè®¾è®¡çš„åˆè¡·æ˜¯åœ¨å¯é çš„ä¼ è¾“åè®®ï¼ˆTCPï¼‰ä¹‹ä¸Šè¿è¡Œçš„ï¼Œå¯æ˜¯æœ‰å®ç°æŠŠå®ƒæ”¾åœ¨æ•°æ®åŒ…åè®®ï¼ˆå¦‚UDPï¼‰ä¸Šï¼Œå½¢æˆDTLSï¼ˆDatagram Transport Layer Securityï¼Œæ•°æ®æŠ¥ä¼ è¾“å±‚å®‰å…¨ï¼ŒRFC 6437ï¼‰æ—¨åœ¨ä»¥TLSåè®®ä¸ºåŸºç¡€ï¼ŒåŒæ—¶å…¼é¡¾æ•°æ®åŒ…äº¤ä»˜æ¨¡å¼å¹¶æä¾›ç±»ä¼¼çš„å®‰å…¨ä¿éšœã€‘ åŸºæœ¬æœåŠ¡TLSç›®æ ‡æ˜¯åœ¨å®ƒä¹‹ä¸Šçš„åº”ç”¨æä¾›ä¸‰ä¸ªåŸºæœ¬æœåŠ¡ï¼š åŠ å¯† æ··æ·†æ•°æ®çš„æœºåˆ¶ èº«ä»½éªŒè¯ éªŒè¯èº«ä»½æ ‡è¯†æœ‰æ•ˆæ€§çš„æœºåˆ¶ å®Œæ•´æ€§ æ£€æµ‹æ¶ˆæ¯æ˜¯å¦è¢«ç¯¡æ”¹æˆ–ä¼ªé€ çš„æœºåˆ¶ å…·ä½“å®ç°ï¼šå¯†é’¥åå•†ï¼šTLSæ¡æ‰‹æ—¶ä¼šé‡‡ç”¨å…¬é’¥å¯†ç ç³»ç»Ÿï¼ˆéå¯¹ç§°å¯†é’¥åŠ å¯†ï¼‰çš„æ–¹å¼ï¼Œè®©é€šä¿¡åŒæ–¹ä¸å¿…äº‹å…ˆâ€œè®¤è¯†â€ï¼Œå³å¯å•†å®šå…±äº«çš„å®‰å…¨å¯†é’¥èº«ä»½éªŒè¯ï¼šTLSæ—¶å…è®¸é€šä¿¡åŒæ–¹äº’ç›¸éªŒæ˜æ­£èº«ï¼Œå¯ä»¥é€šè¿‡ç›¸äº’æä¾›è®¤è¯è¯ä¹¦æ¥éªŒè¯å¯¹æ–¹æ˜¯å¦æ˜¯å®ƒæƒ³è”ç³»çš„æœåŠ¡æ¶ˆæ¯åˆ†å¸§ï¼šä½¿ç”¨MACç®—æ³•ï¼ˆMessage Authentication Codeï¼Œæ¶ˆæ¯è®¤è¯ç ï¼‰ç­¾ç½²æ¯ä¸€æ¡æ¶ˆæ¯ã€‚MACç®—æ³•æ˜¯ä¸€ä¸ªå•å‘åŠ å¯†çš„æ•£åˆ—å‡½æ•°(æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ ¡éªŒå’Œ)ï¼Œå¯†é’¥ç”±è¿æ¥åŒæ–¹åå•†ç¡®å®šã€‚åªè¦å‘é€TLSè®°å½•ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªMACå€¼å¹¶é™„åŠ åˆ°è¯¥æ¶ˆæ¯ä¸­ã€‚æ¥æ”¶ç«¯é€šè¿‡è®¡ç®—å’ŒéªŒè¯è¿™ä¸ªMACå€¼æ¥åˆ¤æ–­æ¶ˆæ¯çš„å®Œæ•´æ€§å’Œå¯é æ€§ã€‚ TLSæ¡æ‰‹â€¢ 0 ms:TLS åœ¨å¯é çš„ä¼ è¾“å±‚(TCP)ä¹‹ä¸Šè¿è¡Œï¼Œè¿™æ„å‘³ç€é¦–å…ˆå¿…é¡»å®Œæˆ TCP çš„â€œä¸‰æ¬¡æ¡æ‰‹â€ï¼Œå³ä¸€æ¬¡å®Œæ•´çš„å¾€è¿”ã€‚â€¢ 56 ms:TCP è¿æ¥å»ºç«‹ä¹‹åï¼Œå®¢æˆ·ç«¯å†ä»¥çº¯æ–‡æœ¬å½¢å¼å‘é€ä¸€äº›è§„æ ¼è¯´æ˜ï¼Œæ¯”å¦‚å®ƒæ‰€è¿è¡Œçš„ TLS åè®®çš„ç‰ˆæœ¬ã€å®ƒæ‰€æ”¯æŒçš„åŠ å¯†å¥—ä»¶åˆ—è¡¨ï¼Œä»¥åŠå®ƒæ”¯æŒæˆ–å¸Œæœ›ä½¿ç”¨çš„å¦å¤–ä¸€ äº› TLS é€‰é¡¹ã€‚â€¢ 84 ms:ç„¶åï¼ŒæœåŠ¡å™¨å–å¾— TLS åè®®ç‰ˆæœ¬ä»¥å¤‡å°†æ¥é€šä¿¡ä½¿ç”¨ï¼Œä»å®¢æˆ·ç«¯æä¾›çš„åŠ å¯†å¥—ä»¶åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œå†é™„ä¸Šè‡ªå·±çš„è¯ä¹¦ã€è¿™é‡Œåº”è¯¥è¿˜æœ‰æœåŠ¡å™¨ç»™å®¢æˆ·ç«¯çš„å…¬é’¥ï¼Œç”¨äºéå¯¹ç§°åŠ å¯†ã€‘ï¼Œå°†å“åº”å‘é€å›å®¢æˆ·ç«¯ã€‚ä½œä¸ºå¯é€‰é¡¹ï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè¦æ±‚å®¢æˆ·ç«¯æä¾›è¯ä¹¦ä»¥åŠå…¶ä»– TLS æ‰©å±•å‚æ•°ã€‚â€¢ 112 ms:å‡è®¾ä¸¤ç«¯ç»è¿‡åå•†ç¡®å®šäº†å…±åŒçš„ç‰ˆæœ¬å’ŒåŠ å¯†å¥—ä»¶ï¼Œå®¢æˆ·ç«¯ä¹Ÿé«˜é«˜å…´å…´åœ°æŠŠè‡ªå·±çš„è¯ä¹¦æä¾›ç»™äº†æœåŠ¡å™¨ã€‚ç„¶åï¼Œå®¢æˆ·ç«¯ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹ç§°å¯†é’¥ï¼Œç”¨æœåŠ¡å™¨çš„å…¬é’¥æ¥åŠ å¯†ï¼ŒåŠ å¯†åå‘é€ç»™æœåŠ¡å™¨ï¼Œå‘Šè¯‰æœåŠ¡å™¨å¯ä»¥å¼€å§‹åŠ å¯†é€šä¿¡äº†ã€‚ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œé™¤äº†ç”¨æœåŠ¡å™¨å…¬é’¥åŠ å¯†çš„æ–°å¯¹ç§°å¯†é’¥ä¹‹å¤–ï¼Œæ‰€æœ‰æ•°æ®éƒ½ä»¥æ˜æ–‡å½¢å¼å‘é€ã€‚â€¢ 140 ms:æœ€åï¼ŒæœåŠ¡å™¨è§£å¯†å‡ºå®¢æˆ·ç«¯å‘æ¥çš„å¯¹ç§°å¯†é’¥ï¼Œé€šè¿‡éªŒè¯æ¶ˆæ¯çš„ MAC æ£€æµ‹æ¶ˆæ¯å®Œæ•´æ€§ï¼Œå†è¿”å›ç»™å®¢æˆ·ç«¯ä¸€ä¸ªåŠ å¯†çš„â€œFinishedâ€æ¶ˆæ¯ã€‚â€¢ 168 ms:å®¢æˆ·ç«¯ç”¨å®ƒä¹‹å‰ç”Ÿæˆçš„å¯¹ç§°å¯†é’¥è§£å¯†è¿™æ¡æ¶ˆæ¯ï¼ŒéªŒè¯ MACï¼Œå¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œåˆ™å»ºç«‹ä¿¡é“å¹¶å¼€å§‹å‘é€åº”ç”¨æ•°æ®ã€‚ åŠ å¯† éå¯¹ç§°åŠ å¯†ï¼šåªåœ¨å»ºç«‹TLSä¿¡é“çš„ä¼šè¯ä¸­ä½¿ç”¨ å¯¹ç§°åŠ å¯†ï¼šå»ºç«‹TLSä¹‹åä¼šä¸€ç›´ä½¿ç”¨ ä¸»è¦åŸå› æ˜¯é¡¾åŠæ€§èƒ½é—®é¢˜ ä»¥æœ€å¸¸ç”¨çš„RSAã€AESåŠ å¯†æ–¹å¼ä¸ºä¾‹å­ï¼šåœ¨å®‰è£…äº†OpenSSLçš„è¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹12$&gt; openssl speed rsa$&gt; openssl speed aes å¯ä»¥çœ‹å‡ºAESéœ€è¦3så·¦å³å®Œæˆä¸€æ¬¡åŠ /è§£å¯†å¯ä»¥çœ‹å‡ºRSAéœ€è¦10så·¦å³å®Œæˆä¸€æ¬¡åŠ /è§£å¯† TODOï¼šåç»­å¯èƒ½ä¼šé’ˆå¯¹åŠ è§£å¯†è¿™å—å†™äº›æ–‡ç« ï¼Œæ¯•ç«Ÿå®¢æˆ·ç«¯åœ¨äºæœåŠ¡ç«¯äº¤äº’çš„æ—¶å€™åŠ è§£å¯†æ˜¯å¿…ä¸å¯å°‘çš„ åº”ç”¨å±‚åè®®åå•†ï¼ˆALPNï¼‰ç½‘ç»œä¸Šé€šä¿¡å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„åè®®è¿›è¡Œé€šä¿¡ HTTPçš„è¯å¯ä»¥ä½¿ç”¨Upgradeæœºåˆ¶ + 80ç«¯å£æ¥åå•†è‡ªå®šä¹‰åè®® HTTPSçš„è¯ç”±äºä½¿ç”¨äº†TLSï¼Œé™¤äº†å¯ä»¥ä½¿ç”¨HTTPçš„Upgradeæœºåˆ¶æ¥åå•†ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ALPN+443ç«¯å£ï¼Œåœ¨TLSæ¡æ‰‹æ—¶å°±æŠŠåå•†ç¡®å®šåè®® ALPNï¼šåœ¨å®¢æˆ·ç«¯å‘é€ClientHelloçš„è¿‡ç¨‹ä¸­å¢åŠ ä¸€ä¸ªæ–°çš„å­—æ®µProtocolNameListï¼Œå‘Šè¯‰æœåŠ¡ç«¯è‡ªå·±æ”¯æŒçš„åº”ç”¨åè®®ï¼›æœåŠ¡å™¨æ£€æŸ¥ProtocolNameListå­—æ®µï¼Œå¦‚æœæ”¯æŒï¼šåœ¨ServerHelloæ¶ˆæ¯ä¸­ä»¥ ProtocolNameå­—æ®µè¿”å›é€‰ä¸­çš„åè®®ï¼›å¦‚æœä¸æ”¯æŒï¼šæ–­å¼€è¿æ¥ã€Upgradeæœºåˆ¶ä¼šå¢åŠ ä¸€æ¬¡å¾€è¿”çš„å»¶è¿Ÿï¼šä¼šåœ¨HTTPéƒ¨åˆ†è¿›è¡Œè®²è§£ã€‘ æœåŠ¡å™¨åç§°æŒ‡ç¤ºï¼ˆSNIï¼‰ç½‘ç»œä¸Šå¯ä»¥å»ºç«‹TCPè¿æ¥çš„ä»»æ„ä¸¤ç«¯éƒ½å¯ä»¥å»ºç«‹åŠ å¯†TLSä¿¡é“ï¼Œå®¢æˆ·ç«¯åªéœ€çŸ¥é“ å¦ä¸€ç«¯çš„IPåœ°å€å³å¯å»ºç«‹è¿æ¥å¹¶è¿›è¡ŒTLSæ¡æ‰‹ã€‚ç„¶è€Œï¼Œå¦‚æœæœåŠ¡å™¨æƒ³åœ¨ä¸€ä¸ªIPåœ°å€ä¸ºå¤šä¸ªç«™ç‚¹æä¾›æœåŠ¡ï¼Œè€Œæ¯ä¸ªç«™ç‚¹éƒ½æ‹¥æœ‰è‡ªå·±çš„TLSè¯ä¹¦ï¼Œé‚£æ€ä¹ˆåŠï¼Ÿå°±è¦ç”¨åˆ°SNIï¼šSNIï¼šè¯¥æ‰©å±•è¢«å¼•å…¥TLSåè®®ï¼Œè¯¥æ‰©å±•å…è®¸å®¢æˆ·ç«¯åœ¨æ¡æ‰‹ä¹‹åˆå°±æŒ‡æ˜è¦è¿æ¥çš„ä¸»æœºåã€‚WebæœåŠ¡å™¨å¯ä»¥æ£€æŸ¥SNIä¸»æœºåï¼Œé€‰æ‹©é€‚å½“çš„è¯ä¹¦ï¼Œç»§ç»­å®Œæˆæ¡æ‰‹ TLSä¼šè¯æ¢å¤TLSæ¡æ‰‹ä¼šå¸¦æ¥é¢å¤–çš„å»¶è¿Ÿå’Œè®¡ç®—é‡ï¼Œé€ æˆä¸€å®šçš„æ€§èƒ½æŸå¤±ã€‚ä¸ºäº†æŒ½å›æŸäº›æŸå¤±ï¼ŒTLSæä¾›äº†æ¢å¤åŠŸèƒ½ï¼Œå³åœ¨å¤šä¸ªè¿æ¥é—´å…±äº«åå•†åçš„å®‰å…¨å¯†é’¥ã€‚ ä¼šè¯æ ‡è¯†ç¬¦ï¼ˆSession Identifierï¼‰ä¼šè¯æ ‡è¯†ç¬¦ï¼ˆRFC 5246ï¼Œåœ¨SSL 2.0å¼•å…¥ï¼‰ï¼šæœåŠ¡å™¨æ”¯æŒåˆ›å»º32å­—èŠ‚çš„ä¼šè¯æ ‡è¯†ç¬¦ï¼Œç”¨äºä¿å­˜ä¸€ä¸ªä¼šè¯IDå’Œåå•†åçš„ä¼šè¯å‚æ•°ã€‚ç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶ï¼šæœåŠ¡å™¨æŠŠIDä¿¡æ¯ä½œä¸ºâ€œServerHelloâ€æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†å‘é€å‡ºå»ï¼Œè‡ªå·±æŠŠå…¶ä»–ä¼šè¯ä¿¡æ¯å­˜å‚¨èµ·æ¥ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åä¿å­˜ä¼šè¯IDä¿¡æ¯éœ€è¦æ¢å¤æ—¶ï¼šå°†è¯¥IDåŒ…å«åœ¨ä¼šè¯çš„â€œClientHelloâ€æ¶ˆæ¯ä¸­ï¼Œ å‘Šè¯‰æœåŠ¡å™¨è‡ªå·±è¿˜è®°ç€ä¸Šæ¬¡æ¡æ‰‹åå•†åçš„åŠ å¯†å¥—ä»¶å’Œå¯†é’¥å‘¢ï¼Œä»è€Œå®ç°é‡ç”¨ã€‚é—®é¢˜ï¼šå¯¹äºæ¯å¤©å‡ ç™¾ä¸‡è¿æ¥çš„æœåŠ¡å™¨æ¥è¯´ï¼ŒTLSè¿æ¥ä¼šå ç”¨ä¸å¿…è¦çš„å†…å­˜ï¼Œäºæ˜¯å¼•å…¥ä¼šè¯è®°å½•å•ï¼ˆSession Ticketï¼‰ ä¼šè¯è®°å½•å•ï¼ˆSession Ticketï¼‰ä¼šè¯è®°å½•å•ï¼ˆRFC 5077ï¼‰ï¼šè¯¥æœºåˆ¶ä¸ç”¨æœåŠ¡å™¨ä¿å­˜æ¯ä¸ªå®¢æˆ·ç«¯çš„ä¼šè¯çŠ¶æ€ï¼Œè€Œæ˜¯å°†åªæœ‰æœåŠ¡å™¨çŸ¥é“çš„å®‰å…¨å¯†é’¥åŠ å¯†è¿‡çš„æ‰€æœ‰ä¼šè¯æ•°æ®äº¤ç”±å®¢æˆ·ç«¯ä¿å­˜ã€‚ç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶ï¼šå®¢æˆ·ç«¯è¡¨æ˜å…¶æ”¯æŒä¼šè¯è®°å½•å•ï¼Œåˆ™æœåŠ¡å™¨å¯ä»¥åœ¨å®Œæ•´TLSæ¡æ‰‹çš„æœ€åä¸€æ¬¡äº¤æ¢ä¸­æ·»åŠ ä¸€æ¡â€œæ–°ä¼šè¯è®°å½•å•â€(New Session Ticket)è®°å½•ï¼Œä¿å­˜å¯¹åº”çš„ä¼šè¯æ•°æ®äº¤ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å°†è¿™ä¸ªä¼šè¯è®°å½•å•ä¿å­˜èµ·æ¥éœ€è¦æ¢å¤æ—¶ï¼šåœ¨ ClientHello æ¶ˆæ¯ä¸­å°†åŠ å¯†è¿‡çš„ä¼šè¯è®°å½•å•æ”¾åœ¨SessionTicketæ‰©å±•ä¸­ï¼ŒæœåŠ¡å™¨æ‹¿åˆ°ä¹‹åæ‹¿è‡ªå·±çš„ç§˜é’¥è§£å¯†å®ç°é‡ç”¨ï¼ˆè¿™ç§å›å¤ç§°ä¹‹ä¸ºæ— çŠ¶æ€æ¢å¤ï¼‰ ä¼šè¯è®°å½•å• å’Œ ä¼šè¯æ ‡è¯†ç¬¦ çš„åŒºåˆ«åœ¨äºæ˜¯æœåŠ¡å™¨è¿˜æ˜¯å®¢æˆ·ç«¯å­˜è¿™ä¸ªä¼šè¯è®°å½• TLSè®°å½•åè®®æ‰€æœ‰ç»è¿‡é‡‡ç”¨TLSçš„åè®®çš„è¯·æ±‚éƒ½å¿…é¡»ç»è¿‡è®°å½•åè®®ï¼Œæ·»åŠ ç›¸åº”çš„å­—æ®µï¼Œè¿›è¡Œä¸€å®šçš„æ•°æ®å¤„ç†ä¹‹åæ‰äº¤ç”±TCPå‘é€å‡ºå»å‘é€ç«¯æ­¥éª¤å¦‚ä¸‹ï¼š è®°å½•åè®®æ¥æ”¶ä¸Šå±‚åº”ç”¨æ•°æ® æ¥æ”¶åˆ°çš„åº”ç”¨æ•°æ®è¢«åˆ‡åˆ†ä¸ºå—:æœ€å¤§ä¸ºæ¯æ¡è®°å½•214å­—èŠ‚ï¼Œå³16KBã€‚ å‹ç¼©åº”ç”¨æ•°æ®(å¯é€‰)ã€‚ æ·»åŠ  MAC(Message Authentication Code)æˆ– HMACã€‚ ç”¨å•†å®šçš„åŠ å¯†å¥—ä»¶åŠ å¯†æ•°æ® äº¤ç”±TCPå±‚ä¼ è¾“æ¥æ”¶ç«¯é¡ºåºç›¸åï¼š6 â€”&gt; 1æ³¨æ„ï¼šTLSè®°å½•åè®®æœ€å¤§ä¸º16KBã€‚äº‹å®ä¸Šå¯ä»¥è‡ªä¸»é€‰æ‹©è®°å½•å¤§å°ï¼Œå°è®°å½•ä¼šå› ä¸ºåˆ†å¸§è€Œæ‹›è‡´è¾ƒå¤§å¼€é”€æ¯æ¡è®°å½•åŒ…å«5å­—èŠ‚çš„é¦–éƒ¨ã€MAC(åœ¨ SSL 3.0ã€TLS 1.0ã€TLS 1.1 ä¸­æœ€å¤š 20 å­—èŠ‚ï¼Œåœ¨ TLS 1.2 ä¸­æœ€å¤š 32 å­—èŠ‚)ï¼Œå¦‚æœä½¿ç”¨å—åŠ å¯†åˆ™è¿˜æœ‰å¡«å……å¿…é¡»æ¥æ”¶åˆ°æ•´æ¡è®°å½•ï¼ˆä¸æ˜¯å¸§ï¼‰æ‰å¼€å§‹è§£å¯†å’ŒéªŒè¯ã€‚ ä¼˜åŒ–å»ºè®® æœ€å¤§é™åˆ¶æå‡TCPæ€§èƒ½ å¼€å¯ä¼šè¯ç¼“å­˜ï¼šåœ¨æ”¯æŒçš„å®¢æˆ·ç«¯ä¸­ä½¿ç”¨ä¼šè¯è®°å½•å•ï¼Œè€Œåœ¨ä¸æ”¯æŒçš„å®¢æˆ·ç«¯ä¸­ä½¿ç”¨ä¼šè¯æ ‡è¯†ç¬¦ è°ƒæ•´TLSè®°å½•å¤§å°ï¼šè®°å½•è¿‡å°ä¼šé€ æˆåˆ†å¸§æµªè´¹ï¼Œå¤§è®°å½•ä¼šå¯¼è‡´å»¶è¿Ÿã€‚æœ€å¥½çš„åšæ³•ï¼šæ¯ä¸ªTCPåˆ†ç»„æ°å¥½å°è£…ä¸€ä¸ªTLSè®°å½•ï¼Œè€ŒTLSè®°å½•å¤§å°æ°å¥½å æ»¡TCPåˆ†é…çš„MSS(Maximum Segment Sizeï¼Œæœ€å¤§æ®µå¤§å°)ï¼ˆä¸€æ–¹é¢ä¸è¦è®©TLSè®°å½•åˆ†æˆå¤šä¸ªTCPåˆ†ç»„ï¼Œå¦ä¸€æ–¹é¢åˆè¦å°½é‡åœ¨ä¸€æ¡è®°å½•ä¸­å¤šå‘é€æ•°æ®ï¼Œå‚è€ƒæ•°æ®å¦‚ä¸‹ï¼š IPv4 å¸§éœ€è¦ 20 å­—èŠ‚ï¼ŒIPv6 éœ€è¦ 40 å­—èŠ‚; TCP å¸§éœ€è¦ 20 å­—èŠ‚; TCP é€‰é¡¹éœ€è¦ 40 å­—èŠ‚(æ—¶é—´æˆ³ã€SACK ç­‰)ã€‚å‡è®¾å¸¸è§çš„MTUä¸º1500å­—èŠ‚ï¼Œåˆ™TLSè®°å½•å¤§å°åœ¨IPv4ä¸‹æ˜¯1420å­—èŠ‚ï¼Œåœ¨IPv6ä¸‹æ˜¯1400å­—èŠ‚ã€‚ä¸ºç¡®ä¿å‘å‰å…¼å®¹ï¼Œå»ºè®®ä½¿ç”¨IPv6ä¸‹çš„å¤§å°:1400å­—èŠ‚ã€‚å½“ç„¶ï¼Œå¦‚æœMTUæ›´å°ï¼Œè¿™ä¸ªå€¼ä¹Ÿè¦ç›¸åº”è°ƒå°ï¼‰ ã€ä½†åº”ç”¨å±‚æ— æ³•æ§åˆ¶TLSè®°å½•å¤§å°ï¼Œä¸€èˆ¬æ˜¯æœåŠ¡å™¨ç¼–è¯‘æ—¶çš„å¸¸é‡æˆ–æ ‡å¿—ï¼Œå¯ä»¥é€šè¿‡æœåŠ¡å™¨æ–‡æ¡£æ¥æŸ¥çœ‹è¿™ä¸ªå€¼ã€‘ ç¦ç”¨æœåŠ¡å™¨çš„TLSå‹ç¼©åŠŸèƒ½ ä¼ è¾“çº§çš„ TLS å‹ç¼©ä¸å…³å¿ƒå†…å®¹ï¼Œå¯èƒ½ä¼šå†æ¬¡å‹ç¼©å·²ç»å‹ç¼©è¿‡çš„æ•°æ®(å›¾åƒã€è§†é¢‘ï¼Œ ç­‰ç­‰)ã€‚åŒé‡å‹ç¼©ä¼šæµªè´¹æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„CPUæ—¶é—´ï¼Œè€Œä¸”æš´éœ²çš„å®‰å…¨æ¼æ´ä¹Ÿå¾ˆä¸¥é‡ï¼Œå› æ­¤ è¯·ç¦ç”¨TLSå‹ç¼© ç¡®ä¿è¯ä¹¦é“¾ä¸ä¼šè¶…è¿‡æ‹¥å¡çª—å£çš„å¤§å°ï¼Œä»ä¿¡ä»»é“¾ä¸­å»æ‰ä¸å¿…è¦çš„è¯ä¹¦ï¼Œå‡å°‘é“¾æ¡å±‚æ¬¡ï¼Œæˆ–è€…ç›´æ¥å‡å°è¯ä¹¦å¤§å° å¦‚æœè¯ä¹¦é“¾é•¿åº¦è¶…è¿‡äº† TCP çš„åˆå§‹æ‹¥å¡çª—å£(å›¾ 4-11)ï¼Œé‚£æˆ‘ä»¬æ— æ„ é—´å°±ä¼šè®©æ¡æ‰‹å¤šäº†ä¸€æ¬¡å¾€è¿”:è¯ä¹¦é•¿åº¦è¶…è¿‡æ‹¥å¡çª—å£ï¼Œä»è€Œå¯¼è‡´æœåŠ¡å™¨åœä¸‹æ¥ç­‰å¾… å®¢æˆ·ç«¯çš„ ACK æ¶ˆæ¯ å¯ç”¨æœåŠ¡å™¨çš„OCSPå°å¥—åŠŸèƒ½ï¼ˆè¯ä¹¦æ–¹é¢çš„ä¼˜åŒ–ï¼‰ å¯ç”¨æœåŠ¡å™¨å¯¹SNIçš„æ”¯æŒ è¿½åŠ HTTPä¸¥æ ¼ä¼ è¾“å®‰å…¨é¦–éƒ¨ï¼ˆä¸å¤ªç†è§£ï¼‰ ï¼ˆåé¢è¿™ä¸¤ä¸ªï¼Œè¦æƒ³è¿›ä¸€æ­¥äº†è§£çœ‹ä¹¦å§ï¼Œæ„Ÿè§‰ä¹¦ä¹Ÿæ²¡è®²ç‰¹åˆ«ç»†ï¼Œä¸ªäººä¹Ÿæ²¡ç‰¹åˆ«æ·±çš„ç†è§£ï¼Œå°±ç•¥è¿‡äº†ï¼‰","tags":[{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://alfredzhenyu.github.io/tags/ç½‘ç»œ/"},{"name":"HTTPS","slug":"HTTPS","permalink":"http://alfredzhenyu.github.io/tags/HTTPS/"},{"name":"SSL/TLS","slug":"SSL-TLS","permalink":"http://alfredzhenyu.github.io/tags/SSL-TLS/"}]},{"title":"ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆäºŒï¼‰","date":"2016-12-23T09:03:47.000Z","path":"2016/12/23/ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆäºŒï¼‰/","text":"ç›®å½• ç¬¬ä¸€éƒ¨åˆ† ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ ç¬¬ä¸‰ç«  UDPæ„æˆ â€‹ ç¬¬ä¸‰ç«  UDPæ„æˆå‰è¨€ å…³äºUDPçš„åº”ç”¨ï¼Œæœ€å¹¿ä¸ºäººçŸ¥åŒæ—¶ä¹Ÿæ˜¯æ‰€æœ‰æµè§ˆå™¨å’Œå› ç‰¹ç½‘åº”ç”¨éƒ½èµ–ä»¥è¿ä½œçš„ï¼Œå°±æ˜¯DNS(Domain Name Systemï¼ŒåŸŸåç³»ç»Ÿ) HTTP å¹¶æœªè§„å®šè¦ä½¿ç”¨ TCPï¼Œä½†ç°å®ä¸­æ‰€æœ‰ HTTP å®ç°(ä»¥åŠ æ„å»ºäºå…¶ä¸Šçš„æ‰€æœ‰æœåŠ¡)éƒ½ä½¿ç”¨ TCPã€‚ä¸è¿‡ï¼Œè¿™éƒ½æ˜¯è¿‡å»çš„äº‹äº†ã€‚IETF å’Œ W3C å·¥ä½œç»„å…±åŒåˆ¶å®šäº†ä¸€å¥—æ–° APIâ€”â€” WebRTC(Web Real-Time Communicationï¼ŒWeb å®æ—¶é€šä¿¡) æ— åè®®æœåŠ¡ä¸ºä»€ä¹ˆç§°ä¹‹ä¸ºæ— åè®®ï¼š ä¸ä¿è¯æ¶ˆæ¯äº¤ä»˜ ä¸ç¡®è®¤ï¼Œä¸é‡ä¼ ï¼Œæ— è¶…æ—¶ã€‚ ä¸ä¿è¯äº¤ä»˜é¡ºåº ä¸è®¾ç½®åŒ…åºå·ï¼Œä¸é‡æ’ï¼Œä¸ä¼šå‘ç”Ÿé˜Ÿé¦–é˜»å¡ã€‚ ä¸è·Ÿè¸ªè¿æ¥çŠ¶æ€ ä¸å¿…å»ºç«‹è¿æ¥æˆ–é‡å¯çŠ¶æ€æœºã€‚* ä¸éœ€è¦æ‹¥å¡æ§åˆ¶ ä¸å†…ç½®å®¢æˆ·ç«¯æˆ–ç½‘ç»œåé¦ˆæœºåˆ¶ã€‚ç½‘ç»œåœ°å€è½¬æ¢å™¨ä¸ºäº†è§£å†³IPv4åœ°å€è€—å°½çš„é—®é¢˜ï¼Œæä¾›äº†ä¸´æ—¶æ€§æ–¹æ¡ˆ â€”â€” IPç½‘ç»œåœ°å€è½¬æ¢å™¨ï¼ˆNATï¼‰IPç½‘ç»œåœ°å€è½¬æ¢å™¨ï¼šNATè®¾å¤‡ç»´æŠ¤ä¸€ä¸ªè¡¨ï¼Œè¡¨ç»´æŠ¤äº†ä¸€å¼ æœ¬åœ°IPåˆ°å¤–ç½‘IPçš„æ˜ å°„è¡¨ï¼Œè¿™æ ·IPå°±å¯ä»¥å®ç°ä¸åŒç½‘ç»œä¸­çš„æ˜ å°„ï¼Œä»è€Œè¾¾åˆ°æ˜ å°„ï¼Œç”¨äºè§£å†³ç½‘ç»œä¸å¤Ÿç”¨çš„é—®é¢˜NATç©¿é€ NATè®¾å¤‡å¸¦æ¥çš„é—®é¢˜ï¼š å†…éƒ¨å®¢æˆ·ç«¯ä¸çŸ¥é“å¤–ç½‘ IP åœ°å€ï¼ŒåªçŸ¥é“å†…ç½‘ IP åœ°å€ã€‚NAT è´Ÿè´£é‡å†™æ¯ä¸ª UDP åˆ†ç»„ä¸­çš„æºç«¯å£ã€åœ°å€ï¼Œä»¥åŠ IP åˆ†ç»„ä¸­çš„æº IP åœ°å€ã€‚ å¦‚æœå®¢æˆ·ç«¯åœ¨åº”ç”¨æ•°æ®ä¸­ä»¥å…¶å†…ç½‘ IP åœ°å€ä¸å¤–ç½‘ä¸»æœºé€šä¿¡ï¼Œè¿æ¥å¿…ç„¶å¤±è´¥ ä»»ä½•åˆ°è¾¾ NAT è®¾å¤‡å¤–ç½‘ IP çš„åˆ†ç»„è¿˜å¿…é¡»æœ‰ä¸€ä¸ªç›®æ ‡ç«¯å£ï¼Œè€Œä¸” NAT è½¬æ¢è¡¨ä¸­ä¹Ÿè¦æœ‰ä¸€ä¸ªæ¡ç›®å¯ä»¥å°†å…¶è½¬æ¢ä¸ºå†…éƒ¨ä¸»æœºçš„ IP åœ°å€å’Œç«¯å£å·ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªæ¡ç›®(é€šå¸¸æ˜¯ä»å¤–ç½‘ä¼ æ•°æ®è¿›æ¥)ï¼Œé‚£åˆ°è¾¾çš„åˆ†ç»„å°±ä¼šè¢«åˆ é™¤ã€‚æ­¤æ—¶çš„ NAT è®¾å¤‡å°±åƒä¸€ä¸ªåˆ†ç»„è¿‡æ»¤å™¨ï¼Œé™¤éç”¨æˆ·é€šè¿‡ç«¯å£ è½¬å‘(æ˜ å°„)æˆ–ç±»ä¼¼æœºåˆ¶é…ç½®è¿‡ï¼Œå¦åˆ™å®ƒæ— æ³•ç¡®å®šå°†åˆ†ç»„å‘é€ç»™å“ªå°å†…éƒ¨ä¸»æœº STUN(Session Traversal Utilities for NAT) STUNåè®®(RFC 5389)ï¼šå¯ä»¥è®©åº”ç”¨ç¨‹åºå‘ç°ç½‘ç»œä¸­çš„åœ°å€è½¬æ¢å™¨ï¼Œå‘ç°ä¹‹åè¿›ä¸€æ­¥å–å¾—ä¸ºå½“å‰è¿æ¥åˆ†é…çš„å¤–ç½‘ IP åœ°å€å’Œç«¯å£(å›¾ 3-5)ã€‚ä¸ºæ­¤ï¼Œè¿™ä¸ªåè®®éœ€è¦ä¸€ä¸ªå·²çŸ¥çš„ç¬¬ä¸‰æ–¹ STUN æœåŠ¡å™¨æ”¯æŒï¼Œè¯¥æœåŠ¡å™¨å¿…é¡»æ¶è®¾åœ¨å…¬ç½‘ä¸Šã€‚ åº”ç”¨ç¨‹åºé¦–å…ˆå‘STUNæœåŠ¡å™¨å‘é€ä¸€ä¸ªç»‘å®šè¯·æ±‚ï¼Œç„¶åSTUNä¼šè¿”å›ä¸€ä¸ªå“åº”åŒ…å«å®¢æˆ·ç«¯åœ¨å¤–ç½‘çš„IPåœ°å€+ç«¯å£ soï¼š åº”ç”¨ç¨‹åºå¯ä»¥è·å¾—å¤–ç½‘ IP å’Œç«¯å£ï¼Œå¹¶åˆ©ç”¨è¿™äº›ä¿¡æ¯ä¸å¯¹ç«¯é€šä¿¡; å‘é€åˆ° STUN æœåŠ¡å™¨çš„å‡ºç«™ç»‘å®šè¯·æ±‚å°†åœ¨é€šä¿¡è¦ç»è¿‡çš„ NAT ä¸­å»ºç«‹è·¯ç”±æ¡ç›®ï¼Œ ä½¿å¾—åˆ°è¾¾è¯¥ IP å’Œç«¯å£çš„å…¥ç«™åˆ†ç»„å¯ä»¥æ‰¾åˆ°å†…ç½‘ä¸­çš„åº”ç”¨ç¨‹åº; STUN åè®®å®šä¹‰äº†ä¸€ä¸ªç®€å• keep-alive æ¢æµ‹æœºåˆ¶ï¼Œå¯ä»¥ä¿è¯ NAT è·¯ç”±æ¡ç›®ä¸è¶…æ—¶ã€‚ ä¸¤å°ä¸»æœºç«¯éœ€è¦é€šè¿‡ UDP é€šä¿¡æ—¶ï¼Œå®ƒä»¬é¦–å…ˆéƒ½ä¼šå‘å„è‡ªçš„ STUN æœåŠ¡å™¨å‘é€ç»‘å®šè¯·æ±‚ï¼Œç„¶ååˆ†åˆ«ä½¿ç”¨å“åº”ä¸­çš„å¤–ç½‘ IP åœ°å€å’Œç«¯å£å·äº¤æ¢æ•°æ®ã€‚ã€ä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒSTUN å¹¶ä¸èƒ½é€‚åº”æ‰€æœ‰ç±»å‹çš„ NAT å’Œç½‘ç»œé…ç½®ã€‚ä¸ä»…å¦‚æ­¤ï¼ŒæŸäº› æƒ…å†µä¸‹ UDP è¿˜ä¼šè¢«é˜²ç«å¢™æˆ–å…¶ä»–ç½‘ç»œè®¾å¤‡å®Œå…¨å±è”½æ‰€ä»¥è¦è€ƒè™‘ä½¿ç”¨TURNã€‘ TURN(Traversal Using Relays around NAT) TURN(Traversal Using Relays around NAT)åè®®(RFC 5766)ï¼šTURN ä¸­çš„å…³é”®è¯å½“ç„¶æ˜¯ä¸­ç»§(relay)ã€‚è¿™ä¸ªåè®®ä¾èµ–äºå¤–ç½‘ä¸­ç»§è®¾å¤‡(å›¾ 3-6)åœ¨ ä¸¤ç«¯é—´ä¼ é€’æ•°æ® ä¸¤ç«¯éƒ½è¦å‘åŒä¸€å° TURN æœåŠ¡å™¨å‘é€åˆ†é…è¯·æ±‚æ¥å»ºç«‹è¿æ¥ï¼Œç„¶åå†è¿›è¡Œæƒé™åå•†ã€‚åå•†å®Œæ¯•ï¼Œä¸¤ç«¯éƒ½æŠŠæ•°æ®å‘é€åˆ° TURN æœåŠ¡å™¨ï¼Œå†ç”± TURN æœåŠ¡å™¨è½¬å‘ï¼Œä»è€Œå®ç°é€šä¿¡ soï¼š è¿™æ ·å·²ç»ä¸å†æ˜¯ç«¯å¯¹ç«¯çš„æ•°æ®è¾ƒäº¤æ¢ è¿ç»´TURNæœåŠ¡å™¨çš„æŠ•å…¥å¾ˆå¤§ ä¸­ç»§è®¾å¤‡å®¹é‡å¿…é¡»è¶³å¤Ÿå¤§ å®é™…åº”ç”¨ä¸­ï¼Œæœ€å¥½åœ¨å…¶ä»–ç›´è¿æ‰‹æ®µéƒ½å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œå†ä½¿ç”¨ TURNã€‚ ICE(Interactive Connectivity Establishment) ICE(Interactive Connectivity Establishment)åè®®(RFC 5245)ï¼šè‡´åŠ›åœ¨é€šä¿¡å„ç«¯ä¹‹é—´å»ºç«‹ä¸€æ¡æœ€æœ‰æ•ˆçš„é€šé“(å›¾ 3-7):èƒ½ç›´è¿å°±ç›´è¿ï¼Œå¿…è¦æ—¶ STUN åå•†ï¼Œå†ä¸è¡Œä½¿ç”¨ TURN UDPä¼˜åŒ–å»ºè®® åº”ç”¨ç¨‹åºå¿…é¡»å®¹å¿å„ç§å› ç‰¹ç½‘è·¯å¾„æ¡ä»¶; åº”ç”¨ç¨‹åºåº”è¯¥æ§åˆ¶ä¼ è¾“é€Ÿåº¦; åº”ç”¨ç¨‹åºåº”è¯¥å¯¹æ‰€æœ‰æµé‡è¿›è¡Œæ‹¥å¡æ§åˆ¶; åº”ç”¨ç¨‹åºåº”è¯¥ä½¿ç”¨ä¸ TCP ç›¸è¿‘çš„å¸¦å®½; åº”ç”¨ç¨‹åºåº”è¯¥å‡†å¤‡åŸºäºä¸¢åŒ…çš„é‡å‘è®¡æ•°å™¨; åº”ç”¨ç¨‹åºåº”è¯¥ä¸å‘é€å¤§äºè·¯å¾„ MTU çš„æ•°æ®æŠ¥; åº”ç”¨ç¨‹åºåº”è¯¥å¤„ç†æ•°æ®æŠ¥ä¸¢å¤±ã€é‡å¤å’Œé‡æ’; åº”ç”¨ç¨‹åºåº”è¯¥è¶³å¤Ÿç¨³å®šä»¥æ”¯æŒ 2 åˆ†é’Ÿä»¥ä¸Šçš„äº¤ä»˜å»¶è¿Ÿ; åº”ç”¨ç¨‹åºåº”è¯¥æ”¯æŒ IPv4 UDP æ ¡éªŒå’Œï¼Œå¿…é¡»æ”¯æŒ IPv6 æ ¡éªŒå’Œ; åº”ç”¨ç¨‹åºå¯ä»¥åœ¨éœ€è¦æ—¶ä½¿ç”¨ keep-alive(æœ€å°é—´éš” 15 ç§’)ã€‚ æˆ‘å¾ˆé«˜å…´å‘Šè¯‰å¤§å®¶:WebRTC å°±æ˜¯ç¬¦åˆè¿™äº›è¦æ±‚çš„æ¡†æ¶!ï¼ˆåé¢æœ‰æœºä¼šï¼Œå¯ä»¥ç ”ç©¶ä¸‹ï¼Œå†å†™æ–‡ç« ï¼‰","tags":[{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://alfredzhenyu.github.io/tags/ç½‘ç»œ/"},{"name":"TCP","slug":"TCP","permalink":"http://alfredzhenyu.github.io/tags/TCP/"}]},{"title":"ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°(ä¸€)","date":"2016-12-23T05:03:13.000Z","path":"2016/12/23/ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆä¸€ï¼‰/","text":"ç›®å½•ï¼š ç¬¬ä¸€éƒ¨åˆ† ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ ç¬¬ä¸€ç«  å»¶è¿Ÿä¸å¸¦å®½ ç¬¬äºŒç«  TCPçš„æ„æˆ ç¬¬ä¸€éƒ¨åˆ† ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆç¬¬ä¸€ç«  å»¶è¿Ÿä¸å¸¦å®½ å¯¹ç½‘ç»œé€šä¿¡é€šä¿¡éƒ¨åˆ†èµ·å†³å®šæ€§å› ç´ çš„æœ‰ä¸¤æ–¹é¢ï¼š å»¶è¿Ÿï¼šåˆ†ç»„ä»ä¿¡æ¯æºåˆ°è¾¾ç›®çš„åœ°æ‰€éœ€çš„æ—¶é—´ å¸¦å®½ï¼šé€»è¾‘æˆ–ç‰©ç†é€šä¿¡æœ€å¤§ååé‡ å»¶è¿Ÿçš„æ„æˆ ä¼ æ’­å»¶è¿Ÿï¼šæ¶ˆæ¯ä»å‘é€ç«¯åˆ°æ¥æ”¶ç«¯éœ€è¦çš„æ—¶é—´ï¼Œæ˜¯ä¿¡å·ä¼ æ’­è·ç¦»å’Œé€Ÿåº¦çš„å‡½æ•° ä¼ è¾“å»¶è¿Ÿï¼šæŠŠæ¶ˆæ¯ä¸­çš„æ‰€æœ‰æ¯”ç‰¹è½¬ç§»åˆ°é“¾è·¯ä¸­éœ€è¦çš„æ—¶é—´ï¼Œæ˜¯æ¶ˆæ¯é•¿åº¦å’Œé“¾è·¯é€Ÿç‡çš„å‡½æ•° å¤„ç†å»¶è¿Ÿï¼šå¤„ç†åˆ†ç»„é¦–éƒ¨ã€æ£€æŸ¥ä½é”™è¯¯åŠç¡®å®šåˆ†ç»„ç›®æ ‡æ‰€éœ€çš„æ—¶é—´ æ’é˜Ÿå»¶è¿Ÿï¼šåˆ°æ¥çš„åˆ†ç»„æ’é˜Ÿç­‰å¾…å¤„ç†çš„æ—¶é—´å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„æ€»å»¶è¿Ÿæ—¶é—´ä¸ºä»¥ä¸Šå»¶è¿Ÿæ—¶é—´çš„æ€»å’Œ å¤§å¤šæ•°ç½‘ç«™æ€§èƒ½çš„ç“¶é¢ˆéƒ½æ˜¯å»¶è¿Ÿï¼Œè€Œä¸æ˜¯å¸¦å®½ ç›®æ ‡ï¼šé«˜å¸¦å®½+ä½å»¶è¿Ÿ å»¶è¿Ÿå¯¹ç”¨æˆ·ä½“éªŒçš„å½±å“: ç¬¬äºŒç«  TCPçš„æ„æˆå‰è¨€å› ç‰¹ç½‘ä¸¤ä¸ªæ ¸å¿ƒåè®®ï¼š TCPï¼š Transmission Control Protocol â€”â€”â€” RFC 791 IPï¼š Internet Protocol â€”â€”â€” RFC 793ã€HTTPæ ‡å‡†å¹¶æœªè§„å®šTCPå°±æ˜¯å”¯ä¸€çš„ä¼ è¾“åè®®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡UDPæˆ–è€…å…¶ä»–åè®®æ¥å‘é€HTTPæ¶ˆæ¯ã€‘ æ¡æ‰‹ä¸‰æ¬¡æ¡æ‰‹ï¼šä¸‰æ¬¡æ¡æ‰‹çš„ç»†èŠ‚å°±ä¸è®²äº†ï¼Œè¿™é‡Œä¸»è¦æƒ³è¯´çš„æ˜¯å…¶å¸¦æ¥çš„å»¶è¿Ÿï¼Œä½¿å¾—æ¯åˆ›å»ºä¸€ä¸ªæ–° TCP è¿æ¥éƒ½è¦ä»˜å‡ºå¾ˆå¤§ä»£ä»·ã€‚è€Œæé«˜TCPæ€§èƒ½çš„å…³é”®ï¼Œåœ¨äºæƒ³åŠæ³•é‡ç”¨è¿æ¥ï¼šTCP å¿«é€Ÿæ‰“å¼€ï¼ˆTCP Fast Open TFOï¼‰ï¼šç”±äºéå¸¸çŸ­çš„ TCP è¿æ¥åœ¨ äº’è”ç½‘ä¸Šéšå¤„å¯è§ï¼Œæ¡æ‰‹é˜¶æ®µå·²ç»æˆä¸ºå½±å“ç½‘ç»œæ€»å»¶è¿Ÿçš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚ä¸ºè§£å†³ è¿™ä¸ªé—®é¢˜ï¼Œäººä»¬æ­£åœ¨ç§¯æå¯»æ‰¾å„ç§æ–¹æ¡ˆï¼Œå…¶ä¸­ TFO(TCP Fast Openï¼ŒTCP å¿«é€Ÿæ‰“ å¼€)å°±æ˜¯è¿™æ ·ä¸€ç§æœºåˆ¶ Linux 3.7 åŠä¹‹åçš„å†…æ ¸å·²ç»åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸­æ”¯æŒ TFOï¼Œå› æ­¤æˆä¸ºäº†å®¢æˆ·ç«¯å’Œ æœåŠ¡å™¨æ“ä½œç³»ç»Ÿé€‰å‹çš„æœ‰åŠ›å€™é€‰æ–¹æ¡ˆã€‚å³ä¾¿å¦‚æ­¤ï¼ŒTFO å¹¶ä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜ã€‚ å®ƒè™½ç„¶æœ‰åŠ©äºå‡å°‘ä¸‰æ¬¡æ¡æ‰‹çš„å¾€è¿”æ—¶é—´ï¼Œä½†å´åªèƒ½åœ¨æŸäº›æƒ…å†µä¸‹æœ‰æ•ˆ TODO:TFOæ€ä¹ˆå®ç°æ¡æ‰‹ä¼˜åŒ–çš„â€¦æ‹¥å¡é¢„é˜²åŠæ§åˆ¶ï¼š æµé‡æ§åˆ¶ æ‹¥å¡æ§åˆ¶ æ‹¥å¡é¢„é˜²æœºåˆ¶ æµé‡æ§åˆ¶ï¼š æ¥æ”¶çª—å£ï¼ˆrwndï¼‰ï¼šæ¯ä¸€æ–¹éƒ½è¦é€šå‘Šè‡ªå·±çš„æ¥æ”¶çª—å£ï¼ˆrwndï¼‰ï¼Œå…¶ä¸­åŒ…å«èƒ½å¤Ÿä¿å­˜æ•°æ®çš„ç¼“å†²åŒºå¤§å°ä¿¡æ¯ã€‚æ¯æ¬¡å‘é€çš„æ•°æ®éƒ½ä¸ä¼šå¤§äºè¿™ä¸ªçª—å£å€¼ã€‚å¦‚æœå…¶ä¸­ä¸€ç«¯ï¼ˆä¸€èˆ¬ä¸ºæ¥æ”¶ç«¯ï¼‰çš„ç¼“å†²åŒºè·Ÿä¸ä¸Šæ•°æ®ä¼ è¾“ï¼Œé‚£å®ƒä¼šå‘å‘é€ç«¯é€šå‘Šä¸€ä¸ªè¾ƒå°çš„çª—å£ï¼Œæ¥å‡å°‘æ¯æ¬¡åˆ†ç»„å‘é€çš„æ•°æ®ã€‚ å‡å¦‚çª—å£ä¸ºé›¶ï¼Œåˆ™æ„å‘³ç€å¿…é¡»ç”±åº”ç”¨å±‚å…ˆæ¸…ç©ºç¼“å†²åŒºï¼Œæ‰èƒ½å†æ¥æ”¶å‰©ä½™æ•°æ® çª—å£ç¼©æ”¾(RFC 1323)ï¼šæœ€åˆçš„TCPè§„èŒƒåˆ†é…ç»™é€šå‘Šçª—å£å¤§å°çš„å­—æ®µæ˜¯ 16ä½çš„,æœ€å¤§å€¼(65535å­—èŠ‚)ã€‚ç»“æœåœ¨è¿™ä¸ªé™åˆ¶å†…ç»å¸¸æ— æ³•è·å¾—æœ€ä¼˜æ€§èƒ½ï¼Œä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRFC 1323æä¾›äº†â€œTCP çª—å£ç¼©æ”¾â€(TCP Window Scaling)é€‰é¡¹ï¼Œ å¯ä»¥æŠŠæ¥æ”¶çª—å£å¤§å°ç”± 65 535 å­—èŠ‚æé«˜åˆ° 1G å­—èŠ‚ï¼Œç¼©æ”¾ TCP çª—å£æ˜¯åœ¨ä¸‰æ¬¡æ¡æ‰‹æœŸ é—´å®Œæˆçš„ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå€¼è¡¨ç¤ºåœ¨å°†æ¥çš„ ACK ä¸­å·¦ç§» 16 ä½çª—å£å­—æ®µçš„ä½æ•°ã€‚ ç°åœ¨ TCP çª—å£ç¼©æ”¾æœºåˆ¶åœ¨æ‰€æœ‰ä¸»è¦å¹³å°ä¸Šéƒ½æ˜¯é»˜è®¤å¯ç”¨çš„ã€‚ä¸è¿‡ï¼Œä¸­é—´èŠ‚ç‚¹å’Œ è·¯ç”±å™¨å¯ä»¥é‡å†™ï¼Œç”šè‡³å®Œå…¨å»æ‰è¿™ä¸ªé€‰é¡¹ã€‚å¦‚æœä½ çš„æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯çš„è¿æ¥ä¸èƒ½ å®Œå…¨åˆ©ç”¨ç°æœ‰å¸¦å®½ï¼Œé‚£å¾€å¾€è¯¥å…ˆæŸ¥ä¸€æŸ¥çª—å£å¤§å°ã€‚åœ¨ Linux ä¸­ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ ä»¤æ£€æŸ¥å’Œå¯ç”¨çª—å£ç¼©æ”¾é€‰é¡¹: 12$&gt; sysctl net.ipv4.tcp_window_scaling$&gt; sysctl -w net.ipv4.tcp_window_scaling=1 æ‹¥å¡çª—å£ æ‹¥å¡çª—å£ï¼ˆcwndï¼‰ï¼šå‘é€ç«¯ä¼šåˆå§‹åŒ–ä¸€ä¸ªæ‹¥å¡çª—å£ï¼ˆcwndï¼‰ï¼Œä½†ä¸ä¼šé€šå‘Šç»™å¯¹æ–¹ã€‚æ¯æ¬¡å‘é€çš„æ•°æ®éƒ½æ˜¯cwndå’Œrwndçš„æœ€å°å€¼ã€‚ æ…¢å¯åŠ¨ï¼šæ¯æ¬¡å»ºç«‹å®Œè¿æ¥ä¹‹åï¼Œé‡‡ç”¨é€æ­¥å¢å¤§æ‹¥å¡çª—å£å¤§å°çš„æ–¹å¼æ…¢æ…¢å¯åŠ¨ï¼Œæœ€åˆcwndä¸ºä¸€ä¸ªTCPæ®µï¼Œä¹‹åé‡‡ç”¨çš„æ˜¯â€æŒ‡æ•°å¢é•¿â€œçš„æ–¹å¼ï¼Œç›´åˆ°è¾¾åˆ°æ‹¥å¡é¢„é˜²æœºåˆ¶ç”Ÿæ•ˆä¸ºæ­¢ã€å› ä¸ºå¾ˆå¤šHTTPè¿æ¥éƒ½æ˜¯çŸ­æš‚çªå‘çš„è¿æ¥ï¼Œå¸¸å¸¸ä¼šå‡ºç°è¿˜æ²¡åˆ°è¾¾åˆ°æœ€å¤§é˜ˆå€¼å°±è¢«ç»ˆæ­¢çš„æƒ…å†µï¼Œå› ä¸ºæ…¢å¯åŠ¨ä¼šé™åˆ¶å¯ç”¨çš„ååé‡ï¼Œè€Œè¿™å¯¹äºå°æ–‡ä»¶ä¼ è¾“éå¸¸ä¸åˆ©ã€‚ã€‘ ç°åœ¨ç›®å‰å¤§å¤šæ•°æœåŠ¡å™¨ä¸­å¸¸è§çš„åˆå§‹æ‹¥å¡çª—å£ä¸ºï¼š4æ®µï¼ˆRFC 2581è§„å®šï¼‰ï¼Œä¸ºå‡å°‘æ…¢å¯åŠ¨çš„æ—¶é—´ï¼Œå¯ä»¥å°è¯•æŠŠåˆå§‹æ‹¥å¡çª—å£å¤§å°å¢åŠ åˆ°10æ®µï¼ˆRFC 9828è§„å®šï¼‰ æ…¢å¯åŠ¨é‡å¯ï¼ˆSlow-Start Restart SSRï¼‰ï¼šè¿™ç§æœºåˆ¶ä¼šåœ¨è¿æ¥ç©ºé—²ä¸€å®šæ—¶é—´åé‡ç½®è¿æ¥çš„æ‹¥å¡çª—å£ã€‚é“ç†å¾ˆç®€å•ï¼Œ åœ¨è¿æ¥ç©ºé—²çš„åŒæ—¶ï¼Œç½‘ç»œçŠ¶å†µä¹Ÿå¯èƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸ºäº†é¿å…æ‹¥å¡ï¼Œç†åº”å°†æ‹¥å¡çª— å£é‡ç½®å›â€œå®‰å…¨çš„â€é»˜è®¤å€¼ã€‚ SSR å¯¹äºé‚£äº›ä¼šå‡ºç°çªå‘ç©ºé—²çš„é•¿å‘¨æœŸ TCP è¿æ¥(æ¯”å¦‚ HTTP çš„ keep-alive è¿æ¥)æœ‰å¾ˆå¤§çš„å½±å“ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å»ºè®®åœ¨æœåŠ¡å™¨ä¸Šç¦ç”¨ SSRã€‚åœ¨ Linux å¹³å°ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥æ£€æŸ¥å’Œç¦ç”¨ SSR: 12$&gt; sysctl net.ipv4.tcp_slow_start_after_idle$&gt; sysctl -w net.ipv4.tcp_slow_start_after_idle=0 æ‹¥å¡é¢„é˜²æœºåˆ¶ æ‹¥å¡é˜ˆå€¼(ssthresh)çª—å£ï¼šæ…¢å¯åŠ¨ä»¥ä¿å®ˆçš„çª—å£åˆå§‹åŒ–è¿æ¥ï¼Œéšåçš„ æ¯æ¬¡å¾€è¿”éƒ½ä¼šæˆå€æé«˜ä¼ è¾“çš„æ•°æ®é‡ï¼Œç›´åˆ°è¶…è¿‡æ¥æ”¶ç«¯çš„æµé‡æ§åˆ¶çª—å£ï¼Œå³ç³»ç»Ÿ é…ç½®çš„æ‹¥å¡é˜ˆå€¼(ssthresh)çª—å£ï¼Œæˆ–è€…æœ‰åˆ†ç»„ä¸¢å¤±ä¸ºæ­¢ï¼Œæ­¤æ—¶æ‹¥å¡é¢„é˜²ç®—æ³•ä»‹å…¥ &emsp; AIMD(Multiplicative Decrease and Additive Increaseï¼Œå€å‡åŠ å¢) ç®—æ³•ï¼šå³å‘ç”Ÿä¸¢åŒ…æ—¶ï¼Œå…ˆå°†æ‹¥å¡çª—å£å‡åŠï¼Œç„¶åæ¯æ¬¡å¾€è¿”å†ç¼“æ…¢åœ°ç»™çª—å£å¢åŠ ä¸€ ä¸ªå›ºå®šçš„å€¼ã€‚ä¸è¿‡ï¼Œå¾ˆå¤šæ—¶å€™ AIMD ç®—æ³•å¤ªè¿‡ä¿å®ˆï¼Œå› æ­¤åˆæœ‰äº†æ–°çš„ç®—æ³•ã€‚ &emsp; PRR(Proportional Rate Reductionï¼Œæ¯”ä¾‹é™é€Ÿ)ç®—æ³•ï¼šå°±æ˜¯ RFC 6937 è§„å®šçš„ä¸€ä¸ªæ–°ç®—æ³•ï¼Œ å…¶ç›®æ ‡å°±æ˜¯æ”¹è¿›ä¸¢åŒ…åçš„æ¢å¤é€Ÿåº¦ã€‚æ”¹è¿›æ•ˆæœå¦‚ä½•å‘¢?æ ¹æ®è°·æ­Œçš„æµ‹é‡ï¼Œå®ç°æ–° ç®—æ³•åï¼Œå› ä¸¢åŒ…é€ æˆçš„å¹³å‡è¿æ¥å»¶è¿Ÿå‡å°‘äº† 3%~10%ã€‚ TODO:PRRå¦‚ä½•æ”¹è¿›ä¸¢åŒ…çš„æ¢å¤é€Ÿåº¦çš„â€¦ å…¶ä»– å¸¦å®½å»¶è¿Ÿç§¯ï¼ˆBandwidth-delay productï¼ŒBDPï¼‰ï¼šä»»æ„æ—¶åˆ»å¤„äºåœ¨å‘é€é€”ä¸­è¿˜æœªæ”¶åˆ°ACKçŠ¶æ€çš„æœ€å¤§æ•°æ®é‡ = æ•°æ®é“¾è·¯çš„å®¹é‡ï¼ˆå¸¦å®½ï¼‰ * ç«¯åˆ°ç«¯çš„å»¶è¿Ÿ é˜Ÿé¦–(HOLï¼ŒHead of Line)é˜»å¡ï¼šæ¯ä¸ªTCPåˆ†ç»„éƒ½ä¼šå¸¦ç€ä¸€ä¸ªå”¯ä¸€çš„åºåˆ—å·è¢«å‘ï¼Œè€Œå†å¯¹äºåº”ç”¨å±‚è€Œè¨€ï¼Œæ‰€æœ‰åˆ†ç»„å¿…é¡»æ˜¯æŒ‰é¡ºåºä¼ é€åˆ°æ¥æ”¶ç«¯ã€‚å¦‚æœTCPåœ¨æ¥æ”¶ä¸­ä¸­é€”æœ‰ä¸€ä¸ªåˆ†ç»„æ²¡èƒ½åˆ°è¾¾æ¥æ”¶ç«¯çš„ä¼ è¾“å±‚ï¼Œé‚£ä¹ˆåç»­åˆ†ç»„å¿…é¡»ä¿å­˜åœ¨æ¥æ”¶ç«¯çš„ TCP ç¼“å†²åŒºï¼Œç­‰å¾…ä¸¢å¤±çš„åˆ†ç»„é‡å‘å¹¶åˆ°è¾¾æ¥æ”¶ç«¯ï¼Œä¹‹åå†ä¸€èµ·æäº¤åˆ°åº”ç”¨å±‚ï¼Œè€Œåº”ç”¨å±‚åœ¨æ¥æ”¶ç«¯åªèƒ½æ„Ÿå—åˆ°è¿™ç§æ•´ä½“çš„å»¶è¿Ÿã€‚è¿™ç§æ•ˆåº”ç§°ä¸º TCP çš„é˜Ÿé¦–é˜»å¡ æŠ–åŠ¨ï¼šç”±äºé˜Ÿé¦–é˜»å¡é€ æˆçš„å»¶è¿Ÿåˆ†ç»„é€ æˆç›¸åº”çš„é‡æ’å’Œé‡ç»„ï¼Œé€ æˆåˆ†ç»„åˆ°è¾¾å»¶è¿Ÿæ— æ³•é¢„çŸ¥ã€‚è¿™ä¸ªå»¶è¿Ÿæ—¶é—´çš„å˜åŒ–é€šå¸¸è¢«ç§°ä¸ºæŠ–åŠ¨ï¼Œä¹Ÿæ˜¯å½±å“åº”ç”¨ç¨‹åºæ€§èƒ½çš„ä¸€ä¸ªä¸»è¦å› ç´ ã€æ— éœ€æŒ‰åºäº¤ä»˜æ•°æ®æˆ–èƒ½å¤Ÿå¤„ç†åˆ†ç»„ä¸¢å¤±çš„åº”ç”¨ç¨‹åºï¼Œä»¥åŠå¯¹å»¶è¿Ÿæˆ–æŠ–åŠ¨è¦æ±‚å¾ˆé«˜çš„åº”ç”¨ç¨‹åºï¼Œæœ€å¥½é€‰æ‹© UDP ç­‰åè®®ã€‚æ¯”å¦‚è¯­éŸ³å’Œæ¸¸æˆçŠ¶æ€é€šä¿¡ï¼š&emsp; éŸ³é¢‘ç¼–è§£ç å™¨ï¼šå°±ç®—æœ‰ä¸ªåŒ…ä¸¢äº†ï¼Œåªè¦åœ¨éŸ³é¢‘ä¸­æ’å…¥ä¸€ä¸ªå°å°çš„é—´æ­‡ï¼Œå°±å¯ä»¥ç»§ç»­ å¤„ç†åæ¥çš„åŒ…ã€‚åªè¦é—´æ­‡å¤Ÿå°ï¼Œç”¨æˆ·å°±æ³¨æ„ä¸åˆ°ï¼Œè€Œç­‰å¾…ä¸¢å¤±çš„åŒ…åˆ™å¯èƒ½å¯¼è‡´éŸ³ é¢‘è¾“å‡ºäº§ç”Ÿæ— æ³•é¢„æ–™çš„æš‚åœã€‚ç›¸å¯¹æ¥è¯´ï¼Œåè€…çš„ç”¨æˆ·ä½“éªŒæ›´ç³Ÿç³•ã€‚&emsp; 3D æ¸¸æˆä¸­è§’è‰²æ›´æ–°çŠ¶æ€ä¹Ÿä¸€æ ·:æ”¶åˆ° T æ—¶åˆ»çš„åŒ…è€Œç­‰å¾… T-1 æ—¶åˆ»çš„ åŒ…é€šå¸¸æ¯«æ— å¿…è¦ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåº”è¯¥å¯ä»¥æ¥æ”¶æ‰€æœ‰çŠ¶æ€æ›´æ–°ï¼Œä½†ä¸ºé¿å…æ¸¸æˆå»¶è¿Ÿï¼Œ é—´æ­‡æ€§çš„ä¸¢åŒ…ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚ã€‘ TCPä¼˜åŒ–å»ºè®®ï¼š æœåŠ¡å™¨ä¼˜åŒ–ï¼š æ›´æ–°ç½®æœ€æ–°çš„å†…æ ¸ å¢å¤§TCPåˆå§‹æ‹¥å¡çª—å£ ç¦ç”¨æ…¢å¯åŠ¨é‡å¯ å¯ç”¨çª—å£ç¼©æ”¾ æ‰“å¼€TCPå¿«é€Ÿæ‰“å¼€ åº”ç”¨ç¨‹åºè°ƒä¼˜ é‡ç”¨å·²ç»å»ºç«‹çš„ TCP è¿æ¥ å‡å°‘ä¸‹è½½ä¸å¿…è¦çš„èµ„æº é€šè¿‡å‹ç¼©ç®—æ³•æŠŠè¦å‘é€çš„æ¯”ç‰¹æ•°é™åˆ°æœ€ä½ åœ¨ä¸åŒçš„åœ°åŒºéƒ¨ç½²æœåŠ¡ å™¨(æ¯”å¦‚ï¼Œä½¿ç”¨ CDN)ï¼ŒæŠŠæ•°æ®æ”¾åˆ°æ¥è¿‘å®¢æˆ·ç«¯çš„åœ°æ–¹","tags":[{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://alfredzhenyu.github.io/tags/ç½‘ç»œ/"},{"name":"TCP","slug":"TCP","permalink":"http://alfredzhenyu.github.io/tags/TCP/"}]},{"title":"èµ„æºç›®å½•æ•´ç†","date":"2016-12-22T06:22:40.000Z","path":"2016/12/22/èµ„æºç›®å½•æ•´ç†/","text":"å¹³æ—¶æ¯å¤©éƒ½ä¼šæ‰“å¼€å‡ åä¸ªç½‘ç«™æ²¡æ—¶é—´ä¸€ä¸€æ¶ˆåŒ–ï¼Œå°±ä¸€ç›´æ™¾ç€è¶Šç§¯è¶Šå¤šï¼Œæ”¶è—å¤¹ä¹Ÿå¤ªå¤šï¼Œä¸€èˆ¬å¡è¿›å»å°±ä¸ä¼šç¿»å‡ºæ¥çœ‹ï¼Œæ‰€ä»¥ç®¡ç†èµ·æ¥ä¹Ÿæ˜¯éº»çƒ¦â€¦æœ¬ç¯‡å°±ä¼šæŠŠä¹‹å‰è‡ªå·±æ¶‰åŠçš„é¢†åŸŸä½¿ç”¨åˆ°çš„æœ‰ç”¨çš„å­¦ä¹ ç½‘ç«™æ±‡æ€»èµ·æ¥ï¼Œåˆ†äº«ç»™å¤§å®¶ï¼Œä¹Ÿæ–¹ä¾¿è‡ªå·±çš„å­¦ä¹ ç®¡ç†ï¼š åè®®ã€ç½‘ç»œç›¸å…³å­¦ä¹ ç½‘ç«™ åè®®åˆ†æã€ç½‘ç»œå®‰å…¨ â€‹ ä¼˜ç§€åšå®¢OpenGLç›¸å…³å­¦ä¹ ç½‘ç«™ é€šä¿—è¯­è¨€è§£é‡ŠOpenGLä¸­ç€è‰²å™¨ï¼Œæ¸²æŸ“ç®¡çº¿ï¼Œå…‰æ …åŒ– â€‹ ä¼˜ç§€åšå®¢iOSå­¦ä¹ ç½‘ç«™ Apple Open Source Core Foundation API å…³äºOCçš„æ¯å‘¨æ›´æ–°çš„å¤–æ–‡å¯¼èˆªç½‘ç«™ google Objective-Cå¼€æºé¡¹ç›®é£æ ¼æŒ‡å— google C++å¼€æºé¡¹ç›®é£æ ¼æŒ‡å— iOS API Reference ä¼˜ç§€åšå®¢ RunLoopè§£æ(YYKitä½œè€…çš„blog) iOSå¼€æºä»£ç è§£æ NSArrayã€NSDictionaryåº•å±‚å®ç° GlowæŠ€æœ¯åšå®¢ Matt Gallagherâ€™s blog å…¶ä»–å­¦ä¹ è¯­è¨€å­¦ä¹ ç½‘ç«™ èœé¸Ÿå­¦ä¹ ç½‘ç«™ â€‹","tags":[{"name":"æ€»ç»“","slug":"æ€»ç»“","permalink":"http://alfredzhenyu.github.io/tags/æ€»ç»“/"}]},{"title":"ç¬¬ä¸€ç¯‡åšå®¢","date":"2016-12-21T06:44:34.000Z","path":"2016/12/21/ç¬¬ä¸€ç¯‡åšå®¢/","text":"ä¹‹å‰å°±ä¸€ç›´æƒ³æŠ½ç©ºæä¸‹è‡ªå·±çš„æŠ€æœ¯åšå®¢ï¼Œä½†æ˜¯ä¸€ç›´å¿™è¿™å¿™é‚£çš„ï¼Œæ²¡æ—¶é—´æï¼Œä½†å¼€blogï¼Œæ— è®ºå¯¹æ‰¾å·¥ä½œä¹Ÿå¥½ï¼Œæå‡è‡ªå·±çš„èƒ½åŠ›ï¼Œä¸°å¯Œè‡ªå·±çš„ç”Ÿæ´»ä¹Ÿç½¢ï¼Œæ„Ÿè§‰å¯¹è‡ªå·±éƒ½æœ‰å¥½å¤„ã€‚è€Œä¸”æœ€è¿‘å—åˆ°å„ç§åˆºæ¿€ï¼ŒæŠŠè‡ªå·±çš„æŠ€æœ¯æ²‰æ·€ä¸‹å»çš„è¿™ç§æœŸæœ›è¶Šæ¥è¶Šå¼ºï¼Œäºæ˜¯æŠŠæ—¶é—´è…¾å¼€æŠŠæƒ³æå·²ä¹…çš„blogå¼€èµ·æ¥â€¦ä¹Ÿå¸Œæœ›è‡ªå·±ä»¥åèƒ½å¤šå¤šæŠ½æ—¶é—´æŠŠè‡ªå·±äº†è§£åˆ°çš„æŠ€æœ¯ï¼Œéƒ½å½’çº³æ€»ç»“èµ·æ¥å§ï¼ˆè™½ç„¶æ„Ÿè§‰é¡¹ç›®ä¸€å¿™èµ·æ¥ï¼Œè¿™äº›éƒ½æ˜¯ç©ºè¯â€¦ï¼‰ æƒ³ç”¨ä¹‹å‰åŒäº‹è¯´çš„ä¸€å¥è¯ä½œä¸ºç»“å°¾ï¼Œæ€»ç»“æœ€è¿‘çš„ç”Ÿæ´»ï¼š ç”Ÿæ´»é™¤äº†çœ¼å‰çš„è‹Ÿä¸”â€¦ è¿˜æœ‰è¿œæ–¹çš„è‹Ÿä¸”â€¦","tags":[{"name":"ç”Ÿæ´»","slug":"ç”Ÿæ´»","permalink":"http://alfredzhenyu.github.io/tags/ç”Ÿæ´»/"}]}]