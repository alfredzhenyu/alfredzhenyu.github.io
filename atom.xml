<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Alfredzhenyu</title>
  <subtitle>Life &amp; Tech</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://alfredzhenyu.github.io/"/>
  <updated>2017-03-15T06:57:52.000Z</updated>
  <id>http://alfredzhenyu.github.io/</id>
  
  <author>
    <name>Alfred</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>åœ¨Macä¸‹ç”¨Xcode8ç¼–è¯‘libtorrentåº“</title>
    <link href="http://alfredzhenyu.github.io/2017/03/15/%E5%9C%A8Mac%E4%B8%8B%E7%94%A8Xcode%E7%BC%96%E8%AF%91libtorrent%E5%BA%93/"/>
    <id>http://alfredzhenyu.github.io/2017/03/15/åœ¨Macä¸‹ç”¨Xcodeç¼–è¯‘libtorrentåº“/</id>
    <published>2017-03-15T02:28:43.000Z</published>
    <updated>2017-03-15T06:57:52.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å’Œå¾€å¸¸ä¸€æ ·æ¯æ¬¡æ¥è§¦æ–°çš„çŸ¥è¯†ï¼Œç¬¬ä¸€æ­¥å®‰è£…ç¼–è¯‘å°±ä¼šå¡ä¸ªåŠå¤©ï¼Œæ„Ÿè§‰åˆ«äººé‡åˆ°çš„æ‰€æœ‰é—®é¢˜éƒ½ç»å†è¿‡ä¸€éä¸€æ ·ï¼Œä½†åŸºæœ¬æœ€åéƒ½è§£å†³äº†ï¼Œè¿˜æ˜¯ä»¬è®©äººæ¬£æ…°çš„ã€‚ä¸è¿‡ç°åœ¨æ›´å–œæ¬¢æŠŠè¿™äº›ä¸œè¥¿è®°å½•ä¸‹æ¥ï¼Œä»¥åå›é¡¾èµ·æ¥ä¹Ÿæ–¹ä¾¿ï¼Œä¹Ÿæ–¹ä¾¿åˆ«äººã€‚</p>
<p>ä»Šå¤©è¦ç¼–è¯‘çš„æ˜¯<a href="http://www.rasterbar.com/products/libtorrent/index.html" target="_blank" rel="external">rasterbarçš„libtorrent</a></p>
<p>githubæµè¡Œçš„æœ‰ä¸¤ä¸ªä¸åŒçš„libtorrentåº“ï¼Œå…·ä½“çš„åŒºåˆ«å¯è§ğŸ‘‡çš„blogï¼š</p>
<p><a href="http://blog.chinaunix.net/uid-736168-id-375924.html" target="_blank" rel="external">ä¸¤ä¸ªlibtorrentåº“çš„åŒºåˆ«</a></p>
<a id="more"></a>
<h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p>libtorrentæœ¬èº«ä¾èµ–OpenSSLã€boostä¸¤ä¸ªåº“ï¼Œæ‰€ä»¥è¦ç¼–è¯‘è¿™ä¸¤ä¸ªåº“</p>
<h3 id="ç¼–è¯‘OpenSSL"><a href="#ç¼–è¯‘OpenSSL" class="headerlink" title="ç¼–è¯‘OpenSSL"></a>ç¼–è¯‘OpenSSL</h3><ol>
<li><p>ç›´æ¥ä¸Šgithubï¼Œä¸‹è½½æºç ï¼š<a href="https://github.com/openssl/openssl" target="_blank" rel="external">OpenSSL</a>ï¼Œæˆ‘è¿™é‡Œä¸‹è½½çš„æ˜¯OpenSSL-1.1.1ç‰ˆæœ¬</p>
</li>
<li><p>å¦‚æœä¸æ˜¯cloneçš„è¯ï¼Œä¸‹è½½çš„æ˜¯å‹ç¼©åŒ…éœ€è¦è§£å‹</p>
</li>
<li><p>ç»ˆç«¯cdåˆ°ä¸‹è½½ä¸‹æ¥çš„æ–‡ä»¶å¤¹ç›®å½•å†…</p>
</li>
<li><p>ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ./Configure darwin64-x86_64-cc </div><div class="line">$ make</div><div class="line">$ make test</div><div class="line">$ make install</div></pre></td></tr></table></figure>
</li>
</ol>
<p>è¿™äº›æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­ä¹Ÿå‡ºç°è¿‡é”™è¯¯ï¼Œä½†å½“æ—¶å¾ˆå¿«å°±è§£å†³äº†ï¼Œæ‰€ä»¥æ²¡æˆªå±è®°ä¸‹æ¥ï¼Œè¦æ˜¯æœ‰é—®é¢˜çš„å¯ä»¥åœ¨ä¸‹é¢ç•™è¨€ã€‚</p>
<h3 id="ç¼–è¯‘boost"><a href="#ç¼–è¯‘boost" class="headerlink" title="ç¼–è¯‘boost"></a>ç¼–è¯‘boost</h3><p>booståº“å…¶å®å·²ç»ä¸æ˜¯ç¬¬ä¸€æ¬¡ç”¨åˆ°äº†ï¼ŒC++çš„ä¸€ä¸ªå¾ˆç‰›é€¼çš„åº“ï¼Œå…‰çœ‹å¤§å°å°±å¾ˆç‰›é€¼ï¼Œæºä»£ç å°±ä¸Šç™¾Mï¼Œæ‰§è¡Œå®Œç¼–è¯‘æŒ‡ä»¤ï¼Œæ‰“åŒ…åº“ç­‰æ“ä½œä¹‹åæ–‡ä»¶å¤¹ä¸Š1ç‚¹å¤šGï¼Œæ‰€ä»¥åœ¨é¡¹ç›®ä¸­è¦ä½¿ç”¨åˆ°boostçš„è¯ï¼Œèƒ½åˆ†ç¦»ä»£ç å°±åˆ†ç¦»å§ã€‚</p>
<p>å…¶å®ç¼–è¯‘boostæœ‰å¾ˆå¤šæ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡brewæˆ–è€…Macportç­‰å·¥å…·æ¥æï¼Œæˆ‘è¿™é‡Œå…¶å®ä¹Ÿæ˜¯å¯¹æºç æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œæ‰€ä»¥ç‰¹æ„ç”¨æ¯”è¾ƒåŸå§‹çš„æ–¹æ³•ï¼š</p>
<ol>
<li><p>ç›´æ¥ä¸‹è½½<a href="http://www.boost.org/" target="_blank" rel="external">booståº“</a>ï¼Œæˆ‘è¿™é‡Œä¸‹è½½çš„æ˜¯1.63ç‰ˆæœ¬</p>
</li>
<li><p>ä¸‹è½½å®Œåè§£å‹</p>
</li>
<li><p>æ‰“å¼€ç»ˆç«¯cdåˆ°å¯¹åº”çš„ç›®å½•</p>
</li>
<li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆéœ€è¦çš„æ—¶é—´æœ‰ç‚¹ä¹…ï¼Œå¯ä»¥å–æ¯å’–å•¡å…ˆï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ./bootstrap.sh</div><div class="line">$ ./b2</div><div class="line">$ sudo ./b2 install</div></pre></td></tr></table></figure>
</li>
</ol>
<p>å¦‚æœä¸å‡ºæ„å¤–ï¼Œå®‰è£…æˆåŠŸçš„è¯ï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ open usr/local</div></pre></td></tr></table></figure>
<p>ç„¶åä¼šæ‰“å¼€ä¸€ä¸ªFinderæ–‡ä»¶å¤¹</p>
<p>æ‰¾åˆ°includeç›®å½•ï¼Œçœ‹ä¸‹æœ‰æ²¡æœ‰boostã€opensslè¿™ä¸¤ä¸ªæ–‡ä»¶ç›®å½•</p>
<p>æ‰¾åˆ°libç›®å½•ï¼Œçœ‹ä¸‹æœ‰æ²¡æœ‰libboost_xxxç›¸å…³çš„.aæ–‡ä»¶</p>
<p>å¦‚æœéƒ½æ­£å¸¸çš„è¯ï¼Œåº”è¯¥æ²¡ä»€ä¹ˆå¤§é—®é¢˜</p>
<hr>
<p><strong>è¿˜æœ‰ä¸€ç§æ¯”è¾ƒé€šç”¨çš„æ£€æŸ¥æ–¹å¼ï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ open usr/local/opt</div></pre></td></tr></table></figure>
<p><strong>è¿™é‡Œé¢å®‰è£…äº†æ‰€æœ‰ä½ ç¼–è¯‘è¿‡çš„åº“ï¼Œè¿™å°±åŒ…æ‹¬äº†boostã€opensslä»¥åŠåé¢ç¼–è¯‘æˆåŠŸçš„libtorrentï¼Œä»¥åä½ å¦‚æœè¦ç¼–è¯‘åˆ«çš„åº“æ¯”å¦‚protobufè¿™ç±»çš„åº“ä¹Ÿæ˜¯éœ€è¦å„ç§ä¾èµ–ï¼Œä½ å°±å¯ä»¥æ¥è¿™ä¸ªç›®å½•æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰ç¼–è¯‘è¿‡ï¼Œä¸ç„¶å°±åªèƒ½å‚»å‚»åœ°ä¸€ä¸ªä¸ªè¯•</strong></p>
<h2 id="libtorrentç¼–è¯‘"><a href="#libtorrentç¼–è¯‘" class="headerlink" title="libtorrentç¼–è¯‘"></a>libtorrentç¼–è¯‘</h2><ol>
<li><p>ä¸Šå®˜ç½‘ä¸‹è½½<a href="http://www.libtorrent.org/index.html" target="_blank" rel="external">libtorrent</a></p>
</li>
<li><p>ä¸‹è½½å®Œæˆåç›´æ¥è§£å‹</p>
</li>
<li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ./configure --disable-debug</div><div class="line">$ make clean</div><div class="line">$ make</div><div class="line">$ sudo make install</div></pre></td></tr></table></figure>
</li>
</ol>
<p>å¦‚æœä¸å‡ºæ„å¤–çš„è¯ç°åœ¨å°±å¯ä»¥ç”¨ä»¥ä¸Šçš„æ–¹æ³•æŸ¥çœ‹åˆ°libtorrentçš„èº«å½±</p>
<h3 id="libtorrentä¸‹çš„Hello-world"><a href="#libtorrentä¸‹çš„Hello-world" class="headerlink" title="libtorrentä¸‹çš„Hello world"></a>libtorrentä¸‹çš„Hello world</h3><ol>
<li>æ–°å»ºä¸€ä¸ªXcode C++çš„Command Line Toolé¡¹ç›®</li>
<li>ç„¶åç‚¹å‡»é¡¹ç›®å·¥ç¨‹-Build Settings</li>
<li>æ‰¾åˆ°ä»¥ä¸‹å­—æ®µæ·»åŠ ä¸€æ¡è®°å½•</li>
</ol>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">HEADER_SEARCH_PATHS</span> =  /usr/local/include</div><div class="line"><span class="attr">LIBRARY_SEARCH_PATHS</span> = /usr/local/lib</div></pre></td></tr></table></figure>
<p>ï¼ˆç‰¹æ„å†™æˆ.xconfigçš„æ ¼å¼ï¼Œæ–¹ä¾¿ä½¿ç”¨xconfigç®¡ç†ç³»ç»Ÿé…ç½®é¡¹çš„åŒå¿—ä»¬ï¼‰</p>
<ol>
<li>æŠŠlibtorrentçš„examplesç›®å½•ä¸‹çš„æ–‡ä»¶æ‹–è¿›æ¥ç¼–è¯‘</li>
<li>â€¦ç½‘ä¸Šå¤§å¤šçš„èµ„æ–™åŸºæœ¬å†™åˆ°è¿™å°±å®Œäº†ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„é”™è¯¯å•Šâ€¦..boostçš„libtorrentçš„â€¦è¿™é‡Œä¸»è¦è®²ä¸‹æˆ‘é‡åˆ°çš„å‡ ä¸ªé”™è¯¯</li>
</ol>
<h3 id="é”™è¯¯åˆ†æ"><a href="#é”™è¯¯åˆ†æ" class="headerlink" title="é”™è¯¯åˆ†æ"></a>é”™è¯¯åˆ†æ</h3><ul>
<li>boostçš„systemå‡½æ•°æ²¡æ‰¾åˆ°</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">Undefined</span> <span class="selector-tag">symbols</span> <span class="selector-tag">for</span> <span class="selector-tag">architecture</span> <span class="selector-tag">x86_64</span>:</div><div class="line">  "<span class="selector-tag">boost</span><span class="selector-pseudo">::system</span><span class="selector-pseudo">::system_category()"</span>, <span class="selector-tag">referenced</span> <span class="selector-tag">from</span>:</div><div class="line">      <span class="selector-tag">boost</span><span class="selector-pseudo">::asio</span><span class="selector-pseudo">::error</span><span class="selector-pseudo">::get_system_category()</span> <span class="selector-tag">in</span> <span class="selector-tag">http_seed_connection</span><span class="selector-class">.o</span></div><div class="line">      ___<span class="selector-tag">cxx_global_var_init</span><span class="selector-class">.5</span> <span class="selector-tag">in</span> <span class="selector-tag">http_seed_connection</span><span class="selector-class">.o</span></div><div class="line">      <span class="selector-tag">boost</span><span class="selector-pseudo">::asio</span><span class="selector-pseudo">::error</span><span class="selector-pseudo">::get_system_category()</span> <span class="selector-tag">in</span> <span class="selector-tag">metadata_transfer</span><span class="selector-class">.o</span></div><div class="line">      ___<span class="selector-tag">cxx_global_var_init</span><span class="selector-class">.2</span> <span class="selector-tag">in</span> <span class="selector-tag">metadata_transfer</span><span class="selector-class">.o</span></div><div class="line">      <span class="selector-tag">boost</span><span class="selector-pseudo">::asio</span><span class="selector-pseudo">::error</span><span class="selector-pseudo">::get_system_category()</span> <span class="selector-tag">in</span> <span class="selector-tag">gzip</span><span class="selector-class">.o</span></div><div class="line">      <span class="selector-tag">boost</span><span class="selector-pseudo">::system</span><span class="selector-pseudo">::error_code</span><span class="selector-pseudo">::clear()</span> <span class="selector-tag">in</span> <span class="selector-tag">gzip</span><span class="selector-class">.o</span></div><div class="line">      ___<span class="selector-tag">cxx_global_var_init</span><span class="selector-class">.2</span> <span class="selector-tag">in</span> <span class="selector-tag">gzip</span><span class="selector-class">.o</span></div><div class="line">      ...</div><div class="line">  "<span class="selector-tag">boost</span><span class="selector-pseudo">::system</span><span class="selector-pseudo">::generic_category()"</span>, <span class="selector-tag">referenced</span> <span class="selector-tag">from</span>:</div><div class="line">      ___<span class="selector-tag">cxx_global_var_init</span><span class="selector-class">.3</span> <span class="selector-tag">in</span> <span class="selector-tag">http_seed_connection</span><span class="selector-class">.o</span></div><div class="line">      ___<span class="selector-tag">cxx_global_var_init</span><span class="selector-class">.4</span> <span class="selector-tag">in</span> <span class="selector-tag">http_seed_connection</span><span class="selector-class">.o</span></div><div class="line">      ___<span class="selector-tag">cxx_global_var_init</span> <span class="selector-tag">in</span> <span class="selector-tag">metadata_transfer</span><span class="selector-class">.o</span></div><div class="line">      ___<span class="selector-tag">cxx_global_var_init</span><span class="selector-class">.1</span> <span class="selector-tag">in</span> <span class="selector-tag">metadata_transfer</span><span class="selector-class">.o</span></div><div class="line">      ___<span class="selector-tag">cxx_global_var_init</span> <span class="selector-tag">in</span> <span class="selector-tag">gzip</span><span class="selector-class">.o</span></div><div class="line">      ___<span class="selector-tag">cxx_global_var_init</span><span class="selector-class">.1</span> <span class="selector-tag">in</span> <span class="selector-tag">gzip</span><span class="selector-class">.o</span></div><div class="line">      ___<span class="selector-tag">cxx_global_var_init</span> <span class="selector-tag">in</span> <span class="selector-tag">disk_io_job</span><span class="selector-class">.o</span></div><div class="line">      ...</div><div class="line"><span class="selector-tag">ld</span>: <span class="selector-tag">symbol</span>(<span class="selector-tag">s</span>) <span class="selector-tag">not</span> <span class="selector-tag">found</span> <span class="selector-tag">for</span> <span class="selector-tag">architecture</span> <span class="selector-tag">x86_64</span></div></pre></td></tr></table></figure>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<p>åˆšåˆšç¼–è¯‘å¥½çš„boostç›®å½•ä¸‹æœ‰ä¸ªstageç›®å½•ï¼Œç„¶ååœ¨libä¸‹æ‰¾åˆ°libboost_system.aï¼Œç›´æ¥é€šè¿‡Linked Frameworks and Libraries - add anotheræ·»åŠ è¿›é¡¹ç›®ä¸­</p>
<ul>
<li>libtorrentçš„å‡½æ•°æ²¡æ‰¾åˆ°</li>
</ul>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">Undefined symbols <span class="keyword">for</span> architecture x86_64:</div><div class="line">  <span class="string">"libtorrent::print_entry(libtorrent::bdecode_node const&amp;, bool, int)"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::bdecode_node::clear()"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::bdecode_node::bdecode_node()"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::torrent_info::torrent_info(libtorrent::bdecode_node const&amp;, boost::system::error_code&amp;, int)"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::torrent_info::~torrent_info()"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::make_magnet_uri(libtorrent::torrent_info const&amp;)"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::to_hex(char const*, int, char*)"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::to_hex(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;)"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::bdecode(char const*, char const*, libtorrent::bdecode_node&amp;, boost::system::error_code&amp;, int*, int, int)"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::file_storage::file_flags(int) const"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::file_storage::file_offset(int) const"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::file_storage::hash(int) const"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::file_storage::mtime(int) const"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::file_storage::symlink(int) const"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::file_storage::map_file(int, long long, int) const"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::file_storage::file_path(int, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;) const"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">  <span class="string">"libtorrent::file_storage::file_size(int) const"</span>, referenced <span class="keyword">from</span>:</div><div class="line">      <span class="variable">_main</span> <span class="built_in">in</span> dump_torrent.o</div><div class="line">ld: symbol(s) <span class="built_in">not</span> found <span class="keyword">for</span> architecture x86_64</div></pre></td></tr></table></figure>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<p>å…¶å®æˆ‘æ„Ÿè§‰åº”è¯¥æ˜¯æˆ‘ä¹‹å‰çš„æµç¨‹å‡ºç°é—®é¢˜ï¼Œä¸è¿‡ä¸å…¶å»æ£€æŸ¥æ¯ä¸ªæŠ¥é”™ä»¥åŠä¹‹å‰çš„ç¼–è¯‘æµç¨‹ï¼Œç½‘ä¸Šå¾ˆå¤šè§£é‡Šéƒ½æ˜¯åŸºäºwindowsä¸‹VSçš„ã€å¾ˆå°‘åŸºäºmacä¸‹Xcodeçš„èµ„æ–™ï¼Œæœ‰çš„è¯ä¹Ÿå› ä¸ºä¸åŒåº“ç¼–è¯‘ç‰ˆæœ¬ä¸åŒäº§ç”Ÿçš„ä¸åŒé”™è¯¯ã€‚</p>
<p>æˆ‘è¿™é‡Œè§£å†³æ–¹æ¡ˆæ˜¯å€’ä¸å¦‚ç›´æ¥æŠŠæºç æ·»åŠ åˆ°å·¥ç¨‹é‡Œå»ï¼Œè¿™æ ·ä¹Ÿæ–¹ä¾¿å­¦ä¹ ã€æºç çš„é˜…è¯»ã€‚</p>
<p>ä¸»è¦æ˜¯æŠŠ3ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„ä»£ç æ·»åŠ è¿›å·¥ç¨‹é‡Œå»ï¼š</p>
<ul>
<li><code>include/libtorrent</code>ä¸‹çš„ä»£ç ï¼ˆä¸»è¦æ˜¯å¤´æ–‡ä»¶hppï¼‰</li>
<li><code>src</code>ä¸‹çš„ä»£ç ï¼ˆä¸»è¦æ˜¯å†…éƒ¨æºç æ–‡ä»¶cppï¼‰</li>
<li><code>ed25519/src</code>ä¸‹çš„ä»£ç ï¼ˆcppã€hppï¼‰</li>
</ul>
<p>æ³¨ï¼š</p>
<ul>
<li><p>è¿è¡Œè¿‡ä¹‹å‰çš„å‘½ä»¤ä¹‹åï¼Œä¸Šè¿°æºç ç›®å½•ä¼šç”Ÿæˆä¸€å †<code>.lo</code>ã€<code>.o</code>æ–‡ä»¶ï¼Œè¿™äº›éƒ½æ˜¯ä¸éœ€è¦çš„ï¼Œæœ€å¥½ç›´æ¥é‡æ–°è§£å‹ä¸€ä»½æºç ï¼Œå–å‡ºéœ€è¦çš„ç›®å½•æ·»åŠ åˆ°å·¥ç¨‹ã€‚</p>
</li>
<li><p>éœ€è¦æ³¨æ„çš„æ˜¯æœ€å¥½å…ˆé‡æ–°å‘½å¥½åä¹‹åå†copyè¿›é¡¹ç›®é‡Œï¼Œä¸ç„¶ä¸¤ä¸ª<code>src</code>æ‹–è¿›å·¥ç¨‹é‡Œå»ä¼šäº§ç”Ÿå†²çª</p>
<p>â€‹</p>
</li>
</ul>
<p>æˆªè‡³ç›®å‰ï¼Œå…¶å®ç¼–è¯‘å·¥ä½œå°±åŸºæœ¬å®Œæˆçš„äº†ã€‚</p>
<p>è¿è¡ŒXcodeï¼Œè¾“å‡ºç³»ç»Ÿè‡ªå¸¦çš„Hello worldï¼Œå·¥ä½œå®Œæˆã€‚</p>
<p>å¯ä»¥æŠŠåŸç”Ÿçš„<code>main.cpp</code>æ–¹æ³•æ”¹æˆ<code>examples</code>ç›®å½•ä¸‹çš„å…¶ä»–cppæ–‡ä»¶è¿›è¡Œå­¦ä¹ </p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™é‡Œä¸»è¦é’ˆå¯¹ç»å†è¿‡æœ€åè¿™ä¸¤ç±»é”™è¯¯çš„äººï¼Œå¦‚æœå‰é¢æ­¥éª¤æœ¬èº«æ²¡é—®é¢˜çš„è¯ï¼Œå¤§å¯ä»¥å¿½ç•¥æ‰æˆ‘åé¢çš„é”™è¯¯å¤„ç†ã€‚å¦‚æœä¸€æ ·é‡åˆ°æˆ‘è¿™æ ·çš„é—®é¢˜ï¼Œå¯ä»¥æŒ‰ç…§æˆ‘çš„æ­¥éª¤å»åšã€‚</p>
<p>åŸç†å‘¢å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ol>
<li>é¦–å…ˆä¸çŸ¥é“booståº“æŒ‡ä»¤ç¼–è¯‘è¿‡ç¨‹åˆ°åº•å“ªé‡Œå‡ºé—®é¢˜ï¼Œsystemçš„åº“æ— æ³•è¯†åˆ«ï¼Œåªèƒ½æ‰‹åŠ¨æ·»åŠ è¿›å·¥ç¨‹é‡Œ</li>
<li>libtorrentå› ä¸ºæ²¡é“¾æ¥æˆåŠŸï¼Œè¿™é‡Œç›´æ¥æ”¾åˆ°ç¨‹åºé‡Œä¸€èµ·ç¼–è¯‘</li>
<li>é‚£ä¹ˆXcodeä¸Šé…ç½®çš„header pathã€library pathé“¾æ¥çš„ä¸»è¦å°±æ˜¯boostå…¶ä»–çš„åº“</li>
</ol>
<p>è¿™ä¸ªå·¥ç¨‹æœ‰å¯èƒ½å¹¶ä¸å®Œç¾ï¼Œæˆ‘æ²¡æœ‰å»è§£å†³ç³»ç»Ÿæˆ–è€…æŒ‡ä»¤çš„ä¸€äº›å†²çªé—®é¢˜ï¼Œä½†ç°åœ¨è¿™æ ·ä¹Ÿç‰¹åˆ«é€‚åˆå­¦ä¹ ï¼Œé¦–å…ˆboostã€opensslè¿™äº›åº“æˆ‘ä»¬å¯ä»¥ä¸ç”¨å…¨éƒ¨ä»£ç æ‹‰è¿›å·¥ç¨‹é‡Œå»ç¼–è¯‘ï¼ˆç›´æ¥Xcodeç¼–è¯‘boostè¦å¾ˆä¹…ï¼Œå¾ˆä¸å¥½ç®¡ç†ï¼Œè°è¯•è°çŸ¥é“ï¼‰ï¼ŒåŒæ—¶libtorrentä½œä¸ºæˆ‘ä»¬ä¸»è¦ä½¿ç”¨çš„åº“ï¼Œæˆ‘å¯ä»¥ç›´æ¥æ”¾åœ¨å·¥ç¨‹é‡Œï¼Œéšæ—¶æŸ¥çœ‹å†…éƒ¨çš„å®ç°æˆ–è€…å‘ï¼Œæ”¹èµ·æ¥ä¹Ÿæ¯”è¾ƒå®¹æ˜“ã€‚</p>
<p>éœ€è¦å­¦ä¹ çš„è¦æºç çš„å¯ä»¥è¯„è®ºä¸‹ï¼Œåç»­æœ‰æ—¶é—´æˆ‘ä¼šæŠŠä»£ç æäº¤åˆ°githubä¸Šï¼Œä¹‹å‰æ¸…è¿‡ä¸€égithubæ‰€ä»¥æ¯”è¾ƒç©ºï¼Œåç»­è€ƒè™‘é‡æ–°æèµ·æ¥</p>
<hr>
<p><center> <strong>â€”â€”Nothing is true, Everything is permitted</strong></center></p>
<p>(åŸè°…æˆ‘æœ€è¿‘è¢«Assassins Creedç”µå½±åœˆç²‰äº†â€¦â€¦.hhh)</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å’Œå¾€å¸¸ä¸€æ ·æ¯æ¬¡æ¥è§¦æ–°çš„çŸ¥è¯†ï¼Œç¬¬ä¸€æ­¥å®‰è£…ç¼–è¯‘å°±ä¼šå¡ä¸ªåŠå¤©ï¼Œæ„Ÿè§‰åˆ«äººé‡åˆ°çš„æ‰€æœ‰é—®é¢˜éƒ½ç»å†è¿‡ä¸€éä¸€æ ·ï¼Œä½†åŸºæœ¬æœ€åéƒ½è§£å†³äº†ï¼Œè¿˜æ˜¯ä»¬è®©äººæ¬£æ…°çš„ã€‚ä¸è¿‡ç°åœ¨æ›´å–œæ¬¢æŠŠè¿™äº›ä¸œè¥¿è®°å½•ä¸‹æ¥ï¼Œä»¥åå›é¡¾èµ·æ¥ä¹Ÿæ–¹ä¾¿ï¼Œä¹Ÿæ–¹ä¾¿åˆ«äººã€‚&lt;/p&gt;
&lt;p&gt;ä»Šå¤©è¦ç¼–è¯‘çš„æ˜¯&lt;a href=&quot;http://www.rasterbar.com/products/libtorrent/index.html&quot;&gt;rasterbarçš„libtorrent&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;githubæµè¡Œçš„æœ‰ä¸¤ä¸ªä¸åŒçš„libtorrentåº“ï¼Œå…·ä½“çš„åŒºåˆ«å¯è§ğŸ‘‡çš„blogï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://blog.chinaunix.net/uid-736168-id-375924.html&quot;&gt;ä¸¤ä¸ªlibtorrentåº“çš„åŒºåˆ«&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="C/C++" scheme="http://alfredzhenyu.github.io/categories/C-C/"/>
    
    
      <category term="C/C++" scheme="http://alfredzhenyu.github.io/tags/C-C/"/>
    
  </entry>
  
  <entry>
    <title>CoreFoundationæºç è§£è¯»ä¹‹CFArray</title>
    <link href="http://alfredzhenyu.github.io/2017/02/07/CoreFoundation%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E4%B9%8BCFArray/"/>
    <id>http://alfredzhenyu.github.io/2017/02/07/CoreFoundationæºç è§£è¯»ä¹‹CFArray/</id>
    <published>2017-02-07T13:10:17.000Z</published>
    <updated>2017-02-28T02:27:25.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç®—æ˜¯CoreFoundationæºç è§£æçš„ç¬¬ä¸€ç¯‡å§ï¼Œä¹‹åæœ‰æœºä¼šå¸Œæœ›èƒ½åšæ›´å¤šçš„æºç è§£æï¼Œå…¶å®åšè¿™å—çš„åŸå› å¾ˆç®€å•ï¼Œå…³äºè¿™å—çš„è§£æè¿˜æ˜¯è›®å°‘ï¼Œè€Œä½œä¸ºä¸€åiOSçš„å¼€å‘å·¥ç¨‹å¸ˆï¼Œæ²¡æœ‰æ¯”å­¦ä¹ å®˜æ–¹æºç çš„æ–¹å¼æ›´ç®€å•ç²—æš´ï¼Œå¯ä»¥ä»ä¸­å¸å–åˆ°å¾ˆå¤šå†…éƒ¨çš„ä»£ç é£æ ¼ï¼Œä¸ä»£ç çš„æŠ€å·§ã€‚</p>
<p>ä»¥ä¸‹å†…å®¹æˆ‘ä¼šåˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>ç®€å•ä»‹ç»ä¸‹ä»ç½‘ä¸ŠæŸ¥åˆ°çš„èµ„æ–™</li>
<li>åˆ†ææºç ï¼Œä»‹ç»ä»æºç ä¸­è·å–åˆ°çš„æœ‰ç”¨çŸ¥è¯†</li>
</ul>
<a id="more"></a>
<h2 id="CFArrayçš„å‘å±•"><a href="#CFArrayçš„å‘å±•" class="headerlink" title="CFArrayçš„å‘å±•"></a>CFArrayçš„å‘å±•</h2><p><strong>æœ€å¼€å§‹ï¼ˆCF-635.15ä»¥å‰ï¼‰</strong></p>
<p>CFArrayæ˜¯ç”±ä¸¤ç§æ•°æ®ç»“æ„å®ç°çš„</p>
<ul>
<li><p><a href="http://en.wikipedia.org/wiki/Double-ended_queue" target="_blank" rel="external">Double-ended queue</a> ï¼šæ•°ç»„é•¿åº¦è¾ƒå°æ—¶ä½¿ç”¨(&lt;262040) ï¼Œç›´æ¥ä½¿ç”¨CFArrayDequeå®ç°ï¼Œæ­¤æ—¶åœ¨å¤´å°¾æ’å…¥åˆ é™¤æ€§èƒ½é«˜ï¼Œä½†æ˜¯åœ¨ä¸­é—´æ’å…¥åˆ é™¤æ—¶ï¼Œå°±éœ€è¦ memmove æ¥æŒªåŠ¨å†…å­˜äº†ï¼Œæ€§èƒ½å°±ä¼šé™ä¸‹æ¥</p>
</li>
<li><p><a href="http://en.wikipedia.org/wiki/Balanced_tree" target="_blank" rel="external">balanced tree</a>ï¼šæ•°ç»„é•¿åº¦è¾ƒå¤§æ—¶ä½¿ç”¨ï¼ˆ&gt;=262040ï¼‰ï¼Œæ”¹æˆä½¿ç”¨CFStorageå®ç°ï¼Œåˆ©ç”¨balanced tree å®ç°äº†å¤§æ•°é‡çš„æ•°å€¼çš„å­˜å‚¨å’Œç¼–è¾‘ï¼Œå¹¶ä¸”åœ¨æ’å…¥å’Œåˆ é™¤æ—¶æœ‰å¾ˆå¥½çš„æ€§èƒ½</p>
<p>å¤‡æ³¨ï¼šå‡†ç¡®ç‚¹æ¥è¯´æ˜¯ä¸‰ç§ï¼Œè¿˜æœ‰ä¸€ç§å°±æ˜¯æ™®é€šçš„å¼€è¾Ÿä¸€æ®µè¿ç»­ç©ºé—´å­˜å‚¨ä¸å¯å˜æ•°ç»„CFArrayRefï¼Œä½†è¿™é‡Œä¸»è¦è®¨è®ºçš„æ˜¯CFMutableArrayRefï¼Œæ‰€ä»¥æŠŠå®ƒå¿½ç•¥æ‰</p>
</li>
</ul>
<p><strong>ä¹‹åï¼ˆCF-635.15 ~ CF-1153.18ï¼‰</strong></p>
<ul>
<li>å»æ‰äº†CFStorageéƒ¨åˆ†ï¼Œåœ¨<code>LONG_MAX</code>ä»¥å†…éƒ½æ˜¯ç”¨deque</li>
</ul>
<p><strong>æœ€æ–°(CF-1153.18ä»¥å)</strong></p>
<ul>
<li>æ®è¯´æ”¹æˆäº†<a href="https://zh.wikipedia.org/wiki/%E7%92%B0%E5%BD%A2%E7%B7%A9%E8%A1%9D%E5%8D%80" target="_blank" rel="external">circular buffer</a>ï¼Œä½†æœ€æ–°çš„ä»£ç ä¸€ç›´éƒ½æ˜¯<code>coming soon!</code></li>
</ul>
<h2 id="å¯¹æ¯”NSArray"><a href="#å¯¹æ¯”NSArray" class="headerlink" title="å¯¹æ¯”NSArray"></a>å¯¹æ¯”NSArray</h2><p>è¿™é‡Œå€¼çš„ä¸€æçš„æ˜¯è™½ç„¶CFArrayæ˜¯å¼€æºï¼Œä½†NSArrayæ˜¯é—­æºçš„ã€‚ä½†å°½ç®¡å¦‚æ­¤ï¼Œè¿˜æ˜¯æœ‰äººé€†å‘å»æ¢ç´¢NSArrayçš„å®ç°ï¼Œå¤§å®¶æœ‰å…´è¶£çš„è¯å¯ä»¥çœ‹ä¸‹å›½å¤–çš„å¤§ç‰›æ˜¯æ€ä¹ˆæ¢ç´¢çš„<a href="http://ciechanowski.me/blog/2014/03/05/exposing-nsmutablearray/" target="_blank" rel="external">Exposing NSMutableArray</a>ï¼Œæˆ‘è¿™é‡Œå°±ä¸ç­é—¨å¼„æ–§äº†ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºçš„ç»“è®ºæ˜¯ï¼š</p>
<p><strong>NSMutableArrayå®é™…ä¸Šä¹Ÿæ˜¯ç”¨<a href="https://zh.wikipedia.org/wiki/%E7%92%B0%E5%BD%A2%E7%B7%A9%E8%A1%9D%E5%8D%80" target="_blank" rel="external">circular buffer</a>ï¼ˆç¯å½¢ç¼“å†²å™¨ï¼‰æ¥å®ç°çš„</strong></p>
<p>è€Œè¿™ç¯‡æ–‡ç« çš„çš„æœ€åä¹ŸæŒ‡å‡ºï¼šç°åœ¨å¼€æºçš„æœ€æ–°ç‰ˆæœ¬(CF-635.15 ~ CF-1153.18)çš„å·¥ä½œåŸç†å…¶å®å’Œç¯å½¢ç¼“å†²å™¨ç›¸ä¼¼ï¼Œä½†æœ¬è´¨ä¸Šå¹¶ä¸æ˜¯ç¯å½¢ç¼“å†²å™¨ï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹ä¸‹å½“å‰å¼€æºç‰ˆæœ¬æ˜¯æ€ä¹ˆç›¸ä¼¼æ³•</p>
<blockquote>
<p>Basically, <code>CFArray</code> moves the memory around to accommodate the changes in the most efficient fashion, similarly to how <code>__NSArrayM</code> does its job. However, the <code>CFArray</code> does <em>not</em> use a circular buffer! Instead it has a larger buffer padded with zeros from both ends which makes enumeration and fetching the correct object much easier. Adding elements at either end simply eats up the remaining padding.</p>
</blockquote>
<h2 id="CFArrayæºç è§£è¯»"><a href="#CFArrayæºç è§£è¯»" class="headerlink" title="CFArrayæºç è§£è¯»"></a>CFArrayæºç è§£è¯»</h2><p>é¦–å…ˆä¸Šå®˜ç½‘æŠŠæºç ä¸‹è½½ä¸‹æ¥ï¼š<a href="https://opensource.apple.com/source/CF/CF-1153.18/" target="_blank" rel="external">CF-1153.18</a> ï¼Œæ‰¾åˆ°CFArray.c/.hï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è¦é˜…è¯»çš„æºç </p>
<p>å¼€å¯ä»¥çœ‹åˆ°ä»£ç é‡å¾ˆå¤šè€Œä¸”æ¯”è¾ƒä¹±ï¼Œæˆ‘è¿™é‡ŒæŒ‰ç…§åŠŸèƒ½æ•´ç†äº†ä¸€ä¸‹ï¼š</p>
<p>ä»¥ä¸‹æ˜¯æˆ‘åˆ†ç±»çš„ç›®å½•ï¼š</p>
<p><img src="æ–¹æ³•ç›®å½•.jpg" alt=""></p>
<p>æœ€åæˆ‘ä¼šæŠŠæˆ‘æ•´ç†è¿‡çš„ä»£ç ä¸Šä¼ ä¸Šå»ä¸Šå»ï¼Œæœ‰éœ€è¦çš„å¯ä»¥è‡ªè¡Œä¸‹è½½</p>
<h3 id="æ•°ç»„çš„å£°æ˜â€”â€”å¤§è‡´äº†è§£æ•°ç»„çš„ç»“æ„"><a href="#æ•°ç»„çš„å£°æ˜â€”â€”å¤§è‡´äº†è§£æ•°ç»„çš„ç»“æ„" class="headerlink" title="æ•°ç»„çš„å£°æ˜â€”â€”å¤§è‡´äº†è§£æ•°ç»„çš„ç»“æ„"></a>æ•°ç»„çš„å£°æ˜â€”â€”å¤§è‡´äº†è§£æ•°ç»„çš„ç»“æ„</h3><p>å…ˆæ¥çœ‹ä¸‹æ•°ç»„çš„ç»“æ„ä½“å£°æ˜ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** æ‰€æœ‰çš„è¿™äº›æšä¸¾å€¼ä¼šå†™è¿›ä¸€ä¸ª32ä½çš„æ•´æ•°é‡Œï¼Œé€šè¿‡äºŒè¿›åˆ¶é‡Œbitsä½æ¥æ ‡è¯† */</span></div><div class="line"><span class="comment">//åˆ†åˆ«ä»£è¡¨ä¸¤ç§ç±»å‹çš„æ•°ç»„__kCFArrayImmutableä¸ºCFArray</span></div><div class="line"><span class="comment">//åˆ†åˆ«ä»£è¡¨ä¸¤ç§ç±»å‹çš„æ•°ç»„__kCFArrayImmutableä¸ºCFMutableArray</span></div><div class="line"><span class="comment">/* Flag bits */</span></div><div class="line"><span class="keyword">enum</span> &#123;		<span class="comment">/* Bits 0-1 */</span></div><div class="line">    __kCFArrayImmutable = <span class="number">0</span>,</div><div class="line">    __kCFArrayDeque = <span class="number">2</span>,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">enum</span> &#123;		<span class="comment">/* Bits 2-3 */</span></div><div class="line">    __kCFArrayHasNullCallBacks = <span class="number">0</span>,</div><div class="line">    __kCFArrayHasCFTypeCallBacks = <span class="number">1</span>,</div><div class="line">    __kCFArrayHasCustomCallBacks = <span class="number">3</span>	<span class="comment">/* callbacks are at end of header */</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> Bits 4 &amp; 5 are reserved for GC use.</div><div class="line"> Bit 4, if set, indicates that the array is weak.</div><div class="line"> Bit 5 marks whether finalization has occured and, thus,</div><div class="line"> whether to continue to do special retain/release processing of elements.</div><div class="line"> */</div><div class="line"><span class="keyword">struct</span> __CFArray &#123;</div><div class="line">    <span class="comment">// CFRuntimeBaseåœ¨CFRuntime.hä¸­å®šä¹‰</span></div><div class="line">    <span class="comment">// typedef struct __CFRuntimeBase &#123;</span></div><div class="line">    <span class="comment">// uintptr_t _cfisa;</span></div><div class="line">    <span class="comment">// uint8_t _cfinfo[4];</span></div><div class="line">    <span class="comment">// #if __LP64__</span></div><div class="line">    <span class="comment">// uint32_t _rc;</span></div><div class="line">    <span class="comment">// #endif</span></div><div class="line">    <span class="comment">// &#125; CFRuntimeBase;</span></div><div class="line">    CFRuntimeBase _base;</div><div class="line">    <span class="comment">//è¿™ä¸ªæ˜¯ç”¨æ¥å­˜æ•°ç»„å…ƒç´ æ•°é‡çš„</span></div><div class="line">    CFIndex _count;		<span class="comment">/* number of objects */</span></div><div class="line">    CFIndex _mutations; <span class="comment">//åˆå§‹åŒ–ä¸º1</span></div><div class="line">    <span class="keyword">int32_t</span> _mutInProgress; <span class="comment">//åˆå§‹åŒ–ä¸º0</span></div><div class="line">    <span class="comment">//è¿™ä¸ªæ˜¯ç”¨æ¥å­˜æ•°ç»„å…ƒç´ çš„,__kCFArrayDequeç±»å‹ä¸‹ï¼Œ_storeå°±æ˜¯__CFArrayDeque</span></div><div class="line">    __strong <span class="keyword">void</span> *_store;    <span class="comment">//åˆå§‹ä¸ºç©ºï¼ŒMutableåŠ å…ƒç´ çš„æ—¶å€™æ‰ä¼šåˆ›å»º       /* can be NULL when MutableDeque */</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> __CFArrayDeque &#123;</div><div class="line">    <span class="keyword">uintptr_t</span> _leftIdx;</div><div class="line">    <span class="keyword">uintptr_t</span> _capacity;</div><div class="line">    <span class="comment">/* struct __CFArrayBucket buckets follow here */</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> __CFArrayBucket &#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *_item;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆæ•°ç»„åˆ†ç±»ä¸¤ç±»ï¼š</p>
<ul>
<li>__kCFArrayImmutableä¸å¯å˜æ•°ç»„</li>
<li>__kCFArrayDequeå¯å˜æ•°ç»„</li>
</ul>
<p>ä½†å®é™…ä¸­ä¸¤è€…éƒ½ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªç»“æ„ä½“ï¼š__CFArrayï¼ˆåªæ˜¯ç±»å‹ä¸åŒï¼Œä»¥åŠå­˜å‚¨æ–¹å¼ä¸ä¸€æ ·ï¼Œåé¢ä¼šè®²åˆ°ï¼‰</p>
<p>__CFArrayç»“æ„ä½“ï¼š</p>
<ul>
<li>CFRuntimeBase _baseï¼šå…¶å®ä¸æ­¢è¿™ä¸¤ä¸ªæ•°ç»„åŒ…å«è¿™ä¸ªç»“æ„ä½“ï¼Œåº”è¯¥è¯´æ‰€æœ‰CFç±»å‹çš„ç»“æ„ä½“éƒ½ä¼šåŒ…å«è¿™ä¸ªç»“æ„ä½“ï¼Œä¸»è¦ä½œç”¨æ˜¯æ–¹ä¾¿runtimeç»Ÿä¸€è°ƒåº¦ç®¡ç†ã€‚åœ¨æœ¬æ¬¡ä»‹ç»ä¸­ä¸»è¦æ¶‰åŠåˆ°çš„æ˜¯__cfinfoçš„CF_INFO_BITSä½ï¼ˆç¬¬0ä½ï¼‰å®ƒä¸»è¦å­˜å‚¨äº†æ•°ç»„çš„æ‰€æœ‰çŠ¶æ€</li>
<li>CFIndex _countï¼šè®°å½•æ•°ç»„æ•°é‡</li>
<li>CFIndex _mutationsï¼š è®°å½•æ•°ç»„çš„æ“ä½œæ¬¡æ•°ï¼Œæ¯æ¬¡æ“ä½œæ•°ç»„ååŠ 1ï¼Œåˆå§‹åˆ›å»ºæ—¶å°±ä¸º1</li>
<li>int32_t _mutInProgressï¼šç”¨äºæ£€æµ‹æ­¤æ—¶æ˜¯å¦æ­£åœ¨æ“ä½œæ•°ç»„ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒä¸€æ—¶é—´æ“ä½œåŒä¸€ä¸ªæ•°ç»„</li>
<li>__strong void *_storeï¼šè¿™æ˜¯ä¸¤ç§ç±»å‹æ•°ç»„çš„ä¸€ä¸ªå…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒå¤§çš„åŒºåˆ«ï¼š<ul>
<li>ä¸å¯å˜æ•°ç»„ï¼šä¸€èˆ¬ä¸ºNULL</li>
<li>å¯å˜æ•°ç»„ï¼šåœ¨æ•°ç»„å…ƒç´ ä¸ºç©ºçš„æ—¶å€™ä¹Ÿä¸ºNULLï¼Œæœ‰æ•°æ®çš„æ—¶å€™_storeæŒ‡å‘__CFArrayDequeç»“æ„ä½“</li>
</ul>
</li>
</ul>
<p>__CFArrayBucketç»“æ„ä½“ï¼š</p>
<p>è¿™ä¸ªç»“æ„ä½“é‡Œé¢å°±åªæœ‰ä¸€ä¸ªæˆå‘˜<code>const void *_item</code></p>
<ul>
<li>const void <em><em>itemï¼šä¹Ÿæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œ**å®é™…ä¸ŠCFArrayä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½å¯¹åº”ä¸€ä¸ª\</em>_CFArrayBucket,è€Œ__CFArrayBucketé‡Œçš„_itemæŒ‡é’ˆå”¯ä¸€æŒ‡å‘å¯¹åº”çš„è¿™ä¸ªå…ƒç´ *</em></li>
</ul>
<p>å…³äº__CFArrayDequeçš„ç»“æ„ä½“ï¼Œæˆ‘ä¼šæ”¾åˆ°åé¢è·Ÿç€æºç ä¸€èµ·æ¥ä»‹ç»ã€‚</p>
<h3 id="æ•°ç»„çš„åˆ›å»ºâ€”â€”åˆ†æä¸å¯å˜æ•°ç»„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼"><a href="#æ•°ç»„çš„åˆ›å»ºâ€”â€”åˆ†æä¸å¯å˜æ•°ç»„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼" class="headerlink" title="æ•°ç»„çš„åˆ›å»ºâ€”â€”åˆ†æä¸å¯å˜æ•°ç»„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼"></a>æ•°ç»„çš„åˆ›å»ºâ€”â€”åˆ†æä¸å¯å˜æ•°ç»„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_CREATION_METHODS 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> DEFINE_CREATION_METHODS</span></div><div class="line"><span class="comment">///å¯¹å¤–Arrayåˆ›å»ºæ–¹æ³•</span></div><div class="line"><span class="function">CFArrayRef <span class="title">CFArrayCreate</span><span class="params">(CFAllocatorRef allocator, <span class="keyword">const</span> <span class="keyword">void</span> **values, CFIndex numValues, <span class="keyword">const</span> CFArrayCallBacks *callBacks)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> __CFArrayCreate0(allocator, values, numValues, callBacks);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">///å¯¹å¤–MutableArrayåˆ›å»ºæ–¹æ³•</span></div><div class="line"><span class="function">CFMutableArrayRef <span class="title">CFArrayCreateMutable</span><span class="params">(CFAllocatorRef allocator, CFIndex capacity, <span class="keyword">const</span> CFArrayCallBacks *callBacks)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> __CFArrayCreateMutable0(allocator, capacity, callBacks);</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<p>æ•°ç»„å¯¹å¤–çš„åˆ›å»ºä¸»è¦æœ‰ä¸¤ä¸ª</p>
<ul>
<li><code>CFArrayCreate</code> è°ƒç”¨<code>__CFArrayCreate0</code>æ–¹æ³•åˆ›å»º</li>
<li><code>CFArrayCreateMutable</code>è°ƒç”¨<code>__CFArrayCreateMutable0</code>æ–¹æ³•åˆ›å»º</li>
</ul>
<p>å†æ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªå†…éƒ¨æ–¹æ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªCFArrayRefä¸å¯å˜æ•°ç»„</span></div><div class="line"><span class="comment">// @param allocator æ˜¯ä½¿ç”¨å·²æœ‰çš„ç©ºé—´è¿˜æ˜¯å¼€è¾Ÿæ–°çš„ç©ºé—´æ¥åˆ›å»ºæ•°ç»„. ä¼  NULL æˆ–è€… kCFAllocatorDefault ä½¿ç”¨é»˜è®¤çš„allocator</span></div><div class="line"><span class="comment">// @param values cè¯­è¨€æ•°ç»„æŒ‡é’ˆ</span></div><div class="line"><span class="comment">// @param numValues æ•°ç»„ä¸ªæ•°</span></div><div class="line"><span class="comment">// @param callBacks ä¸€ä¸ª CFArrayCallBacksçš„ç»“æ„æŒ‡é’ˆ</span></div><div class="line"><span class="comment">//CFArrayRef å†…éƒ¨åˆ›å»ºæ–¹æ³•ï¼Œè°ƒç”¨__CFArrayInit</span></div><div class="line">CF_PRIVATE CFArrayRef __CFArrayCreate0(CFAllocatorRef allocator, <span class="keyword">const</span> <span class="keyword">void</span> **values, CFIndex numValues, <span class="keyword">const</span> CFArrayCallBacks *callBacks) &#123;</div><div class="line">    </div><div class="line">    CFArrayRef result;</div><div class="line">    <span class="keyword">const</span> CFArrayCallBacks *cb;</div><div class="line">    <span class="keyword">struct</span> __CFArrayBucket *buckets;</div><div class="line">    CFAllocatorRef bucketsAllocator;</div><div class="line">    <span class="keyword">void</span>* bucketsBase;</div><div class="line">    CFIndex idx;</div><div class="line">    </div><div class="line">    CFAssert2(<span class="number">0</span> &lt;= numValues, __kCFLogAssertion, <span class="string">"%s(): numValues (%d) cannot be less than zero"</span>, __PRETTY_FUNCTION__, numValues);</div><div class="line">    </div><div class="line">    <span class="comment">//__CFArrayInitåˆå§‹åŒ–</span></div><div class="line">    result = __CFArrayInit(allocator, __kCFArrayImmutable, numValues, callBacks);</div><div class="line">    <span class="comment">//è·å–callback</span></div><div class="line">    cb = __CFArrayGetCallBacks(result);</div><div class="line">    <span class="comment">//æ¯ä¸ªæ•°ç»„å…ƒç´ éƒ½ç”¨ä¸€ä¸ªbucketè£…ç€ï¼Œé€šè¿‡ç»“æ„ä½“æŒ‡é’ˆæ¥ç´¢å¼•ï¼Œç»“æ„ä½“æŒ‡é’ˆé¡ºåºå­˜å‚¨ï¼Œé€šè¿‡æŒ‡é’ˆ+1æ¥è·å–å¯¹åº”bucketæŒ‡é’ˆï¼Œä»è€Œåˆ©ç”¨itemç´¢å¼•å¯¹åº”çš„å…ƒç´ </span></div><div class="line">    buckets = __CFArrayGetBucketsPtr(result);</div><div class="line">    bucketsAllocator = isStrongMemory(result) ? allocator : kCFAllocatorNull;</div><div class="line">    bucketsBase = CF_IS_COLLECTABLE_ALLOCATOR(bucketsAllocator) ? (<span class="keyword">void</span> *)auto_zone_base_pointer(objc_collectableZone(), buckets) : <span class="literal">NULL</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != cb-&gt;retain) &#123;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (idx = <span class="number">0</span>; idx &lt; numValues; idx++) &#123;</div><div class="line"></div><div class="line"> <span class="comment">//           åœ¨CFInternal.hé‡Œå®šä¹‰</span></div><div class="line"> <span class="comment">//            CF_INLINE void __CFAssignWithWriteBarrier(void **location, void *value) &#123;</span></div><div class="line"> <span class="comment">//            if (kCFUseCollectableAllocator) &#123;</span></div><div class="line"> <span class="comment">//            objc_assign_strongCast((id)value, (id *)location);</span></div><div class="line"> <span class="comment">//            &#125; else &#123;</span></div><div class="line"> <span class="comment">//            *location = value;</span></div><div class="line"> <span class="comment">//            &#125;</span></div><div class="line"> <span class="comment">//            &#125;</span></div><div class="line">            <span class="comment">//__CFAssignWithWriteBarrier((void **)&amp;buckets-&gt;_item, (void *)(cb-&gt;retain)(allocator, *values));</span></div><div class="line">            __CFAssignWithWriteBarrier((<span class="keyword">void</span> **)&amp;buckets-&gt;_item, (<span class="keyword">void</span> *)INVOKE_CALLBACK2(cb-&gt;retain, allocator, *values));</div><div class="line">            </div><div class="line">            values++;</div><div class="line">            buckets++;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (idx = <span class="number">0</span>; idx &lt; numValues; idx++) &#123;</div><div class="line">            __CFAssignWithWriteBarrier((<span class="keyword">void</span> **)&amp;buckets-&gt;_item, (<span class="keyword">void</span> *)*values);</div><div class="line">            values++;</div><div class="line">            buckets++;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    <span class="comment">//è®¾ç½®__CFArrayç»“æ„ä½“çš„æ•°ç»„å¤§å°</span></div><div class="line">    __CFArraySetCount(result, numValues);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/** åˆ›å»ºä¸€ä¸ªCFMutableArrayRefå¯å˜æ•°ç»„ */</span></div><div class="line"><span class="comment">//CFMutableArrayRef å†…éƒ¨åˆ›å»ºæ–¹æ³•ï¼ˆç›´æ¥è°ƒç”¨__CFArrayInitåˆå§‹åŒ–å³å¯ï¼‰</span></div><div class="line">CF_PRIVATE CFMutableArrayRef __CFArrayCreateMutable0(CFAllocatorRef allocator, CFIndex capacity, <span class="keyword">const</span> CFArrayCallBacks *callBacks) &#123;</div><div class="line">    <span class="comment">//æ–­è¨€</span></div><div class="line">    CFAssert2(<span class="number">0</span> &lt;= capacity, __kCFLogAssertion, <span class="string">"%s(): capacity (%d) cannot be less than zero"</span>, __PRETTY_FUNCTION__, capacity);</div><div class="line">    CFAssert2(capacity &lt;= LONG_MAX / <span class="keyword">sizeof</span>(<span class="keyword">void</span> *), __kCFLogAssertion, <span class="string">"%s(): capacity (%d) is too large for this architecture"</span>, __PRETTY_FUNCTION__, capacity);</div><div class="line">    <span class="comment">//__CFArrayInitåˆå§‹åŒ–</span></div><div class="line">    <span class="keyword">return</span> (CFMutableArrayRef)__CFArrayInit(allocator, __kCFArrayDeque, capacity, callBacks);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»<code>__CFArrayCreate0</code>é‡Œå¯¹bucketsçš„æ“ä½œå…¶å®å°±å¯ä»¥æ¨æ–­å‡ºä¸å¯å˜çš„æ•°ç»„æ•°æ®ç»“æ„äº†ï¼Œä¸ºäº†ç¡®ä¿æ¨æ–­æ— è¯¯ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸‹ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè°ƒç”¨åŸºç¡€æ–¹æ³•<code>__CFArrayInit</code></p>
<p>ä»¥ä¸‹æ˜¯<code>__CFArrayInit</code>çš„æºç :</p>
<p>(æ³¨é‡Šé‡Œå†™äº†ä¸€äº›ä½¿ç”¨åˆ°çš„ï¼Œåœ¨åˆ«çš„æ–‡ä»¶ä¸­å®šä¹‰çš„ç›¸å…³å®ï¼Œä»¥ä¾›å‚è€ƒ)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /** åˆå§‹åŒ–ä¸€ä¸ªCFArrayRefæ•°ç»„</span></div><div class="line"><span class="comment">// *  @param allocator æ˜¯ä½¿ç”¨å·²æœ‰çš„ç©ºé—´è¿˜æ˜¯æ–°çš„ç©ºé—´æ¥åˆ›å»ºæ•°ç»„. ä¼  NULL æˆ–è€… kCFAllocatorDefault ä½¿ç”¨é»˜è®¤çš„allocator</span></div><div class="line"><span class="comment">// *  @param flags æ•°ç»„ç±»å‹ï¼š__kCFArrayImmutable ä¸å¯å˜æ•°ç»„/__kCFArrayDeque å¯å˜æ•°ç»„</span></div><div class="line"><span class="comment">// *  @param capacity æ•°ç»„å¤§å°</span></div><div class="line"><span class="comment">// *  @param callBacks ä¸€ä¸ª CFArrayCallBacksçš„ç»“æ„æŒ‡é’ˆ</span></div><div class="line"><span class="comment">// */</span></div><div class="line"></div><div class="line"><span class="comment">///#if (TARGET_OS_MAC &amp;&amp; !(TARGET_OS_EMBEDDED || TARGET_OS_IPHONE))</span></div><div class="line"><span class="comment">///#define CF_IS_COLLECTABLE_ALLOCATOR(allocator) (kCFUseCollectableAllocator &amp;&amp; (NULL == (allocator) || kCFAllocatorSystemDefault == (allocator) || 0))</span></div><div class="line"><span class="comment">///#else 0</span></div><div class="line"><span class="comment">///#endif</span></div><div class="line"></div><div class="line"><span class="comment">///#define INVOKE_CALLBACK2(P, A, B) (P)(A, B)</span></div><div class="line"><span class="comment">///#define __CFBitfieldGetValue(V, N1, N2)	(((V) &amp; __CFBitfieldMask(N1, N2)) &gt;&gt; (N2))</span></div><div class="line"><span class="comment">///#define __CFBitfieldMask(N1, N2)	((((UInt32)~0UL) &lt;&lt; (31UL - (N1) + (N2))) &gt;&gt; (31UL - N1))</span></div><div class="line"><span class="comment">///#define __CFBitfieldSetValue(V, N1, N2, X)	((V) = ((V) &amp; ~__CFBitfieldMask(N1, N2)) | (((X) &lt;&lt; (N2)) &amp; __CFBitfieldMask(N1, N2)))</span></div><div class="line"><span class="keyword">static</span> CFArrayRef __CFArrayInit(CFAllocatorRef allocator, UInt32 flags, CFIndex capacity, <span class="keyword">const</span> CFArrayCallBacks *callBacks) &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">struct</span> __CFArray *memory;</div><div class="line">    UInt32 size;</div><div class="line">    <span class="comment">//å¯¹äºUint32ä½çš„flagsï¼Œå–å‡º2~31ä½çš„æ•°è®¾ç½®æˆ0</span></div><div class="line">    __CFBitfieldSetValue(flags, <span class="number">31</span>, <span class="number">2</span>, <span class="number">0</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (CF_IS_COLLECTABLE_ALLOCATOR(allocator))<span class="comment">//ALLOCATOR = NULL æ—¶ä¸ºNO</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (!callBacks || (callBacks-&gt;retain == <span class="literal">NULL</span> &amp;&amp; callBacks-&gt;release == <span class="literal">NULL</span>))</div><div class="line">        &#123;</div><div class="line">	    __CFBitfieldSetValue(flags, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1</span>); <span class="comment">// setWeak</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//åˆ©ç”¨2-3ä½æ¥æ ‡è¯†callbackç±»å‹</span></div><div class="line">    <span class="keyword">if</span> (__CFArrayCallBacksMatchNull(callBacks)) &#123;</div><div class="line">        __CFBitfieldSetValue(flags, <span class="number">3</span>, <span class="number">2</span>, __kCFArrayHasNullCallBacks);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFArrayCallBacksMatchCFType(callBacks)) &#123;</div><div class="line">        __CFBitfieldSetValue(flags, <span class="number">3</span>, <span class="number">2</span>, __kCFArrayHasCFTypeCallBacks);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        __CFBitfieldSetValue(flags, <span class="number">3</span>, <span class="number">2</span>, __kCFArrayHasCustomCallBacks);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">//size =__CFArrayç»“æ„ä½“å¤§å°+ callBackç»“æ„ä½“å¤§å°ï¼ˆå¦‚æœæœ‰è‡ªå®šä¹‰çš„è¯ï¼‰- CFRuntimeBaseç»“æ„ä½“å¤§å°</span></div><div class="line">    size = __CFArrayGetSizeOfType(flags) - <span class="keyword">sizeof</span>(CFRuntimeBase);</div><div class="line">    <span class="comment">//åˆ©ç”¨0-1ä½æ¥æ ‡è¯†æ•°ç»„ç±»å‹æ˜¯__kCFArrayImmutableè¿˜æ˜¯__kCFArrayDeque</span></div><div class="line">    <span class="comment">//size =__CFArrayç»“æ„ä½“å¤§å°+ callBackç»“æ„ä½“å¤§å°ï¼ˆå¦‚æœæœ‰è‡ªå®šä¹‰çš„è¯ï¼‰- CFRuntimeBaseç»“æ„ä½“å¤§å° + ä¸ªæ•° * __CFArrayBucketç»“æ„ä½“å¤§å°</span></div><div class="line">    <span class="keyword">switch</span> (__CFBitfieldGetValue(flags, <span class="number">1</span>, <span class="number">0</span>))</div><div class="line">    &#123;</div><div class="line">    <span class="keyword">case</span> __kCFArrayImmutable:</div><div class="line">            size += capacity * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> __kCFArrayDeque:</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//Runtimeåˆ›å»ºç©ºé—´ï¼Œæ³¨æ„_CFRuntimeCreateInstanceéœ€è¦çš„å‚æ•°æ˜¯extraBytesï¼Œéœ€è¦é™¤å»CFRuntimeBaseå¤§å°ã€‚ å°±æ˜¯ä¸Šé¢çš„sizeï¼Œäº‹å®ä¸Šå¯ä»¥é€šè¿‡æŸ¥çœ‹_CFRuntimeCreateInstanceçš„æºç çŸ¥é“CFRuntimeBaseæ˜¯å†…éƒ¨åˆ›å»ºçš„ï¼Œå¤–éƒ¨å¹¶ä¸éœ€è¦ç®¡</span></div><div class="line">    memory = (<span class="keyword">struct</span> __CFArray*)_CFRuntimeCreateInstance(allocator, CFArrayGetTypeID(), size, <span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == memory) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//åˆå§‹åŒ–CFRuntimeBaseç»“æ„ä½“å‚æ•°</span></div><div class="line">    <span class="comment">//æŠŠflagsä¿¡æ¯å­˜è¿›ç»“æ„ä½“ä¸­</span></div><div class="line">    __CFBitfieldSetValue(memory-&gt;_base._cfinfo[CF_INFO_BITS], <span class="number">6</span>, <span class="number">0</span>, flags);</div><div class="line">    </div><div class="line">    <span class="comment">//åˆå§‹åŒ–ç»“æ„ä½“çš„æ•°ç»„å¤§å°</span></div><div class="line">    __CFArraySetCount((CFArrayRef)memory, <span class="number">0</span>);</div><div class="line">    <span class="comment">//åˆ©ç”¨0-1ä½æ¥æ ‡è¯†æ•°ç»„ç±»å‹æ˜¯__kCFArrayImmutableè¿˜æ˜¯__kCFArrayDeque</span></div><div class="line">    <span class="keyword">switch</span> (__CFBitfieldGetValue(flags, <span class="number">1</span>, <span class="number">0</span>))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">case</span> __kCFArrayImmutable:</div><div class="line">            <span class="keyword">if</span> (isWeakMemory(memory))</div><div class="line">            &#123;  <span class="comment">// if weak, don't scan</span></div><div class="line">                auto_zone_set_unscanned(objc_collectableZone(), memory);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (__CFOASafe) __CFSetLastAllocationEventName(memory, <span class="string">"CFArray (immutable)"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> __kCFArrayDeque:</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (__CFOASafe) __CFSetLastAllocationEventName(memory, <span class="string">"CFArray (mutable-variable)"</span>);</div><div class="line">            </div><div class="line">            ((<span class="keyword">struct</span> __CFArray *)memory)-&gt;_mutations = <span class="number">1</span>;</div><div class="line">            ((<span class="keyword">struct</span> __CFArray *)memory)-&gt;_mutInProgress = <span class="number">0</span>;</div><div class="line">            ((<span class="keyword">struct</span> __CFArray*)memory)-&gt;_store = <span class="literal">NULL</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//è®¾ç½®callback</span></div><div class="line">    <span class="keyword">if</span> (__kCFArrayHasCustomCallBacks == __CFBitfieldGetValue(flags, <span class="number">3</span>, <span class="number">2</span>))</div><div class="line">    &#123;</div><div class="line">        CFArrayCallBacks *cb = (CFArrayCallBacks *)__CFArrayGetCallBacks((CFArrayRef)memory);</div><div class="line">        *cb = *callBacks;</div><div class="line">        FAULT_CALLBACK((<span class="keyword">void</span> **)&amp;(cb-&gt;retain));</div><div class="line">        FAULT_CALLBACK((<span class="keyword">void</span> **)&amp;(cb-&gt;release));</div><div class="line">        FAULT_CALLBACK((<span class="keyword">void</span> **)&amp;(cb-&gt;copyDescription));</div><div class="line">        FAULT_CALLBACK((<span class="keyword">void</span> **)&amp;(cb-&gt;equal));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (CFArrayRef)memory;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>__CFArrayInit</code>æœ€ä¸»è¦èŒè´£æ˜¯å¼€è¾Ÿå¯¹åº”çš„ç©ºé—´ï¼Œç„¶åè®¾ç½®æ•°ç»„çš„CallBacksã€çŠ¶æ€ä½ï¼ŒæŠŠçŠ¶æ€ä½å†™è¿›<code>_base._cfinfo[CF_INFO_BITS]</code>é‡Œã€‚</p>
<p>è¿™é‡Œæ€»ç»“å‡ºä¸ªæœ‰ç”¨çš„æŠ€å·§ï¼š</p>
<p><strong>å½“ä¸€ä¸ªå¯¹è±¡æœ‰å¾ˆå¤šçŠ¶æ€éœ€è¦æ ‡è¯†çš„æ—¶å€™ï¼Œæœ€å¥½çš„æ–¹æ³•ä¸æ˜¯è®¾ç½®å¤šä¸ªå¸ƒå°”å±æ€§ã€æšä¸¾å±æ€§ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ä¸€ä¸ª32ï¼ˆæˆ–è€…16ï¼‰ä½çš„æ•´å½¢æ•°æ¥å­˜å‚¨æ‰€æœ‰çŠ¶æ€ï¼Œå°†è¿™ä¸ªæ•´å½¢æ•°è½¬æ¢æˆäºŒè¿›åˆ¶ï¼Œåˆ©ç”¨ä¸åŒä½æ•°ä»£è¡¨çš„ä¸åŒçŠ¶æ€ã€‚</strong></p>
<h3 id="å°ç»“â€”â€”ä¸å¯å˜æ•°ç»„åœ¨å†…å­˜çš„å­˜å‚¨æ–¹å¼"><a href="#å°ç»“â€”â€”ä¸å¯å˜æ•°ç»„åœ¨å†…å­˜çš„å­˜å‚¨æ–¹å¼" class="headerlink" title="å°ç»“â€”â€”ä¸å¯å˜æ•°ç»„åœ¨å†…å­˜çš„å­˜å‚¨æ–¹å¼"></a>å°ç»“â€”â€”ä¸å¯å˜æ•°ç»„åœ¨å†…å­˜çš„å­˜å‚¨æ–¹å¼</h3><p>ä»ä»¥ä¸Šçš„ä»£ç å°±å¯ä»¥å¤§è‡´åˆ†æå‡ºä¸å¯å˜æ•°ç»„çš„æ•°æ®ç»“æ„ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="ä¸å¯å˜æ•°ç»„.png" alt=""></p>
<p>ç”±äºå¯å˜æ•°ç»„åœ¨æ•´ä¸ªåˆ›å»ºè¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œæ“ä½œï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥é˜…è¯»å¯å˜æ•°ç»„å¯¹æ•°æ®çš„å¢åˆ æ”¹æŸ¥æ¥è¿›ä¸€æ­¥äº†è§£å¯å˜æ•°ç»„çš„å­˜å‚¨æ–¹å¼ã€‚</p>
<h3 id="æ•°ç»„çš„å¢åˆ æ”¹æŸ¥â€”â€”åˆ†æå¯å˜æ•°ç»„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼"><a href="#æ•°ç»„çš„å¢åˆ æ”¹æŸ¥â€”â€”åˆ†æå¯å˜æ•°ç»„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼" class="headerlink" title="æ•°ç»„çš„å¢åˆ æ”¹æŸ¥â€”â€”åˆ†æå¯å˜æ•°ç»„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼"></a>æ•°ç»„çš„å¢åˆ æ”¹æŸ¥â€”â€”åˆ†æå¯å˜æ•°ç»„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼</h3><h4 id="å¢ï¼šä¸ºå¯å˜æ•°ç»„æ·»åŠ å…ƒç´ "><a href="#å¢ï¼šä¸ºå¯å˜æ•°ç»„æ·»åŠ å…ƒç´ " class="headerlink" title="å¢ï¼šä¸ºå¯å˜æ•°ç»„æ·»åŠ å…ƒç´ "></a>å¢ï¼šä¸ºå¯å˜æ•°ç»„æ·»åŠ å…ƒç´ </h4><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æ·»åŠ </span></div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark add</span></div><div class="line"><span class="comment">//åœ¨æ•°ç»„idxä½ç½®ä¸­æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼ˆè°ƒç”¨_CFArrayReplaceValuesï¼‰</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CFArrayInsertValueAtIndex</span><span class="params">(CFMutableArrayRef <span class="built_in">array</span>, CFIndex idx, <span class="keyword">const</span> <span class="keyword">void</span> *value)</span> </span>&#123;</div><div class="line">    CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), <span class="keyword">void</span>, (NSMutableArray *)<span class="built_in">array</span>, insertObject:(id)value atIndex:(NSUInteger)idx);</div><div class="line">    __CFGenericValidateType(<span class="built_in">array</span>, CFArrayGetTypeID());</div><div class="line">    CFAssert1(__CFArrayGetType(<span class="built_in">array</span>) != __kCFArrayImmutable, __kCFLogAssertion, <span class="string">"%s(): array is immutable"</span>, __PRETTY_FUNCTION__);</div><div class="line">    CFAssert2(<span class="number">0</span> &lt;= idx &amp;&amp; idx &lt;= __CFArrayGetCount(<span class="built_in">array</span>), __kCFLogAssertion, <span class="string">"%s(): index (%d) out of bounds"</span>, __PRETTY_FUNCTION__, idx);</div><div class="line">    CHECK_FOR_MUTATION(<span class="built_in">array</span>);</div><div class="line">    </div><div class="line">    _CFArrayReplaceValues(<span class="built_in">array</span>, CFRangeMake(idx, <span class="number">0</span>), &amp;value, <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">//åœ¨æ•°ç»„çš„æœ€åæ’å…¥ä¸€ä¸ªå…ƒç´ ï¼ˆè°ƒç”¨_CFArrayReplaceValuesï¼‰</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CFArrayAppendValue</span><span class="params">(CFMutableArrayRef <span class="built_in">array</span>, <span class="keyword">const</span> <span class="keyword">void</span> *value)</span> </span>&#123;</div><div class="line">    CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), <span class="keyword">void</span>, (NSMutableArray *)<span class="built_in">array</span>, addObject:(id)value);</div><div class="line">    __CFGenericValidateType(<span class="built_in">array</span>, CFArrayGetTypeID());</div><div class="line">    CFAssert1(__CFArrayGetType(<span class="built_in">array</span>) != __kCFArrayImmutable, __kCFLogAssertion, <span class="string">"%s(): array is immutable"</span>, __PRETTY_FUNCTION__);</div><div class="line">    CHECK_FOR_MUTATION(<span class="built_in">array</span>);</div><div class="line">    </div><div class="line">    _CFArrayReplaceValues(<span class="built_in">array</span>, CFRangeMake(__CFArrayGetCount(<span class="built_in">array</span>), <span class="number">0</span>), &amp;value, <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">//åœ¨æ•°ç»„çš„æœ€åæ’å…¥ä¸€ä¸ªæ•°ç»„ï¼ˆè°ƒç”¨CFArrayAppendValueï¼‰</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CFArrayAppendArray</span><span class="params">(CFMutableArrayRef <span class="built_in">array</span>, CFArrayRef otherArray, CFRange otherRange)</span> </span>&#123;</div><div class="line">    __CFArrayValidateRange(otherArray, otherRange, __PRETTY_FUNCTION__);</div><div class="line">    </div><div class="line">    <span class="comment">// implemented abstractly, careful!</span></div><div class="line">    <span class="keyword">for</span> (CFIndex idx = otherRange.location; idx &lt; otherRange.location + otherRange.length; idx++) &#123;</div><div class="line">        CFArrayAppendValue(<span class="built_in">array</span>, CFArrayGetValueAtIndex(otherArray, idx));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="åˆ ï¼šä¸ºå¯å˜æ•°ç»„åˆ é™¤å…ƒç´ "><a href="#åˆ ï¼šä¸ºå¯å˜æ•°ç»„åˆ é™¤å…ƒç´ " class="headerlink" title="åˆ ï¼šä¸ºå¯å˜æ•°ç»„åˆ é™¤å…ƒç´ "></a>åˆ ï¼šä¸ºå¯å˜æ•°ç»„åˆ é™¤å…ƒç´ </h4><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark array delete</span></div><div class="line"><span class="comment">//åˆ é™¤æ•°ç»„idxä½ç½®çš„å…ƒç´ ï¼ˆè°ƒç”¨_CFArrayReplaceValuesï¼‰</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CFArrayRemoveValueAtIndex</span><span class="params">(CFMutableArrayRef <span class="built_in">array</span>, CFIndex idx)</span> </span>&#123;</div><div class="line">    CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), <span class="keyword">void</span>, (NSMutableArray *)<span class="built_in">array</span>, removeObjectAtIndex:(NSUInteger)idx);</div><div class="line">    __CFGenericValidateType(<span class="built_in">array</span>, CFArrayGetTypeID());</div><div class="line">    CFAssert1(__CFArrayGetType(<span class="built_in">array</span>) != __kCFArrayImmutable, __kCFLogAssertion, <span class="string">"%s(): array is immutable"</span>, __PRETTY_FUNCTION__);</div><div class="line">    CFAssert2(<span class="number">0</span> &lt;= idx &amp;&amp; idx &lt; __CFArrayGetCount(<span class="built_in">array</span>), __kCFLogAssertion, <span class="string">"%s(): index (%d) out of bounds"</span>, __PRETTY_FUNCTION__, idx);</div><div class="line">    CHECK_FOR_MUTATION(<span class="built_in">array</span>);</div><div class="line">    </div><div class="line">    _CFArrayReplaceValues(<span class="built_in">array</span>, CFRangeMake(idx, <span class="number">1</span>), <span class="literal">NULL</span>, <span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">//åˆ é™¤æ•°ç»„ä¸­æ‰€æœ‰çš„å…ƒç´ ï¼ˆè°ƒç”¨_CFArrayReplaceValuesï¼‰</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CFArrayRemoveAllValues</span><span class="params">(CFMutableArrayRef <span class="built_in">array</span>)</span> </span>&#123;</div><div class="line">    CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), <span class="keyword">void</span>, (NSMutableArray *)<span class="built_in">array</span>, removeAllObjects);</div><div class="line">    __CFGenericValidateType(<span class="built_in">array</span>, CFArrayGetTypeID());</div><div class="line">    CFAssert1(__CFArrayGetType(<span class="built_in">array</span>) != __kCFArrayImmutable, __kCFLogAssertion, <span class="string">"%s(): array is immutable"</span>, __PRETTY_FUNCTION__);</div><div class="line">    CHECK_FOR_MUTATION(<span class="built_in">array</span>);</div><div class="line">    BEGIN_MUTATION(<span class="built_in">array</span>);</div><div class="line">    </div><div class="line">    __CFArrayReleaseValues(<span class="built_in">array</span>, CFRangeMake(<span class="number">0</span>, __CFArrayGetCount(<span class="built_in">array</span>)), <span class="literal">true</span>);</div><div class="line">    __CFArraySetCount(<span class="built_in">array</span>, <span class="number">0</span>);</div><div class="line">    <span class="built_in">array</span>-&gt;_mutations++;</div><div class="line">    </div><div class="line">    END_MUTATION(<span class="built_in">array</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="æ”¹ï¼šä¸ºå¯å˜æ•°ç»„æ›´æ”¹å…ƒç´ "><a href="#æ”¹ï¼šä¸ºå¯å˜æ•°ç»„æ›´æ”¹å…ƒç´ " class="headerlink" title="æ”¹ï¼šä¸ºå¯å˜æ•°ç»„æ›´æ”¹å…ƒç´ "></a>æ”¹ï¼šä¸ºå¯å˜æ•°ç»„æ›´æ”¹å…ƒç´ </h4><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä¿®æ”¹</span></div><div class="line"><span class="comment">//å°†ç¬¬idxä½ç½®çš„å…ƒç´ ä¿®æ”¹æˆå¯¹åº”çš„å€¼ï¼ˆè°ƒç”¨_CFArrayReplaceValuesï¼‰</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CFArraySetValueAtIndex</span><span class="params">(CFMutableArrayRef <span class="built_in">array</span>, CFIndex idx, <span class="keyword">const</span> <span class="keyword">void</span> *value)</span> </span>&#123;</div><div class="line">    CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), <span class="keyword">void</span>, (NSMutableArray *)<span class="built_in">array</span>, setObject:(id)value atIndex:(NSUInteger)idx);</div><div class="line">    __CFGenericValidateType(<span class="built_in">array</span>, CFArrayGetTypeID());</div><div class="line">    CFAssert1(__CFArrayGetType(<span class="built_in">array</span>) != __kCFArrayImmutable, __kCFLogAssertion, <span class="string">"%s(): array is immutable"</span>, __PRETTY_FUNCTION__);</div><div class="line">    CFAssert2(<span class="number">0</span> &lt;= idx &amp;&amp; idx &lt;= __CFArrayGetCount(<span class="built_in">array</span>), __kCFLogAssertion, <span class="string">"%s(): index (%d) out of bounds"</span>, __PRETTY_FUNCTION__, idx);</div><div class="line">    CHECK_FOR_MUTATION(<span class="built_in">array</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (idx == __CFArrayGetCount(<span class="built_in">array</span>)) &#123;</div><div class="line">        _CFArrayReplaceValues(<span class="built_in">array</span>, CFRangeMake(idx, <span class="number">0</span>), &amp;value, <span class="number">1</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        BEGIN_MUTATION(<span class="built_in">array</span>);</div><div class="line">        <span class="keyword">const</span> <span class="keyword">void</span> *old_value;</div><div class="line">        <span class="keyword">const</span> CFArrayCallBacks *cb = __CFArrayGetCallBacks(<span class="built_in">array</span>);</div><div class="line">        CFAllocatorRef allocator = __CFGetAllocator(<span class="built_in">array</span>);</div><div class="line">        <span class="keyword">struct</span> __CFArrayBucket *bucket = __CFArrayGetBucketAtIndex(<span class="built_in">array</span>, idx);</div><div class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != cb-&gt;retain &amp;&amp; !hasBeenFinalized(<span class="built_in">array</span>)) &#123;</div><div class="line">            value = (<span class="keyword">void</span> *)INVOKE_CALLBACK2(cb-&gt;retain, allocator, value);</div><div class="line">        &#125;</div><div class="line">        old_value = bucket-&gt;_item;</div><div class="line">        __CFAssignWithWriteBarrier((<span class="keyword">void</span> **)&amp;bucket-&gt;_item, (<span class="keyword">void</span> *)value); <span class="comment">// GC: handles deque/CFStorage cases.</span></div><div class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != cb-&gt;release &amp;&amp; !hasBeenFinalized(<span class="built_in">array</span>)) &#123;</div><div class="line">            INVOKE_CALLBACK2(cb-&gt;release, allocator, old_value);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        </div><div class="line">        <span class="built_in">array</span>-&gt;_mutations++;</div><div class="line">        END_MUTATION(<span class="built_in">array</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//ç”¨æ–°çš„æ•°ç»„ä»£æ›¿æ—§æ•°ç»„éƒ¨åˆ†å…ƒç´ ï¼ˆè°ƒç”¨_CFArrayReplaceValuesï¼‰</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CFArrayReplaceValues</span><span class="params">(CFMutableArrayRef <span class="built_in">array</span>, CFRange range, <span class="keyword">const</span> <span class="keyword">void</span> **newValues, CFIndex newCount)</span> </span>&#123;</div><div class="line">    </div><div class="line">    CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), <span class="keyword">void</span>, (NSMutableArray *)<span class="built_in">array</span>, replaceObjectsInRange:NSMakeRange(range.location, range.length) withObjects:(id *)newValues count:(NSUInteger)newCount);</div><div class="line">    __CFGenericValidateType(<span class="built_in">array</span>, CFArrayGetTypeID());</div><div class="line">    __CFArrayValidateRange(<span class="built_in">array</span>, range, __PRETTY_FUNCTION__);</div><div class="line">    </div><div class="line">    CFAssert1(__CFArrayGetType(<span class="built_in">array</span>) != __kCFArrayImmutable, __kCFLogAssertion, <span class="string">"%s(): array is immutable"</span>, __PRETTY_FUNCTION__);</div><div class="line">    CFAssert2(<span class="number">0</span> &lt;= newCount, __kCFLogAssertion, <span class="string">"%s(): newCount (%d) cannot be less than zero"</span>, __PRETTY_FUNCTION__, newCount);</div><div class="line">    </div><div class="line">    CHECK_FOR_MUTATION(<span class="built_in">array</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> _CFArrayReplaceValues(<span class="built_in">array</span>, range, newValues, newCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="æŸ¥ï¼šè¯»å–å¯å˜æ•°ç»„çš„å…ƒç´ "><a href="#æŸ¥ï¼šè¯»å–å¯å˜æ•°ç»„çš„å…ƒç´ " class="headerlink" title="æŸ¥ï¼šè¯»å–å¯å˜æ•°ç»„çš„å…ƒç´ "></a>æŸ¥ï¼šè¯»å–å¯å˜æ•°ç»„çš„å…ƒç´ </h4><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è·å–idxä½ç½®çš„æ•°å€¼ï¼ˆè°ƒç”¨__CFArrayGetBucketAtIndexï¼‰</span></div><div class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">void</span> *<span class="title">CFArrayGetValueAtIndex</span><span class="params">(CFArrayRef <span class="built_in">array</span>, CFIndex idx)</span> </span>&#123;</div><div class="line">    CF_OBJC_FUNCDISPATCHV(CFArrayGetTypeID(), <span class="keyword">const</span> <span class="keyword">void</span> *, (NSArray *)<span class="built_in">array</span>, objectAtIndex:idx);</div><div class="line">    __CFGenericValidateType(<span class="built_in">array</span>, CFArrayGetTypeID());</div><div class="line">    CFAssert2(<span class="number">0</span> &lt;= idx &amp;&amp; idx &lt; __CFArrayGetCount(<span class="built_in">array</span>), __kCFLogAssertion, <span class="string">"%s(): index (%d) out of bounds"</span>, __PRETTY_FUNCTION__, idx);</div><div class="line">    CHECK_FOR_MUTATION(<span class="built_in">array</span>);</div><div class="line">    <span class="keyword">return</span> __CFArrayGetBucketAtIndex(<span class="built_in">array</span>, idx)-&gt;_item;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="åˆ†æå¯å˜æ•°ç»„å­˜å‚¨æ–¹å¼"><a href="#åˆ†æå¯å˜æ•°ç»„å­˜å‚¨æ–¹å¼" class="headerlink" title="åˆ†æå¯å˜æ•°ç»„å­˜å‚¨æ–¹å¼"></a>åˆ†æå¯å˜æ•°ç»„å­˜å‚¨æ–¹å¼</h4><p>ä»â€œå¢åˆ æ”¹â€ä¸‰ä¸ªæ“ä½œé‡Œå¯ä»¥çœ‹å‡ºæ•´ä¸ªå¯å˜æ•°ç»„æ“ä½œçš„æ ¸å¿ƒæ–¹æ³•å°±æ˜¯ï¼š<code>_CFArrayReplaceValues</code></p>
<p>è€Œâ€œæŸ¥â€åŒ…æ‹¬â€œæ”¹â€åˆ™æ¶‰åŠå…³äºbucketsçš„æ“ä½œæ¯”å¦‚ï¼š<code>__CFArrayGetBucketAtIndex</code>ã€<code>__CFArrayGetBucketsPtr</code></p>
<p>å…ˆæ¥çœ‹ä¸‹bucketsç›¸å…³çš„æ–¹æ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /** è£…è½½å…ƒç´ æŒ‡é’ˆbucketçš„æ•´å—åŒºåŸŸéƒ½æ˜¯è¿ç»­çš„ï¼Œå› ä¸ºæ— è®ºImmutableè¿˜æ˜¯Dequeéƒ½æ»¡è¶³ï¼šç¬¬idxä¸ªæŒ‡é’ˆç­‰äºç¬¬ä¸€ä¸ªbucketæŒ‡é’ˆ+idxï¼Œåªæ˜¯å¯å˜æ•°ç»„å’Œä¸å¯å˜æ•°ç»„çš„ç¬¬ä¸€ä¸ªbucketæŒ‡é’ˆçš„ä½ç½®ä¸ä¸€æ · */</span></div><div class="line"><span class="comment">// /* Only applies to immutable and mutable-deque-using arrays;</span></div><div class="line"><span class="comment">// * Returns the bucket holding the left-most real value in the latter case. */</span></div><div class="line"><span class="comment">//è·å–ç¬¬ä¸€ä¸ªå…ƒç´ Bucketsçš„æŒ‡é’ˆ</span></div><div class="line">CF_INLINE <span class="keyword">struct</span> __CFArrayBucket *__CFArrayGetBucketsPtr(CFArrayRef <span class="built_in">array</span>) &#123;</div><div class="line">    <span class="keyword">switch</span> (__CFArrayGetType(<span class="built_in">array</span>)) &#123;</div><div class="line">            <span class="comment">//æ¯ä¸ªæ•°ç»„å…ƒç´ éƒ½ç”¨ä¸€ä¸ªbucketè£…ç€ï¼Œé€šè¿‡ç»“æ„ä½“æŒ‡é’ˆæ¥ç´¢å¼•ï¼Œé€šè¿‡æŒ‡é’ˆ+1æ¥è·å–å¯¹åº”bucketè£…ç€çš„å…ƒç´ ï¼ˆitemï¼‰</span></div><div class="line">        <span class="keyword">case</span> __kCFArrayImmutable:</div><div class="line">            <span class="comment">//ç¬¬ä¸€ä¸ªå…ƒç´ çš„BucketæŒ‡é’ˆä½ç½®ï¼šarrayçš„æŒ‡é’ˆ + ç©ºæ•°ç»„å¤§å°</span></div><div class="line">            <span class="keyword">return</span> (<span class="keyword">struct</span> __CFArrayBucket *)( (<span class="keyword">uint8_t</span> *)<span class="built_in">array</span> + __CFArrayGetSizeOfType(((CFRuntimeBase *)<span class="built_in">array</span>)-&gt;_cfinfo[CF_INFO_BITS]));</div><div class="line">        <span class="keyword">case</span> __kCFArrayDeque: &#123;</div><div class="line">            <span class="comment">//è·å–é˜Ÿåˆ—ç»“æ„ä½“çš„æŒ‡é’ˆ</span></div><div class="line">            <span class="keyword">struct</span> __CFArrayDeque *<span class="built_in">deque</span> = (<span class="keyword">struct</span> __CFArrayDeque *)<span class="built_in">array</span>-&gt;_store;</div><div class="line">            <span class="comment">//é˜Ÿåˆ—ç»“æ„ä½“çš„æŒ‡é’ˆ + é˜Ÿåˆ—ç»“æ„ä½“å¤§å° + é˜Ÿåˆ—å·¦å€¼*bucketå¤§å°</span></div><div class="line">            <span class="keyword">return</span> (<span class="keyword">struct</span> __CFArrayBucket *)((<span class="keyword">uint8_t</span> *)<span class="built_in">deque</span> + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayDeque) + <span class="built_in">deque</span>-&gt;_leftIdx * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/* This shouldn't be called if the array count is 0. */</span></div><div class="line"><span class="comment">//è·å–ç¬¬idxä¸ªå…ƒç´ Bucketsçš„æŒ‡é’ˆ</span></div><div class="line">CF_INLINE <span class="keyword">struct</span> __CFArrayBucket *__CFArrayGetBucketAtIndex(CFArrayRef <span class="built_in">array</span>, CFIndex idx) &#123;</div><div class="line">    <span class="keyword">switch</span> (__CFArrayGetType(<span class="built_in">array</span>)) &#123;</div><div class="line">        <span class="keyword">case</span> __kCFArrayImmutable:</div><div class="line">        <span class="keyword">case</span> __kCFArrayDeque:</div><div class="line">            <span class="keyword">return</span> __CFArrayGetBucketsPtr(<span class="built_in">array</span>) + idx;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é‡è¦çš„ç»“è®ºï¼š<strong>è£…è½½å…ƒç´ æŒ‡é’ˆbucketçš„æ•´å—åŒºåŸŸéƒ½æ˜¯è¿ç»­çš„ï¼Œå› ä¸ºæ— è®ºå¯å˜è¿˜æ˜¯ä¸å¯å˜éƒ½æ»¡è¶³ï¼šç¬¬idxä¸ªæŒ‡é’ˆç­‰äºç¬¬ä¸€ä¸ªbucketæŒ‡é’ˆ+idxï¼Œåªæ˜¯å¯å˜æ•°ç»„å’Œä¸å¯å˜æ•°ç»„çš„ç¬¬ä¸€ä¸ªbucketæŒ‡é’ˆçš„ä½ç½®ä¸ä¸€æ ·</strong></p>
<p>æœ‰ç”¨çš„ä¿¡æ¯æœ‰ï¼š</p>
<ul>
<li>å¯å˜æ•°ç»„æ•°æ®å­˜å‚¨ä¹Ÿæ˜¯è¿ç»­çš„</li>
<li>å¯å˜æ•°ç»„çš„å…ƒç´ æ˜¯å­˜åœ¨<code>__CFArrayDeque</code>åé¢ï¼Œä¸å¯å˜æ•°ç»„çš„å…ƒç´ æ˜¯ç›´æ¥æ”¾åœ¨<code>__CFArray</code>åé¢çš„</li>
<li>å¯å˜æ•°ç»„å¹¶ä¸æ˜¯ç›´æ¥å°†æ•°ç»„è·Ÿåœ¨<code>__CFArrayDeque</code>åé¢çš„ï¼Œè€Œæ˜¯åç§»äº†<code>_leftIdx</code>ä½çš„</li>
</ul>
<p>æœ€åä¸€ç‚¹æ¯”è¾ƒéš¾ç†è§£ï¼Œæˆ‘ä»¬å›å¤´çœ‹ä¸€ä¸‹<code>__CFArrayDeque</code>è¿™ä¸ªç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> __CFArrayDeque &#123;</div><div class="line">    <span class="keyword">uintptr_t</span> _leftIdx;</div><div class="line">    <span class="keyword">uintptr_t</span> _capacity;</div><div class="line">    <span class="comment">/* struct __CFArrayBucket buckets follow here */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œé¢æœ‰ä¸¤ä¸ªæˆå‘˜ï¼š</p>
<ul>
<li>uintptr_t _capacityï¼šå®¹é‡</li>
<li>uintptr_t _leftIdxï¼šåç§»é‡</li>
</ul>
<p>å¦‚æœè¯´å•çº¯æ ‡è®°æ•°ç»„å…ƒç´ å…ƒç´ çš„è¯ç”¨<code>_count</code>è¶³å¤Ÿäº†ï¼Œå®Œå…¨æ²¡å¿…è¦åŠ <code>_capacity</code>è¿™ä¸ªæˆå‘˜ï¼ŒåŠ ä¸Šåˆšåˆšçš„æçš„åç§»äº†<code>_leftIdx</code>ä½ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£è¿™ä¸ª<strong><code>_capacity</code>æ˜¯ä¸€ä¸ªå¤§äºå…ƒç´ ä¸ªæ•°çš„å®¹å™¨ï¼Œè€Œæ•°ç»„å…ƒç´ åªå­˜åœ¨å®¹å™¨å†…çš„ä¸€éƒ¨åˆ†</strong>ã€‚</p>
<p>è€Œä¸<code>_capacity</code>ç›¸å…³çš„ä¸»è¦å°±ä¸€ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">    __CF_MAX_BUCKETS_PER_DEQUE = LONG_MAX</div><div class="line">&#125;;</div><div class="line"><span class="comment">// capacity &lt; 4        =&gt; è¿”å›4</span></div><div class="line"><span class="comment">// __CF_MAX_BUCKETS_PER_DEQUE &gt; capacity &gt;= 4     =&gt; capacity-&gt;2è¿›åˆ¶ï¼Œè·å–ä½æ•°nï¼Œè¿”å› 2^n</span></div><div class="line"><span class="comment">// capacity &gt;= __CF_MAX_BUCKETS_PER_DEQUE           =&gt; è¿”å›__CF_MAX_BUCKETS_PER_DEQUE</span></div><div class="line"><span class="comment">// egï¼š</span></div><div class="line"><span class="comment">// 1~3 =&gt; 4</span></div><div class="line"><span class="comment">// 4~7 =&gt; 8</span></div><div class="line"><span class="comment">// 8~15 =&gt; 16</span></div><div class="line"><span class="comment">//flsl:  return the position of the first bit set, or 0 if no bits are set in value.</span></div><div class="line">CF_INLINE CFIndex __CFArrayDequeRoundUpCapacity(CFIndex capacity) &#123;</div><div class="line">    <span class="keyword">if</span> (capacity &lt; <span class="number">4</span>) <span class="keyword">return</span> <span class="number">4</span>;</div><div class="line">    <span class="keyword">return</span> __CFMin((<span class="number">1</span> &lt;&lt; flsl(capacity)), __CF_MAX_BUCKETS_PER_DEQUE);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯æ ¹æ®æ•°ç»„çš„å…ƒç´ ä¸ªæ•°æ¥è·å–è¿™ä¸ª<code>_capacity</code>å¤§å°ã€‚</p>
<p>è¿™é‡Œä¸»è¦ä¹Ÿæ˜¯é‡‡ç”¨äºŒè¿›åˆ¶æ¥è¿ç®—çš„ï¼Œå¯èƒ½å¤§å®¶çœ‹èµ·æ¥æœ‰ç‚¹å›°éš¾ï¼Œå…¶å®ç”¨åè¿›åˆ¶æ¥æè¿°å°±ååˆ†æ¸…æ¥šï¼š</p>
<p>0-9 =&gt; 10</p>
<p>10-99 =&gt;100</p>
<p>100-999 =&gt; 1000</p>
<p>â€¦.</p>
<p>ç›¸å½“äºæ€»æ˜¯ç”¨æ¯”è¿™ä¸ªæ•°å¤šä¸€ä½çš„æ•°æ¥ä½œä¸ºå®¹å™¨çš„å®¹é‡ã€‚</p>
<p>ä½†åŒæ ·æ˜¯ä¸ºäº†åŠ å¿«æ•ˆç‡ï¼Œè‹¹æœæ˜¯ç”¨äºŒè¿›åˆ¶æ¥å¤„ç†çš„ï¼š</p>
<p>0-11 =&gt; 100            å³ 0-3 =&gt; 4</p>
<p>100-111 =&gt; 1000        å³4~7 =&gt; 8</p>
<p>1000-1111 =&gt; 10000    å³8~15 =&gt; 16</p>
<p>â€¦</p>
<p>ç†è§£äº†è¿™ä¸€ç‚¹ä¹‹åï¼Œå…¶å®åªç”¨ç†è§£<code>_leftIdx</code>çš„å«ä¹‰å°±å¯ä»¥åˆ†æå‡ºå¯å˜æ•°ç»„æ˜¯æ€ä¹ˆå­˜çš„äº†ï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹<code>_CFArrayReplaceValues</code>ã€‚</p>
<p>ç”±äºæˆ‘ä»¬é‡ç‚¹æ˜¯äº†è§£å¦‚ä½•å¾€<code>__CFArrayDeque</code>å†™æ•°æ®çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä»¥ç›´æ¥å¯¹ä¸€ä¸ªç©ºæ•°ç»„ä¸€æ¬¡æ€§æ·»åŠ 4ä¸ªå…ƒç´ æ¥æ“ä½œï¼Œè¿™æ—¶å€™æˆ‘ä»¬å‘ç°<code>__CFArrayDeque</code>æ˜¯åœ¨ä»¥ä¸‹ä»£ç ä¸‹è¢«åˆå§‹åŒ–çš„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="number">0</span>) &#123;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">NULL</span> == <span class="built_in">array</span>-&gt;_store) &#123;</div><div class="line">	<span class="comment">//æ–°æ•°ç»„æˆ–è€…è¢«æ¸…ç©ºçš„æ•°ç»„ä¼šè¿›æ¥</span></div><div class="line">	<span class="keyword">if</span> (<span class="number">0</span>) &#123;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> &lt;= futureCnt) &#123;  </div><div class="line">	    <span class="comment">// å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—å¯¹è±¡</span></div><div class="line">    	<span class="keyword">struct</span> __CFArrayDeque *<span class="built_in">deque</span>;</div><div class="line">    	<span class="comment">// æ ¹æ®å…ƒç´ æ€»æ•°ç¡®å®šå®¹å™¨å¯è½½å…ƒç´ æ€»æ•°</span></div><div class="line">    	CFIndex capacity = __CFArrayDequeRoundUpCapacity(futureCnt);</div><div class="line">    	<span class="comment">// æ ¹æ®å®¹å™¨åˆ†é…ç©ºé—´å¤§å°</span></div><div class="line">    	CFIndex size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayDeque) + capacity * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket);</div><div class="line">       <span class="comment">// åˆå§‹åŒ–dequeï¼ŒåŠ è¿›_storeé‡Œ</span></div><div class="line">       <span class="built_in">deque</span> = (<span class="keyword">struct</span> __CFArrayDeque *)CFAllocatorAllocate((allocator), size, isStrongMemory(<span class="built_in">array</span>) ? __kCFAllocatorGCScannedMemory : <span class="number">0</span>);</div><div class="line">       <span class="keyword">if</span> (__CFOASafe) __CFSetLastAllocationEventName(<span class="built_in">deque</span>, <span class="string">"CFArray (store-deque)"</span>);</div><div class="line">            <span class="built_in">deque</span>-&gt;_leftIdx = (capacity - newCount) / <span class="number">2</span>;<span class="comment">//ä½¿å¾—æ·»åŠ äº†ç›®æ ‡å…ƒç´ ä¹‹åä¸Šä¸‹å‰©ä½™çš„ç©ºé—´æ˜¯ç›¸åŒçš„ï¼Œè¿™æ—¶å€™ä»å¤´å’Œå°¾æ·»åŠ å°‘é‡å…ƒç´ æ—¶éƒ½ä¸éœ€è¦é‡æ–°å¼€è¾Ÿç©ºé—´</span></div><div class="line">       <span class="built_in">deque</span>-&gt;_capacity = capacity;</div><div class="line">       __CFAssignWithWriteBarrier((<span class="keyword">void</span> **)&amp;<span class="built_in">array</span>-&gt;_store, (<span class="keyword">void</span> *)<span class="built_in">deque</span>);</div><div class="line">       <span class="keyword">if</span> (CF_IS_COLLECTABLE_ALLOCATOR(allocator)) 				auto_zone_release(objc_collectableZone(), <span class="built_in">deque</span>); <span class="comment">// GC: now safe to unroot the array body.</span></div><div class="line">	&#125;        </div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">   <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨é‡Šå·²ç»å†™çš„å¾ˆæ¸…æ¥šäº†ï¼Œé»˜è®¤æƒ…å†µä¸‹æ•°ç»„çš„å…ƒç´ æ˜¯ä¼šæ”¾åœ¨è¿™ä¸ªå®¹å™¨çš„ä¸­é—´çš„ï¼Œä¸Šä¸‹éƒ½ä¿ç•™ç›¸ç­‰çš„ç©ºé—´ã€‚</p>
<p>è€Œä½œç”¨å‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆæ˜æ˜¾â€”â€”å°±æ˜¯æ–¹ä¾¿å‰åå…ƒç´ çš„å¢åˆ æ“ä½œçš„</p>
<h3 id="å°ç»“â€”â€”å¯å˜æ•°ç»„åœ¨å†…å­˜çš„å­˜å‚¨æ–¹å¼"><a href="#å°ç»“â€”â€”å¯å˜æ•°ç»„åœ¨å†…å­˜çš„å­˜å‚¨æ–¹å¼" class="headerlink" title="å°ç»“â€”â€”å¯å˜æ•°ç»„åœ¨å†…å­˜çš„å­˜å‚¨æ–¹å¼"></a>å°ç»“â€”â€”å¯å˜æ•°ç»„åœ¨å†…å­˜çš„å­˜å‚¨æ–¹å¼</h3><p>è‡³æ­¤æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹å¯å˜æ•°ç»„çš„å­˜å‚¨æ–¹å¼ï¼š</p>
<p><strong><code>__CFArray</code>ç»“æ„ä½“å’Œä¸å¯å˜æ•°ç»„ä¸€æ ·ï¼Œæ ¹æ®æ˜¯å¦æœ‰è®¾ç½®è‡ªå®šä¹‰CallBackï¼Œæ¥åˆ¤æ–­æ˜¯å¦åœ¨ç»“æ„ä½“åé¢å¼€è¾Ÿå†…å­˜æ¥å­˜å–<code>CFArrayCallBacks</code>ï¼Œè€ŒçœŸæ­£æ•°ç»„å…ƒç´ æ˜¯å­˜åœ¨é€šè¿‡<code>_store</code>ç´¢å¼•çš„ä¸€ä¸ª<code>__CFArrayDeque</code>ç»“æ„ä½“åé¢çš„ä¸€å—å†…å­˜ç©ºé—´çš„ï¼Œè€Œä¸”å‰åè¿˜ä¿ç•™äº†ä¸€äº›ç©ºä½ï¼Œä»¥ä¾›å…ƒç´ çš„å¢åˆ æ“ä½œ</strong></p>
<p><img src="å¯å˜æ•°ç»„.png" alt=""></p>
<h3 id="CFArrayReplaceValuesâ€”â€”è¯¦ç»†è§£è¯»å¯å˜æ•°ç»„çš„æ“ä½œè¿‡ç¨‹"><a href="#CFArrayReplaceValuesâ€”â€”è¯¦ç»†è§£è¯»å¯å˜æ•°ç»„çš„æ“ä½œè¿‡ç¨‹" class="headerlink" title="_CFArrayReplaceValuesâ€”â€”è¯¦ç»†è§£è¯»å¯å˜æ•°ç»„çš„æ“ä½œè¿‡ç¨‹"></a><code>_CFArrayReplaceValues</code>â€”â€”è¯¦ç»†è§£è¯»å¯å˜æ•°ç»„çš„æ“ä½œè¿‡ç¨‹</h3><p>ç›´æ¥ä¸Šæºç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /**</span></div><div class="line"><span class="comment">// *  @param array:è¦æ“ä½œçš„æ•°ç»„</span></div><div class="line"><span class="comment">// *  @param range:è¦æ“ä½œçš„èŒƒå›´ï¼šrange.locationè¡¨ç¤ºä»åŸæ•°ç»„çš„å“ªä½å¼€å§‹æ“ä½œï¼Œrange.lengthè¡¨ç¤ºåŸæ•°ç»„ä¸­éœ€è¦æ“ä½œçš„æ•°é‡</span></div><div class="line"><span class="comment">// *  @param newValues:æ“ä½œçš„æ–°æ•°å€¼æ•°ç»„</span></div><div class="line"><span class="comment">// *  @param newCount:æ–°æ•°å€¼çš„æ•°é‡</span></div><div class="line"><span class="comment">// */</span></div><div class="line"><span class="comment">// This function does no ObjC dispatch or argument checking;</span></div><div class="line"><span class="comment">// It should only be called from places where that dispatch and check has already been done, or NSCFArray</span></div><div class="line"><span class="keyword">void</span> _CFArrayReplaceValues(CFMutableArrayRef <span class="built_in">array</span>, CFRange range, <span class="keyword">const</span> <span class="keyword">void</span> **newValues, CFIndex newCount) &#123;</div><div class="line">    </div><div class="line">    CHECK_FOR_MUTATION(<span class="built_in">array</span>);</div><div class="line">    BEGIN_MUTATION(<span class="built_in">array</span>);</div><div class="line">    <span class="comment">//cb: callback</span></div><div class="line">    <span class="comment">//idx: å¾ªç¯å†…çš„ä¸´æ—¶å˜é‡</span></div><div class="line">    <span class="comment">//cnt: æ•°ç»„å˜åŒ–ä¹‹å‰çš„å…ƒç´ ä¸ªæ•°</span></div><div class="line">    <span class="comment">//futureCnt: æ•°ç»„å˜åŒ–ä¹‹åçš„å…ƒç´ ä¸ªæ•°</span></div><div class="line">    <span class="comment">//newv: æ–°å€¼æ•°ç»„ï¼Œçº³å…¥Allocatorç®¡ç†</span></div><div class="line">    <span class="comment">//buffer: 256ä¸ªæŒ‡é’ˆå…ƒç´ çš„æ•°ç»„,å¤§å°ä¸º256X8=2048bit</span></div><div class="line">    <span class="keyword">const</span> CFArrayCallBacks *cb;</div><div class="line">    CFIndex idx, cnt, futureCnt;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">void</span> **newv, *buffer[<span class="number">256</span>];</div><div class="line">    cnt = __CFArrayGetCount(<span class="built_in">array</span>);</div><div class="line">    futureCnt = cnt - range.length + newCount;</div><div class="line">    CFAssert1(newCount &lt;= futureCnt, __kCFLogAssertion, <span class="string">"%s(): internal error 1"</span>, __PRETTY_FUNCTION__);</div><div class="line">    cb = __CFArrayGetCallBacks(<span class="built_in">array</span>);</div><div class="line">    CFAllocatorRef allocator = __CFGetAllocator(<span class="built_in">array</span>);</div><div class="line">    </div><div class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦retain</span></div><div class="line">    <span class="comment">/* Retain new values if needed, possibly allocating a temporary buffer for them */</span></div><div class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != cb-&gt;retain &amp;&amp; !hasBeenFinalized(<span class="built_in">array</span>)) &#123;</div><div class="line">        <span class="comment">//ä¸ªæ•°å°äº256ï¼Œå°±ç›´æ¥ç”¨ä¸ªæ•°ä¸º256çš„cæ•°ç»„ï¼Œå¦åˆ™Allocatoræ¥ç®¡ç†å†…å­˜</span></div><div class="line">        newv = (newCount &lt;= <span class="number">256</span>) ? (<span class="keyword">const</span> <span class="keyword">void</span> **)buffer : (<span class="keyword">const</span> <span class="keyword">void</span> **)CFAllocatorAllocate(kCFAllocatorSystemDefault, newCount * <span class="keyword">sizeof</span>(<span class="keyword">void</span> *), <span class="number">0</span>); <span class="comment">// GC OK</span></div><div class="line">        <span class="keyword">if</span> (newv != buffer &amp;&amp; __CFOASafe) __CFSetLastAllocationEventName(newv, <span class="string">"CFArray (temp)"</span>);</div><div class="line">        <span class="keyword">for</span> (idx = <span class="number">0</span>; idx &lt; newCount; idx++) &#123;</div><div class="line">            <span class="comment">///#define INVOKE_CALLBACK2(P, A, B) (P)(A, B)</span></div><div class="line">            newv[idx] = (<span class="keyword">void</span> *)INVOKE_CALLBACK2(cb-&gt;retain, allocator, (<span class="keyword">void</span> *)newValues[idx]);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        newv = newValues;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">array</span>-&gt;_mutations++;</div><div class="line">    </div><div class="line">    <span class="comment">// å°†ä¸€ä¸ªæ•°ç»„çš„å…ƒç´ åŒºåŸŸåˆ†æˆäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½å¯èƒ½ä¸ºç©º</span></div><div class="line">    <span class="comment">// A: ä»ç´¢å¼•ä¸‹æ ‡é›¶çš„ä½ç½®åˆ°å°äº range.location çš„åŒºåŸŸ</span></div><div class="line">    <span class="comment">// B: ä¼ å…¥çš„ range.location åŒºåŸŸ</span></div><div class="line">    <span class="comment">// C: ä» range.location + range.length åˆ°æ•°ç»„æœ«å°¾</span></div><div class="line">    <span class="comment">//å¹²æ‰BåŒºåŸŸæ•°æ®</span></div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> &lt; range.length) &#123;</div><div class="line">        __CFArrayReleaseValues(<span class="built_in">array</span>, range, <span class="literal">false</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span>) &#123;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">NULL</span> == <span class="built_in">array</span>-&gt;_store) &#123;</div><div class="line">        <span class="comment">//æ–°æ•°ç»„æˆ–è€…è¢«æ¸…ç©ºçš„æ•°ç»„ä¼šè¿›æ¥</span></div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span>) &#123;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> &lt;= futureCnt) &#123;</div><div class="line">            </div><div class="line">            <span class="comment">// å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—å¯¹è±¡</span></div><div class="line">            <span class="keyword">struct</span> __CFArrayDeque *<span class="built_in">deque</span>;</div><div class="line">            <span class="comment">// æ ¹æ®å…ƒç´ æ€»æ•°ç¡®å®šå®¹å™¨å¯è½½å…ƒç´ æ€»æ•°</span></div><div class="line">            CFIndex capacity = __CFArrayDequeRoundUpCapacity(futureCnt);</div><div class="line">            <span class="comment">// æ ¹æ®å®¹å™¨åˆ†é…ç©ºé—´å¤§å°</span></div><div class="line">            CFIndex size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayDeque) + capacity * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket);</div><div class="line">            <span class="comment">// åˆå§‹åŒ–dequeï¼ŒåŠ è¿›_storeé‡Œ</span></div><div class="line">            <span class="built_in">deque</span> = (<span class="keyword">struct</span> __CFArrayDeque *)CFAllocatorAllocate((allocator), size, isStrongMemory(<span class="built_in">array</span>) ? __kCFAllocatorGCScannedMemory : <span class="number">0</span>);</div><div class="line">            <span class="keyword">if</span> (__CFOASafe) __CFSetLastAllocationEventName(<span class="built_in">deque</span>, <span class="string">"CFArray (store-deque)"</span>);</div><div class="line">            <span class="built_in">deque</span>-&gt;_leftIdx = (capacity - newCount) / <span class="number">2</span>;<span class="comment">//åŸå› ï¼šä½¿å¾—æ·»åŠ äº†ç›®æ ‡å…ƒç´ ä¹‹åä¸Šä¸‹å‰©ä½™çš„ç©ºé—´æ˜¯ç›¸åŒçš„ï¼Œè¿™æ—¶å€™ä»å¤´å’Œå°¾æ·»åŠ å°‘é‡å…ƒç´ æ—¶éƒ½ä¸éœ€è¦é‡æ–°å¼€è¾Ÿç©ºé—´</span></div><div class="line">            <span class="built_in">deque</span>-&gt;_capacity = capacity;</div><div class="line">            __CFAssignWithWriteBarrier((<span class="keyword">void</span> **)&amp;<span class="built_in">array</span>-&gt;_store, (<span class="keyword">void</span> *)<span class="built_in">deque</span>);</div><div class="line">            <span class="keyword">if</span> (CF_IS_COLLECTABLE_ALLOCATOR(allocator)) auto_zone_release(objc_collectableZone(), <span class="built_in">deque</span>); <span class="comment">// GC: now safe to unroot the array body.</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125; <span class="keyword">else</span> &#123;		<span class="comment">// Deque</span></div><div class="line">        <span class="comment">//dequeå·²ç»åˆ›å»ºå‡ºæ¥ï¼Œå…ƒç´ ä¸ªæ•°ä¸ä¸ºç©º</span></div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span>) &#123;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (range.length != newCount) &#123;</div><div class="line">            <span class="comment">//æ ¹æ®BåŒºåŸŸå…ƒç´ ä¸ªæ•°ï¼ŒæŒªåŠ¨Aã€CåŒºåŸŸ</span></div><div class="line">            __CFArrayRepositionDequeRegions(<span class="built_in">array</span>, range, newCount);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//ä»¥ä¸Šæ“ä½œåªæ˜¯å¼€è¾Ÿæ–°ç©ºé—´ï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰æŠŠæ–°çš„å…ƒç´ å¼„è¿›æ•°ç»„é‡Œï¼Œä¸‹é¢æŠŠå…ƒç´ ç§»è¿›æ•°ç»„é‡Œ</span></div><div class="line">    <span class="comment">// copy in new region B elements</span></div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> &lt; newCount) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span>) &#123;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;	<span class="comment">// Deque</span></div><div class="line">            <span class="keyword">struct</span> __CFArrayDeque *<span class="built_in">deque</span> = (<span class="keyword">struct</span> __CFArrayDeque *)<span class="built_in">array</span>-&gt;_store;</div><div class="line">            <span class="keyword">struct</span> __CFArrayBucket *raw_buckets = (<span class="keyword">struct</span> __CFArrayBucket *)((<span class="keyword">uint8_t</span> *)<span class="built_in">deque</span> + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayDeque));</div><div class="line">            <span class="comment">///TODOï¼šobjc_memmove_collectable???</span></div><div class="line">            objc_memmove_collectable(raw_buckets + <span class="built_in">deque</span>-&gt;_leftIdx + range.location, newv, newCount * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    __CFArraySetCount(<span class="built_in">array</span>, futureCnt);</div><div class="line">    <span class="keyword">if</span> (newv != buffer &amp;&amp; newv != newValues) CFAllocatorDeallocate(kCFAllocatorSystemDefault, newv);</div><div class="line">    END_MUTATION(<span class="built_in">array</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»£ç é‡å¾ˆå¤§ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹æ•´ä¸ªReplaceçš„æ­¥éª¤</p>
<ol>
<li>å¯¹newValuesè¿›è¡Œretainå¤„ç†</li>
<li>æ¸…é™¤åŸæ•°ç»„ä¸­è¦è¢«æ›¿ä»£çš„rangeå†…çš„å…ƒç´ </li>
<li>æ ¹æ®æ–°å¢ä¸ªæ•°å¯¹åŸæ¥å†…å­˜çš„å…ƒç´ è¿›è¡Œå…ƒç´ æŒªåŠ¨ï¼ˆå¯èƒ½è¿˜ä¼šä¸ºæ–°æ•°ç»„å¼€è¾Ÿç©ºä»¶ï¼‰</li>
<li>æŠŠæ–°å¢å…ƒç´ æ·»åŠ åˆ°å¯¹åº”çš„dequeçš„ä½ç½®</li>
</ol>
<p>å…¶ä¸­1ã€2ã€4æ­¥éª¤éƒ½ç›´æ¥å±•ç¤ºå‡ºæ¥çš„ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç†è§£ä¸Šçš„å›°éš¾ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹ç¬¬3æ­¥ï¼Œç¬¬ä¸‰æ­¥æ˜¯é€šè¿‡<code>__CFArrayRepositionDequeRegions</code>å®ç°çš„ï¼Œè¿™ä¹Ÿæ˜¯ç†è§£æ•´ä¸ªæ•°ç»„å…ƒç´ æ“ä½œçš„é‡è¦ä¸€æ­¥ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// may move deque storage, as it may need to grow deque</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __CFArrayRepositionDequeRegions(CFMutableArrayRef <span class="built_in">array</span>, CFRange range, CFIndex newCount) &#123;</div><div class="line">    <span class="comment">// newCount elements are going to replace the range, and the result will fit in the deque</span></div><div class="line">    <span class="keyword">struct</span> __CFArrayDeque *<span class="built_in">deque</span> = (<span class="keyword">struct</span> __CFArrayDeque *)<span class="built_in">array</span>-&gt;_store;</div><div class="line">    <span class="keyword">struct</span> __CFArrayBucket *buckets;</div><div class="line">    CFIndex cnt, futureCnt, numNewElems;</div><div class="line">    CFIndex L, A, B, C, R;</div><div class="line">    </div><div class="line">    buckets = (<span class="keyword">struct</span> __CFArrayBucket *)((<span class="keyword">uint8_t</span> *)<span class="built_in">deque</span> + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayDeque));</div><div class="line">    cnt = __CFArrayGetCount(<span class="built_in">array</span>);</div><div class="line">    futureCnt = cnt - range.length + newCount;</div><div class="line">    </div><div class="line">    L = <span class="built_in">deque</span>-&gt;_leftIdx;		<span class="comment">// length of region to left of deque</span></div><div class="line">    A = range.location;			<span class="comment">// length of region in deque to left of replaced range</span></div><div class="line">    B = range.length;			<span class="comment">// length of replaced range</span></div><div class="line">    C = cnt - B - A;			<span class="comment">// length of region in deque to right of replaced range</span></div><div class="line">    R = <span class="built_in">deque</span>-&gt;_capacity - cnt - L;	<span class="comment">// length of region to right of deque</span></div><div class="line">    numNewElems = newCount - B;</div><div class="line">    </div><div class="line">    <span class="comment">// deque-&gt;_capacityä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯2^nè¿™é‡Œæ˜¯è®©n-17,</span></div><div class="line">    CFIndex wiggle = <span class="built_in">deque</span>-&gt;_capacity &gt;&gt; <span class="number">17</span>;</div><div class="line">    <span class="comment">// so: äºŒè¿›åˆ¶ä½æ•°å°äº20ä½æˆ–è€…åè¿›åˆ¶å°äº131072ï¼Œwiggle = 4ï¼Œ å¦åˆ™ wiggle = 2^(n-17)</span></div><div class="line">    <span class="keyword">if</span> (wiggle &lt; <span class="number">4</span>) wiggle = <span class="number">4</span>;</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">deque</span>-&gt;_capacity &lt; (<span class="keyword">uint32_t</span>)futureCnt || (cnt &lt; futureCnt &amp;&amp; L + R &lt; wiggle)) &#123;</div><div class="line">        <span class="comment">//æ­¤æ—¶ä¸€å®šè¦å¼€è¾Ÿæ–°çš„ç©ºé—´ï¼Œå¤§äºå¯æŠ–åŠ¨èŒƒå›´ï¼Œä¸èƒ½é€šè¿‡æŒªåŠ¨æ•°æ®å®Œæˆæ“ä½œ</span></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * å¼€è¾Ÿæ–°çš„ä¸€æ•´å—çš„è¿ç»­ç©ºé—´ï¼ˆåŒ…æ‹¬dequeç»“æ„ä½“ï¼‰ï¼Œè®¡ç®—æ–°çš„æ•°æ®å—ï¼ˆAã€Cï¼‰åœ¨æ–°ç©ºé—´çš„ä½ç½®ï¼Œmemoveç§»æ¤è¿‡å»ï¼Œ</div><div class="line">         */</div><div class="line">        <span class="comment">// must be inserting or space is tight, reallocate and re-center everything</span></div><div class="line">        CFIndex capacity = __CFArrayDequeRoundUpCapacity(futureCnt + wiggle);</div><div class="line">        CFIndex size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayDeque) + capacity * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket);</div><div class="line">        CFAllocatorRef allocator = __CFGetAllocator(<span class="built_in">array</span>);</div><div class="line">        Boolean collectableMemory = CF_IS_COLLECTABLE_ALLOCATOR(allocator);</div><div class="line">        </div><div class="line">        <span class="keyword">struct</span> __CFArrayDeque *newDeque = (<span class="keyword">struct</span> __CFArrayDeque *)CFAllocatorAllocate(allocator, size, isStrongMemory(<span class="built_in">array</span>) ? __kCFAllocatorGCScannedMemory : <span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> (__CFOASafe) __CFSetLastAllocationEventName(newDeque, <span class="string">"CFArray (store-deque)"</span>);</div><div class="line">        <span class="keyword">struct</span> __CFArrayBucket *newBuckets = (<span class="keyword">struct</span> __CFArrayBucket *)((<span class="keyword">uint8_t</span> *)newDeque + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayDeque));</div><div class="line">        </div><div class="line">        CFIndex oldL = L;</div><div class="line">        CFIndex newL = (capacity - futureCnt) / <span class="number">2</span>;</div><div class="line">        CFIndex oldC0 = oldL + A + B;</div><div class="line">        CFIndex newC0 = newL + A + newCount;</div><div class="line">        newDeque-&gt;_leftIdx = newL;</div><div class="line">        newDeque-&gt;_capacity = capacity;</div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span> &lt; A) objc_memmove_collectable(newBuckets + newL, buckets + oldL, A * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span> &lt; C) objc_memmove_collectable(newBuckets + newC0, buckets + oldC0, C * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">        __CFAssignWithWriteBarrier((<span class="keyword">void</span> **)&amp;<span class="built_in">array</span>-&gt;_store, (<span class="keyword">void</span> *)newDeque);</div><div class="line">        <span class="keyword">if</span> (!collectableMemory &amp;&amp; <span class="built_in">deque</span>) CFAllocatorDeallocate(allocator, <span class="built_in">deque</span>);</div><div class="line">        <span class="keyword">if</span> (CF_IS_COLLECTABLE_ALLOCATOR(allocator)) auto_zone_release(objc_collectableZone(), newDeque);</div><div class="line">        <span class="comment">//printf("3:  array %p store is now %p (%lx)\n", array, array-&gt;_store, *(unsigned long *)(array-&gt;_store));</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"><span class="comment">//    /**</span></div><div class="line"><span class="comment">//     *  numNewElems &lt; 0 è¯´æ˜æ•°æ®å˜å°‘äº†ï¼Œçœ‹æ˜¯Aå°è¿˜æ˜¯Cå°ï¼Œmemmoveä¸¤è€…å°çš„é‚£å—åŒºåŸŸå³å¯</span></div><div class="line"><span class="comment">//     *  numNewElems &gt; 0 è¯´æ˜æ•°æ®å˜å¤šäº†ï¼Œå¦‚æœA &gt; C ä¸” Cä¸‹é¢çš„RåŒºåŸŸå¤Ÿå¤§å°±memmove CåŒºåŸŸå³å¯ï¼Œ C &lt; A ä¸”ä¸Šé¢çš„LåŒºåŸŸå¤Ÿå¤§å°±memmove AåŒºåŸŸå³å¯</span></div><div class="line"><span class="comment">//     *  numNewElems &gt; 0 ä¸”ä¸ç¬¦åˆä¸Šè¿°è§„åˆ™ï¼Œ éœ€è¦æ ¹æ®å…·ä½“æƒ…å†µåŒæ—¶ç§»åŠ¨Aã€CåŒºåŸŸ</span></div><div class="line"><span class="comment">//     */</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ((numNewElems &lt; <span class="number">0</span> &amp;&amp; C &lt; A) || (numNewElems &lt;= R &amp;&amp; C &lt; A)) &#123;	<span class="comment">// move C</span></div><div class="line">        <span class="comment">// deleting: C is smaller</span></div><div class="line">        <span class="comment">// inserting: C is smaller and R has room</span></div><div class="line">        CFIndex oldC0 = L + A + B;</div><div class="line">        CFIndex newC0 = L + A + newCount;</div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span> &lt; C) objc_memmove_collectable(buckets + newC0, buckets + oldC0, C * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">        <span class="comment">// GrP GC: zero-out newly exposed space on the right, if any</span></div><div class="line">        <span class="keyword">if</span> (oldC0 &gt; newC0) <span class="built_in">memset</span>(buckets + newC0 + C, <span class="number">0</span>, (oldC0 - newC0) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((numNewElems &lt; <span class="number">0</span>) || (numNewElems &lt;= L &amp;&amp; A &lt;= C)) &#123;	<span class="comment">// move A</span></div><div class="line">        <span class="comment">// deleting: A is smaller or equal (covers remaining delete cases)</span></div><div class="line">        <span class="comment">// inserting: A is smaller and L has room</span></div><div class="line">        CFIndex oldL = L;</div><div class="line">        CFIndex newL = L - numNewElems;</div><div class="line">        <span class="built_in">deque</span>-&gt;_leftIdx = newL;</div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span> &lt; A) objc_memmove_collectable(buckets + newL, buckets + oldL, A * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">        <span class="comment">// GrP GC: zero-out newly exposed space on the left, if any</span></div><div class="line">        <span class="keyword">if</span> (newL &gt; oldL) <span class="built_in">memset</span>(buckets + oldL, <span class="number">0</span>, (newL - oldL) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// now, must be inserting, and either:</span></div><div class="line">        <span class="comment">//    A&lt;=C, but L doesn't have room (R might have, but don't care)</span></div><div class="line">        <span class="comment">//    C&lt;A, but R doesn't have room (L might have, but don't care)</span></div><div class="line">        <span class="comment">// re-center everything</span></div><div class="line">        CFIndex oldL = L;</div><div class="line">        CFIndex newL = (L + R - numNewElems) / <span class="number">2</span>;</div><div class="line">        newL = newL - newL / <span class="number">2</span>;</div><div class="line">        CFIndex oldC0 = oldL + A + B;</div><div class="line">        CFIndex newC0 = newL + A + newCount;</div><div class="line">        <span class="built_in">deque</span>-&gt;_leftIdx = newL;</div><div class="line">        <span class="keyword">if</span> (newL &lt; oldL) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="number">0</span> &lt; A) objc_memmove_collectable(buckets + newL, buckets + oldL, A * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">            <span class="keyword">if</span> (<span class="number">0</span> &lt; C) objc_memmove_collectable(buckets + newC0, buckets + oldC0, C * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">            <span class="comment">// GrP GC: zero-out newly exposed space on the right, if any</span></div><div class="line">            <span class="keyword">if</span> (oldC0 &gt; newC0) <span class="built_in">memset</span>(buckets + newC0 + C, <span class="number">0</span>, (oldC0 - newC0) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="number">0</span> &lt; C) objc_memmove_collectable(buckets + newC0, buckets + oldC0, C * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">            <span class="keyword">if</span> (<span class="number">0</span> &lt; A) objc_memmove_collectable(buckets + newL, buckets + oldL, A * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">            <span class="comment">// GrP GC: zero-out newly exposed space on the left, if any</span></div><div class="line">            <span class="keyword">if</span> (newL &gt; oldL) <span class="built_in">memset</span>(buckets + oldL, <span class="number">0</span>, (newL - oldL) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFArrayBucket));</div><div class="line">        &#125;</div><div class="line">    &#125;   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºè‹¹æœåœ¨è¿™å—è¿˜æ˜¯æœ‰åšæ¯”è¾ƒå¤šçš„ä¼˜åŒ–çš„ï¼Œå¤§è‡´è®²ä¸‹çš„æ€è·¯ï¼š</p>
<ul>
<li>é¦–å…ˆæ ¹æ®æ˜¯å¦è¦åˆ›å»ºç©ºé—´åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼šéœ€è¦åˆ†é…æ–°å†…å­˜ã€ä¸éœ€è¦åˆ†é…æ–°å†…å­˜<ul>
<li>éœ€è¦åˆ†é…æ–°å†…å­˜ï¼šé‡æ–°å¼€è¾Ÿä¸€æ•´ä¸ªèƒ½å®¹å¾—ä¸‹æ–°æ•°ç»„çš„å®¹å™¨ã€‚æŒ‰ç…§ä¹‹å‰çš„è§„åˆ™ï¼ˆæŠŠæ•°æ®æ”¾åˆ°ä¸­é—´ï¼‰æŠŠå¯¹åº”åŒºåŸŸçš„æ•°æ®æ‹·åˆ°ç›¸åº”çš„ä½ç½®ä¸­å»</li>
<li>ä¸éœ€è¦åˆ†é…æ–°å†…å­˜ï¼šåˆ¤æ–­æ˜¯å¢åŠ æ•°æ®è¿˜æ˜¯å‡å°‘æ•°æ®<ul>
<li>å‡å°‘æ•°æ®ï¼šåˆ¤æ–­æ˜¯AåŒºåŸŸå°è¿˜æ˜¯CåŒºåŸŸå°<ul>
<li>AåŒºåŸŸå°ï¼šç§»åŠ¨AåŒºåŸŸï¼Œé‡ç½®æ²¡ç”¨çš„å†…å­˜ç©ºé—´</li>
<li>CåŒºåŸŸå°ï¼šç§»åŠ¨CåŒºåŸŸï¼Œé‡ç½®æ²¡ç”¨çš„å†…å­˜ç©ºé—´</li>
</ul>
</li>
<li>å¢åŠ æ•°æ®ï¼šåˆ¤æ–­ä¸¤è€…åŒºåŸŸå…³ç³»ä»¥åŠä¸Šä¸‹æ˜¯å¦æœ‰è¶³å¤Ÿçš„å®¹é‡<ul>
<li>Aæ¯”Cå°ï¼Œä¸”ä¸Šé¢çš„LåŒºåŸŸæ¯”å¢åŠ çš„ä¸ªæ•°å¤§ï¼šç§»åŠ¨AåŒºåŸŸï¼Œé‡ç½®æ²¡ç”¨çš„å†…å­˜ç©ºé—´</li>
<li>Cæ¯”Aå°ï¼Œä¸”ä¸‹é¢çš„RåŒºåŸŸæ¯”å¢åŠ çš„ä¸ªæ•°å¤§ï¼šç§»åŠ¨CåŒºåŸŸï¼Œé‡ç½®æ²¡ç”¨çš„å†…å­˜ç©ºé—´</li>
<li>å…¶ä»–æƒ…å†µï¼šæŒ‰ç…§ä¹‹å‰çš„è§„åˆ™ï¼ˆæŠŠæ•°æ®æ”¾åˆ°ä¸­é—´ï¼‰åŒæ—¶ç§»åŠ¨Aã€CåŒºåŸŸï¼Œæ¸…é™¤æ²¡ç”¨æ•°æ®</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ï¼ˆå®ç°å’Œæˆ‘åˆ†æçš„å¯èƒ½éƒ¨åˆ†é¡ºåºä¸Šæœ‰ä¸åŒï¼Œä½†æ€è·¯ç›¸åŒï¼‰</p>
<p>å…³äºLã€Aã€Bã€Cã€RåŒºåŸŸçš„åˆ’åˆ†å¯ä»¥å‚ç…§ä¸‹å›¾ï¼šé¡ºä¾¿ä¸¾äº†å‡ ä¸ªä¾‹å­ï¼š</p>
<ul>
<li>ä¸éœ€è¦åˆ›å»ºå†…å­˜ç©ºé—´ï¼Œåªç§»åŠ¨Aï¼ˆCï¼‰ä¸€å—åŒºåŸŸï¼š</li>
</ul>
<p><img src="åæ’ä¸¤ä¸ªå…ƒç´ .png" alt=""></p>
<ul>
<li>ä¸éœ€è¦åˆ›å»ºå†…å­˜ç©ºé—´ï¼Œä½†æ˜¯è¦ç§»åŠ¨Aã€Cä¸¤å—åŒºåŸŸï¼š</li>
</ul>
<p><img src="å‰æ’ä¸¤ä¸ªå…ƒç´ .png" alt=""></p>
<ul>
<li>éœ€è¦åˆ›å»ºå†…å­˜ç©ºé—´ï¼ŒåŒæ—¶ç§»åŠ¨Aã€Cä¸¤å—åŒºåŸŸ</li>
</ul>
<p><img src="æ’å…¥å››ä¸ªå…ƒç´ .png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ç®—æ˜¯CoreFoundationæºç è§£æçš„ç¬¬ä¸€ç¯‡å§ï¼Œä¹‹åæœ‰æœºä¼šå¸Œæœ›èƒ½åšæ›´å¤šçš„æºç è§£æï¼Œå…¶å®åšè¿™å—çš„åŸå› å¾ˆç®€å•ï¼Œå…³äºè¿™å—çš„è§£æè¿˜æ˜¯è›®å°‘ï¼Œè€Œä½œä¸ºä¸€åiOSçš„å¼€å‘å·¥ç¨‹å¸ˆï¼Œæ²¡æœ‰æ¯”å­¦ä¹ å®˜æ–¹æºç çš„æ–¹å¼æ›´ç®€å•ç²—æš´ï¼Œå¯ä»¥ä»ä¸­å¸å–åˆ°å¾ˆå¤šå†…éƒ¨çš„ä»£ç é£æ ¼ï¼Œä¸ä»£ç çš„æŠ€å·§ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸‹å†…å®¹æˆ‘ä¼šåˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç®€å•ä»‹ç»ä¸‹ä»ç½‘ä¸ŠæŸ¥åˆ°çš„èµ„æ–™&lt;/li&gt;
&lt;li&gt;åˆ†ææºç ï¼Œä»‹ç»ä»æºç ä¸­è·å–åˆ°çš„æœ‰ç”¨çŸ¥è¯†&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://alfredzhenyu.github.io/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://alfredzhenyu.github.io/tags/iOS/"/>
    
      <category term="Objc" scheme="http://alfredzhenyu.github.io/tags/Objc/"/>
    
      <category term="æºç è§£æ" scheme="http://alfredzhenyu.github.io/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>2017å¹´çš„æ–°å¹´å¯„è¯­</title>
    <link href="http://alfredzhenyu.github.io/2017/02/07/2017%E5%B9%B4%E7%9A%84%E6%96%B0%E5%B9%B4%E5%AF%84%E8%AF%AD/"/>
    <id>http://alfredzhenyu.github.io/2017/02/07/2017å¹´çš„æ–°å¹´å¯„è¯­/</id>
    <published>2017-02-07T12:59:48.000Z</published>
    <updated>2017-02-07T10:39:27.000Z</updated>
    
    <content type="html"><![CDATA[<p>â€‹    è¿™æ˜¯2017å¹´è¿‡å®Œå†œå†æ–°å¹´çš„ç¬¬ä¸€ç¯‡blogï¼Œè¿‡å¹´ç»™è‡ªå·±æ”¾äº†ä¸ªå°å‡ï¼Œä¼‘æ¯äº†ä¸€æ®µæ—¶é—´ã€‚åˆšè¿‡å®Œå¹´ï¼Œä¸æƒ³å†™å¤ªå¤šæŠ€æœ¯æ€§çš„ä¸œè¥¿ã€‚æ‰€è°“æ–°å¹´æ–°å¸Œæœ›æ–°ç›®æ ‡ï¼Œåœ¨è¿™é‡Œä¹Ÿæƒ³ç»™è‡ªå·±å®šä¸ªæ–°çš„ç›®æ ‡ï¼Œç®—æ˜¯ç»™è‡ªå·±å®šéœ€æ±‚ï¼Œç£ä¿ƒä¸‹è‡ªå·±å§ã€‚</p>
<a id="more"></a>
<h2 id="2017çš„â€œå°ç›®æ ‡â€"><a href="#2017çš„â€œå°ç›®æ ‡â€" class="headerlink" title="2017çš„â€œå°ç›®æ ‡â€"></a>2017çš„â€œå°ç›®æ ‡â€</h2><ul>
<li>è¿›ä¸€æ­¥äº†è§£ä¸€äº›iOSçš„åº•å±‚å®ç°<ol>
<li>CF</li>
<li>Objc-runtime</li>
</ol>
</li>
<li>å¦‚æœæœ‰æœºä¼šçš„è¯å¯ä»¥æ¥è§¦ä¸‹JavaScriptCoreã€WebKitè¿™ç±»ç½‘ç»œæ¡†æ¶</li>
<li>äº†è§£ä¸‹iOS8ã€9ã€10çš„ä¸€äº›æ–°ç‰¹æ€§</li>
<li>æ·±å…¥å»å­¦ä¹ iOSçš„åŠ¨æ€éƒ¨ç½²æ–¹æ¡ˆ<ol>
<li>äº†è§£ä¸‹æ€ä¹ˆæ ·åœ¨iOSä¸Šé¢è·‘Luaï¼Œå¦‚æœæ–¹æ¡ˆå¯è¡Œçš„è¯å¯ä»¥è€ƒè™‘æ·±å…¥å­¦ä¹ ä¸‹luaï¼Œæœ‰æœºä¼šåº”ç”¨åœ¨å·¥ç¨‹é‡Œå»</li>
<li>æ·±å…¥ç†è§£RNåº•å±‚çš„å®ç°åŸç†ï¼Œäº‰å–èƒ½åšåˆ°æŠŠä¹‹å‰å­¦çš„RNåº”ç”¨åˆ°é¡¹ç›®ä¸­å»</li>
</ol>
</li>
<li>æ·±å…¥å­¦ä¹ OpenGL</li>
<li>æ¸¸æˆå¼€å‘ï¼ˆä»OpenGLå…¥é—¨è¿‡æ¸¡åˆ°3Dæ¸¸æˆçš„å¼€å‘ï¼Œå­¦ä¹ ä¸€ä¸ªæ¸¸æˆå¼•æ“ï¼‰<ol>
<li>SpiritKitï¼ˆæœ‰æœºä¼šå¯ä»¥é¡ºå¸¦äº†è§£ä¸‹Metalï¼‰</li>
<li>Unity3d/unrealè¿˜æ²¡çº ç»“å¥½é€‰å“ªä¸ª</li>
</ol>
</li>
<li>ç®—æ³•çš„ç§¯ç´¯ï¼ˆå¸Œæœ›æœ‰æœºä¼šèƒ½æ²‰æ·€ä¸‹ï¼‰</li>
<li>äº†è§£ä¸‹è§†é¢‘ç›´æ’­æŠ€æœ¯ï¼Œå¸Œæœ›æœ‰æœºä¼šèƒ½å‚ä¸å…¶ä¸­</li>
</ul>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æš‚æ—¶å°±è¿™ä¹ˆå¤šå•¦â€¦.å…¶å®æˆ‘è§‰å¾—å·²ç»ä¸æ˜¯å‡ ä¸ªâ€å°ç›®æ ‡â€è¿™ä¹ˆç®€å•äº†ï¼Œèƒ½å®Œæˆä¼°è®¡ä¼šæœ‰å¦å¤–ä¸€ä¸ªé£è·ƒå§ã€‚</p>
<p>å…±å‹‰ï¼ï¼ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;â€‹    è¿™æ˜¯2017å¹´è¿‡å®Œå†œå†æ–°å¹´çš„ç¬¬ä¸€ç¯‡blogï¼Œè¿‡å¹´ç»™è‡ªå·±æ”¾äº†ä¸ªå°å‡ï¼Œä¼‘æ¯äº†ä¸€æ®µæ—¶é—´ã€‚åˆšè¿‡å®Œå¹´ï¼Œä¸æƒ³å†™å¤ªå¤šæŠ€æœ¯æ€§çš„ä¸œè¥¿ã€‚æ‰€è°“æ–°å¹´æ–°å¸Œæœ›æ–°ç›®æ ‡ï¼Œåœ¨è¿™é‡Œä¹Ÿæƒ³ç»™è‡ªå·±å®šä¸ªæ–°çš„ç›®æ ‡ï¼Œç®—æ˜¯ç»™è‡ªå·±å®šéœ€æ±‚ï¼Œç£ä¿ƒä¸‹è‡ªå·±å§ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="ç”Ÿæ´»" scheme="http://alfredzhenyu.github.io/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
      <category term="ç”Ÿæ´»" scheme="http://alfredzhenyu.github.io/tags/%E7%94%9F%E6%B4%BB/"/>
    
  </entry>
  
  <entry>
    <title>iOSå¼€å‘é»‘ç§‘æŠ€ä¹‹Xcodeå¤šTargetå¼€å‘</title>
    <link href="http://alfredzhenyu.github.io/2017/01/13/iOS%E5%BC%80%E5%8F%91%E9%BB%91%E7%A7%91%E6%8A%80%E4%B9%8BXcode%E5%A4%9ATarget%E5%BC%80%E5%8F%91/"/>
    <id>http://alfredzhenyu.github.io/2017/01/13/iOSå¼€å‘é»‘ç§‘æŠ€ä¹‹Xcodeå¤šTargetå¼€å‘/</id>
    <published>2017-01-13T02:39:45.000Z</published>
    <updated>2017-02-05T03:39:36.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¾ˆå¤šæ—¶å€™ä¼šå‡ºç°ä¸€ç§æƒ…å†µï¼šåŒä¸€ä¸ªå·¥ç¨‹æ–‡ä»¶éœ€è¦ç”Ÿæˆå¤šä¸ªç›¸ä¼¼çš„app</p>
<p>æ¯”å¦‚ï¼š</p>
<p>åŒä¸€ä¸ªappçš„Proã€Liteã€Freeç‰ˆ</p>
<p>åŒä¸€ä¸ªæ¨¡æ¿å·¥ç¨‹åº”ç”¨äºä¸åŒapp</p>
<p>åŒä¸€ä¸ªappçš„iPadã€iPhoneç‰ˆ</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±éœ€è¦åœ¨ä¸€ä¸ªXcodeå·¥ç¨‹ä¸‹æ·»åŠ å¤šä¸ªTargetæ¥å®ç°ï¼Œè¿™é‡Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹ï¼Œå¦‚ä½•åœ¨ä¸€ä¸ªå·¥ç¨‹ä¸‹è¿›è¡Œå¤šTargetå¼€å‘</p>
<a id="more"></a>
<h2 id="Targetçš„åˆ›å»º"><a href="#Targetçš„åˆ›å»º" class="headerlink" title="Targetçš„åˆ›å»º"></a>Targetçš„åˆ›å»º</h2><h3 id="å¤åˆ¶ä¸€ä¸ªæ–°Target"><a href="#å¤åˆ¶ä¸€ä¸ªæ–°Target" class="headerlink" title="å¤åˆ¶ä¸€ä¸ªæ–°Target"></a>å¤åˆ¶ä¸€ä¸ªæ–°Target</h3><p><img src="DuplicateTarget.png" alt=""></p>
<p>ç‚¹å‡»å·¥ç¨‹-æ‰¾åˆ°æ§åˆ¶çª—å£çš„ä¾§è¾¹æ é‡Œæ‰¾åˆ°<code>TARGETS</code>-å³é”®å‘¼å‡ºèœå•ç‚¹å‡»<code>Duplicate</code></p>
<p>å¯ä»¥çœ‹åˆ°</p>
<p><img src="TargetCopy.png" alt=""></p>
<p>æˆ‘ä»¬å‘ç°å›¾ç‰‡ç®­å¤´åœ°æ–¹å¤šäº†æ–°çš„Copy Targetï¼Œä½†é€šå¸¸è¿™ä¸ªåå­—æ˜¾å¾—æœ‰ç‚¹ä¸å¤ªä¸“ä¸šï¼Œå¹¶ä¸æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œæ”¹å</p>
<h3 id="æ›´æ”¹Targetåå­—"><a href="#æ›´æ”¹Targetåå­—" class="headerlink" title="æ›´æ”¹Targetåå­—"></a>æ›´æ”¹Targetåå­—</h3><p>ç›´æ¥åŒå‡»æ§åˆ¶æ é‡Œçš„ä¾§è¾¹æ çš„<code>Target</code>ï¼Œæ›´æ”¹åå­—å¦‚å›¾ï¼š</p>
<p><img src="TargetModifyName1.png" alt="æ›´æ”¹Targetåå­—"></p>
<h3 id="æ›´æ”¹Schemeåå­—"><a href="#æ›´æ”¹Schemeåå­—" class="headerlink" title="æ›´æ”¹Schemeåå­—"></a>æ›´æ”¹Schemeåå­—</h3><p>ç‚¹å‡»æœ€ä¸Šæ–¹åœ¨æ›´æ”¹å½“å‰ç¼–è¯‘çš„<code>Target</code>ä½ç½®é‡Œç‚¹å‡»<code>edit scheme</code>é€‰é¡¹ï¼Œå‡ºç°å¦‚å›¾æ§åˆ¶çª— </p>
<p><img src="SchemeModifyName1.png" alt=""></p>
<p>ç‚¹å‡»<code>Manage Scemes</code>æ‰¾åˆ°éœ€è¦æ›´æ”¹åå­—çš„<code>Sceme</code>,åŒå‡»é‡å‘½å</p>
<p><img src="SchemeModifyName2.png" alt="æ›´æ”¹Schemeåå­—"></p>
<h3 id="æ›´æ”¹-plistæ–‡ä»¶å"><a href="#æ›´æ”¹-plistæ–‡ä»¶å" class="headerlink" title="æ›´æ”¹.plistæ–‡ä»¶å"></a>æ›´æ”¹.plistæ–‡ä»¶å</h3><p>åŒå‡»éœ€è¦æ›´æ”¹çš„plistæ–‡ä»¶åï¼Œè¾“å…¥æ–‡ä»¶åå³å¯ï¼Œå¦‚å›¾</p>
<p><img src="PlistModifyName.png" alt=""></p>
<p>ä½†å‘ç°æ›´æ”¹åå­—åå·¥ç¨‹æ— æ³•è¯†åˆ«ï¼Œå¯ä»¥æ‰¾åˆ°å¯¹åº”<code>Target</code>çš„<code>Build Setting</code>æ‰¾åˆ°ä¸€ä¸ªé€‰é¡¹<code>Info.plist File</code>ï¼Œæ›´æ”¹æˆå¯¹åº”è·¯å¾„å³å¯</p>
<p><img src="InfoPlistPath.png" alt=""></p>
<h2 id="å¤šTargetå¼€å‘"><a href="#å¤šTargetå¼€å‘" class="headerlink" title="å¤šTargetå¼€å‘"></a>å¤šTargetå¼€å‘</h2><p>å®é™…é¡¹ç›®ä¸­é€šå¸¸ä¼šå‡ºç°ä¸åŒçš„Targetä½¿ç”¨ä¸åŒçš„èµ„æºã€ä»£ç </p>
<p>è¿™é‡Œï¼Œæˆ‘æ¥è®²è®²æˆ‘åœ¨è¿™å—çš„ä¸€äº›ç»éªŒï¼š</p>
<h3 id="ä¸åŒTargetä¸åŒèµ„æºçš„å¤„ç†"><a href="#ä¸åŒTargetä¸åŒèµ„æºçš„å¤„ç†" class="headerlink" title="ä¸åŒTargetä¸åŒèµ„æºçš„å¤„ç†"></a>ä¸åŒTargetä¸åŒèµ„æºçš„å¤„ç†</h3><p>åœ¨èµ„æºæ–‡ä»¶å¤¹ä¸­æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹<code>TargetDiff</code>ç”¨äºè£…ä¸åŒTargetä¸ä¸€æ ·çš„èµ„æºï¼Œè¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼Œå°±æ˜¯åœ¨<code>TargetDiff</code>æ–‡ä»¶å¤¹ä¸‹å»ºå¤šä¸ªæ–‡ä»¶å¤¹ä»¥å¯¹åº”ä¸åŒçš„Targetï¼Œç„¶åå†æ¯ä¸ªTargetæ–‡ä»¶å¤¹ä¸‹å¯¹äºåŒä¸€ç§èµ„æºå–ç›¸åŒçš„åå­—ï¼Œå¦‚å›¾ï¼š</p>
<p><img src="TargetResources.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°ä¸åŒçš„Targetï¼š<code>Bemewings</code>å’Œ<code>Bemetoy</code>ä¸‹éƒ½æœ‰<code>Logo.bundle</code>ç„¶åä¸‹é¢æœ‰<code>login_logo.png</code>ç­‰ç­‰çš„åŒåèµ„æº</p>
<p>è¿™æ—¶å€™æˆ‘ä»¬åªè¦åœ¨å³ä¾§æ›´æ”¹å…¶å¯¹åº”çš„<code>Target Membership</code>ï¼Œé€‰æ‹©ä¸åŒçš„Targetï¼Œè¿™æ—¶å€™ä¸åŒTargetç¼–è¯‘çš„æ—¶å€™ï¼Œåªæœ‰åœ¨membershipä¹‹å†…çš„èµ„æºæ‰ä¼šæ‰“åŒ…è¿›appå†…ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°åªå†™ä¸€å¥—åŠ è½½èµ„æºçš„ä»£ç ï¼Œå°±å¯ä»¥ç´¢å¼•åˆ°å¯¹åº”Targetçš„èµ„æºï¼Œä»è€Œåº”ç”¨åœ¨ä¸åŒçš„Targetä¸Š</p>
<h3 id="ä¸åŒTargetä¸åŒä»£ç çš„å¤„ç†"><a href="#ä¸åŒTargetä¸åŒä»£ç çš„å¤„ç†" class="headerlink" title="ä¸åŒTargetä¸åŒä»£ç çš„å¤„ç†"></a>ä¸åŒTargetä¸åŒä»£ç çš„å¤„ç†</h3><h4 id="Targetæ ‡è¯†ç¬¦"><a href="#Targetæ ‡è¯†ç¬¦" class="headerlink" title="Targetæ ‡è¯†ç¬¦"></a>Targetæ ‡è¯†ç¬¦</h4><p>æ‰“å¼€ä¸åŒTargetä¸‹çš„<code>Build Setting</code>ï¼Œæ‰¾åˆ°ä¸‹é¢è¿™ä¸€ç±»ï¼š</p>
<p><img src="Prepoccesing.png" alt=""></p>
<ul>
<li>æŠŠ<code>Enable Foundation Assertions</code>è®¾ç½®ä¸ºYES</li>
<li>åœ¨<code>Preprocessor Macros</code>ä¸‹çš„æ¯ä¸€ä¸ªé€‰é¡¹éƒ½æ·»åŠ ä¸€ä¸ªå®ç”¨äºæ ‡è¯†å¯¹åº”çš„Target</li>
</ul>
<p>åœ¨è¿™é‡Œæˆ‘æ·»åŠ äº†ä¸€ä¸ª<code>BEMEWINGS</code>ä»¥å¯¹åº”æˆ‘çš„<code>Bemewings</code>çš„Target</p>
<p>è¿™æ—¶å€™å¯ä»¥åœ¨AppDelegateé‡Œå°±å¯ä»¥åŠ å…¥ä»¥ä¸‹ä»£ç æ¥å®ç°ä¸åŒTargetä¸åŒå¤„ç†ï¼š</p>
<p><img src="TargetDiffCode.png" alt=""></p>
<h4 id="User-Definedæ ‡è¯†"><a href="#User-Definedæ ‡è¯†" class="headerlink" title="User-Definedæ ‡è¯†"></a>User-Definedæ ‡è¯†</h4><p>ä¸Šé¢çš„é‚£ç§æ–¹æ³•åªæ˜¯ç®€å•çš„è¯†åˆ«æ˜¯å¦æ˜¯æŸä¸ªTargetï¼Œä½†æ˜¯å®é™…å¼€å‘ä¸­ä¼šå‡ºç°è¿™æ ·çš„éœ€æ±‚ï¼š</p>
<p>å‡è®¾æœ‰ä¸‰å››ä¸ªç›¸ä¼¼çš„appï¼ˆTargetï¼‰å¯èƒ½å…¶ä¸­æœ‰ä¸€ä¸¤ä¸ªä½¿ç”¨åˆ°è¿™ä¸ªåŠŸèƒ½æ¨¡å—ï¼Œè¿è¡Œäº†è¿™æ®µä»£ç ï¼Œè€Œå…¶ä»–åˆ™æ²¡æœ‰ï¼Œé‚£ä¹ˆå°±éœ€è¦ç”¨åˆ°User-Definedæ¥å°†ä»£ç æ¨¡å—åŠŸèƒ½åŒ–ï¼Œé€šè¿‡Xcodeçš„é€‰é¡¹æ¥æ§åˆ¶ä¸åŒTargetã€ç”šè‡³ä¸åŒç¼–è¯‘ç‰ˆæœ¬æ˜¯å¦å¼€å¯å…³é—­è¿™ä¸ªåŠŸèƒ½:</p>
<p>å…ˆä¸Šå›¾ï¼š</p>
<p><img src="AddUserDefined.png" alt=""></p>
<p>ä»¥å­—æ®µ<code>_BM_SHELLSCORE_ENABLE</code>ä¸ºä¾‹</p>
<p>æ³¨ï¼š</p>
<p>å‰é¢åŠ ä¸‹åˆ’çº¿æ˜¯å› ä¸ºè¿™æ˜¯ä¸ªç§æœ‰å˜é‡ï¼Œå…¶å®å¤–ç•Œæ˜¯è®¿é—®ä¸åˆ°è¿™ä¸ªçš„</p>
<p>å¦å¤–è¿™é‡Œçš„å€¼å†™YESã€NOæˆ–è€…ä»»æ„å­—ç¬¦ä¸²éƒ½æ˜¯å¯ä»¥çš„ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå®ï¼ŒçœŸæ­£å€¼æ˜¯å•¥å–å†³äºåé¢çš„æ“ä½œï¼š</p>
<ul>
<li><strong>è®¾ç½®å…¨å±€å®ï¼š</strong></li>
</ul>
<p>å¦‚å›¾ï¼š</p>
<p><img src="GloabalFlag.png" alt=""></p>
<p>åœ¨å¯¹åº”çš„æ·»åŠ å®å®šä¹‰</p>
<p>æŠŠ<code>_BM_SHELLSCORE_ENABLE</code>å½“å€¼æ—¶ï¼Œå¯ä»¥è¿™æ ·å®šä¹‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-D&apos;BM_SHELLSCORE_ENABLE=$(_BM_SHELLSCORE_ENABLE)&apos;</div></pre></td></tr></table></figure>
<p>æŠŠ<code>_BM_SHELLSCORE_ENABLE</code>å½“å­—ç¬¦ä¸²æ—¶ï¼Œå¯ä»¥è¿™æ ·å®šä¹‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-D&apos;BM_SHELLSCORE_OPEN_INFO=@&quot;$(_BM_SHELLSCORE_ENABLE)&quot;&apos;</div></pre></td></tr></table></figure>
<p>æ³¨ï¼š</p>
<p><code>BM_SHELLSCORE_ENABLE</code>æ˜¯çœŸçœŸæ­£æ­£èƒ½ä»£ç ä¸­ä½¿ç”¨çš„å®</p>
<p><code>$(_BM_SHELLSCORE_ENABLE)</code>è¡¨ç¤ºå–<code>_BM_SHELLSCORE_ENABLE</code>çš„å€¼</p>
<ul>
<li><p><strong>è®¾ç½®å±€éƒ¨å®ï¼š</strong></p>
<p>ç‚¹å‡»<code>Target</code>-<code>Build Phases</code>-ç‚¹å‡»éœ€è¦å®çš„æ–‡ä»¶-æ·»åŠ <code>Compiler Flags</code>ï¼Œè¾“å…¥ä¸Šé¢ä¸€æ ·çš„çš„å®å®šä¹‰å³å¯</p>
<p>æ³¨æ„ï¼š</p>
<p>å®šä¹‰å¤šä¸ªå®æ—¶ï¼Œä¸€å®šè¦æ¢è¡Œï¼Œæ¢è¡Œçš„æ–¹å¼æ˜¯<code>Option+enter</code>é”®ï¼Œä¸èƒ½ç›´æ¥<code>enter</code></p>
</li>
</ul>
<p>åŠŸèƒ½æ¨¡å—æ§åˆ¶ï¼š</p>
<p>å¯¹äºåŠŸèƒ½æ¨¡å—çš„ä»£ç ç»Ÿä¸€åŠ å…¥å®:</p>
<p><img src="FlagCode.png" alt=""></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">if</span> BM_SHELLSCORE_ENABLE</span></div><div class="line"><span class="comment">//code here</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="comment">//code here</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<p>è¿™æ—¶å€™ï¼Œä½ å°±å¯ä»¥é€šè¿‡æ›´æ”¹å·¥ç¨‹æ–‡ä»¶-Targeté‡ŒBuild Settingé‡Œçš„User-Deifinedå€¼æ¥æ§åˆ¶æ˜¯å¦å¼€å¯è¿™é¡¹åŠŸèƒ½</p>
<h4 id="User-Definedæ‰©å±•"><a href="#User-Definedæ‰©å±•" class="headerlink" title="User-Definedæ‰©å±•"></a>User-Definedæ‰©å±•</h4><p>è€Œå¯¹äºStringç±»å‹çš„å®æ›´å¤šç”¨äºåœ¨ä¸åŒç¼–è¯‘ç‰ˆæœ¬ä¸‹è®¾ç½®ä¸åŒçš„URLï¼Œå› ä¸ºä¸€èˆ¬æ¥è¯´æµ‹è¯•ç¯å¢ƒä¸æ­£å¼ç¯å¢ƒè®¿é—®çš„åœ°å€ï¼ŒåŸŸåéƒ½ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡User-Definedé‡Œä¸€ä¸ªå­—æ®µä¸‹é¢çš„Debugã€Releaseè®¾ç½®ä¸åŒçš„URLï¼Œå°±å¯ä»¥å®ç°åŒä¸€æ®µä»£ç è®¿é—®åŒä¸€ä¸ªå®ï¼Œå®é™…ä½¿ç”¨çš„æ˜¯ä¸åŒå€¼çš„æƒ…å†µ</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å¾ˆå¤šæ—¶å€™ä¼šå‡ºç°ä¸€ç§æƒ…å†µï¼šåŒä¸€ä¸ªå·¥ç¨‹æ–‡ä»¶éœ€è¦ç”Ÿæˆå¤šä¸ªç›¸ä¼¼çš„app&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚ï¼š&lt;/p&gt;
&lt;p&gt;åŒä¸€ä¸ªappçš„Proã€Liteã€Freeç‰ˆ&lt;/p&gt;
&lt;p&gt;åŒä¸€ä¸ªæ¨¡æ¿å·¥ç¨‹åº”ç”¨äºä¸åŒapp&lt;/p&gt;
&lt;p&gt;åŒä¸€ä¸ªappçš„iPadã€iPhoneç‰ˆ&lt;/p&gt;
&lt;p&gt;åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±éœ€è¦åœ¨ä¸€ä¸ªXcodeå·¥ç¨‹ä¸‹æ·»åŠ å¤šä¸ªTargetæ¥å®ç°ï¼Œè¿™é‡Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹ï¼Œå¦‚ä½•åœ¨ä¸€ä¸ªå·¥ç¨‹ä¸‹è¿›è¡Œå¤šTargetå¼€å‘&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://alfredzhenyu.github.io/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://alfredzhenyu.github.io/tags/iOS/"/>
    
      <category term="Xcode" scheme="http://alfredzhenyu.github.io/tags/Xcode/"/>
    
  </entry>
  
  <entry>
    <title>Objcçš„Runtimeæºç è§£è¯»ï¼ˆä¸‰ï¼‰ä¹‹æ¶ˆæ¯ï¼ˆMessagingï¼‰æœºåˆ¶</title>
    <link href="http://alfredzhenyu.github.io/2017/01/11/Objc%E7%9A%84Runtime%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%89%EF%BC%89%E4%B9%8B%E6%B6%88%E6%81%AF%EF%BC%88Messaging%EF%BC%89%E6%9C%BA%E5%88%B6/"/>
    <id>http://alfredzhenyu.github.io/2017/01/11/Objcçš„Runtimeæºç è§£è¯»ï¼ˆä¸‰ï¼‰ä¹‹æ¶ˆæ¯ï¼ˆMessagingï¼‰æœºåˆ¶/</id>
    <published>2017-01-11T08:54:46.000Z</published>
    <updated>2017-02-05T03:20:02.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç›®å½•ï¼š</p>
<ul>
<li>æ¶ˆæ¯ä¼ é€’æœºåˆ¶<ul>
<li>â€‹</li>
</ul>
</li>
</ul>
<a id="more"></a>
<h2 id="æ¶ˆæ¯ä¼ é€’-Messaging"><a href="#æ¶ˆæ¯ä¼ é€’-Messaging" class="headerlink" title="æ¶ˆæ¯ä¼ é€’(Messaging)"></a>æ¶ˆæ¯ä¼ é€’(Messaging)</h2><blockquote>
<p>Iâ€™m sorry that I long ago coined the term â€œobjectsâ€ for this topic because it gets many people to focus on the lesser idea. <strong>The big idea is â€œmessaging</strong>â€ â€“ that is what the kernal[sic] of Smalltalk is all aboutâ€¦ The key in making great and growable systems is much more to design how its modules communicate rather than what their internal properties and behaviors should be.</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç›®å½•ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ¶ˆæ¯ä¼ é€’æœºåˆ¶&lt;ul&gt;
&lt;li&gt;â€‹&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://alfredzhenyu.github.io/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://alfredzhenyu.github.io/tags/iOS/"/>
    
      <category term="Objc" scheme="http://alfredzhenyu.github.io/tags/Objc/"/>
    
      <category term="æºç è§£æ" scheme="http://alfredzhenyu.github.io/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Objcçš„Runtimeæºç è§£è¯»ï¼ˆäºŒï¼‰ä¹‹æ–¹æ³•çš„å­˜å‚¨</title>
    <link href="http://alfredzhenyu.github.io/2017/01/09/Objc%E7%9A%84Runtime%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%8C%EF%BC%89%E4%B9%8B%E6%96%B9%E6%B3%95%E7%9A%84%E5%AD%98%E5%82%A8/"/>
    <id>http://alfredzhenyu.github.io/2017/01/09/Objcçš„Runtimeæºç è§£è¯»ï¼ˆäºŒï¼‰ä¹‹æ–¹æ³•çš„å­˜å‚¨/</id>
    <published>2017-01-09T08:50:25.000Z</published>
    <updated>2017-02-05T03:20:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç›®å½•ï¼š</p>
<ul>
<li>æ–¹æ³•çš„å­˜å‚¨<ul>
<li><code>class_data_bits</code>ç»“æ„ä½“</li>
<li><code>class_rw_t</code>å’Œ<code>class_ro_t</code>ç»“æ„ä½“</li>
<li>ä»<code>realizeClass</code>çœ‹æ–¹æ³•çš„å­˜å‚¨</li>
<li>ç›¸å…³æºç </li>
</ul>
</li>
</ul>
<a id="more"></a>
<h2 id="class-data-bits-ç»“æ„ä½“"><a href="#class-data-bits-ç»“æ„ä½“" class="headerlink" title="class_data_bits ç»“æ„ä½“"></a><code>class_data_bits</code> ç»“æ„ä½“</h2><p>æ­£å¦‚ä¸Šç¯‡æ–‡ç« æåˆ°çš„ä¸€æ ·ï¼Œæ–¹æ³•å‚¨å­˜åœ¨<code>obj_class</code>çš„<code>class_data_bits</code>ç±»å‹çš„ç»“æ„ä½“é‡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_class : objc_object &#123;</div><div class="line">    <span class="keyword">isa_t</span> isa;</div><div class="line">    Class superclass;</div><div class="line">    <span class="keyword">cache_t</span> cache;             <span class="comment">// formerly cache pointer and vtable</span></div><div class="line">    <span class="keyword">class_data_bits_t</span> bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>class_data_bits</code> ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="keyword">class_data_bits_t</span> &#123;</div><div class="line">    <span class="keyword">uintptr_t</span> bits;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™é‡Œçš„bitsæ¯ä¸€ä½çš„å«ä¹‰ï¼š</p>
<p>æ³¨æ„åˆ°åœ¨objc_classæ³¨é‡Šé‡Œå†™çš„ <code>class_data_bits_t</code> ç›¸å½“äº <code>class_rw_t</code> æŒ‡é’ˆåŠ ä¸Š rr/alloc çš„æ ‡å¿—ã€‚è€Œåœ¨<code>class_data_bits_t</code>çš„æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™ä¸ªæ–¹æ³•ä¾¿æ·çš„è¿”å›<code>class_rw_t *</code> æŒ‡é’ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// data pointer</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FAST_DATA_MASK          0x00007ffffffffff8UL</span></div><div class="line"><span class="keyword">class_rw_t</span>* data() &#123;</div><div class="line">   <span class="keyword">return</span> (<span class="keyword">class_rw_t</span> *)(bits &amp; FAST_DATA_MASK);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡º <code>class_rw_t *</code> æŒ‡é’ˆçš„åœ°å€ä»ç¬¬3åˆ°ç¬¬47ä½</p>
<p><img src="objc-method-class_data_bits_t.png" alt=""></p>
<p>è€Œbitsçš„å…¶ä»–ä½ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#define FAST_IS_SWIFT           (1UL&lt;&lt;0)</div><div class="line">#define FAST_HAS_DEFAULT_RR     (1UL&lt;&lt;1)</div><div class="line">#define FAST_REQUIRES_RAW_ISA   (1UL&lt;&lt;2)</div><div class="line">#define FAST_DATA_MASK          0x00007ffffffffff8UL</div></pre></td></tr></table></figure>
<ul>
<li><code>isSwift()``FAST_IS_SWIFT</code> ç”¨äºåˆ¤æ–­ Swift ç±»</li>
<li><code>hasDefaultRR()``FAST_HAS_DEFAULT_RR</code> å½“å‰ç±»æˆ–è€…çˆ¶ç±»å«æœ‰é»˜è®¤çš„ <code>retain/release/autorelease/retainCount/_tryRetain/_isDeallocating/retainWeakReference/allowsWeakReference</code> æ–¹æ³•</li>
<li><code>requiresRawIsa()``FAST_REQUIRES_RAW_ISA</code> å½“å‰ç±»çš„å®ä¾‹éœ€è¦ raw <code>isa</code></li>
</ul>
<p>æ³¨ï¼šé€šè¿‡ <code>objc_class</code> ä¸­çš„ <code>data()</code> æ–¹æ³•å’Œ <code>class_data_bits_t</code> ä¸­çš„ <code>data()</code> æ–¹æ³•è¿”å›çš„æ˜¯åŒä¸€ä¸ª<code>class_rw_t *</code>æŒ‡é’ˆ</p>
<h2 id="class-rw-tå’Œclass-ro-tç»“æ„ä½“"><a href="#class-rw-tå’Œclass-ro-tç»“æ„ä½“" class="headerlink" title="class_rw_tå’Œclass_ro_tç»“æ„ä½“"></a><code>class_rw_t</code>å’Œ<code>class_ro_t</code>ç»“æ„ä½“</h2><h3 id="class-rw-tæºç "><a href="#class-rw-tæºç " class="headerlink" title="class_rw_tæºç "></a><code>class_rw_t</code>æºç </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="keyword">class_rw_t</span> &#123;</div><div class="line">    <span class="keyword">uint32_t</span> flags;</div><div class="line">    <span class="keyword">uint32_t</span> version;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro;</div><div class="line"></div><div class="line">    <span class="keyword">method_array_t</span> methods;</div><div class="line">    <span class="keyword">property_array_t</span> properties;</div><div class="line">    <span class="keyword">protocol_array_t</span> protocols;</div><div class="line"></div><div class="line">    Class firstSubclass;</div><div class="line">    Class nextSiblingClass;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°:</p>
<p>è¿™é‡Œé¢å­˜å‚¨ç€å±æ€§(properties)ã€æ–¹æ³•(methods)ã€éµå¾ªçš„åè®®(protocols)</p>
<p>åŒæ—¶è¿™å†…éƒ¨è¿˜æœ‰ä¸€ä¸ªæŒ‡é’ˆå«åš<code>ro</code>ï¼Œç±»å‹ä¸º<code>class_ro_t</code></p>
<p>æˆ‘ä»¬å†æ¥çœ‹ä¸‹<code>class_ro_t</code>çš„æºç </p>
<h3 id="class-ro-tæºç "><a href="#class-ro-tæºç " class="headerlink" title="class_ro_tæºç "></a><code>class_ro_t</code>æºç </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="keyword">class_ro_t</span> &#123;</div><div class="line">    <span class="keyword">uint32_t</span> flags;</div><div class="line">    <span class="keyword">uint32_t</span> instanceStart;</div><div class="line">    <span class="keyword">uint32_t</span> instanceSize;</div><div class="line">    <span class="keyword">uint32_t</span> reserved;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> * ivarLayout;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * name;</div><div class="line">    <span class="keyword">method_list_t</span> * baseMethodList;</div><div class="line">    <span class="keyword">protocol_list_t</span> * baseProtocols;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">ivar_list_t</span> * ivars;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> * weakIvarLayout;</div><div class="line">    <span class="keyword">property_list_t</span> *baseProperties;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å‘ç°è¿™ä¸¤ä¸ªæœ‰ç‚¹åƒä¹Ÿæœ‰å±æ€§ã€æ–¹æ³•ã€åè®®</p>
<p>ä»å­—é¢ä¸Šå°±å¯ä»¥ç†è§£è¿™ä¸¤ä¸ªçš„å·®åˆ«ï¼š</p>
<ul>
<li>roï¼šread onlyã€‚å­˜å‚¨çš„æ˜¯å½“å‰ç±»åœ¨ç¼–è¯‘æœŸé—´å°±å·²ç»ç¡®å®šçš„å±æ€§(baseProperties)ã€æ–¹æ³•(baseMethodList)ä»¥åŠéµå¾ªçš„åè®®(baseProtocols)</li>
<li>rwï¼šread writeã€‚å­˜å‚¨çš„æ˜¯ä¸€äº›è‡ªå·±å®ç°çš„æ–¹æ³•ï¼ˆåŒ…æ‹¬åˆ†ç±»ï¼‰(methods)ã€å±æ€§(properties)ã€ä»¥åŠéµå¾ªçš„åè®®(protocols)</li>
</ul>
<p>è¦æƒ³æ·±å…¥ç†è§£æ–¹æ³•çš„å­˜å‚¨å¯ä»¥çœ‹ä¸‹<code>class_ro_t</code>å’Œ <code>class_rw_t</code>åœ¨åŠ è½½ObjCè¿è¡Œæ—¶æ˜¯æ€ä¹ˆè°ƒç”¨çš„ï¼Œå¯ä»¥æ‰¾åˆ° <code>realizeClass</code> è¿™ä¸ªæ–¹æ³•</p>
<h3 id="ä»realizeClassçœ‹æ–¹æ³•çš„å­˜å‚¨"><a href="#ä»realizeClassçœ‹æ–¹æ³•çš„å­˜å‚¨" class="headerlink" title="ä»realizeClassçœ‹æ–¹æ³•çš„å­˜å‚¨"></a>ä»<code>realizeClass</code>çœ‹æ–¹æ³•çš„å­˜å‚¨</h3><p>ä¸»è¦çœ‹ä¸‹æ–¹æ³•å†…éƒ¨<code>class_ro_t</code>å’Œ <code>class_rw_t</code>ç›¸å…³çš„éƒ¨åˆ†ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro = (<span class="keyword">const</span> <span class="keyword">class_ro_t</span> *)cls-&gt;data();</div><div class="line"><span class="keyword">class_rw_t</span> *rw = (<span class="keyword">class_rw_t</span> *)<span class="built_in">calloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">class_rw_t</span>), <span class="number">1</span>);</div><div class="line">rw-&gt;ro = ro;</div><div class="line">rw-&gt;flags = RW_REALIZED|RW_REALIZING;</div><div class="line">cls-&gt;setData(rw);</div></pre></td></tr></table></figure>
<p>ä¸»è¦çš„æ­¥éª¤ï¼š</p>
<ol>
<li>ä» <code>class_data_bits_t</code> è°ƒç”¨ <code>data</code> æ–¹æ³•ï¼Œå°†ç»“æœä» <code>class_rw_t</code> å¼ºåˆ¶è½¬æ¢ä¸º <code>class_ro_t</code> æŒ‡é’ˆ</li>
<li>åˆå§‹åŒ–ä¸€ä¸ª <code>class_rw_t</code> ç»“æ„ä½“</li>
<li>è®¾ç½®ç»“æ„ä½“ <code>ro</code> çš„å€¼ä»¥åŠ <code>flag</code></li>
<li>æœ€åè®¾ç½®æ­£ç¡®çš„ <code>data</code>ã€‚</li>
</ol>
<p>ä»è¿™é‡Œå¯ä»¥getåˆ°ï¼š</p>
<p><code>realizeClass</code> æ–¹æ³•æ‰§è¡Œå‰</p>
<p><img src="objc-method-before-realize-class.png" alt=""></p>
<p><code>realizeClass</code> æ–¹æ³•æ‰§è¡Œå</p>
<p><img src="objc-method-after-realize-class.png" alt=""></p>
<p>å®é™…ä¸Šï¼š</p>
<ul>
<li><strong>åœ¨ç¼–è¯‘æœŸé—´</strong>ç±»çš„ç»“æ„ä¸­çš„ <code>class_data_bits_t *data</code> æŒ‡å‘çš„æ˜¯ä¸€ä¸ª <code>class_ro_t *</code> æŒ‡é’ˆ</li>
<li><strong>åœ¨åŠ è½½è¿è¡Œæ—¶ä»£ç è¿è¡Œ<code>realizeClass</code> </strong>ä¹‹åï¼Œ<code>class_data_bits_t *data</code> æ‰æŒ‡å‘ <code>class_rw_t</code> æŒ‡é’ˆã€‚</li>
</ul>
<p>ä½†æ­¤æ—¶æ–¹æ³•ï¼Œå±æ€§ä»¥åŠåè®®åˆ—è¡¨å‡ä¸ºç©ºã€‚è¿™æ—¶éœ€è¦ <code>realizeClass</code> è°ƒç”¨ <code>methodizeClass</code> æ–¹æ³•æ¥<strong>å°†ç±»è‡ªå·±å®ç°çš„æ–¹æ³•ï¼ˆåŒ…æ‹¬åˆ†ç±»ï¼‰ã€å±æ€§å’Œéµå¾ªçš„åè®®åŠ è½½åˆ° methodsã€ properties å’Œ protocols åˆ—è¡¨ä¸­</strong></p>
<p>å¤‡æ³¨ï¼š</p>
<p><code>realizeClass</code>ä¸»è¦ä½œç”¨æ˜¯å¯¹ç±»è¿›è¡Œç¬¬ä¸€æ¬¡åˆå§‹åŒ–åŒ…æ‹¬</p>
<ul>
<li>åˆ†é…å¯è¯»å†™æ•°æ®ç©ºé—´ï¼ˆ<code>class_rw_t</code>ï¼‰</li>
<li>è¿”å›çœŸæ­£çš„ç±»ç»“æ„ï¼ˆ<code>Class</code>ï¼‰</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> Class <span class="title">realizeClass</span><span class="params">(Class cls)</span></span></div></pre></td></tr></table></figure>
<h2 id="ç›¸å…³æºç "><a href="#ç›¸å…³æºç " class="headerlink" title="ç›¸å…³æºç "></a>ç›¸å…³æºç </h2><blockquote>
<p>TODO:è¡¥å……ç›¸å…³ä»£ç è§£ææ³¨é‡Š</p>
</blockquote>
<h3 id="æ–¹æ³•ç»“æ„ä½“"><a href="#æ–¹æ³•ç»“æ„ä½“" class="headerlink" title="æ–¹æ³•ç»“æ„ä½“"></a>æ–¹æ³•ç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="keyword">method_t</span> &#123;</div><div class="line">    SEL name;<span class="comment">//æ–¹æ³•å</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *types;<span class="comment">//åœ¨ObjCä¸­å«åšç±»å‹ç¼–ç (Type Encoding)</span></div><div class="line">    IMP imp;<span class="comment">//å®ç°çš„æŒ‡é’ˆ</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="å±æ€§ç»“æ„ä½“"><a href="#å±æ€§ç»“æ„ä½“" class="headerlink" title="å±æ€§ç»“æ„ä½“"></a>å±æ€§ç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="keyword">property_t</span> &#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *attributes;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="åè®®ç»“æ„ä½“"><a href="#åè®®ç»“æ„ä½“" class="headerlink" title="åè®®ç»“æ„ä½“"></a>åè®®ç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="keyword">protocol_t</span> : objc_object &#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *mangledName;</div><div class="line">    <span class="keyword">struct</span> <span class="keyword">protocol_list_t</span> *protocols;</div><div class="line">    <span class="keyword">method_list_t</span> *instanceMethods;</div><div class="line">    <span class="keyword">method_list_t</span> *classMethods;</div><div class="line">    <span class="keyword">method_list_t</span> *optionalInstanceMethods;</div><div class="line">    <span class="keyword">method_list_t</span> *optionalClassMethods;</div><div class="line">    <span class="keyword">property_list_t</span> *instanceProperties;</div><div class="line">    <span class="keyword">uint32_t</span> size;   <span class="comment">// sizeof(protocol_t)</span></div><div class="line">    <span class="keyword">uint32_t</span> flags;</div><div class="line">    <span class="comment">// Fields below this point are not always present on disk.</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> **_extendedMethodTypes;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *_demangledName;</div><div class="line">    <span class="keyword">property_list_t</span> *_classProperties;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">demangledName</span><span class="params">()</span></span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>â€‹</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://github.com/Draveness/iOS-Source-Code-Analyze/blob/master/contents/objc/%E4%BB%8E%20NSObject%20%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%86%E8%A7%A3%20isa.md#ISA" target="_blank" rel="external">Dravenessçš„github</a></li>
<li><a href="http://www.sealiesoftware.com/blog/archive/2009/04/14/objc_explain_Classes_and_metaclasses.html" target="_blank" rel="external">Classes and Metaclasses</a></li>
<li><a href="https://en.wikipedia.org/wiki/Tagged_pointer" target="_blank" rel="external">Tagged Pointer</a></li>
<li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="external">ç±»å‹ç¼–ç </a></li>
<li><a href="http://nshipster.cn/type-encodings/" target="_blank" rel="external">Type Encodings</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç›®å½•ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ–¹æ³•çš„å­˜å‚¨&lt;ul&gt;
&lt;li&gt;&lt;code&gt;class_data_bits&lt;/code&gt;ç»“æ„ä½“&lt;/li&gt;
&lt;li&gt;&lt;code&gt;class_rw_t&lt;/code&gt;å’Œ&lt;code&gt;class_ro_t&lt;/code&gt;ç»“æ„ä½“&lt;/li&gt;
&lt;li&gt;ä»&lt;code&gt;realizeClass&lt;/code&gt;çœ‹æ–¹æ³•çš„å­˜å‚¨&lt;/li&gt;
&lt;li&gt;ç›¸å…³æºç &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://alfredzhenyu.github.io/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://alfredzhenyu.github.io/tags/iOS/"/>
    
      <category term="Objc" scheme="http://alfredzhenyu.github.io/tags/Objc/"/>
    
      <category term="æºç è§£æ" scheme="http://alfredzhenyu.github.io/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Objcçš„Runtimeæºç è§£è¯»ï¼ˆä¸€ï¼‰ä¹‹isaæŒ‡é’ˆ</title>
    <link href="http://alfredzhenyu.github.io/2017/01/09/Objc%E7%9A%84Runtime%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89%E4%B9%8Bisa%E6%8C%87%E9%92%88/"/>
    <id>http://alfredzhenyu.github.io/2017/01/09/Objcçš„Runtimeæºç è§£è¯»ï¼ˆä¸€ï¼‰ä¹‹isaæŒ‡é’ˆ/</id>
    <published>2017-01-09T02:22:43.000Z</published>
    <updated>2017-02-05T03:19:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç›®å½•ï¼š</p>
<ul>
<li>isaæŒ‡é’ˆ<ul>
<li><code>objc_object</code>å’Œ<code>objc_class</code>ç»“æ„ä½“</li>
<li><code>isa</code>æŒ‡é’ˆçš„ä½œç”¨</li>
<li><code>isa_t</code>ç»“æ„ä½“</li>
</ul>
</li>
</ul>
<a id="more"></a>
<h2 id="objc-objectå’Œobjc-classç»“æ„ä½“"><a href="#objc-objectå’Œobjc-classç»“æ„ä½“" class="headerlink" title="objc_objectå’Œobjc_classç»“æ„ä½“"></a><code>objc_object</code>å’Œ<code>objc_class</code>ç»“æ„ä½“</h2><ul>
<li><p>ObjCéƒ½æ˜¯Cè¯­è¨€ç»“æ„ä½“ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½åŒ…å«ä¸€ä¸ªç±»å‹ä¸ºisa_tçš„isaæŒ‡é’ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_object &#123;</div><div class="line">    <span class="keyword">isa_t</span> isa;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>æ‰€æœ‰ç»§æ‰¿è‡ªNSObjectçš„ç±»çš„å®ä¾‹åŒ–åçš„å¯¹è±¡éƒ½ä¼šåŒ…å«ä¸€ä¸ªç±»å‹ä¸ºisa_tçš„ç»“æ„ä½“â€‹</p>
</li>
<li><p>åœ¨ObjCçš„Classå®šä¹‰ä¸ºä¸€ä¸ªåä¸º<code>objc_class</code> çš„ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_class : objc_object &#123;</div><div class="line">    <span class="keyword">isa_t</span> isa;</div><div class="line">    Class superclass;</div><div class="line">    <span class="keyword">cache_t</span> cache;</div><div class="line">    <span class="keyword">class_data_bits_t</span> bits;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡º<code>objc_class</code> ç»“æ„ä½“æ˜¯ç»§æ‰¿è‡ª <code>objc_object</code> çš„ï¼Œæ‰€æœ‰çš„ç±»ä¹Ÿæœ‰ä¸€ä¸ªisaï¼Œæ‰€ä»¥Objcä¸­çš„ç±»æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡</p>
</li>
</ul>
<h2 id="isaæŒ‡é’ˆçš„ä½œç”¨"><a href="#isaæŒ‡é’ˆçš„ä½œç”¨" class="headerlink" title="isaæŒ‡é’ˆçš„ä½œç”¨"></a>isaæŒ‡é’ˆçš„ä½œç”¨</h2><p>é¦–å…ˆå¯¹è±¡çš„æ–¹æ³•ï¼ˆå®ä¾‹æ–¹æ³•ã€ç±»æ–¹æ³•ï¼‰æ˜¯ä¸å­˜å‚¨åœ¨å¯¹è±¡çš„ç»“æ„ä½“ä¸­çš„ï¼Œä¸ç„¶åˆ›å»ºåŒä¸€ä¸ªç±»çš„ä¸åŒå¯¹è±¡ä¼šé€ æˆå†…å­˜çš„å†—ä½™ï¼Œæ‰€ä»¥ï¼š</p>
<ul>
<li><strong>å½“å®ä¾‹æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šé€šè¿‡å¯¹è±¡çš„isaæ¥æŸ¥æ‰¾å¯¹åº”çš„ç±»ï¼Œç„¶ååœ¨<code>class_data_bits_t</code> ç»“æ„ä½“ä¸­æŸ¥æ‰¾å¯¹åº”æ–¹æ³•çš„å®ç°ï¼ŒåŒæ—¶ä½¿ç”¨ <code>super_class</code> æ¥æŸ¥æ‰¾ç»§æ‰¿çš„ç±»ï¼Œè¿›è€Œæ‰¾åˆ°ç»§æ‰¿çš„æ–¹æ³•</strong></li>
<li><strong>å½“ç±»æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šé€šè¿‡ç±»çš„isaæ¥æŸ¥æ‰¾å¯¹åº”çš„å…ƒç±»ï¼Œç„¶ååœ¨å…ƒç±»æŸ¥æ‰¾å¯¹åº”ç±»æ–¹æ³•çš„å®ç°ï¼Œä»¥ä¿è¯é€šè¿‡ç›¸åŒçš„æœºåˆ¶æ¥æŸ¥æ‰¾æ–¹æ³•çš„å®ç°</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//<span class="doctag">TODO:</span>å…ƒç±»å’Œç±»å…±ç”¨ä¸€å¥—å®ç°ä»£ç ï¼Œæ€æ ·é€šè¿‡ç±»æ–¹æ³•æŸ¥æ‰¾ç±»æ–¹æ³•çš„</span></div></pre></td></tr></table></figure>
<p><img src="objc-isa-class-diagram.png" alt=""></p>
<p>ä¸Šå›¾æ˜¯å„ä¸ªå¯¹è±¡çš„isaçš„æŒ‡å‘å›¾ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨64ä½ä»¥åæ‰æœ‰çš„isa_tç±»å‹è¿™ä¸ªç»“æ„ä½“ï¼Œéœ€è¦é€šè¿‡ä¸€å®šçš„å¤„ç†æ‰èƒ½å¾—åˆ°ä»–éœ€è¦æŒ‡å‘çš„å¯¹è±¡ï¼Œè€Œåœ¨64ä½ä»¥å‰æ˜¯isaç±»å‹ï¼Œå•çº¯çš„æŒ‡å‘å®ƒéœ€è¦çš„å¯¹è±¡ï¼Œä¸‹é¢ä¼šè®²åˆ°ã€‚</p>
<p>â€‹</p>
<h2 id="isa-tç»“æ„ä½“"><a href="#isa-tç»“æ„ä½“" class="headerlink" title="isa_tç»“æ„ä½“"></a>isa_tç»“æ„ä½“</h2><ul>
<li><p>æºç å®šä¹‰ï¼š</p>
<ul>
<li>x86_64:</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">#define ISA_MASK        0x00007ffffffffff8ULL</div><div class="line">#define ISA_MAGIC_MASK  0x001f800000000001ULL</div><div class="line">#define ISA_MAGIC_VALUE 0x001d800000000001ULL</div><div class="line">#define RC_ONE   (1ULL&lt;&lt;56)</div><div class="line">#define RC_HALF  (1ULL&lt;&lt;7)</div><div class="line"></div><div class="line">union isa_t &#123;</div><div class="line">    isa_t() &#123; &#125;</div><div class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</div><div class="line"></div><div class="line">    Class cls;</div><div class="line">    uintptr_t bits;</div><div class="line"></div><div class="line">    struct &#123;</div><div class="line">        uintptr_t indexed           : 1;</div><div class="line">        uintptr_t has_assoc         : 1;</div><div class="line">        uintptr_t has_cxx_dtor      : 1;</div><div class="line">        uintptr_t shiftcls          : 44;</div><div class="line">        uintptr_t magic             : 6;</div><div class="line">        uintptr_t weakly_referenced : 1;</div><div class="line">        uintptr_t deallocating      : 1;</div><div class="line">        uintptr_t has_sidetable_rc  : 1;</div><div class="line">        uintptr_t extra_rc          : 8;</div><div class="line">    &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li>arm64:</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">#define ISA_MASK        0x0000000ffffffff8ULL</div><div class="line">#define ISA_MAGIC_MASK  0x000003f000000001ULL</div><div class="line">#define ISA_MAGIC_VALUE 0x000001a000000001ULL</div><div class="line">#define RC_ONE   (1ULL&lt;&lt;45)</div><div class="line">#define RC_HALF  (1ULL&lt;&lt;18)</div><div class="line">union isa_t &#123;</div><div class="line">    isa_t() &#123; &#125;</div><div class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</div><div class="line"></div><div class="line">    Class cls;</div><div class="line">    uintptr_t bits;</div><div class="line"></div><div class="line">    struct &#123;</div><div class="line">       uintptr_t indexed           : 1;</div><div class="line">       uintptr_t has_assoc         : 1;</div><div class="line">       uintptr_t has_cxx_dtor      : 1;</div><div class="line">       uintptr_t shiftcls          : 33;</div><div class="line">       uintptr_t magic             : 6;</div><div class="line">       uintptr_t weakly_referenced : 1;</div><div class="line">       uintptr_t deallocating      : 1;</div><div class="line">       uintptr_t has_sidetable_rc  : 1;</div><div class="line">       uintptr_t extra_rc          : 19;</div><div class="line">    &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>ï¼ˆMacOSï¼Œè™šæ‹Ÿæœºæ˜¯x86_64ï¼Œè€ŒiOSæ˜¯arm64ï¼‰</p>
<p>å¯ä»¥çœ‹å‡ºä¸åŒçš„æ¶æ„ä¸Šï¼Œå­—æ®µæ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ä½æ•°å’Œå®ç°ä¸Šæœ‰äº›å·®åˆ«ï¼Œè¿™é‡Œç»Ÿä¸€ç”¨x86çš„æ¥è®²è§£</p>
</li>
<li><p><code>isa_t</code> æ˜¯ä¸€ä¸ª <code>union</code> ç±»å‹çš„ç»“æ„ä½“ã€‚å…¶ä¸­çš„ <code>isa_t</code>ã€<code>cls</code>ã€ <code>bits</code> è¿˜æœ‰ç»“æ„ä½“å…±ç”¨åŒä¸€å—åœ°å€ç©ºé—´ã€‚è€Œå®é™…ä¸Š <code>isa</code> æ€»å…±ä¼šå æ® 64 ä½çš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥ä»<code>bits</code>çœ‹å‡ºæ¥</p>
<p><img src="objc-isa-isat.png" alt=""></p>
</li>
<li><p>ä¸‹é¢æˆ‘ä»¬ä»åˆå§‹åŒ–çš„è¿‡ç¨‹æ¥çœ‹è¿™64ä½æ¯ä¸€ä½çš„æ„ä¹‰ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span> </div><div class="line">objc_object::initInstanceIsa(Class cls, <span class="keyword">bool</span> hasCxxDtor)</div><div class="line">&#123;</div><div class="line">    initIsa(cls, <span class="literal">true</span>, hasCxxDtor);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span> </div><div class="line">objc_object::initIsa(Class cls, <span class="keyword">bool</span> indexed, <span class="keyword">bool</span> hasCxxDtor) </div><div class="line">&#123; </div><div class="line">    <span class="keyword">if</span> (!indexed) &#123;</div><div class="line">        isa.cls = cls;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        isa.bits = ISA_MAGIC_VALUE;</div><div class="line">        isa.has_cxx_dtor = hasCxxDtor;</div><div class="line">        isa.shiftcls = (<span class="keyword">uintptr_t</span>)cls &gt;&gt; <span class="number">3</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹æ•´ä¸ª <code>isa</code> çš„å€¼ <code>bits</code> è¿›è¡Œè®¾ç½®ï¼Œä¼ å…¥ <code>ISA_MAGIC_VALUE</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ISA_MAGIC_VALUE 0x001d800000000001ULL</span></div></pre></td></tr></table></figure>
<p><img src="objc-isa-isat-bits.png" alt=""></p>
<p>å¯ä»¥çœ‹å‡ºå®é™…ä¸Šè®¾ç½®çš„æ˜¯<code>indexed</code>ä»¥åŠ<code>magic</code>è¿™ä¸¤ä¸ªå­—æ®µ</p>
</li>
<li><p><code>indexed</code>è¡¨ç¤º<code>isa_t</code>ç±»å‹ï¼š</p>
<ul>
<li>0åœ¨è¿ç§»åˆ°64ä½ä¹‹å‰çš„æ—¶å€™ä½¿ç”¨ï¼Œè¿™æ—¶å€™çš„isaæ˜¯æ²¡æœ‰structéƒ¨åˆ†ï¼Œé€šè¿‡object-&gt;isaå¾—åˆ°çš„æ˜¯clsçš„æŒ‡é’ˆï¼ˆé‚£æ—¶ä¸æ˜¯isa_tç±»å‹ï¼Œè€Œæ˜¯isaç±»å‹ï¼‰</li>
<li>1åœ¨è¿ç§»åˆ°64ä½ä¹‹åçš„æ—¶å€™ä½¿ç”¨ï¼Œè¿™æ—¶å€™çš„isaå¢åŠ äº†structéƒ¨åˆ†ï¼Œé€šè¿‡object-&gt;isaå¾—åˆ°çš„æ˜¯64ä½çš„bitså€¼ï¼ˆéœ€è¦ç”¨<code>shiftcls</code>ä½çš„åç§»æ¥è·å–clsçš„æŒ‡é’ˆï¼‰</li>
</ul>
</li>
<li><p><code>magic</code>çš„å€¼ä¸º0x3bç”¨äºè°ƒè¯•å™¨åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯çœŸçš„å¯¹è±¡è¿˜æ˜¯æ²¡åˆå§‹åŒ–çš„ç©ºé—´</p>
<blockquote>
<p>TODO: magicå€¼å…·ä½“æ€ä¹ˆåˆ¤æ–­å½“å‰å¯¹è±¡çš„</p>
</blockquote>
</li>
<li><p><code>has_cxx_dtor</code>å®é™…ä¸Šä¹Ÿæ˜¯64ä½ä¸­çš„1ä½ï¼Œè¡¨ç¤ºå½“å‰å¯¹è±¡æ—¶å€™æœ‰C++ã€ObjCçš„ææ„å™¨</p>
</li>
<li><p><code>shiftcls</code>å°±æ˜¯ç±»æŒ‡é’ˆï¼Œå› ä¸ºç±»æŒ‡é’ˆè§„å®šè¦æŒ‰ç…§å­—èŠ‚ï¼ˆ8bitï¼‰å¯¹é½å†…å­˜ï¼Œæ‰€ä»¥åä¸‰ä½bitä¸º000ï¼ˆå¯ä»¥è¾“å‡º[NSObject class]æŒ‡é’ˆçœ‹ä¸‹ï¼‰ï¼Œè¿™é‡Œä¸ºäº†å‡å°å†…å­˜æ¶ˆè€—ï¼Œç‰¹æ„å³ç§»3ä½å†™è¿›shiftclså†…ï¼Œè¿™ä¸ªå­—æ®µå°±ç›¸å½“äº64ä½ä»¥å‰çš„isaç±»å‹æŒ‡é’ˆï¼Œéµå¾ªä¸Šé¢çš„æŒ‡å‘å›¾</p>
<p>ã€åŒæ—¶å¯ä»¥æ‰“å°å¯¹è±¡æŒ‡é’ˆï¼Œå¯ä»¥å‘ç°å¯¹è±¡å†…å­˜åœ°å€çš„åå››ä½éƒ½æ˜¯0ï¼Œè¯´æ˜ObjCåœ¨åˆå§‹åŒ–å†…å­˜æ—¶æ˜¯ä»¥16å­—èŠ‚å¯¹é½çš„ï¼Œåˆ†é…çš„å†…å­˜åœ°å€åå››ä½éƒ½æ˜¯0ã€‘</p>
<p>æ³¨æ„ï¼š</p>
<p>ç”±äºæ”¹ç‰ˆè‡³64ä½ï¼Œä¸å¯ä»¥é€šè¿‡object-&gt;isaç›´æ¥è·å–clsæŒ‡é’ˆï¼Œæ‰€ä»¥æ–°å¢äº†ISA()æ–¹æ³•æ¥è·å–</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ISA_MASK 0x00007ffffffffff8ULL</span></div><div class="line"><span class="keyword">inline</span> Class </div><div class="line">objc_object::ISA() </div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> (Class)(isa.bits &amp; ISA_MASK);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>â€‹</p>
</li>
<li><p>å…¶ä»–bits</p>
<p>åœ¨ <code>isa_t</code> ä¸­ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€äº›æ²¡æœ‰ä»‹ç»çš„å…¶å®ƒ bitsï¼Œåœ¨è¿™ä¸ªå°ç»“å°±ç®€å•ä»‹ç»ä¸‹è¿™äº› bits çš„ä½œç”¨</p>
<ul>
<li><code>has_assoc</code>å¯¹è±¡å«æœ‰æˆ–è€…æ›¾ç»å«æœ‰å…³è”å¼•ç”¨ï¼Œæ²¡æœ‰å…³è”å¼•ç”¨çš„å¯ä»¥æ›´å¿«åœ°é‡Šæ”¾å†…å­˜</li>
<li><code>weakly_referenced</code>å¯¹è±¡è¢«æŒ‡å‘æˆ–è€…æ›¾ç»æŒ‡å‘ä¸€ä¸ª ARC çš„å¼±å˜é‡ï¼Œæ²¡æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡å¯ä»¥æ›´å¿«é‡Šæ”¾</li>
<li><code>deallocating</code>å¯¹è±¡æ­£åœ¨é‡Šæ”¾å†…å­˜</li>
<li><code>has_sidetable_rc</code>å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¤ªå¤§äº†ï¼Œå­˜ä¸ä¸‹</li>
<li><code>extra_rc</code>å¯¹è±¡çš„å¼•ç”¨è®¡æ•°è¶…è¿‡ 1ï¼Œä¼šå­˜åœ¨è¿™ä¸ªè¿™ä¸ªé‡Œé¢ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°ä¸º 10ï¼Œ<code>extra_rc</code> çš„å€¼å°±ä¸º 9</li>
</ul>
</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><p><a href="https://github.com/Draveness/iOS-Source-Code-Analyze/blob/master/contents/objc/%E4%BB%8E%20NSObject%20%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%86%E8%A7%A3%20isa.md#ISA" target="_blank" rel="external">Dravenessçš„github</a></p>
</li>
<li><p><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtHowMessagingWorks.html" target="_blank" rel="external">Objective-C Runtime Programming Guide</a></p>
</li>
<li><p><a href="http://www.cocoawithlove.com/2010/01/what-is-meta-class-in-objective-c.html" target="_blank" rel="external">What is a meta-class in Objective-C?</a></p>
</li>
<li><p><a href="http://www.sealiesoftware.com/blog/archive/2009/04/14/objc_explain_Classes_and_metaclasses.html" target="_blank" rel="external">objc_explain_Classes_and_metaclasses</a></p>
</li>
<li><p><a href="http://stackoverflow.com/questions/18997362/storing-things-in-isa" target="_blank" rel="external">Storing things in isa</a></p>
</li>
<li><p><a href="http://stackoverflow.com/questions/252552/why-do-we-need-c-unions" target="_blank" rel="external">Why do we need C Unions?</a></p>
</li>
<li><p><a href="http://www.sealiesoftware.com/blog/archive/2013/09/24/objc_explain_Non-pointer_isa.html" target="_blank" rel="external">objc_explain_Non-pointer_isa</a></p>
</li>
<li><p><a href="https://en.wikipedia.org/wiki/Tagged_pointer" target="_blank" rel="external">Tagged Pointer</a></p>
</li>
<li><p><a href="https://www.mikeash.com/pyblog/friday-qa-2013-09-27-arm64-and-you.html" target="_blank" rel="external">ARM64 and You</a></p>
</li>
<li><p><a href="http://blog.xcodev.com/posts/tagged-pointer-and-64-bit/" target="_blank" rel="external">64ä½ä¸Tagged Pointer</a></p>
<p>â€‹</p>
</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç›®å½•ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;isaæŒ‡é’ˆ&lt;ul&gt;
&lt;li&gt;&lt;code&gt;objc_object&lt;/code&gt;å’Œ&lt;code&gt;objc_class&lt;/code&gt;ç»“æ„ä½“&lt;/li&gt;
&lt;li&gt;&lt;code&gt;isa&lt;/code&gt;æŒ‡é’ˆçš„ä½œç”¨&lt;/li&gt;
&lt;li&gt;&lt;code&gt;isa_t&lt;/code&gt;ç»“æ„ä½“&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://alfredzhenyu.github.io/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://alfredzhenyu.github.io/tags/iOS/"/>
    
      <category term="Objc" scheme="http://alfredzhenyu.github.io/tags/Objc/"/>
    
      <category term="æºç è§£æ" scheme="http://alfredzhenyu.github.io/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆäº”ï¼‰</title>
    <link href="http://alfredzhenyu.github.io/2017/01/04/%E3%80%8AWeb%E6%80%A7%E8%83%BD%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/"/>
    <id>http://alfredzhenyu.github.io/2017/01/04/ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆäº”ï¼‰/</id>
    <published>2017-01-04T02:07:00.000Z</published>
    <updated>2017-02-05T03:20:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç›®å½•ï¼š</p>
<ul>
<li>ç¬¬ä¸‰éƒ¨åˆ† HTTP<ul>
<li>ç¬¬åäºŒç«  HTTP 2.x</li>
<li>ç¬¬åä¸‰ç«  ä¼˜åŒ–åº”ç”¨çš„äº¤ä»˜</li>
</ul>
</li>
</ul>
<a id="more"></a>
<h1 id="ç¬¬ä¸‰éƒ¨åˆ†-HTTP"><a href="#ç¬¬ä¸‰éƒ¨åˆ†-HTTP" class="headerlink" title="ç¬¬ä¸‰éƒ¨åˆ† HTTP"></a>ç¬¬ä¸‰éƒ¨åˆ† HTTP</h1><h2 id="ç¬¬åäºŒç« -HTTP-2-x"><a href="#ç¬¬åäºŒç« -HTTP-2-x" class="headerlink" title="ç¬¬åäºŒç«  HTTP 2.x"></a>ç¬¬åäºŒç«  HTTP 2.x</h2><h3 id="äºŒè¿›åˆ¶åˆ†å¸§å±‚"><a href="#äºŒè¿›åˆ¶åˆ†å¸§å±‚" class="headerlink" title="äºŒè¿›åˆ¶åˆ†å¸§å±‚"></a>äºŒè¿›åˆ¶åˆ†å¸§å±‚</h3><p><img src="äºŒè¿›åˆ¶åˆ†å¸§å±‚.png" alt=""><br>äºŒè¿›åˆ¶åˆ†å±‚æŒ‡çš„æ˜¯ä½äºå¥—æ¥å­—æ¥å£ä¸åº”ç”¨å¯è§çš„é«˜å±‚HTTP APIä¹‹é—´çš„ä¸€ä¸ªæ–°æœºåˆ¶ï¼šHTTP 1.xæ˜¯ä»¥æ¢è¡Œç¬¦ä½œä¸ºçº¯æ–‡æœ¬çš„åˆ†éš”ç¬¦ï¼Œè€ŒHTTP2.0åˆ™å°†æ‰€æœ‰ä¼ è¾“çš„ä¿¡æ¯åˆ†å‰²ä¸ºæ›´å°çš„æ¶ˆæ¯å’Œå¸§ï¼Œå¹¶å¯¹å®ƒä»¬é‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼çš„ç¼–ç ã€‚</p>
<h3 id="æµã€æ¶ˆæ¯ã€å¸§"><a href="#æµã€æ¶ˆæ¯ã€å¸§" class="headerlink" title="æµã€æ¶ˆæ¯ã€å¸§"></a>æµã€æ¶ˆæ¯ã€å¸§</h3><p>ä¸ºäº†ç†è§£äºŒè¿›åˆ¶åˆ†å±‚å¼•å…¥ä¸€ä¸‹å‡ ä¸ªæ–°æ¦‚å¿µï¼š</p>
<ul>
<li>æµï¼šå·²å»ºç«‹çš„è¿æ¥ä¸Šçš„åŒå‘å­—èŠ‚æµã€‚<em> æ¶ˆæ¯ï¼šä¸é€»è¾‘æ¶ˆæ¯å¯¹åº”çš„å®Œæ•´çš„ä¸€ç³»åˆ—æ•°æ®å¸§ã€‚</em> å¸§ï¼šHTTP 2.0 é€šä¿¡çš„æœ€å°å•ä½ï¼Œæ¯ä¸ªå¸§åŒ…å«å¸§é¦–éƒ¨ï¼Œè‡³å°‘ä¹Ÿä¼šæ ‡è¯†å‡ºå½“å‰å¸§æ‰€å±çš„æµã€‚</li>
</ul>
<p><strong>æ‰€æœ‰ HTTP 2.0 é€šä¿¡éƒ½åœ¨ä¸€ä¸ªTCPè¿æ¥ä¸Šå®Œæˆï¼Œè¿™ä¸ªè¿æ¥å¯ä»¥æ‰¿è½½ä»»æ„æ•°é‡çš„åŒå‘æ•°æ®æµã€‚ç›¸åº”åœ°ï¼Œæ¯ä¸ªæ•°æ®æµï¼ˆè¯·æ±‚ã€å“åº”ï¼‰ä»¥æ¶ˆæ¯çš„å½¢å¼å‘é€ï¼Œè€Œæ¶ˆæ¯ç”±ä¸€æˆ–å¤šä¸ªå¸§ç»„æˆï¼Œè¿™äº›å¸§å¯ä»¥ä¹±åºå‘é€ï¼Œç„¶åå†æ ¹æ®æ¯ä¸ªå¸§é¦–éƒ¨çš„æµæ ‡è¯†ç¬¦é‡æ–°ç»„è£…ã€‚</strong><br>è¿™æ ·ï¼Œ<strong>HTTP 2.0 æŠŠ HTTP åè®®é€šä¿¡çš„åŸºæœ¬å•ä½ç¼©å°ä¸ºä¸€ä¸ªä¸€ä¸ªçš„å¸§</strong>ï¼Œè¿™äº›å¸§å¯¹åº”ç€é€»è¾‘æµä¸­çš„æ¶ˆæ¯ã€‚ç›¸åº”åœ°ï¼Œ<strong>å¾ˆå¤šæµå¯ä»¥å¹¶è¡Œåœ°åœ¨åŒä¸€ä¸ª TCP è¿æ¥ä¸Šäº¤æ¢æ¶ˆæ¯ã€‚</strong></p>
<p>ä¸¾ä¸ªä¾‹å­ï¼š<br><img src="HTTP2.0å…±äº«è¿æ¥.png" alt=""><br>å›¾ 12-3 ä¸­åŒ…å«äº†åŒä¸€ä¸ªè¿æ¥ä¸Šå¤šä¸ªä¼ è¾“ä¸­çš„æ•°æ®æµ:å®¢æˆ·ç«¯æ­£åœ¨å‘æœåŠ¡å™¨ä¼ è¾“ä¸€ä¸ª DATA å¸§(stream 5)ï¼Œä¸æ­¤åŒæ—¶ï¼ŒæœåŠ¡å™¨æ­£å‘å®¢æˆ·ç«¯ä¹±åºå‘é€ stream 1 å’Œ stream 3 çš„ä¸€ç³»åˆ—å¸§ã€‚æ­¤æ—¶ï¼Œä¸€ä¸ªè¿æ¥ä¸Šæœ‰ 3 ä¸ªè¯·æ±‚ / å“åº”å¹¶è¡Œäº¤æ¢!</p>
<p>è¿™æ ·åšçš„ä¼˜åŠ¿ï¼š</p>
<ul>
<li>å¯ä»¥å¹¶è¡Œäº¤é”™åœ°å‘é€è¯·æ±‚ï¼Œè¯·æ±‚ä¹‹é—´äº’ä¸å½±å“;<em> å¯ä»¥å¹¶è¡Œäº¤é”™åœ°å‘é€å“åº”ï¼Œå“åº”ä¹‹é—´äº’ä¸å¹²æ‰°;</em> åªä½¿ç”¨ä¸€ä¸ªè¿æ¥å³å¯å¹¶è¡Œå‘é€å¤šä¸ªè¯·æ±‚å’Œå“åº”;<em> æ¶ˆé™¤ä¸å¿…è¦çš„å»¶è¿Ÿï¼Œä»è€Œå‡å°‘é¡µé¢åŠ è½½çš„æ—¶é—´;</em> ä¸å¿…å†ä¸ºç»•è¿‡ HTTP 1.x é™åˆ¶è€Œå¤šåšå¾ˆå¤šå·¥ä½œ;</li>
</ul>
<h3 id="è¯·æ±‚ä¼˜å…ˆçº§"><a href="#è¯·æ±‚ä¼˜å…ˆçº§" class="headerlink" title="è¯·æ±‚ä¼˜å…ˆçº§"></a>è¯·æ±‚ä¼˜å…ˆçº§</h3><p>æŠŠ HTTP æ¶ˆæ¯åˆ†è§£ä¸ºå¾ˆå¤šç‹¬ç«‹çš„å¸§çš„å¦å¤–ä¸€ä¸ªä¼˜åŠ¿ï¼šå¯ä»¥é€šè¿‡ä¼˜åŒ–è¿™äº›å¸§çš„äº¤é”™å’Œä¼ è¾“é¡ºåºï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚<br>HTTP2.0é€šè¿‡å¾€æ¯ä¸ªæµä¸­åŠ å…¥ä¸€ä¸ª31bitçš„ä¼˜å…ˆçº§å­—æ®µ<em> <strong>0 è¡¨ç¤ºæœ€é«˜ä¼˜å…ˆçº§</strong></em> <strong>231-1 è¡¨ç¤ºæœ€ä½ä¼˜å…ˆçº§</strong></p>
<p>è¿™æ ·ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å°±å¯ä»¥åœ¨å¤„ç†ä¸åŒçš„æµæ—¶é‡‡å–ä¸åŒçš„ç­–ç•¥ï¼Œä»¥æœ€ä¼˜çš„æ–¹å¼å‘é€æµã€æ¶ˆæ¯å’Œå¸§ã€‚<br>å…·ä½“æ¥è®²ï¼ŒæœåŠ¡å™¨å¯ä»¥æ ¹æ®æµçš„ä¼˜å…ˆçº§ï¼Œæ§åˆ¶èµ„æºåˆ†é…(CPUã€å†…å­˜ã€å¸¦å®½)ï¼Œè€Œåœ¨å“åº”æ•°æ®å‡†å¤‡å¥½ä¹‹åï¼Œä¼˜å…ˆå°†æœ€é«˜ä¼˜å…ˆçº§çš„å¸§å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p>
<h3 id="æ¯ä¸ªæ¥æºä¸€ä¸ªè¿æ¥"><a href="#æ¯ä¸ªæ¥æºä¸€ä¸ªè¿æ¥" class="headerlink" title="æ¯ä¸ªæ¥æºä¸€ä¸ªè¿æ¥"></a>æ¯ä¸ªæ¥æºä¸€ä¸ªè¿æ¥</h3><p>æ–°çš„åˆ†å¸§æœºåˆ¶å¸¦æ¥çš„å¦ä¸€ä¸ªå¥½å¤„å°±æ˜¯ä¸ç”¨ä¾èµ–äºå¤šä¸ªTCPè¿æ¥æˆ–è€…å¤šåŸŸåæ¥å®ç°å¹¶è¡Œæœºåˆ¶ï¼Œæ­¤æ—¶æ‰€æœ‰çš„HTTP2.0è¿æ¥éƒ½æ˜¯æŒä¹…åŒ–çš„ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´åªéœ€è¦ä¸€ä¸ªè¿æ¥å³å¯</p>
<h3 id="æµé‡æ§åˆ¶"><a href="#æµé‡æ§åˆ¶" class="headerlink" title="æµé‡æ§åˆ¶"></a>æµé‡æ§åˆ¶</h3><p>HTTP2.0ä¸ºæ•°æ®æµå’Œè¿æ¥æä¾›ä¸€ä¸ªç®€å•çš„æµé‡æ§åˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶å®é™…ä¸Šå’ŒTCPçš„æµé‡æ§åˆ¶æ˜¯ä¸€æ ·çš„ã€‚ç„¶è€Œï¼Œç”±äº TCP æµé‡æ§åˆ¶ä¸èƒ½å¯¹åŒä¸€æ¡ HTTP 2.0 è¿æ¥å†…çš„å¤šä¸ªæµå®æ–½å·®å¼‚åŒ–ç­–ç•¥ï¼Œå› æ­¤å…‰æœ‰TCPçš„æµé‡æ§åˆ¶æ˜¯ä¸å¤Ÿçš„ã€‚è¿™æ­£æ˜¯ HTTP 2.0 æµé‡æ§åˆ¶æœºåˆ¶å‡ºå°çš„åŸå› ã€‚</p>
<p>HTTP 2.0 æ ‡å‡†æ²¡æœ‰è§„å®šä»»ä½•ç‰¹å®šçš„ç®—æ³•ã€å€¼ï¼Œæˆ–è€…ä»€ä¹ˆæ—¶å€™å‘é€ WINDOW_UPDATE å¸§ã€‚ å› æ­¤ï¼Œå®ç°å¯ä»¥é€‰æ‹©è‡ªå·±çš„ç®—æ³•ä»¥åŒ¹é…è‡ªå·±çš„åº”ç”¨åœºæ™¯ï¼Œä»è€Œæ±‚å¾—æœ€ä½³æ€§èƒ½ã€‚</p>
<p><strong>TODOï¼šè¿›ä¸€æ­¥äº†è§£HTTP2.0å¦‚ä½•å®ç°æµé‡æ§åˆ¶çš„</strong></p>
<h3 id="æœåŠ¡å™¨æ¨é€"><a href="#æœåŠ¡å™¨æ¨é€" class="headerlink" title="æœåŠ¡å™¨æ¨é€"></a>æœåŠ¡å™¨æ¨é€</h3><p>HTTP 2.0 æ–°å¢çš„ä¸€ä¸ªå¼ºå¤§çš„æ–°åŠŸèƒ½ï¼Œå°±æ˜¯æœåŠ¡å™¨å¯ä»¥å¯¹ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚å‘é€å¤šä¸ªå“åº”ã€‚æ¢å¥è¯è¯´ï¼Œé™¤äº†å¯¹æœ€åˆè¯·æ±‚çš„å“åº”å¤–ï¼ŒæœåŠ¡å™¨è¿˜å¯ä»¥é¢å¤–å‘å®¢æˆ·ç«¯æ¨é€èµ„æºï¼Œè€Œæ— éœ€å®¢æˆ·ç«¯æ˜ç¡®åœ°è¯·æ±‚ã€‚<br>å»ºç«‹ HTTP 2.0 è¿æ¥åï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨äº¤æ¢ SETTINGS å¸§ï¼Œå€Ÿæ­¤å¯ä»¥é™å®šåŒå‘å¹¶å‘çš„æµçš„æœ€å¤§æ•°é‡ã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯å¯ä»¥é™å®šæ¨é€æµçš„æ•°é‡ï¼Œæˆ–è€…é€šè¿‡æŠŠè¿™ä¸ªå€¼è®¾ç½®ä¸º 0 è€Œå®Œå…¨ç¦ç”¨æœåŠ¡å™¨æ¨é€ã€‚</p>
<h3 id="é¦–éƒ¨å‹ç¼©"><a href="#é¦–éƒ¨å‹ç¼©" class="headerlink" title="é¦–éƒ¨å‹ç¼©"></a>é¦–éƒ¨å‹ç¼©</h3><p>åœ¨HTTP1.xä¸­ç”±äºå…ƒæ•°æ®éƒ½æ˜¯ä»¥çº¯æ–‡æœ¬æ–¹å¼ï¼Œé€šå¸¸ä¼šç»™æ¯ä¸ªè¯·æ±‚å¢åŠ 500~800å­—èŠ‚çš„è´Ÿè·ï¼Œä¸ºæé«˜æ€§èƒ½ï¼ŒHTTP 2.0ä¼šå‹ç¼©é¦–éƒ¨å…ƒæ•°æ®ï¼š<br>å‹ç¼©é‡‡ç”¨çš„æ˜¯é¦–éƒ¨çš„å·®å¼‚åŒ–ç¼–ç çš„æ–¹å¼å®ç°çš„ï¼š<br><strong>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…±åŒç»´æŠ¤ä¸€å¼ â€œé¦–éƒ¨è¡¨â€æ¥è·Ÿè¸ªå’Œå­˜å‚¨ä¹‹å‰çš„é”®-å€¼å¯¹ï¼Œåœ¨åŒä¸€è¿æ¥ä¸­å§‹ç»ˆå­˜åœ¨ï¼Œæœ‰å®¢æˆ·ç«¯ã€æœåŠ¡å™¨å…±åŒæ¸è¿›åœ°æ›´æ–°ï¼Œæ¯ä¸ªæ–°çš„é¦–éƒ¨é”®-å€¼è¦ä¹ˆè¿½åŠ åˆ°å½“å‰è¡¨çš„æœ«å°¾ã€è¦ä¹ˆæ›¿æ¢å½“å‰çš„å€¼ã€‚è€Œå¯¹äºç›¸åŒçš„æ•°æ®ï¼Œä¸å†åœ¨æ¯æ¬¡è¯·æ±‚å’Œå“åº”ä¸­å‘é€ï¼Œ</strong><br>ä¸¾ä¸ªä¾‹å­ï¼š<br><img src="å·®å¼‚åŒ–ç¼–ç .png" alt=""><br>ç¬¬äºŒä¸ªè¯·æ±‚åªéœ€è¦å‘é€å˜åŒ–äº†çš„è·¯å¾„é¦–éƒ¨(:path)ï¼Œå…¶ä»–é¦–éƒ¨æ²¡æœ‰å˜åŒ–ï¼Œä¸ç”¨å†å‘é€ã€‚è¿™æ ·å°±å¯ä»¥é¿å…ä¼ è¾“å†—ä½™çš„é¦–éƒ¨ï¼Œä»è€Œæ˜¾è‘—å‡å°‘æ¯ä¸ªè¯·æ±‚çš„å¼€é”€ã€‚</p>
<h3 id="HTTP2-0å‡çº§"><a href="#HTTP2-0å‡çº§" class="headerlink" title="HTTP2.0å‡çº§"></a>HTTP2.0å‡çº§</h3><p>å‡çº§HTTP 2.0éœ€è¦ä½¿ç”¨åˆ°HTTPçš„Upgradeæœºåˆ¶ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>å‘èµ·å¸¦æœ‰ HTTP 2.0 Upgrade é¦–éƒ¨çš„ HTTP 1.1 è¯·æ±‚</li>
<li>å¦‚æœæœåŠ¡å™¨ä¸æ”¯æŒ HTTP 2.0ï¼Œå°±ç«‹å³è¿”å› HTTP 1.1 å“åº”/æœåŠ¡å™¨å°±ä¼šä»¥ HTTP 1.1 æ ¼å¼è¿”å› 101 Switching Protocols å“åº”ï¼Œç„¶åç«‹å³åˆ‡æ¢åˆ° HTTP 2.0 å¹¶ä½¿ç”¨æ–°çš„äºŒè¿›åˆ¶åˆ†å¸§åè®®è¿”å›å“åº”</li>
</ol>
<h3 id="åˆ†å¸§é¦–éƒ¨"><a href="#åˆ†å¸§é¦–éƒ¨" class="headerlink" title="åˆ†å¸§é¦–éƒ¨"></a>åˆ†å¸§é¦–éƒ¨</h3><p><img src="åˆ†å¸§é¦–éƒ¨.png" alt=""></p>
<ul>
<li>16 ä½çš„é•¿åº¦å‰ç¼€æ„å‘³ç€ä¸€å¸§å¤§çº¦å¯ä»¥æºå¸¦ 64 KB æ•°æ®ï¼Œä¸åŒ…æ‹¬ 8 å­—èŠ‚é¦–éƒ¨ã€‚</li>
<li>8 ä½çš„å¸§ç±»å‹å­—æ®µå†³å®šå¦‚ä½•è§£é‡Šå¸§å…¶ä½™éƒ¨åˆ†çš„å†…å®¹ã€‚</li>
<li>8 ä½çš„æ ‡å¿—å­—æ®µå…è®¸ä¸åŒçš„å¸§ç±»å‹å®šä¹‰ç‰¹å®šäºå¸§çš„æ¶ˆæ¯æ ‡å¿—ã€‚</li>
<li>1 ä½çš„ä¿ç•™å­—æ®µå§‹ç»ˆç½®ä¸º 0ã€‚</li>
<li>31 ä½çš„æµæ ‡è¯†ç¬¦å”¯ä¸€æ ‡è¯† HTTP 2.0 çš„æµã€‚</li>
</ul>
<p>å¸§ç±»å‹å­—æ®µï¼š</p>
<ul>
<li>DATA:ç”¨äºä¼ è¾“ HTTP æ¶ˆæ¯ä½“ã€‚</li>
<li>HEADERS:ç”¨äºä¼ è¾“å…³äºæµçš„é¢å¤–çš„é¦–éƒ¨å­—æ®µã€‚</li>
<li>PRIORITY:ç”¨äºæŒ‡å®šæˆ–é‡æ–°æŒ‡å®šå¼•ç”¨èµ„æºçš„ä¼˜å…ˆçº§ã€‚</li>
<li>RST_STREAM:ç”¨äºé€šçŸ¥æµçš„éæ­£å¸¸ç»ˆæ­¢ã€‚</li>
<li>SETTINGS:ç”¨äºé€šçŸ¥ä¸¤ç«¯é€šä¿¡æ–¹å¼çš„é…ç½®æ•°æ®ã€‚</li>
<li>PUSH_PROMISE:ç”¨äºå‘å‡ºåˆ›å»ºæµå’ŒæœåŠ¡å™¨å¼•ç”¨èµ„æºçš„è¦çº¦ã€‚</li>
<li>PING:ç”¨äºè®¡ç®—å¾€è¿”æ—¶é—´ï¼Œæ‰§è¡Œâ€œæ´»æ€§â€æ£€æŸ¥ã€‚</li>
<li>GOAWAY:ç”¨äºé€šçŸ¥å¯¹ç«¯åœæ­¢åœ¨å½“å‰è¿æ¥ä¸­åˆ›å»ºæµã€‚</li>
<li>WINDOW_UPDATE:ç”¨äºé’ˆå¯¹ä¸ªåˆ«æµæˆ–ä¸ªåˆ«è¿æ¥å®ç°æµé‡æ§åˆ¶ã€‚</li>
<li>CONTINUATION:ç”¨äºç»§ç»­ä¸€ç³»åˆ—é¦–éƒ¨å—ç‰‡æ®µã€‚</li>
</ul>
<h3 id="å‘èµ·æ–°æµ"><a href="#å‘èµ·æ–°æµ" class="headerlink" title="å‘èµ·æ–°æµ"></a>å‘èµ·æ–°æµ</h3><p>HTTP 2.0 åè®®è§„å®šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½å¯ä»¥å‘èµ·æ–°æµï¼š<br><strong>å®¢æˆ·ç«¯æ–°æµ</strong>ï¼šå®¢æˆ·ç«¯é€šè¿‡å‘é€ç±»å‹ä¸ºHEADERSçš„å¸§å‘èµ·æ–°æµï¼Œæ–°æµåŒ…å«å¸¦æœ‰æ–°æµIDï¼Œå¯é€‰çš„31ä½ä¼˜å…ˆå€¼ä»¥åŠHTTPé”®-å€¼å¯¹é¦–éƒ¨<br><strong>æœåŠ¡ç«¯æ–°æµ</strong>ï¼šæœåŠ¡ç«¯é€šè¿‡å‘é€ç±»å‹ä¸ºPUSH_PROMISEå¸§æ¥å‘èµ·æ¨é€æµï¼Œè¿™ä¸ªå¸§ä¸HEADERSç­‰æ•ˆï¼Œä½†å®ƒæ²¡æœ‰ä¼˜å…ˆå€¼<br><strong>ç”±äºä¸¤ç«¯éƒ½å¯ä»¥å‘èµ·æ–°æµï¼Œæµè®¡æ•°å™¨éœ€è¦ä¸€å®šè§„åˆ™:å®¢æˆ·ç«¯å‘èµ·çš„æµå…·æœ‰å¶æ•°IDï¼ŒæœåŠ¡å™¨å‘èµ·çš„æµå…·æœ‰å¥‡æ•°IDã€‚è¿™æ ·ï¼Œä¸¤ç«¯çš„æµIDä¸ä¼šå†²çªï¼Œè€Œä¸”å„è‡ªæŒæœ‰ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ï¼Œæ¯æ¬¡å‘èµ·æ–°æµæ—¶é€’å¢IDå³å¯ã€‚</strong></p>
<h3 id="å‘èµ·åº”ç”¨æ•°æ®"><a href="#å‘èµ·åº”ç”¨æ•°æ®" class="headerlink" title="å‘èµ·åº”ç”¨æ•°æ®"></a>å‘èµ·åº”ç”¨æ•°æ®</h3><p>åˆ›å»ºæ–°æµå¹¶å‘é€HTTPé¦–éƒ¨ä¹‹åï¼Œä¹‹ååˆ©ç”¨DATAå¸§å‘é€åº”ç”¨æ•°æ®ï¼Œä¸€å—åº”ç”¨æ•°æ®å¯ä»¥åˆ†ä¸ºå¤šä¸ªDATAå¸§ï¼Œæœ€åä¸€å¸§è¦ç¿»è½¬å¸§é¦–éƒ¨çš„END_STREAMå­—æ®µ<br>ï¼ˆHTTP2.0æ ‡å‡†è¦æ±‚å•å¸§æ•°æ®ä¸èƒ½è¶…è¿‡2^14-1(16383)å­—èŠ‚ï¼‰</p>
<h2 id="ç¬¬åä¸‰ç« -ä¼˜åŒ–åº”ç”¨çš„äº¤ä»˜"><a href="#ç¬¬åä¸‰ç« -ä¼˜åŒ–åº”ç”¨çš„äº¤ä»˜" class="headerlink" title="ç¬¬åä¸‰ç«  ä¼˜åŒ–åº”ç”¨çš„äº¤ä»˜"></a>ç¬¬åä¸‰ç«  ä¼˜åŒ–åº”ç”¨çš„äº¤ä»˜</h2><ul>
<li>å‡å°‘DNSæŸ¥æ‰¾</li>
<li>é‡ç”¨TCPè¿æ¥</li>
<li>å‡å°‘HTTPé‡å®šå‘</li>
<li>ä½¿ç”¨CDN</li>
<li>å»æ‰ä¸å¿…è¦çš„è¯·æ±‚</li>
<li>å®¢æˆ·ç«¯ç¼“å­˜èµ„æº</li>
<li>ä¼ è¾“å‹ç¼©è¿‡çš„å†…å®¹</li>
<li>å‡å°‘ä¸å¿…è¦çš„è¯·æ±‚å¼€é”€</li>
<li>å¹¶è¡Œå¤„ç†è¯·æ±‚å’Œå“åº”</li>
</ul>
<h3 id="å®¢æˆ·ç«¯ç¼“å­˜èµ„æº"><a href="#å®¢æˆ·ç«¯ç¼“å­˜èµ„æº" class="headerlink" title="å®¢æˆ·ç«¯ç¼“å­˜èµ„æº"></a>å®¢æˆ·ç«¯ç¼“å­˜èµ„æº</h3><p>HTTPä¼ è¾“ä¸‹å¯ä»¥ä½¿ç”¨é¦–éƒ¨å­—æ®µæ¥å®ç°ç¼“å­˜ï¼š </p>
<ul>
<li>Cache-Control é¦–éƒ¨ç”¨äºæŒ‡å®šç¼“å­˜æ—¶é—´ï¼›</li>
<li>Last-Modified å’Œ ETag é¦–éƒ¨æä¾›éªŒè¯æœºåˆ¶</li>
</ul>
<p>æ³¨æ„ä¸¤è€…ç¼ºä¸€ä¸å¯ï¼š<br>å¦‚æœæ²¡æœ‰æŒ‡å®šéªŒè¯ï¼šå¯¼è‡´æ¯æ¬¡éƒ½åœ¨æ²¡æœ‰æ›´æ–°çš„æƒ…å†µä¸‹é‡å‘ç›¸åŒå†…å®¹<br>å¦‚æœæ²¡æœ‰æŒ‡å®šç¼“å­˜æ—¶é—´ï¼šå¯¼è‡´æ¯æ¬¡ä½¿ç”¨èµ„æºæ—¶éƒ½å¤šä½™åœ°æ‰§è¡ŒéªŒè¯æ£€æŸ¥</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç›®å½•ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç¬¬ä¸‰éƒ¨åˆ† HTTP&lt;ul&gt;
&lt;li&gt;ç¬¬åäºŒç«  HTTP 2.x&lt;/li&gt;
&lt;li&gt;ç¬¬åä¸‰ç«  ä¼˜åŒ–åº”ç”¨çš„äº¤ä»˜&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="http://alfredzhenyu.github.io/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="ç½‘ç»œ" scheme="http://alfredzhenyu.github.io/tags/%E7%BD%91%E7%BB%9C/"/>
    
      <category term="HTTP" scheme="http://alfredzhenyu.github.io/tags/HTTP/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆå››ï¼‰</title>
    <link href="http://alfredzhenyu.github.io/2016/12/26/%E3%80%8AWeb%E6%80%A7%E8%83%BD%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89/"/>
    <id>http://alfredzhenyu.github.io/2016/12/26/ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆå››ï¼‰/</id>
    <published>2016-12-26T03:59:41.000Z</published>
    <updated>2017-02-05T03:20:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç›®å½•ï¼š</p>
<ul>
<li>ç¬¬ä¸‰éƒ¨åˆ† HTTP<ul>
<li>ç¬¬ä¹ç«  HTTPç®€å²</li>
<li>ç¬¬åç«  Webæ€§èƒ½è¦ç‚¹</li>
<li>ç¬¬åä¸€ç«  HTTP 1.x</li>
</ul>
</li>
</ul>
<a id="more"></a>
<h1 id="ç¬¬ä¸‰éƒ¨åˆ†-HTTP"><a href="#ç¬¬ä¸‰éƒ¨åˆ†-HTTP" class="headerlink" title="ç¬¬ä¸‰éƒ¨åˆ† HTTP"></a>ç¬¬ä¸‰éƒ¨åˆ† HTTP</h1><h2 id="ç¬¬ä¹ç« -HTTPç®€å²"><a href="#ç¬¬ä¹ç« -HTTPç®€å²" class="headerlink" title="ç¬¬ä¹ç«  HTTPç®€å²"></a>ç¬¬ä¹ç«  HTTPç®€å²</h2><p>HTTP 0.9ï¼šåªæœ‰ä¸€è¡Œçš„åè®®+æ‚„ç„¶èµ·æ­¥<br>HTTP 1.0ï¼šå‚è€ƒæ€§RFC+è¿…é€Ÿå‘å±•<br>HTTP 1.1ï¼šæ­£å¼çº³å…¥RFC+æ ‡å‡†åŒ–<br>HTTP 2.0ï¼šæ€§èƒ½æ”¹è¿›+ä¼˜åŒ–</p>
<h2 id="ç¬¬åç« -Webæ€§èƒ½è¦ç‚¹"><a href="#ç¬¬åç« -Webæ€§èƒ½è¦ç‚¹" class="headerlink" title="ç¬¬åç«  Webæ€§èƒ½è¦ç‚¹"></a>ç¬¬åç«  Webæ€§èƒ½è¦ç‚¹</h2><p>æµè§ˆå™¨ä¼˜åŒ–ç­–ç•¥</p>
<ul>
<li><strong>åŸºäºæ–‡æ¡£çš„ä¼˜åŒ–</strong>ï¼šç†Ÿæ‚‰ç½‘ç»œåè®®ï¼Œäº†è§£æ–‡æ¡£ã€CSS å’Œ JavaScript è§£æç®¡é“ï¼Œå‘ç°å’Œä¼˜å…ˆå®‰æ’å…³é”®ç½‘ ç»œèµ„æºï¼Œå°½æ—©åˆ†æ´¾è¯·æ±‚å¹¶å–å¾—é¡µé¢ï¼Œä½¿å…¶å°½å¿«è¾¾åˆ°å¯äº¤äº’çš„çŠ¶æ€ã€‚ä¸»è¦æ–¹æ³•æ˜¯ä¼˜ å…ˆè·å–èµ„æºã€æå‰è§£æç­‰ã€‚<em> <em>*æ¨æµ‹æ€§ä¼˜åŒ–</em></em>ï¼šæµè§ˆå™¨å¯ä»¥å­¦ä¹ ç”¨æˆ·çš„å¯¼èˆªæ¨¡å¼ï¼Œæ‰§è¡Œæ¨æµ‹æ€§ä¼˜åŒ–ï¼Œå°è¯•é¢„æµ‹ç”¨æˆ·çš„ä¸‹ä¸€æ¬¡æ“ ä½œã€‚ç„¶åï¼Œé¢„å…ˆè§£æ DNSã€é¢„å…ˆè¿æ¥å¯èƒ½çš„ç›®æ ‡ã€‚</li>
</ul>
<p>æµè§ˆå™¨é‡‡ç”¨çš„æŠ€æœ¯ï¼š</p>
<ul>
<li><strong>èµ„æºé¢„å–å’Œæ’å®šä¼˜å…ˆæ¬¡åº</strong>ï¼šæ–‡æ¡£ã€CSS å’Œ JavaScript è§£æå™¨å¯ä»¥ä¸ç½‘ç»œåè®®å±‚æ²Ÿé€šï¼Œå£°æ˜æ¯ç§èµ„æºçš„ä¼˜å…ˆ çº§:åˆå§‹æ¸²æŸ“å¿…éœ€çš„é˜»å¡èµ„æºå…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼Œè€Œä½ä¼˜å…ˆçº§çš„è¯·æ±‚å¯èƒ½ä¼šè¢«ä¸´æ—¶ ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­ã€‚</li>
<li><strong>DNSé¢„è§£æ</strong>ï¼šå¯¹å¯èƒ½çš„åŸŸåè¿›è¡Œæå‰è§£æï¼Œé¿å…å°†æ¥ HTTP è¯·æ±‚æ—¶çš„ DNS å»¶è¿Ÿã€‚é¢„è§£æå¯ä»¥ é€šè¿‡å­¦ä¹ å¯¼èˆªå†å²ã€ç”¨æˆ·çš„é¼ æ ‡æ‚¬åœï¼Œæˆ–å…¶ä»–é¡µé¢ä¿¡å·æ¥è§¦å‘ã€‚</li>
<li><strong>TCPé¢„è¿æ¥</strong>ï¼šDNS è§£æä¹‹åï¼Œæµè§ˆå™¨å¯ä»¥æ ¹æ®é¢„æµ‹çš„ HTTP è¯·æ±‚ï¼Œæ¨æµ‹æ€§åœ°æ‰“å¼€ TCP è¿æ¥ã€‚ å¦‚æœçŒœå¯¹çš„è¯ï¼Œåˆ™å¯ä»¥èŠ‚çœä¸€æ¬¡å®Œæ•´çš„å¾€è¿”(TCP æ¡æ‰‹)æ—¶é—´ã€‚</li>
<li><strong>é¡µé¢é¢„æ¸²æŸ“</strong>ï¼šæŸäº›æµè§ˆå™¨å¯ä»¥è®©æˆ‘ä»¬æç¤ºä¸‹ä¸€ä¸ªå¯èƒ½çš„ç›®æ ‡ï¼Œä»è€Œåœ¨éšè—çš„æ ‡ç­¾é¡µä¸­é¢„å…ˆæ¸²æŸ“ æ•´ä¸ªé¡µé¢ã€‚è¿™æ ·ï¼Œå½“ç”¨æˆ·çœŸçš„è§¦å‘å¯¼èˆªæ—¶ï¼Œå°±èƒ½ç«‹å³åˆ‡æ¢è¿‡æ¥ã€‚</li>
</ul>
<p>å…³äºç½‘ç«™å»ºè®¾ä¸­çš„ä¼˜åŒ–å»ºè®®ï¼š</p>
<ul>
<li><strong>å‡å°‘DNSæŸ¥è¯¢</strong>ï¼šæ¯æ¬¡åŸŸåè§£æéƒ½éœ€è¦ä¸€æ¬¡ç½‘ç»œå¾€è¿”ï¼Œå¢åŠ è¯·æ±‚çš„å»¶è¿Ÿï¼Œåœ¨æŸ¥è¯¢æœŸé—´ä¼šé˜»å¡è¯·æ±‚ã€‚<em> <em>*å‡å°‘HTTPè¯·æ±‚</em></em>ï¼šä»»ä½•è¯·æ±‚éƒ½ä¸å¦‚æ²¡æœ‰è¯·æ±‚æ›´å¿«ï¼Œå› æ­¤è¦å»æ‰é¡µé¢ä¸Šæ²¡æœ‰å¿…è¦çš„èµ„æº</li>
<li><strong>ä½¿ç”¨CDN</strong>ï¼šä»åœ°ç†ä¸ŠæŠŠæ•°æ®æ”¾åˆ°æ¥è¿‘å®¢æˆ·ç«¯çš„åœ°æ–¹ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘æ¯æ¬¡ TCP è¿æ¥çš„ç½‘ç»œå»¶ è¿Ÿï¼Œå¢åŠ ååé‡ã€‚<em> <strong>æ·»åŠ Expiresé¦–éƒ¨å¹¶é…ç½®ETagæ ‡ç­¾</strong>ï¼šç›¸å…³èµ„æºåº”è¯¥ç¼“å­˜ï¼Œä»¥é¿å…é‡å¤è¯·æ±‚æ¯ä¸ªé¡µé¢ä¸­ç›¸åŒçš„èµ„æºã€‚Expires é¦–éƒ¨å¯ç”¨ äºæŒ‡å®šç¼“å­˜æ—¶é—´ï¼Œåœ¨è¿™ä¸ªæ—¶é—´å†…å¯ä»¥ç›´æ¥ä»ç¼“å­˜å–å¾—èµ„æºï¼Œå®Œå…¨é¿å… HTTP è¯· æ±‚ã€‚ETag åŠ Last-Modified é¦–éƒ¨æä¾›äº†ä¸€ä¸ªä¸ç¼“å­˜ç›¸å…³çš„æœºåˆ¶ï¼Œç›¸å½“äºæœ€åä¸€æ¬¡ æ›´æ–°çš„æŒ‡çº¹æˆ–æ—¶é—´æˆ³ã€‚</em> <strong>Gzipèµ„æº</strong>ï¼šæ‰€æœ‰æ–‡æœ¬èµ„æºéƒ½åº”è¯¥ä½¿ç”¨ Gzip å‹ç¼©ï¼Œç„¶åå†åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é—´ä¼ è¾“ã€‚ä¸€èˆ¬æ¥ è¯´ï¼ŒGzip å¯ä»¥å‡å°‘ 60%~80% çš„æ–‡ä»¶å¤§å°ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç›¸å¯¹ç®€å•(åªè¦åœ¨æœåŠ¡å™¨ä¸Š é…ç½®ä¸€ä¸ªé€‰é¡¹)ï¼Œä½†ä¼˜åŒ–æ•ˆæœè¾ƒå¥½çš„ä¸¾æªã€‚<em> <em>*é¿å…HTTPé‡å®šå‘</em></em>ï¼šHTTP é‡å®šå‘æå…¶è€—æ—¶ï¼Œç‰¹åˆ«æ˜¯æŠŠå®¢æˆ·ç«¯å®šå‘åˆ°ä¸€ä¸ªå®Œå…¨ä¸åŒçš„åŸŸåçš„æƒ…å†µä¸‹ï¼Œ è¿˜ä¼šå¯¼è‡´é¢å¤–çš„ DNS æŸ¥è¯¢ã€TCP è¿æ¥å»¶è¿Ÿï¼Œç­‰ç­‰ã€‚</li>
</ul>
<h2 id="ç¬¬åä¸€ç« -HTTP-1-x"><a href="#ç¬¬åä¸€ç« -HTTP-1-x" class="headerlink" title="ç¬¬åä¸€ç«  HTTP 1.x"></a>ç¬¬åä¸€ç«  HTTP 1.x</h2><p><strong>å¯¹äºHTTP1.0çš„ä¼˜åŒ–ç­–ç•¥ï¼šå‡çº§HTTP1.1</strong></p>
<p>HTTP1.1ç‰¹æ€§ï¼š</p>
<ul>
<li>æŒä¹…åŒ–è¿æ¥ä»¥æ”¯æŒè¿æ¥é‡ç”¨</li>
<li>åˆ†å—ä¼ è¾“ç¼–ç ä»¥æ”¯æŒæµå¼å“åº”</li>
<li>è¯·æ±‚ç®¡é“+æ”¯æŒå¹¶è¡Œè¯·æ±‚å¤„ç†</li>
<li>å­—èŠ‚æœåŠ¡ä»¥æ”¯æŒåŸºäºèŒƒå›´çš„èµ„æºè¯·æ±‚</li>
<li>æ”¹è¿›çš„ç¼“å­˜æœºåˆ¶</li>
</ul>
<h3 id="æŒä¹…åŒ–è¿æ¥"><a href="#æŒä¹…åŒ–è¿æ¥" class="headerlink" title="æŒä¹…åŒ–è¿æ¥"></a>æŒä¹…åŒ–è¿æ¥</h3><p>éæŒä¹…åŒ–è¿æ¥<br><img src="éæŒä¹…åŒ–è¿æ¥.png" alt=""></p>
<p><strong>æŒä¹…åŒ–è¿æ¥</strong><br><img src="æŒä¹…åŒ–è¿æ¥.png" alt=""></p>
<p>æŒä¹… HTTP å¯ä»¥è®©æˆ‘ä»¬é‡ç”¨å·²æœ‰çš„è¿æ¥æ¥å®Œæˆå¤šæ¬¡åº”ç”¨è¯·æ±‚ï¼Œä½†å¤šæ¬¡è¯·æ±‚å¿…é¡»ä¸¥æ ¼æ»¡è¶³å…ˆè¿›å…ˆå‡º(FIFO)çš„é˜Ÿåˆ—é¡ºåº:å‘é€è¯·æ±‚ï¼Œç­‰å¾…å“åº”å®Œæˆï¼Œå†å‘é€å®¢æˆ·ç«¯é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼ŒHTTPç®¡é“æ˜¯ä¸€ä¸ªå¾ˆå°ä½†å¯¹ä¸Šè¿°å·¥ä½œæµå´éå¸¸é‡è¦çš„ä¸€æ¬¡ä¼˜åŒ–ã€‚ç®¡é“å¯ä»¥è®©æˆ‘ä»¬æŠŠFIFOé˜Ÿåˆ—ä»å®¢æˆ·ç«¯(è¯·æ±‚é˜Ÿåˆ—)è¿ç§»åˆ°æœåŠ¡å™¨(å“åº”é˜Ÿåˆ—)ã€‚</p>
<h3 id="HTTPç®¡é“"><a href="#HTTPç®¡é“" class="headerlink" title="HTTPç®¡é“"></a>HTTPç®¡é“</h3><p><strong>HTTPç®¡é“ä¼˜åŒ–</strong><br><img src="HTTPç®¡é“.png" alt=""></p>
<p><strong>æœåŠ¡å™¨å¹¶è¡Œå¤„ç†ä¼˜åŒ–</strong><br><img src="HTTPç®¡é“+å¹¶è¡Œä¼˜åŒ–.png" alt=""></p>
<ul>
<li>HTML å’Œ CSS è¯·æ±‚åŒæ—¶åˆ°è¾¾ï¼Œä½†å…ˆå¤„ç†çš„æ˜¯ HTML è¯·æ±‚;<em> æœåŠ¡å™¨å¹¶è¡Œå¤„ç†ä¸¤ä¸ªè¯·æ±‚ï¼Œå…¶ä¸­å¤„ç† HTML ç”¨æ—¶ 40 msï¼Œå¤„ç† CSS ç”¨æ—¶ 20 ms;</em> CSS è¯·æ±‚å…ˆå¤„ç†å®Œæˆï¼Œä½†è¢«ç¼“å†²èµ·æ¥ä»¥ç­‰å€™å‘é€ HTML å“åº”;* å‘é€å®Œ HTML å“åº”åï¼Œå†å‘é€æœåŠ¡å™¨ç¼“å†²ä¸­çš„ CSS å“åº”ã€‚<br>HTTP 1.xåªèƒ½ä¸¥æ ¼ä¸²è¡Œåœ°è¿”å›å“åº”ã€‚ç‰¹åˆ«æ˜¯ï¼ŒHTTP 1.x ä¸å…è®¸ä¸€ä¸ªè¿æ¥ä¸Šçš„å¤šä¸ªå“åº”æ•°æ®äº¤é”™åˆ°è¾¾(å¤šè·¯å¤ç”¨)ï¼Œå› è€Œä¸€ä¸ªå“åº”å¿…é¡»å®Œå…¨è¿”å›åï¼Œä¸‹ä¸€ä¸ªå“åº”æ‰ä¼šå¼€å§‹ä¼ è¾“ã€‚</li>
</ul>
<p>è¿™ä¸ªä¼šé€ æˆçš„é—®é¢˜ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ…¢å“åº”å°±ä¼šé˜»å¡æ‰€æœ‰åç»­è¯·æ±‚;<em> å¹¶è¡Œå¤„ç†è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨å¿…é¡»ç¼“å†²ç®¡é“ä¸­çš„å“åº”ï¼Œä»è€Œå ç”¨æœåŠ¡å™¨èµ„æºï¼Œå¦‚æœæœ‰ä¸ªå“åº”éå¸¸å¤§ï¼Œåˆ™å¾ˆå®¹æ˜“å½¢æˆæœåŠ¡å™¨çš„å—æ”»å‡»é¢;</em> å“åº”å¤±è´¥å¯èƒ½ç»ˆæ­¢ TCP è¿æ¥ï¼Œä»é¡µå¼ºè¿«å®¢æˆ·ç«¯é‡æ–°å‘é€å¯¹æ‰€æœ‰åç»­èµ„æºçš„è¯·æ±‚ï¼Œå¯¼è‡´é‡å¤å¤„ç†;<em> ç”±äºå¯èƒ½å­˜åœ¨ä¸­é—´ä»£ç†ï¼Œå› æ­¤æ£€æµ‹ç®¡é“å…¼å®¹æ€§ï¼Œç¡®ä¿å¯é æ€§å¾ˆé‡è¦;</em> å¦‚æœä¸­é—´ä»£ç†ä¸æ”¯æŒç®¡é“ï¼Œé‚£å®ƒå¯èƒ½ä¼šä¸­æ–­è¿æ¥ï¼Œä¹Ÿå¯èƒ½ä¼šæŠŠæ‰€æœ‰è¯·æ±‚ä¸²è”èµ·æ¥ã€‚</li>
</ul>
<p>æ³¨æ„ï¼š<br>HTTP ç®¡é“æŠ€æœ¯çš„åº”ç”¨éå¸¸æœ‰é™ï¼Œè™½ç„¶å…¶ä¼˜ç‚¹æ¯‹åº¸ç½®ç–‘ã€‚ä»Šå¤©ï¼Œä¸€äº›æ”¯æŒç®¡é“çš„æµè§ˆå™¨ï¼Œé€šå¸¸éƒ½å°†å…¶ä½œä¸ºä¸€ä¸ªé«˜çº§é…ç½®é€‰é¡¹ï¼Œä½†å¤§å¤šæ•°æµè§ˆå™¨éƒ½ä¼šç¦ç”¨å®ƒã€‚ï¼ˆä½†å¦‚æœå¯¹æœåŠ¡å™¨å’Œåˆ»ç”»æ®µæ‹¥æœ‰å®Œå…¨æ§åˆ¶çš„æƒé™ï¼Œè¿˜æ˜¯å»ºè®®å¼€å¯ï¼Œå…¶ä¸­iTuneså°±åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œå®ç°æ€§èƒ½çš„ä¼˜åŒ–ï¼‰</p>
<h3 id="å¤šä¸ªTCPè¿æ¥"><a href="#å¤šä¸ªTCPè¿æ¥" class="headerlink" title="å¤šä¸ªTCPè¿æ¥"></a>å¤šä¸ªTCPè¿æ¥</h3><p><strong>ç”±äºä¸æ”¯æŒå¤šè·¯å¤ç”¨ï¼Œæµè§ˆå™¨é‡‡ç”¨å…è®¸å¹¶è¡Œå»ºç«‹å¤šä¸ªTCPè¿æ¥çš„æ–¹å¼æ¥è§£å†³ã€‚</strong><br>ç°å®ä¸­ï¼Œå¤§å¤šæ•°ç°ä»£æµè§ˆå™¨ï¼ŒåŒ…æ‹¬æ¡Œé¢å’Œç§»åŠ¨æµè§ˆå™¨ï¼Œéƒ½æ”¯æŒæ¯ä¸ªä¸»æœºæ‰“å¼€ 6 ä¸ªè¿æ¥ã€‚<br>è¿™ä¸ªéœ€è¦çš„ä»£ä»·ï¼š</p>
<ul>
<li>æ›´å¤šçš„å¥—æ¥å­—ä¼šå ç”¨å®¢æˆ·ç«¯ã€æœåŠ¡å™¨ä»¥åŠä»£ç†çš„èµ„æºï¼ŒåŒ…æ‹¬å†…å­˜ç¼“å†²åŒºå’Œ CPU æ—¶é’Ÿå‘¨æœŸ;<em> å¹¶è¡Œ TCP æµä¹‹é—´ç«äº‰å…±äº«çš„å¸¦å®½;</em> ç”±äºå¤„ç†å¤šä¸ªå¥—æ¥å­—ï¼Œå®ç°å¤æ‚æ€§æ›´é«˜;* å³ä½¿å¹¶è¡Œ TCP æµï¼Œåº”ç”¨çš„å¹¶è¡Œèƒ½åŠ›ä¹Ÿå—é™åˆ¶ã€‚<br>å®è·µä¸­ï¼ŒCPU å’Œå†…å­˜å ç”¨å¹¶éå¾®ä¸è¶³é“ï¼Œç”±æ­¤ä¼šå¯¼è‡´å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„èµ„æºå ç”¨é‡ä¸Šå‡ï¼Œè¿ç»´æˆæœ¬æé«˜ã€‚ç±»ä¼¼åœ°ï¼Œç”±äºå®¢æˆ·ç«¯å®ç°çš„å¤æ‚æ€§æé«˜ï¼Œå¼€å‘æˆæœ¬ä¹Ÿä¼šæé«˜ã€‚æœ€åï¼Œè¯´åˆ°åº”ç”¨çš„å¹¶è¡Œæ€§ï¼Œè¿™ç§æ–¹å¼æä¾›çš„å¥½å¤„è¿˜æ˜¯éå¸¸æœ‰é™çš„ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªé•¿æœŸçš„æ–¹æ¡ˆã€‚</li>
</ul>
<h3 id="åŸŸååˆ†åŒº"><a href="#åŸŸååˆ†åŒº" class="headerlink" title="åŸŸååˆ†åŒº"></a>åŸŸååˆ†åŒº</h3><p>å’Œä¸Šé¢çš„åŸç†æ–¹æ³•ä¸€æ ·ï¼Œé€šè¿‡æ‰‹å·¥æŠŠèµ„æºåˆ†æ•£åˆ°å¤šä¸ªå­åŸŸåä¸Šï¼Œ<strong>ç”±äºåŸŸåä¸ä¸€æ ·ï¼Œå¯ä»¥çªç ´æµè§ˆå™¨çš„è¿æ¥é™åˆ¶ï¼Œå®ç°æ›´é«˜çš„å¹¶è¡Œçš„èƒ½åŠ›ï¼ŒåŸŸååˆ†åŒºä½¿ç”¨çš„è¶Šå¤šï¼Œå¹¶è¡Œèƒ½åŠ›è¶Šå¼º</strong><br>è¿™ä¸ªéœ€è¦çš„ä»£ä»·ï¼š</p>
<ul>
<li>ä¸€æ¬¡é¢å¤–çš„ DNS æŸ¥è¯¢</li>
<li>æ¯å¤šä¸€ä¸ªå¥—æ¥å­—éƒ½ä¼šå¤šæ¶ˆè€—ä¸¤ç«¯çš„ä¸€äº›èµ„æº</li>
<li>ç«™ç‚¹å¿…é¡»æ‰‹å·¥åˆ†ç¦»è¿™äº›èµ„æºï¼Œå¹¶åˆ†åˆ«æŠŠå®ƒä»¬æ‰˜ç®¡åˆ°å¤šä¸ªä¸»æœºä¸Šã€‚<br>åŸŸååˆ†åŒºæ˜¯ä¸€ç§åˆç†ä½†åˆä¸å®Œç¾çš„ä¼˜åŒ–æ‰‹æ®µã€‚ç°å®å½“ä¸­ï¼ŒçœŸæ­£å› åŒæ—¶æ‰“å¼€åå‡ ä¸ªè¿æ¥è€Œæå‡æ€§èƒ½çš„ç«™ç‚¹å¹¶ä¸å¤šï¼Œå¦‚æœä½ æœ€ç»ˆä½¿ç”¨äº†å¾ˆå¤šåˆ†åŒºï¼Œé‚£ä¹ˆä½ ä¼šå‘ç°å‡å°‘èµ„æºæ•°é‡æˆ–è€…å°†å®ƒä»¬åˆå¹¶ä¸ºæ›´å°‘çš„è¯·æ±‚ï¼Œåè€Œèƒ½å¸¦æ¥æ›´å¤§çš„å¥½å¤„ã€‚</li>
</ul>
<h3 id="è¿æ¥ä¸æ‹¼åˆ"><a href="#è¿æ¥ä¸æ‹¼åˆ" class="headerlink" title="è¿æ¥ä¸æ‹¼åˆ"></a>è¿æ¥ä¸æ‹¼åˆ</h3><p>æœ€å¿«çš„è¯·æ±‚æ˜¯ä¸ç”¨è¯·æ±‚ã€‚å‡å°‘è¯·æ±‚æ¬¡æ•°æ€»æ˜¯æœ€å¥½çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µã€‚å¦‚æœä½ æ— è®ºå¦‚ä½•ä¹Ÿæ— æ³•å‡å°‘è¯·æ±‚ï¼Œé‚£ä¹ˆå¯¹ HTTP 1.x è€Œè¨€ï¼Œ<strong>å¯ä»¥è€ƒè™‘æŠŠå¤šä¸ªèµ„æºæ†ç»‘æ‰“åŒ…åˆ°ä¸€å—ï¼Œé€šè¿‡ä¸€æ¬¡ç½‘ç»œè¯·æ±‚è·å–</strong>:</p>
<ul>
<li>è¿æ¥ æŠŠå¤šä¸ª JavaScript æˆ– CSS æ–‡ä»¶ç»„åˆä¸ºä¸€ä¸ªæ–‡ä»¶ã€‚* æ‹¼åˆ æŠŠå¤šå¼ å›¾ç‰‡ç»„åˆä¸ºä¸€ä¸ªæ›´å¤§çš„å¤åˆçš„å›¾ç‰‡ã€‚<br>ä¼˜åŠ¿ï¼š</li>
<li>å‡å°‘åè®®å¼€é”€ï¼šé€šè¿‡æŠŠæ–‡ä»¶ç»„åˆæˆä¸€ä¸ªèµ„æºï¼Œå¯ä»¥æ¶ˆé™¤ä¸æ–‡ä»¶ç›¸å…³çš„åè®®å¼€é”€ã€‚* åº”ç”¨å±‚ç®¡é“ï¼šè¿™ä¸¤ç§æŠ€æœ¯çš„æ•ˆæœéƒ½å¥½åƒæ˜¯å¯ç”¨äº† HTTP ç®¡é“:å¤šä¸ªå“åº”çš„æ•°æ®å‰åç›¸ç»§åœ°è¿æ¥åœ¨ä¸€èµ·ï¼Œæ¶ˆé™¤äº†é¢å¤–çš„ç½‘ç»œå»¶è¿Ÿã€‚å®é™…ä¸Šï¼Œå°±æ˜¯æŠŠç®¡é“æé«˜äº†ä¸€å±‚ï¼Œç½®å…¥äº†åº”ç”¨ä¸­ã€‚<br>é—®é¢˜ï¼š</li>
<li>æŠŠæ‰€æœ‰èµ„æºéƒ½ç»„åˆåˆ°ä¸€ä¸ªæ–‡ä»¶ç»å¸¸ä¼šå¯¼è‡´å¤„ç†å’ŒåŠ è½½ä¸å¿…è¦çš„å­—èŠ‚ã€‚è™½ç„¶å¯ ä»¥æŠŠå®ƒçœ‹æˆä¸€ç§é¢„è·å–ï¼Œä½†ä»£ä»·åˆ™æ˜¯é™ä½äº†åˆå§‹å¯åŠ¨çš„é€Ÿåº¦ã€‚</li>
<li>å‡å¦‚æ‰“åŒ…èµ„æºå˜åŠ¨é¢‘ç‡è¿‡é«˜ï¼Œæˆ–æ˜¯èµ„æºåŒ…è¿‡å¤§çš„æƒ…å†µä¸‹ï¼Œä¼šå¾—ä¸å¿å¤±ã€‚</li>
<li>å†…å­˜å ç”¨ï¼šå³ä¾¿å®é™…ä¸Š åªæ˜¾ç¤ºäº†å…¶ä¸­çš„ä¸€å°å—ï¼Œä¹Ÿè¦å§‹ç»ˆæŠŠæ•´ä¸ªå›¾ç‰‡éƒ½ä¿å­˜åœ¨å†…å­˜ä¸­</li>
</ul>
<h3 id="åµŒå…¥èµ„æº"><a href="#åµŒå…¥èµ„æº" class="headerlink" title="åµŒå…¥èµ„æº"></a>åµŒå…¥èµ„æº</h3><p><strong>åµŒå…¥èµ„æºæ˜¯å¦ä¸€ç§éå¸¸æµè¡Œçš„ä¼˜åŒ–æ–¹æ³•ï¼ŒæŠŠèµ„æºåµŒå…¥æ–‡æ¡£å¯ä»¥å‡å°‘è¯·æ±‚çš„æ¬¡æ•°</strong>ã€‚æ¯”å¦‚ï¼ŒJavaScript å’Œ CSS ä»£ç ï¼Œé€šè¿‡é€‚å½“çš„ script å’Œ style å—å¯ä»¥ç›´æ¥æ”¾åœ¨é¡µé¢ä¸­ï¼Œè€Œå›¾ç‰‡ç”šè‡³éŸ³é¢‘æˆ– PDF æ–‡ä»¶ï¼Œéƒ½å¯ä»¥é€šè¿‡æ•°æ®URIçš„æ–¹å¼åµŒå…¥åˆ°é¡µé¢ä¸­<br>ï¼ˆå®é™…ä¸Šï¼Œå¸¸è§çš„ä¸€ä¸ªç»éªŒè§„åˆ™æ˜¯åªè€ƒè™‘åµŒå…¥ 1~2 KB ä»¥ä¸‹çš„èµ„æºï¼Œå› ä¸ºå°äºè¿™ä¸ªæ ‡å‡†çš„èµ„æºç»å¸¸ä¼šå¯¼è‡´æ¯”å®ƒè‡ªèº«æ›´é«˜çš„ HTTP å¼€é”€ã€‚ç„¶è€Œï¼Œå¦‚æœåµŒå…¥çš„èµ„æºé¢‘ç¹å˜æ›´ï¼Œ åˆä¼šå¯¼è‡´å®¿ä¸»æ–‡æ¡£çš„æ— æ•ˆç¼“å­˜ç‡å‡é«˜ï¼‰</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç›®å½•ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç¬¬ä¸‰éƒ¨åˆ† HTTP&lt;ul&gt;
&lt;li&gt;ç¬¬ä¹ç«  HTTPç®€å²&lt;/li&gt;
&lt;li&gt;ç¬¬åç«  Webæ€§èƒ½è¦ç‚¹&lt;/li&gt;
&lt;li&gt;ç¬¬åä¸€ç«  HTTP 1.x&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="http://alfredzhenyu.github.io/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="ç½‘ç»œ" scheme="http://alfredzhenyu.github.io/tags/%E7%BD%91%E7%BB%9C/"/>
    
      <category term="HTTP" scheme="http://alfredzhenyu.github.io/tags/HTTP/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆä¸‰ï¼‰</title>
    <link href="http://alfredzhenyu.github.io/2016/12/26/%E3%80%8AWeb%E6%80%A7%E8%83%BD%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/"/>
    <id>http://alfredzhenyu.github.io/2016/12/26/ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆä¸‰ï¼‰/</id>
    <published>2016-12-26T02:51:14.000Z</published>
    <updated>2017-02-05T03:20:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç›®å½•ï¼š</p>
<ul>
<li>ç¬¬ä¸€éƒ¨åˆ† ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ<ul>
<li>ç¬¬å››ç«  ä¼ è¾“å±‚å®‰å…¨ï¼ˆTLSï¼‰</li>
</ul>
</li>
</ul>
<a id="more"></a>
<h2 id="ç¬¬å››ç« -ä¼ è¾“å±‚å®‰å…¨"><a href="#ç¬¬å››ç« -ä¼ è¾“å±‚å®‰å…¨" class="headerlink" title="ç¬¬å››ç«  ä¼ è¾“å±‚å®‰å…¨"></a>ç¬¬å››ç«  ä¼ è¾“å±‚å®‰å…¨</h2><p>ä¸ªäººçš„ç†è§£ï¼šHTTPS = TLS + HTTP<br><img src="å›¾4.1ä¼ è¾“å±‚å®‰å…¨TLS.png" alt=""><br>soï¼šç†è§£TLSï¼Œåœ¨ç†è§£HTTPSä¸­æä¸ºé‡è¦</p>
<h3 id="TLSä¸SSL"><a href="#TLSä¸SSL" class="headerlink" title="TLSä¸SSL"></a>TLSä¸SSL</h3><p>SSLï¼ˆSecure Sockets Layerï¼Œå®‰å…¨å¥—æ¥å­—ï¼‰æœ€åˆæ˜¯ä¸ºäº†ä¿è¯ç½‘ä¸Šäº¤æ˜“å®‰å…¨è€Œå¼€å‘çš„ä¸€å¥—å®‰å…¨åè®®ï¼Œåè®®é€šè¿‡åŠ å¯†ä¿æŠ¤å®¢æˆ·ä¸ªäººèµ„æ–™ï¼Œé€šè¿‡è®¤è¯å’Œå®Œæ•´æ€§æ£€æŸ¥æ¥ç¡®ä¿äº¤æ˜“å®‰å…¨ï¼ŒSSLä¸ä¼šå½±å“ä¸Šå±‚åè®®ï¼Œä½†èƒ½ä¿è¯ä¸Šå±‚åè®®çš„ç½‘ç»œé€šä¿¡å®‰å…¨ï¼ˆHTTPã€ç”µå­é‚®ä»¶ã€å³æ—¶é€šè®¯ï¼‰<br>TLSï¼ˆTransport Layer Securityï¼Œ ä¼ è¾“å±‚å®‰å…¨ï¼‰ï¼šåæ¥è¢«IETFæ ‡å‡†åŒ–SSLä¹‹åæ”¹äº†åå­—ï¼Œå®é™…ä¸Šä¸¤è€…æŒ‡çš„æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œåªæ˜¯åœ¨ä¸åŒæ—¶é—´æ®µï¼ŒæŒ‡ä»£ä¸åŒçš„åè®®ç‰ˆæœ¬<br>ã€TLSè®¾è®¡çš„åˆè¡·æ˜¯åœ¨å¯é çš„ä¼ è¾“åè®®ï¼ˆTCPï¼‰ä¹‹ä¸Šè¿è¡Œçš„ï¼Œå¯æ˜¯æœ‰å®ç°æŠŠå®ƒæ”¾åœ¨æ•°æ®åŒ…åè®®ï¼ˆå¦‚UDPï¼‰ä¸Šï¼Œå½¢æˆDTLSï¼ˆDatagram Transport Layer Securityï¼Œæ•°æ®æŠ¥ä¼ è¾“å±‚å®‰å…¨ï¼ŒRFC 6437ï¼‰æ—¨åœ¨ä»¥TLSåè®®ä¸ºåŸºç¡€ï¼ŒåŒæ—¶å…¼é¡¾æ•°æ®åŒ…äº¤ä»˜æ¨¡å¼å¹¶æä¾›ç±»ä¼¼çš„å®‰å…¨ä¿éšœã€‘</p>
<h3 id="åŸºæœ¬æœåŠ¡"><a href="#åŸºæœ¬æœåŠ¡" class="headerlink" title="åŸºæœ¬æœåŠ¡"></a>åŸºæœ¬æœåŠ¡</h3><p>TLSç›®æ ‡æ˜¯åœ¨å®ƒä¹‹ä¸Šçš„åº”ç”¨æä¾›ä¸‰ä¸ªåŸºæœ¬æœåŠ¡ï¼š</p>
<ul>
<li>åŠ å¯† æ··æ·†æ•°æ®çš„æœºåˆ¶<em> èº«ä»½éªŒè¯ éªŒè¯èº«ä»½æ ‡è¯†æœ‰æ•ˆæ€§çš„æœºåˆ¶</em> å®Œæ•´æ€§ æ£€æµ‹æ¶ˆæ¯æ˜¯å¦è¢«ç¯¡æ”¹æˆ–ä¼ªé€ çš„æœºåˆ¶</li>
</ul>
<p>å…·ä½“å®ç°ï¼š<br><strong>å¯†é’¥åå•†</strong>ï¼šTLSæ¡æ‰‹æ—¶ä¼šé‡‡ç”¨<strong>å…¬é’¥å¯†ç ç³»ç»Ÿï¼ˆéå¯¹ç§°å¯†é’¥åŠ å¯†ï¼‰</strong>çš„æ–¹å¼ï¼Œè®©é€šä¿¡åŒæ–¹ä¸å¿…äº‹å…ˆâ€œè®¤è¯†â€ï¼Œå³å¯å•†å®šå…±äº«çš„å®‰å…¨å¯†é’¥<br><strong>èº«ä»½éªŒè¯</strong>ï¼šTLSæ—¶å…è®¸é€šä¿¡åŒæ–¹äº’ç›¸éªŒæ˜æ­£èº«ï¼Œå¯ä»¥é€šè¿‡ç›¸äº’æä¾›è®¤è¯è¯ä¹¦æ¥éªŒè¯å¯¹æ–¹æ˜¯å¦æ˜¯å®ƒæƒ³è”ç³»çš„æœåŠ¡<br><strong>æ¶ˆæ¯åˆ†å¸§</strong>ï¼šä½¿ç”¨MACç®—æ³•ï¼ˆMessage Authentication Codeï¼Œæ¶ˆæ¯è®¤è¯ç ï¼‰ç­¾ç½²æ¯ä¸€æ¡æ¶ˆæ¯ã€‚<strong>MACç®—æ³•æ˜¯ä¸€ä¸ªå•å‘åŠ å¯†çš„æ•£åˆ—å‡½æ•°(æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ ¡éªŒå’Œ)ï¼Œå¯†é’¥ç”±è¿æ¥åŒæ–¹åå•†ç¡®å®š</strong>ã€‚åªè¦å‘é€TLSè®°å½•ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªMACå€¼å¹¶é™„åŠ åˆ°è¯¥æ¶ˆæ¯ä¸­ã€‚æ¥æ”¶ç«¯é€šè¿‡è®¡ç®—å’ŒéªŒè¯è¿™ä¸ªMACå€¼æ¥åˆ¤æ–­æ¶ˆæ¯çš„å®Œæ•´æ€§å’Œå¯é æ€§ã€‚</p>
<h3 id="TLSæ¡æ‰‹"><a href="#TLSæ¡æ‰‹" class="headerlink" title="TLSæ¡æ‰‹"></a>TLSæ¡æ‰‹</h3><p><img src="å›¾4.2TLSæ¡æ‰‹åè®®.png" alt=""><br>â€¢ 0 ms:TLS åœ¨å¯é çš„ä¼ è¾“å±‚(TCP)ä¹‹ä¸Šè¿è¡Œï¼Œè¿™æ„å‘³ç€é¦–å…ˆå¿…é¡»å®Œæˆ TCP çš„â€œä¸‰æ¬¡æ¡æ‰‹â€ï¼Œå³ä¸€æ¬¡å®Œæ•´çš„å¾€è¿”ã€‚â€¢ 56 ms:TCP è¿æ¥å»ºç«‹ä¹‹åï¼Œå®¢æˆ·ç«¯å†ä»¥çº¯æ–‡æœ¬å½¢å¼å‘é€ä¸€äº›è§„æ ¼è¯´æ˜ï¼Œæ¯”å¦‚<strong>å®ƒæ‰€è¿è¡Œçš„ TLS åè®®çš„ç‰ˆæœ¬ã€å®ƒæ‰€æ”¯æŒçš„åŠ å¯†å¥—ä»¶åˆ—è¡¨ï¼Œä»¥åŠå®ƒæ”¯æŒæˆ–å¸Œæœ›ä½¿ç”¨çš„å¦å¤–ä¸€ äº› TLS é€‰é¡¹</strong>ã€‚â€¢ 84 ms:ç„¶åï¼ŒæœåŠ¡å™¨å–å¾— TLS åè®®ç‰ˆæœ¬ä»¥å¤‡å°†æ¥é€šä¿¡ä½¿ç”¨ï¼Œ<strong>ä»å®¢æˆ·ç«¯æä¾›çš„åŠ å¯†å¥—ä»¶åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œå†é™„ä¸Šè‡ªå·±çš„è¯ä¹¦ã€è¿™é‡Œåº”è¯¥è¿˜æœ‰æœåŠ¡å™¨ç»™å®¢æˆ·ç«¯çš„å…¬é’¥ï¼Œç”¨äºéå¯¹ç§°åŠ å¯†ã€‘</strong>ï¼Œå°†å“åº”å‘é€å›å®¢æˆ·ç«¯ã€‚ä½œä¸ºå¯é€‰é¡¹ï¼Œ<strong>æœåŠ¡å™¨ä¹Ÿå¯ä»¥å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè¦æ±‚å®¢æˆ·ç«¯æä¾›è¯ä¹¦ä»¥åŠå…¶ä»– TLS æ‰©å±•å‚æ•°</strong>ã€‚â€¢ 112 ms:å‡è®¾ä¸¤ç«¯ç»è¿‡åå•†ç¡®å®šäº†å…±åŒçš„ç‰ˆæœ¬å’ŒåŠ å¯†å¥—ä»¶ï¼Œå®¢æˆ·ç«¯ä¹Ÿé«˜é«˜å…´å…´åœ°<strong>æŠŠè‡ªå·±çš„è¯ä¹¦æä¾›ç»™äº†æœåŠ¡å™¨</strong>ã€‚ç„¶åï¼Œ<strong>å®¢æˆ·ç«¯ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹ç§°å¯†é’¥ï¼Œç”¨æœåŠ¡å™¨çš„å…¬é’¥æ¥åŠ å¯†ï¼ŒåŠ å¯†åå‘é€ç»™æœåŠ¡å™¨ï¼Œå‘Šè¯‰æœåŠ¡å™¨å¯ä»¥å¼€å§‹åŠ å¯†é€šä¿¡äº†</strong>ã€‚</p>
<blockquote>
<p><strong>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œé™¤äº†ç”¨æœåŠ¡å™¨å…¬é’¥åŠ å¯†çš„æ–°å¯¹ç§°å¯†é’¥ä¹‹å¤–ï¼Œæ‰€æœ‰æ•°æ®éƒ½ä»¥æ˜æ–‡å½¢å¼å‘é€ã€‚</strong>â€¢ 140 ms:æœ€åï¼Œ<strong>æœåŠ¡å™¨è§£å¯†å‡ºå®¢æˆ·ç«¯å‘æ¥çš„å¯¹ç§°å¯†é’¥</strong>ï¼Œé€šè¿‡<strong>éªŒè¯æ¶ˆæ¯çš„ MAC æ£€æµ‹æ¶ˆæ¯å®Œæ•´æ€§ï¼Œå†è¿”å›ç»™å®¢æˆ·ç«¯ä¸€ä¸ªåŠ å¯†çš„â€œFinishedâ€æ¶ˆæ¯</strong>ã€‚â€¢ 168 ms:å®¢æˆ·ç«¯ç”¨å®ƒä¹‹å‰ç”Ÿæˆçš„å¯¹ç§°å¯†é’¥è§£å¯†è¿™æ¡æ¶ˆæ¯ï¼ŒéªŒè¯ MACï¼Œå¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œåˆ™å»ºç«‹ä¿¡é“å¹¶å¼€å§‹å‘é€åº”ç”¨æ•°æ®ã€‚</p>
</blockquote>
<h4 id="åŠ å¯†"><a href="#åŠ å¯†" class="headerlink" title="åŠ å¯†"></a>åŠ å¯†</h4><p> éå¯¹ç§°åŠ å¯†ï¼šåªåœ¨å»ºç«‹TLSä¿¡é“çš„ä¼šè¯ä¸­ä½¿ç”¨<br> å¯¹ç§°åŠ å¯†ï¼šå»ºç«‹TLSä¹‹åä¼šä¸€ç›´ä½¿ç”¨<br> ä¸»è¦åŸå› æ˜¯é¡¾åŠæ€§èƒ½é—®é¢˜<br> ä»¥æœ€å¸¸ç”¨çš„RSAã€AESåŠ å¯†æ–¹å¼ä¸ºä¾‹å­ï¼šåœ¨å®‰è£…äº†OpenSSLçš„è¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$&gt; openssl speed rsa</div><div class="line">$&gt; openssl speed aes</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹å‡ºAESéœ€è¦3så·¦å³å®Œæˆä¸€æ¬¡åŠ /è§£å¯†<br>å¯ä»¥çœ‹å‡ºRSAéœ€è¦10så·¦å³å®Œæˆä¸€æ¬¡åŠ /è§£å¯†</p>
<p><strong>TODOï¼šåç»­å¯èƒ½ä¼šé’ˆå¯¹åŠ è§£å¯†è¿™å—å†™äº›æ–‡ç« ï¼Œæ¯•ç«Ÿå®¢æˆ·ç«¯åœ¨äºæœåŠ¡ç«¯äº¤äº’çš„æ—¶å€™åŠ è§£å¯†æ˜¯å¿…ä¸å¯å°‘çš„</strong></p>
<h4 id="åº”ç”¨å±‚åè®®åå•†ï¼ˆALPNï¼‰"><a href="#åº”ç”¨å±‚åè®®åå•†ï¼ˆALPNï¼‰" class="headerlink" title="åº”ç”¨å±‚åè®®åå•†ï¼ˆALPNï¼‰"></a>åº”ç”¨å±‚åè®®åå•†ï¼ˆALPNï¼‰</h4><p>ç½‘ç»œä¸Šé€šä¿¡å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„åè®®è¿›è¡Œé€šä¿¡</p>
<ul>
<li>HTTPçš„è¯å¯ä»¥ä½¿ç”¨Upgradeæœºåˆ¶ + 80ç«¯å£æ¥åå•†è‡ªå®šä¹‰åè®®</li>
<li>HTTPSçš„è¯ç”±äºä½¿ç”¨äº†TLSï¼Œé™¤äº†å¯ä»¥ä½¿ç”¨HTTPçš„Upgradeæœºåˆ¶æ¥åå•†ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ALPN+443ç«¯å£ï¼Œåœ¨TLSæ¡æ‰‹æ—¶å°±æŠŠåå•†ç¡®å®šåè®®</li>
</ul>
<p><strong>ALPN</strong>ï¼šåœ¨å®¢æˆ·ç«¯å‘é€ClientHelloçš„è¿‡ç¨‹ä¸­å¢åŠ ä¸€ä¸ªæ–°çš„å­—æ®µProtocolNameListï¼Œå‘Šè¯‰æœåŠ¡ç«¯è‡ªå·±æ”¯æŒçš„åº”ç”¨åè®®ï¼›<br>æœåŠ¡å™¨æ£€æŸ¥ProtocolNameListå­—æ®µï¼Œå¦‚æœæ”¯æŒï¼šåœ¨ServerHelloæ¶ˆæ¯ä¸­ä»¥ ProtocolNameå­—æ®µè¿”å›é€‰ä¸­çš„åè®®ï¼›å¦‚æœä¸æ”¯æŒï¼šæ–­å¼€è¿æ¥<br>ã€Upgradeæœºåˆ¶ä¼šå¢åŠ ä¸€æ¬¡å¾€è¿”çš„å»¶è¿Ÿï¼šä¼šåœ¨HTTPéƒ¨åˆ†è¿›è¡Œè®²è§£ã€‘</p>
<h4 id="æœåŠ¡å™¨åç§°æŒ‡ç¤ºï¼ˆSNIï¼‰"><a href="#æœåŠ¡å™¨åç§°æŒ‡ç¤ºï¼ˆSNIï¼‰" class="headerlink" title="æœåŠ¡å™¨åç§°æŒ‡ç¤ºï¼ˆSNIï¼‰"></a>æœåŠ¡å™¨åç§°æŒ‡ç¤ºï¼ˆSNIï¼‰</h4><p>ç½‘ç»œä¸Šå¯ä»¥å»ºç«‹TCPè¿æ¥çš„ä»»æ„ä¸¤ç«¯éƒ½å¯ä»¥å»ºç«‹åŠ å¯†TLSä¿¡é“ï¼Œå®¢æˆ·ç«¯åªéœ€çŸ¥é“ å¦ä¸€ç«¯çš„IPåœ°å€å³å¯å»ºç«‹è¿æ¥å¹¶è¿›è¡ŒTLSæ¡æ‰‹ã€‚ç„¶è€Œï¼Œå¦‚æœæœåŠ¡å™¨æƒ³åœ¨ä¸€ä¸ªIPåœ°å€ä¸ºå¤šä¸ªç«™ç‚¹æä¾›æœåŠ¡ï¼Œè€Œæ¯ä¸ªç«™ç‚¹éƒ½æ‹¥æœ‰è‡ªå·±çš„TLSè¯ä¹¦ï¼Œé‚£æ€ä¹ˆåŠï¼Ÿå°±è¦ç”¨åˆ°SNIï¼š<br><strong>SNI</strong>ï¼šè¯¥æ‰©å±•è¢«å¼•å…¥TLSåè®®ï¼Œè¯¥æ‰©å±•å…è®¸å®¢æˆ·ç«¯åœ¨æ¡æ‰‹ä¹‹åˆå°±æŒ‡æ˜è¦è¿æ¥çš„ä¸»æœºåã€‚WebæœåŠ¡å™¨å¯ä»¥æ£€æŸ¥SNIä¸»æœºåï¼Œé€‰æ‹©é€‚å½“çš„è¯ä¹¦ï¼Œç»§ç»­å®Œæˆæ¡æ‰‹</p>
<h3 id="TLSä¼šè¯æ¢å¤"><a href="#TLSä¼šè¯æ¢å¤" class="headerlink" title="TLSä¼šè¯æ¢å¤"></a>TLSä¼šè¯æ¢å¤</h3><p>TLSæ¡æ‰‹ä¼šå¸¦æ¥é¢å¤–çš„å»¶è¿Ÿå’Œè®¡ç®—é‡ï¼Œé€ æˆä¸€å®šçš„æ€§èƒ½æŸå¤±ã€‚ä¸ºäº†æŒ½å›æŸäº›æŸå¤±ï¼ŒTLSæä¾›äº†æ¢å¤åŠŸèƒ½ï¼Œå³åœ¨å¤šä¸ªè¿æ¥é—´å…±äº«åå•†åçš„å®‰å…¨å¯†é’¥ã€‚</p>
<h4 id="ä¼šè¯æ ‡è¯†ç¬¦ï¼ˆSession-Identifierï¼‰"><a href="#ä¼šè¯æ ‡è¯†ç¬¦ï¼ˆSession-Identifierï¼‰" class="headerlink" title="ä¼šè¯æ ‡è¯†ç¬¦ï¼ˆSession Identifierï¼‰"></a>ä¼šè¯æ ‡è¯†ç¬¦ï¼ˆSession Identifierï¼‰</h4><p><strong>ä¼šè¯æ ‡è¯†ç¬¦</strong>ï¼ˆRFC 5246ï¼Œåœ¨SSL 2.0å¼•å…¥ï¼‰ï¼šæœåŠ¡å™¨æ”¯æŒåˆ›å»º32å­—èŠ‚çš„ä¼šè¯æ ‡è¯†ç¬¦ï¼Œç”¨äºä¿å­˜ä¸€ä¸ªä¼šè¯IDå’Œåå•†åçš„ä¼šè¯å‚æ•°ã€‚<br>ç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶ï¼šæœåŠ¡å™¨æŠŠIDä¿¡æ¯ä½œä¸ºâ€œServerHelloâ€æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†å‘é€å‡ºå»ï¼Œè‡ªå·±æŠŠå…¶ä»–ä¼šè¯ä¿¡æ¯å­˜å‚¨èµ·æ¥ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åä¿å­˜ä¼šè¯IDä¿¡æ¯<br>éœ€è¦æ¢å¤æ—¶ï¼šå°†è¯¥IDåŒ…å«åœ¨ä¼šè¯çš„â€œClientHelloâ€æ¶ˆæ¯ä¸­ï¼Œ å‘Šè¯‰æœåŠ¡å™¨è‡ªå·±è¿˜è®°ç€ä¸Šæ¬¡æ¡æ‰‹åå•†åçš„åŠ å¯†å¥—ä»¶å’Œå¯†é’¥å‘¢ï¼Œä»è€Œå®ç°é‡ç”¨ã€‚<br>é—®é¢˜ï¼šå¯¹äºæ¯å¤©å‡ ç™¾ä¸‡è¿æ¥çš„æœåŠ¡å™¨æ¥è¯´ï¼ŒTLSè¿æ¥ä¼šå ç”¨ä¸å¿…è¦çš„å†…å­˜ï¼Œäºæ˜¯å¼•å…¥ä¼šè¯è®°å½•å•ï¼ˆSession Ticketï¼‰</p>
<h4 id="ä¼šè¯è®°å½•å•ï¼ˆSession-Ticketï¼‰"><a href="#ä¼šè¯è®°å½•å•ï¼ˆSession-Ticketï¼‰" class="headerlink" title="ä¼šè¯è®°å½•å•ï¼ˆSession Ticketï¼‰"></a>ä¼šè¯è®°å½•å•ï¼ˆSession Ticketï¼‰</h4><p><strong>ä¼šè¯è®°å½•å•</strong>ï¼ˆRFC 5077ï¼‰ï¼šè¯¥æœºåˆ¶ä¸ç”¨æœåŠ¡å™¨ä¿å­˜æ¯ä¸ªå®¢æˆ·ç«¯çš„ä¼šè¯çŠ¶æ€ï¼Œè€Œæ˜¯å°†åªæœ‰æœåŠ¡å™¨çŸ¥é“çš„å®‰å…¨å¯†é’¥åŠ å¯†è¿‡çš„æ‰€æœ‰ä¼šè¯æ•°æ®äº¤ç”±å®¢æˆ·ç«¯ä¿å­˜ã€‚<br>ç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶ï¼šå®¢æˆ·ç«¯è¡¨æ˜å…¶æ”¯æŒä¼šè¯è®°å½•å•ï¼Œåˆ™æœåŠ¡å™¨å¯ä»¥åœ¨å®Œæ•´TLSæ¡æ‰‹çš„æœ€åä¸€æ¬¡äº¤æ¢ä¸­æ·»åŠ ä¸€æ¡â€œæ–°ä¼šè¯è®°å½•å•â€(New Session Ticket)è®°å½•ï¼Œä¿å­˜å¯¹åº”çš„ä¼šè¯æ•°æ®äº¤ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å°†è¿™ä¸ªä¼šè¯è®°å½•å•ä¿å­˜èµ·æ¥<br>éœ€è¦æ¢å¤æ—¶ï¼šåœ¨ ClientHello æ¶ˆæ¯ä¸­å°†åŠ å¯†è¿‡çš„ä¼šè¯è®°å½•å•æ”¾åœ¨SessionTicketæ‰©å±•ä¸­ï¼ŒæœåŠ¡å™¨æ‹¿åˆ°ä¹‹åæ‹¿è‡ªå·±çš„ç§˜é’¥è§£å¯†å®ç°é‡ç”¨ï¼ˆè¿™ç§å›å¤ç§°ä¹‹ä¸ºæ— çŠ¶æ€æ¢å¤ï¼‰</p>
<p><strong>ä¼šè¯è®°å½•å• å’Œ ä¼šè¯æ ‡è¯†ç¬¦ çš„åŒºåˆ«åœ¨äºæ˜¯æœåŠ¡å™¨è¿˜æ˜¯å®¢æˆ·ç«¯å­˜è¿™ä¸ªä¼šè¯è®°å½•</strong></p>
<h3 id="TLSè®°å½•åè®®"><a href="#TLSè®°å½•åè®®" class="headerlink" title="TLSè®°å½•åè®®"></a>TLSè®°å½•åè®®</h3><p>æ‰€æœ‰ç»è¿‡é‡‡ç”¨TLSçš„åè®®çš„è¯·æ±‚éƒ½å¿…é¡»ç»è¿‡è®°å½•åè®®ï¼Œæ·»åŠ ç›¸åº”çš„å­—æ®µï¼Œè¿›è¡Œä¸€å®šçš„æ•°æ®å¤„ç†ä¹‹åæ‰äº¤ç”±TCPå‘é€å‡ºå»<br>å‘é€ç«¯æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>è®°å½•åè®®æ¥æ”¶ä¸Šå±‚åº”ç”¨æ•°æ®</li>
<li>æ¥æ”¶åˆ°çš„åº”ç”¨æ•°æ®è¢«åˆ‡åˆ†ä¸ºå—:æœ€å¤§ä¸ºæ¯æ¡è®°å½•214å­—èŠ‚ï¼Œå³16KBã€‚</li>
<li>å‹ç¼©åº”ç”¨æ•°æ®(å¯é€‰)ã€‚</li>
<li>æ·»åŠ  MAC(Message Authentication Code)æˆ– HMACã€‚</li>
<li>ç”¨å•†å®šçš„åŠ å¯†å¥—ä»¶åŠ å¯†æ•°æ®</li>
<li>äº¤ç”±TCPå±‚ä¼ è¾“<br>æ¥æ”¶ç«¯é¡ºåºç›¸åï¼š6 â€”&gt; 1<br>æ³¨æ„ï¼š<br>TLSè®°å½•åè®®æœ€å¤§ä¸º16KBã€‚äº‹å®ä¸Šå¯ä»¥è‡ªä¸»é€‰æ‹©è®°å½•å¤§å°ï¼Œå°è®°å½•ä¼šå› ä¸ºåˆ†å¸§è€Œæ‹›è‡´è¾ƒå¤§å¼€é”€<br>æ¯æ¡è®°å½•åŒ…å«5å­—èŠ‚çš„é¦–éƒ¨ã€MAC(åœ¨ SSL 3.0ã€TLS 1.0ã€TLS 1.1 ä¸­æœ€å¤š 20 å­—èŠ‚ï¼Œåœ¨ TLS 1.2 ä¸­æœ€å¤š 32 å­—èŠ‚)ï¼Œå¦‚æœä½¿ç”¨å—åŠ å¯†åˆ™è¿˜æœ‰å¡«å……<br>å¿…é¡»æ¥æ”¶åˆ°æ•´æ¡è®°å½•ï¼ˆä¸æ˜¯å¸§ï¼‰æ‰å¼€å§‹è§£å¯†å’ŒéªŒè¯ã€‚</li>
</ol>
<h3 id="ä¼˜åŒ–å»ºè®®"><a href="#ä¼˜åŒ–å»ºè®®" class="headerlink" title="ä¼˜åŒ–å»ºè®®"></a>ä¼˜åŒ–å»ºè®®</h3><ul>
<li>æœ€å¤§é™åˆ¶æå‡TCPæ€§èƒ½</li>
<li>å¼€å¯ä¼šè¯ç¼“å­˜ï¼šåœ¨æ”¯æŒçš„å®¢æˆ·ç«¯ä¸­ä½¿ç”¨ä¼šè¯è®°å½•å•ï¼Œè€Œåœ¨ä¸æ”¯æŒçš„å®¢æˆ·ç«¯ä¸­ä½¿ç”¨ä¼šè¯æ ‡è¯†ç¬¦</li>
<li>è°ƒæ•´TLSè®°å½•å¤§å°ï¼šè®°å½•è¿‡å°ä¼šé€ æˆåˆ†å¸§æµªè´¹ï¼Œå¤§è®°å½•ä¼šå¯¼è‡´å»¶è¿Ÿã€‚æœ€å¥½çš„åšæ³•ï¼šæ¯ä¸ªTCPåˆ†ç»„æ°å¥½å°è£…ä¸€ä¸ªTLSè®°å½•ï¼Œè€ŒTLSè®°å½•å¤§å°æ°å¥½å æ»¡TCPåˆ†é…çš„MSS(Maximum Segment Sizeï¼Œæœ€å¤§æ®µå¤§å°)<pre><code>ï¼ˆä¸€æ–¹é¢ä¸è¦è®©TLSè®°å½•åˆ†æˆå¤šä¸ªTCPåˆ†ç»„ï¼Œå¦ä¸€æ–¹é¢åˆè¦å°½é‡åœ¨ä¸€æ¡è®°å½•ä¸­å¤šå‘é€æ•°æ®ï¼Œå‚è€ƒæ•°æ®å¦‚ä¸‹ï¼š
</code></pre></li>
<li>IPv4 å¸§éœ€è¦ 20 å­—èŠ‚ï¼ŒIPv6 éœ€è¦ 40 å­—èŠ‚;</li>
<li>TCP å¸§éœ€è¦ 20 å­—èŠ‚;</li>
<li>TCP é€‰é¡¹éœ€è¦ 40 å­—èŠ‚(æ—¶é—´æˆ³ã€SACK ç­‰)ã€‚<pre><code>å‡è®¾å¸¸è§çš„MTUä¸º1500å­—èŠ‚ï¼Œåˆ™TLSè®°å½•å¤§å°åœ¨IPv4ä¸‹æ˜¯1420å­—èŠ‚ï¼Œåœ¨IPv6ä¸‹æ˜¯1400å­—èŠ‚ã€‚ä¸ºç¡®ä¿å‘å‰å…¼å®¹ï¼Œå»ºè®®ä½¿ç”¨IPv6ä¸‹çš„å¤§å°:1400å­—èŠ‚ã€‚å½“ç„¶ï¼Œå¦‚æœMTUæ›´å°ï¼Œè¿™ä¸ªå€¼ä¹Ÿè¦ç›¸åº”è°ƒå°ï¼‰
ã€ä½†åº”ç”¨å±‚æ— æ³•æ§åˆ¶TLSè®°å½•å¤§å°ï¼Œä¸€èˆ¬æ˜¯æœåŠ¡å™¨ç¼–è¯‘æ—¶çš„å¸¸é‡æˆ–æ ‡å¿—ï¼Œå¯ä»¥é€šè¿‡æœåŠ¡å™¨æ–‡æ¡£æ¥æŸ¥çœ‹è¿™ä¸ªå€¼ã€‘
</code></pre></li>
<li>ç¦ç”¨æœåŠ¡å™¨çš„TLSå‹ç¼©åŠŸèƒ½<ul>
<li>ä¼ è¾“çº§çš„ TLS å‹ç¼©ä¸å…³å¿ƒå†…å®¹ï¼Œå¯èƒ½ä¼šå†æ¬¡å‹ç¼©å·²ç»å‹ç¼©è¿‡çš„æ•°æ®(å›¾åƒã€è§†é¢‘ï¼Œ ç­‰ç­‰)ã€‚åŒé‡å‹ç¼©ä¼šæµªè´¹æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„CPUæ—¶é—´ï¼Œè€Œä¸”æš´éœ²çš„å®‰å…¨æ¼æ´ä¹Ÿå¾ˆä¸¥é‡ï¼Œå› æ­¤ è¯·ç¦ç”¨TLSå‹ç¼©</li>
</ul>
</li>
<li>ç¡®ä¿è¯ä¹¦é“¾ä¸ä¼šè¶…è¿‡æ‹¥å¡çª—å£çš„å¤§å°ï¼Œä»ä¿¡ä»»é“¾ä¸­å»æ‰ä¸å¿…è¦çš„è¯ä¹¦ï¼Œå‡å°‘é“¾æ¡å±‚æ¬¡ï¼Œæˆ–è€…ç›´æ¥å‡å°è¯ä¹¦å¤§å°<ul>
<li>å¦‚æœè¯ä¹¦é“¾é•¿åº¦è¶…è¿‡äº† TCP çš„åˆå§‹æ‹¥å¡çª—å£(å›¾ 4-11)ï¼Œé‚£æˆ‘ä»¬æ— æ„ é—´å°±ä¼šè®©æ¡æ‰‹å¤šäº†ä¸€æ¬¡å¾€è¿”:è¯ä¹¦é•¿åº¦è¶…è¿‡æ‹¥å¡çª—å£ï¼Œä»è€Œå¯¼è‡´æœåŠ¡å™¨åœä¸‹æ¥ç­‰å¾… å®¢æˆ·ç«¯çš„ ACK æ¶ˆæ¯</li>
</ul>
</li>
<li>å¯ç”¨æœåŠ¡å™¨çš„OCSPå°å¥—åŠŸèƒ½ï¼ˆè¯ä¹¦æ–¹é¢çš„ä¼˜åŒ–ï¼‰</li>
<li>å¯ç”¨æœåŠ¡å™¨å¯¹SNIçš„æ”¯æŒ</li>
<li>è¿½åŠ HTTPä¸¥æ ¼ä¼ è¾“å®‰å…¨é¦–éƒ¨ï¼ˆä¸å¤ªç†è§£ï¼‰</li>
</ul>
<p>ï¼ˆåé¢è¿™ä¸¤ä¸ªï¼Œè¦æƒ³è¿›ä¸€æ­¥äº†è§£çœ‹ä¹¦å§ï¼Œæ„Ÿè§‰ä¹¦ä¹Ÿæ²¡è®²ç‰¹åˆ«ç»†ï¼Œä¸ªäººä¹Ÿæ²¡ç‰¹åˆ«æ·±çš„ç†è§£ï¼Œå°±ç•¥è¿‡äº†ï¼‰</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç›®å½•ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç¬¬ä¸€éƒ¨åˆ† ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ&lt;ul&gt;
&lt;li&gt;ç¬¬å››ç«  ä¼ è¾“å±‚å®‰å…¨ï¼ˆTLSï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="http://alfredzhenyu.github.io/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="ç½‘ç»œ" scheme="http://alfredzhenyu.github.io/tags/%E7%BD%91%E7%BB%9C/"/>
    
      <category term="HTTPS" scheme="http://alfredzhenyu.github.io/tags/HTTPS/"/>
    
      <category term="SSL/TLS" scheme="http://alfredzhenyu.github.io/tags/SSL-TLS/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆäºŒï¼‰</title>
    <link href="http://alfredzhenyu.github.io/2016/12/23/%E3%80%8AWeb%E6%80%A7%E8%83%BD%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>http://alfredzhenyu.github.io/2016/12/23/ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆäºŒï¼‰/</id>
    <published>2016-12-23T09:03:47.000Z</published>
    <updated>2017-02-05T03:21:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç›®å½•</p>
<ul>
<li><p>ç¬¬ä¸€éƒ¨åˆ† ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ</p>
<ul>
<li>ç¬¬ä¸‰ç«  UDPæ„æˆ</li>
</ul>
<p>â€‹</p>
<a id="more"></a>
</li>
</ul>
<h2 id="ç¬¬ä¸‰ç« -UDPæ„æˆ"><a href="#ç¬¬ä¸‰ç« -UDPæ„æˆ" class="headerlink" title="ç¬¬ä¸‰ç«  UDPæ„æˆ"></a>ç¬¬ä¸‰ç«  UDPæ„æˆ</h2><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><ul>
<li>å…³äºUDPçš„åº”ç”¨ï¼Œæœ€å¹¿ä¸ºäººçŸ¥åŒæ—¶ä¹Ÿæ˜¯æ‰€æœ‰æµè§ˆå™¨å’Œå› ç‰¹ç½‘åº”ç”¨éƒ½èµ–ä»¥è¿ä½œçš„ï¼Œå°±æ˜¯DNS(Domain Name Systemï¼ŒåŸŸåç³»ç»Ÿ)</li>
<li>HTTP å¹¶æœªè§„å®šè¦ä½¿ç”¨ TCPï¼Œä½†ç°å®ä¸­æ‰€æœ‰ HTTP å®ç°(ä»¥åŠ æ„å»ºäºå…¶ä¸Šçš„æ‰€æœ‰æœåŠ¡)éƒ½ä½¿ç”¨ TCPã€‚ä¸è¿‡ï¼Œè¿™éƒ½æ˜¯è¿‡å»çš„äº‹äº†ã€‚IETF å’Œ W3C å·¥ä½œç»„å…±åŒåˆ¶å®šäº†ä¸€å¥—æ–° APIâ€”â€” WebRTC(Web Real-Time Communicationï¼ŒWeb å®æ—¶é€šä¿¡)</li>
</ul>
<h3 id="æ— åè®®æœåŠ¡"><a href="#æ— åè®®æœåŠ¡" class="headerlink" title="æ— åè®®æœåŠ¡"></a>æ— åè®®æœåŠ¡</h3><p>ä¸ºä»€ä¹ˆç§°ä¹‹ä¸ºæ— åè®®ï¼š</p>
<ul>
<li>ä¸ä¿è¯æ¶ˆæ¯äº¤ä»˜ ä¸ç¡®è®¤ï¼Œä¸é‡ä¼ ï¼Œæ— è¶…æ—¶ã€‚<em> ä¸ä¿è¯äº¤ä»˜é¡ºåº ä¸è®¾ç½®åŒ…åºå·ï¼Œä¸é‡æ’ï¼Œä¸ä¼šå‘ç”Ÿé˜Ÿé¦–é˜»å¡ã€‚</em> ä¸è·Ÿè¸ªè¿æ¥çŠ¶æ€ ä¸å¿…å»ºç«‹è¿æ¥æˆ–é‡å¯çŠ¶æ€æœºã€‚* ä¸éœ€è¦æ‹¥å¡æ§åˆ¶ ä¸å†…ç½®å®¢æˆ·ç«¯æˆ–ç½‘ç»œåé¦ˆæœºåˆ¶ã€‚<h3 id="ç½‘ç»œåœ°å€è½¬æ¢å™¨"><a href="#ç½‘ç»œåœ°å€è½¬æ¢å™¨" class="headerlink" title="ç½‘ç»œåœ°å€è½¬æ¢å™¨"></a>ç½‘ç»œåœ°å€è½¬æ¢å™¨</h3>ä¸ºäº†è§£å†³IPv4åœ°å€è€—å°½çš„é—®é¢˜ï¼Œæä¾›äº†ä¸´æ—¶æ€§æ–¹æ¡ˆ â€”â€” IPç½‘ç»œåœ°å€è½¬æ¢å™¨ï¼ˆNATï¼‰<br>IPç½‘ç»œåœ°å€è½¬æ¢å™¨ï¼šNATè®¾å¤‡ç»´æŠ¤ä¸€ä¸ªè¡¨ï¼Œè¡¨ç»´æŠ¤äº†ä¸€å¼ æœ¬åœ°IPåˆ°å¤–ç½‘IPçš„æ˜ å°„è¡¨ï¼Œè¿™æ ·IPå°±å¯ä»¥å®ç°ä¸åŒç½‘ç»œä¸­çš„æ˜ å°„ï¼Œä»è€Œè¾¾åˆ°æ˜ å°„ï¼Œç”¨äºè§£å†³ç½‘ç»œä¸å¤Ÿç”¨çš„é—®é¢˜<h3 id="NATç©¿é€"><a href="#NATç©¿é€" class="headerlink" title="NATç©¿é€"></a>NATç©¿é€</h3></li>
</ul>
<h4 id="NATè®¾å¤‡å¸¦æ¥çš„é—®é¢˜ï¼š"><a href="#NATè®¾å¤‡å¸¦æ¥çš„é—®é¢˜ï¼š" class="headerlink" title="NATè®¾å¤‡å¸¦æ¥çš„é—®é¢˜ï¼š"></a>NATè®¾å¤‡å¸¦æ¥çš„é—®é¢˜ï¼š</h4><ul>
<li>å†…éƒ¨å®¢æˆ·ç«¯ä¸çŸ¥é“å¤–ç½‘ IP åœ°å€ï¼ŒåªçŸ¥é“å†…ç½‘ IP åœ°å€ã€‚NAT è´Ÿè´£é‡å†™æ¯ä¸ª UDP åˆ†ç»„ä¸­çš„æºç«¯å£ã€åœ°å€ï¼Œä»¥åŠ IP åˆ†ç»„ä¸­çš„æº IP åœ°å€ã€‚ å¦‚æœå®¢æˆ·ç«¯åœ¨åº”ç”¨æ•°æ®ä¸­ä»¥å…¶å†…ç½‘ IP åœ°å€ä¸å¤–ç½‘ä¸»æœºé€šä¿¡ï¼Œè¿æ¥å¿…ç„¶å¤±è´¥</li>
<li>ä»»ä½•åˆ°è¾¾ NAT è®¾å¤‡å¤–ç½‘ IP çš„åˆ†ç»„è¿˜å¿…é¡»æœ‰ä¸€ä¸ªç›®æ ‡ç«¯å£ï¼Œè€Œä¸” NAT è½¬æ¢è¡¨ä¸­ä¹Ÿè¦æœ‰ä¸€ä¸ªæ¡ç›®å¯ä»¥å°†å…¶è½¬æ¢ä¸ºå†…éƒ¨ä¸»æœºçš„ IP åœ°å€å’Œç«¯å£å·ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªæ¡ç›®(é€šå¸¸æ˜¯ä»å¤–ç½‘ä¼ æ•°æ®è¿›æ¥)ï¼Œé‚£åˆ°è¾¾çš„åˆ†ç»„å°±ä¼šè¢«åˆ é™¤ã€‚æ­¤æ—¶çš„ NAT è®¾å¤‡å°±åƒä¸€ä¸ªåˆ†ç»„è¿‡æ»¤å™¨ï¼Œé™¤éç”¨æˆ·é€šè¿‡ç«¯å£ è½¬å‘(æ˜ å°„)æˆ–ç±»ä¼¼æœºåˆ¶é…ç½®è¿‡ï¼Œå¦åˆ™å®ƒæ— æ³•ç¡®å®šå°†åˆ†ç»„å‘é€ç»™å“ªå°å†…éƒ¨ä¸»æœº</li>
</ul>
<h4 id="STUN-Session-Traversal-Utilities-for-NAT"><a href="#STUN-Session-Traversal-Utilities-for-NAT" class="headerlink" title="STUN(Session Traversal Utilities for NAT)"></a>STUN(Session Traversal Utilities for NAT)</h4><ul>
<li>STUNåè®®(RFC 5389)ï¼šå¯ä»¥è®©åº”ç”¨ç¨‹åºå‘ç°ç½‘ç»œä¸­çš„åœ°å€è½¬æ¢å™¨ï¼Œå‘ç°ä¹‹åè¿›ä¸€æ­¥å–å¾—ä¸ºå½“å‰è¿æ¥åˆ†é…çš„å¤–ç½‘ IP åœ°å€å’Œç«¯å£(å›¾ 3-5)ã€‚ä¸ºæ­¤ï¼Œè¿™ä¸ªåè®®éœ€è¦ä¸€ä¸ªå·²çŸ¥çš„ç¬¬ä¸‰æ–¹ STUN æœåŠ¡å™¨æ”¯æŒï¼Œè¯¥æœåŠ¡å™¨å¿…é¡»æ¶è®¾åœ¨å…¬ç½‘ä¸Šã€‚</li>
<li>åº”ç”¨ç¨‹åºé¦–å…ˆå‘STUNæœåŠ¡å™¨å‘é€ä¸€ä¸ªç»‘å®šè¯·æ±‚ï¼Œç„¶åSTUNä¼šè¿”å›ä¸€ä¸ªå“åº”åŒ…å«å®¢æˆ·ç«¯åœ¨å¤–ç½‘çš„IPåœ°å€+ç«¯å£</li>
<li>soï¼š<ul>
<li>åº”ç”¨ç¨‹åºå¯ä»¥è·å¾—å¤–ç½‘ IP å’Œç«¯å£ï¼Œå¹¶åˆ©ç”¨è¿™äº›ä¿¡æ¯ä¸å¯¹ç«¯é€šä¿¡; </li>
<li>å‘é€åˆ° STUN æœåŠ¡å™¨çš„å‡ºç«™ç»‘å®šè¯·æ±‚å°†åœ¨é€šä¿¡è¦ç»è¿‡çš„ NAT ä¸­å»ºç«‹è·¯ç”±æ¡ç›®ï¼Œ ä½¿å¾—åˆ°è¾¾è¯¥ IP å’Œç«¯å£çš„å…¥ç«™åˆ†ç»„å¯ä»¥æ‰¾åˆ°å†…ç½‘ä¸­çš„åº”ç”¨ç¨‹åº;</li>
<li>STUN åè®®å®šä¹‰äº†ä¸€ä¸ªç®€å• keep-alive æ¢æµ‹æœºåˆ¶ï¼Œå¯ä»¥ä¿è¯ NAT è·¯ç”±æ¡ç›®ä¸è¶…æ—¶ã€‚</li>
</ul>
</li>
</ul>
<p>ä¸¤å°ä¸»æœºç«¯éœ€è¦é€šè¿‡ UDP é€šä¿¡æ—¶ï¼Œå®ƒä»¬é¦–å…ˆéƒ½ä¼šå‘å„è‡ªçš„ STUN æœåŠ¡å™¨å‘é€ç»‘å®šè¯·æ±‚ï¼Œç„¶ååˆ†åˆ«ä½¿ç”¨å“åº”ä¸­çš„å¤–ç½‘ IP åœ°å€å’Œç«¯å£å·äº¤æ¢æ•°æ®ã€‚<br>ã€ä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒSTUN å¹¶ä¸èƒ½é€‚åº”æ‰€æœ‰ç±»å‹çš„ NAT å’Œç½‘ç»œé…ç½®ã€‚ä¸ä»…å¦‚æ­¤ï¼ŒæŸäº› æƒ…å†µä¸‹ UDP è¿˜ä¼šè¢«é˜²ç«å¢™æˆ–å…¶ä»–ç½‘ç»œè®¾å¤‡å®Œå…¨å±è”½æ‰€ä»¥è¦è€ƒè™‘ä½¿ç”¨TURNã€‘</p>
<h4 id="TURN-Traversal-Using-Relays-around-NAT"><a href="#TURN-Traversal-Using-Relays-around-NAT" class="headerlink" title="TURN(Traversal Using Relays around NAT)"></a>TURN(Traversal Using Relays around NAT)</h4><ul>
<li>TURN(Traversal Using Relays around NAT)åè®®(RFC 5766)ï¼šTURN ä¸­çš„å…³é”®è¯å½“ç„¶æ˜¯ä¸­ç»§(relay)ã€‚è¿™ä¸ªåè®®ä¾èµ–äºå¤–ç½‘ä¸­ç»§è®¾å¤‡(å›¾ 3-6)åœ¨ ä¸¤ç«¯é—´ä¼ é€’æ•°æ®</li>
<li>ä¸¤ç«¯éƒ½è¦å‘åŒä¸€å° TURN æœåŠ¡å™¨å‘é€åˆ†é…è¯·æ±‚æ¥å»ºç«‹è¿æ¥ï¼Œç„¶åå†è¿›è¡Œæƒé™åå•†ã€‚åå•†å®Œæ¯•ï¼Œä¸¤ç«¯éƒ½æŠŠæ•°æ®å‘é€åˆ° TURN æœåŠ¡å™¨ï¼Œå†ç”± TURN æœåŠ¡å™¨è½¬å‘ï¼Œä»è€Œå®ç°é€šä¿¡</li>
<li>soï¼š<ul>
<li>è¿™æ ·å·²ç»ä¸å†æ˜¯ç«¯å¯¹ç«¯çš„æ•°æ®è¾ƒäº¤æ¢</li>
<li>è¿ç»´TURNæœåŠ¡å™¨çš„æŠ•å…¥å¾ˆå¤§</li>
<li>ä¸­ç»§è®¾å¤‡å®¹é‡å¿…é¡»è¶³å¤Ÿå¤§</li>
</ul>
</li>
</ul>
<p>å®é™…åº”ç”¨ä¸­ï¼Œæœ€å¥½åœ¨å…¶ä»–ç›´è¿æ‰‹æ®µéƒ½å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œå†ä½¿ç”¨ TURNã€‚</p>
<h4 id="ICE-Interactive-Connectivity-Establishment"><a href="#ICE-Interactive-Connectivity-Establishment" class="headerlink" title="ICE(Interactive Connectivity Establishment)"></a>ICE(Interactive Connectivity Establishment)</h4><ul>
<li>ICE(Interactive Connectivity Establishment)åè®®(RFC 5245)ï¼šè‡´åŠ›åœ¨é€šä¿¡å„ç«¯ä¹‹é—´å»ºç«‹ä¸€æ¡æœ€æœ‰æ•ˆçš„é€šé“(å›¾ 3-7):èƒ½ç›´è¿å°±ç›´è¿ï¼Œå¿…è¦æ—¶ STUN åå•†ï¼Œå†ä¸è¡Œä½¿ç”¨ TURN</li>
</ul>
<h3 id="UDPä¼˜åŒ–å»ºè®®"><a href="#UDPä¼˜åŒ–å»ºè®®" class="headerlink" title="UDPä¼˜åŒ–å»ºè®®"></a>UDPä¼˜åŒ–å»ºè®®</h3><ul>
<li>åº”ç”¨ç¨‹åºå¿…é¡»å®¹å¿å„ç§å› ç‰¹ç½‘è·¯å¾„æ¡ä»¶;</li>
<li>åº”ç”¨ç¨‹åºåº”è¯¥æ§åˆ¶ä¼ è¾“é€Ÿåº¦;</li>
<li>åº”ç”¨ç¨‹åºåº”è¯¥å¯¹æ‰€æœ‰æµé‡è¿›è¡Œæ‹¥å¡æ§åˆ¶;</li>
<li>åº”ç”¨ç¨‹åºåº”è¯¥ä½¿ç”¨ä¸ TCP ç›¸è¿‘çš„å¸¦å®½;</li>
<li>åº”ç”¨ç¨‹åºåº”è¯¥å‡†å¤‡åŸºäºä¸¢åŒ…çš„é‡å‘è®¡æ•°å™¨;</li>
<li>åº”ç”¨ç¨‹åºåº”è¯¥ä¸å‘é€å¤§äºè·¯å¾„ MTU çš„æ•°æ®æŠ¥;</li>
<li>åº”ç”¨ç¨‹åºåº”è¯¥å¤„ç†æ•°æ®æŠ¥ä¸¢å¤±ã€é‡å¤å’Œé‡æ’;</li>
<li>åº”ç”¨ç¨‹åºåº”è¯¥è¶³å¤Ÿç¨³å®šä»¥æ”¯æŒ 2 åˆ†é’Ÿä»¥ä¸Šçš„äº¤ä»˜å»¶è¿Ÿ;</li>
<li>åº”ç”¨ç¨‹åºåº”è¯¥æ”¯æŒ IPv4 UDP æ ¡éªŒå’Œï¼Œå¿…é¡»æ”¯æŒ IPv6 æ ¡éªŒå’Œ;</li>
<li>åº”ç”¨ç¨‹åºå¯ä»¥åœ¨éœ€è¦æ—¶ä½¿ç”¨ keep-alive(æœ€å°é—´éš” 15 ç§’)ã€‚</li>
</ul>
<p><strong>æˆ‘å¾ˆé«˜å…´å‘Šè¯‰å¤§å®¶:WebRTC å°±æ˜¯ç¬¦åˆè¿™äº›è¦æ±‚çš„æ¡†æ¶!</strong><br>ï¼ˆåé¢æœ‰æœºä¼šï¼Œå¯ä»¥ç ”ç©¶ä¸‹ï¼Œå†å†™æ–‡ç« ï¼‰</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç›®å½•&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;ç¬¬ä¸€éƒ¨åˆ† ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç¬¬ä¸‰ç«  UDPæ„æˆ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;â€‹&lt;/p&gt;
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="http://alfredzhenyu.github.io/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="ç½‘ç»œ" scheme="http://alfredzhenyu.github.io/tags/%E7%BD%91%E7%BB%9C/"/>
    
      <category term="TCP" scheme="http://alfredzhenyu.github.io/tags/TCP/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°(ä¸€)</title>
    <link href="http://alfredzhenyu.github.io/2016/12/23/%E3%80%8AWeb%E6%80%A7%E8%83%BD%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://alfredzhenyu.github.io/2016/12/23/ã€ŠWebæ€§èƒ½æƒå¨æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆä¸€ï¼‰/</id>
    <published>2016-12-23T05:03:13.000Z</published>
    <updated>2017-02-05T03:20:31.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç›®å½•ï¼š</p>
<ul>
<li>ç¬¬ä¸€éƒ¨åˆ† ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ<ul>
<li>ç¬¬ä¸€ç«  å»¶è¿Ÿä¸å¸¦å®½</li>
<li>ç¬¬äºŒç«  TCPçš„æ„æˆ</li>
</ul>
</li>
</ul>
<a id="more"></a>
<h1 id="ç¬¬ä¸€éƒ¨åˆ†-ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ"><a href="#ç¬¬ä¸€éƒ¨åˆ†-ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ† ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ"></a>ç¬¬ä¸€éƒ¨åˆ† ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ</h1><h2 id="ç¬¬ä¸€ç« -å»¶è¿Ÿä¸å¸¦å®½"><a href="#ç¬¬ä¸€ç« -å»¶è¿Ÿä¸å¸¦å®½" class="headerlink" title="ç¬¬ä¸€ç«  å»¶è¿Ÿä¸å¸¦å®½"></a>ç¬¬ä¸€ç«  å»¶è¿Ÿä¸å¸¦å®½</h2><ol>
<li>å¯¹ç½‘ç»œé€šä¿¡é€šä¿¡éƒ¨åˆ†èµ·å†³å®šæ€§å› ç´ çš„æœ‰ä¸¤æ–¹é¢ï¼š<ul>
<li>å»¶è¿Ÿï¼šåˆ†ç»„ä»ä¿¡æ¯æºåˆ°è¾¾ç›®çš„åœ°æ‰€éœ€çš„æ—¶é—´</li>
<li>å¸¦å®½ï¼šé€»è¾‘æˆ–ç‰©ç†é€šä¿¡æœ€å¤§ååé‡</li>
</ul>
</li>
<li>å»¶è¿Ÿçš„æ„æˆ<ul>
<li>ä¼ æ’­å»¶è¿Ÿï¼šæ¶ˆæ¯ä»å‘é€ç«¯åˆ°æ¥æ”¶ç«¯éœ€è¦çš„æ—¶é—´ï¼Œæ˜¯ä¿¡å·ä¼ æ’­è·ç¦»å’Œé€Ÿåº¦çš„å‡½æ•°</li>
<li>ä¼ è¾“å»¶è¿Ÿï¼šæŠŠæ¶ˆæ¯ä¸­çš„æ‰€æœ‰æ¯”ç‰¹è½¬ç§»åˆ°é“¾è·¯ä¸­éœ€è¦çš„æ—¶é—´ï¼Œæ˜¯æ¶ˆæ¯é•¿åº¦å’Œé“¾è·¯é€Ÿç‡çš„å‡½æ•°</li>
<li>å¤„ç†å»¶è¿Ÿï¼šå¤„ç†åˆ†ç»„é¦–éƒ¨ã€æ£€æŸ¥ä½é”™è¯¯åŠç¡®å®šåˆ†ç»„ç›®æ ‡æ‰€éœ€çš„æ—¶é—´</li>
<li>æ’é˜Ÿå»¶è¿Ÿï¼šåˆ°æ¥çš„åˆ†ç»„æ’é˜Ÿç­‰å¾…å¤„ç†çš„æ—¶é—´<br>å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„æ€»å»¶è¿Ÿæ—¶é—´ä¸ºä»¥ä¸Šå»¶è¿Ÿæ—¶é—´çš„æ€»å’Œ</li>
</ul>
</li>
<li>å¤§å¤šæ•°ç½‘ç«™æ€§èƒ½çš„ç“¶é¢ˆéƒ½æ˜¯å»¶è¿Ÿï¼Œè€Œä¸æ˜¯å¸¦å®½</li>
<li>ç›®æ ‡ï¼šé«˜å¸¦å®½+ä½å»¶è¿Ÿ</li>
</ol>
<p>å»¶è¿Ÿå¯¹ç”¨æˆ·ä½“éªŒçš„å½±å“:<br><img src="å»¶æ—¶ä¸ç”¨æˆ·ä½“éªŒ.png" alt=""></p>
<h2 id="ç¬¬äºŒç« -TCPçš„æ„æˆ"><a href="#ç¬¬äºŒç« -TCPçš„æ„æˆ" class="headerlink" title="ç¬¬äºŒç«  TCPçš„æ„æˆ"></a>ç¬¬äºŒç«  TCPçš„æ„æˆ</h2><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>å› ç‰¹ç½‘ä¸¤ä¸ªæ ¸å¿ƒåè®®ï¼š</p>
<ul>
<li><strong>TCP</strong>ï¼š Transmission Control Protocol â€”â€”â€” RFC 791 </li>
<li><strong>IP</strong>ï¼š Internet Protocol â€”â€”â€” RFC 793<br>ã€HTTPæ ‡å‡†å¹¶æœªè§„å®šTCPå°±æ˜¯å”¯ä¸€çš„ä¼ è¾“åè®®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡UDPæˆ–è€…å…¶ä»–åè®®æ¥å‘é€HTTPæ¶ˆæ¯ã€‘</li>
</ul>
<h3 id="æ¡æ‰‹"><a href="#æ¡æ‰‹" class="headerlink" title="æ¡æ‰‹"></a>æ¡æ‰‹</h3><p><strong>ä¸‰æ¬¡æ¡æ‰‹</strong>ï¼šä¸‰æ¬¡æ¡æ‰‹çš„ç»†èŠ‚å°±ä¸è®²äº†ï¼Œè¿™é‡Œä¸»è¦æƒ³è¯´çš„æ˜¯å…¶å¸¦æ¥çš„å»¶è¿Ÿï¼Œä½¿å¾—æ¯åˆ›å»ºä¸€ä¸ªæ–° TCP è¿æ¥éƒ½è¦ä»˜å‡ºå¾ˆå¤§ä»£ä»·ã€‚è€Œæé«˜TCPæ€§èƒ½çš„å…³é”®ï¼Œåœ¨äºæƒ³åŠæ³•é‡ç”¨è¿æ¥ï¼š<br><strong>TCP å¿«é€Ÿæ‰“å¼€ï¼ˆTCP Fast Open TFOï¼‰</strong>ï¼šç”±äºéå¸¸çŸ­çš„ TCP è¿æ¥åœ¨ äº’è”ç½‘ä¸Šéšå¤„å¯è§ï¼Œæ¡æ‰‹é˜¶æ®µå·²ç»æˆä¸ºå½±å“ç½‘ç»œæ€»å»¶è¿Ÿçš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚ä¸ºè§£å†³ è¿™ä¸ªé—®é¢˜ï¼Œäººä»¬æ­£åœ¨ç§¯æå¯»æ‰¾å„ç§æ–¹æ¡ˆï¼Œå…¶ä¸­ TFO(TCP Fast Openï¼ŒTCP å¿«é€Ÿæ‰“ å¼€)å°±æ˜¯è¿™æ ·ä¸€ç§æœºåˆ¶  </p>
<blockquote>
<p>Linux 3.7 åŠä¹‹åçš„å†…æ ¸å·²ç»åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸­æ”¯æŒ TFOï¼Œå› æ­¤æˆä¸ºäº†å®¢æˆ·ç«¯å’Œ æœåŠ¡å™¨æ“ä½œç³»ç»Ÿé€‰å‹çš„æœ‰åŠ›å€™é€‰æ–¹æ¡ˆã€‚å³ä¾¿å¦‚æ­¤ï¼ŒTFO å¹¶ä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜ã€‚ å®ƒè™½ç„¶æœ‰åŠ©äºå‡å°‘ä¸‰æ¬¡æ¡æ‰‹çš„å¾€è¿”æ—¶é—´ï¼Œä½†å´åªèƒ½åœ¨æŸäº›æƒ…å†µä¸‹æœ‰æ•ˆ</p>
</blockquote>
<h4 id="TODO-TFOæ€ä¹ˆå®ç°æ¡æ‰‹ä¼˜åŒ–çš„â€¦"><a href="#TODO-TFOæ€ä¹ˆå®ç°æ¡æ‰‹ä¼˜åŒ–çš„â€¦" class="headerlink" title="TODO:TFOæ€ä¹ˆå®ç°æ¡æ‰‹ä¼˜åŒ–çš„â€¦"></a>TODO:TFOæ€ä¹ˆå®ç°æ¡æ‰‹ä¼˜åŒ–çš„â€¦</h4><h3 id="æ‹¥å¡é¢„é˜²åŠæ§åˆ¶ï¼š"><a href="#æ‹¥å¡é¢„é˜²åŠæ§åˆ¶ï¼š" class="headerlink" title="æ‹¥å¡é¢„é˜²åŠæ§åˆ¶ï¼š"></a>æ‹¥å¡é¢„é˜²åŠæ§åˆ¶ï¼š</h3><ul>
<li>æµé‡æ§åˆ¶</li>
<li>æ‹¥å¡æ§åˆ¶</li>
<li>æ‹¥å¡é¢„é˜²æœºåˆ¶</li>
</ul>
<h3 id="æµé‡æ§åˆ¶ï¼š"><a href="#æµé‡æ§åˆ¶ï¼š" class="headerlink" title="æµé‡æ§åˆ¶ï¼š"></a>æµé‡æ§åˆ¶ï¼š</h3><ul>
<li><strong>æ¥æ”¶çª—å£ï¼ˆrwndï¼‰</strong>ï¼šæ¯ä¸€æ–¹éƒ½è¦é€šå‘Šè‡ªå·±çš„æ¥æ”¶çª—å£ï¼ˆrwndï¼‰ï¼Œå…¶ä¸­åŒ…å«èƒ½å¤Ÿä¿å­˜æ•°æ®çš„ç¼“å†²åŒºå¤§å°ä¿¡æ¯ã€‚æ¯æ¬¡å‘é€çš„æ•°æ®éƒ½ä¸ä¼šå¤§äºè¿™ä¸ªçª—å£å€¼ã€‚å¦‚æœå…¶ä¸­ä¸€ç«¯ï¼ˆä¸€èˆ¬ä¸ºæ¥æ”¶ç«¯ï¼‰çš„ç¼“å†²åŒºè·Ÿä¸ä¸Šæ•°æ®ä¼ è¾“ï¼Œé‚£å®ƒä¼šå‘å‘é€ç«¯é€šå‘Šä¸€ä¸ªè¾ƒå°çš„çª—å£ï¼Œæ¥å‡å°‘æ¯æ¬¡åˆ†ç»„å‘é€çš„æ•°æ®ã€‚ å‡å¦‚çª—å£ä¸ºé›¶ï¼Œåˆ™æ„å‘³ç€å¿…é¡»ç”±åº”ç”¨å±‚å…ˆæ¸…ç©ºç¼“å†²åŒºï¼Œæ‰èƒ½å†æ¥æ”¶å‰©ä½™æ•°æ®</li>
<li><strong>çª—å£ç¼©æ”¾(RFC 1323)</strong>ï¼šæœ€åˆçš„TCPè§„èŒƒåˆ†é…ç»™é€šå‘Šçª—å£å¤§å°çš„å­—æ®µæ˜¯ 16ä½çš„,æœ€å¤§å€¼(65535å­—èŠ‚)ã€‚ç»“æœåœ¨è¿™ä¸ªé™åˆ¶å†…ç»å¸¸æ— æ³•è·å¾—æœ€ä¼˜æ€§èƒ½ï¼Œä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRFC 1323æä¾›äº†â€œTCP çª—å£ç¼©æ”¾â€(TCP Window Scaling)é€‰é¡¹ï¼Œ å¯ä»¥æŠŠæ¥æ”¶çª—å£å¤§å°ç”± 65 535 å­—èŠ‚æé«˜åˆ° 1G å­—èŠ‚ï¼Œç¼©æ”¾ TCP çª—å£æ˜¯åœ¨ä¸‰æ¬¡æ¡æ‰‹æœŸ é—´å®Œæˆçš„ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå€¼è¡¨ç¤ºåœ¨å°†æ¥çš„ ACK ä¸­å·¦ç§» 16 ä½çª—å£å­—æ®µçš„ä½æ•°ã€‚</li>
</ul>
<blockquote>
<p>ç°åœ¨ TCP çª—å£ç¼©æ”¾æœºåˆ¶åœ¨æ‰€æœ‰ä¸»è¦å¹³å°ä¸Šéƒ½æ˜¯é»˜è®¤å¯ç”¨çš„ã€‚ä¸è¿‡ï¼Œä¸­é—´èŠ‚ç‚¹å’Œ è·¯ç”±å™¨å¯ä»¥é‡å†™ï¼Œç”šè‡³å®Œå…¨å»æ‰è¿™ä¸ªé€‰é¡¹ã€‚å¦‚æœä½ çš„æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯çš„è¿æ¥ä¸èƒ½ å®Œå…¨åˆ©ç”¨ç°æœ‰å¸¦å®½ï¼Œé‚£å¾€å¾€è¯¥å…ˆæŸ¥ä¸€æŸ¥çª—å£å¤§å°ã€‚åœ¨ Linux ä¸­ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ ä»¤æ£€æŸ¥å’Œå¯ç”¨çª—å£ç¼©æ”¾é€‰é¡¹:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$&gt; sysctl net.ipv4.tcp_window_scaling</div><div class="line">$&gt; sysctl -w net.ipv4.tcp_window_scaling=1</div></pre></td></tr></table></figure>
</blockquote>
<h3 id="æ‹¥å¡çª—å£"><a href="#æ‹¥å¡çª—å£" class="headerlink" title="æ‹¥å¡çª—å£"></a>æ‹¥å¡çª—å£</h3><ul>
<li><strong>æ‹¥å¡çª—å£ï¼ˆcwndï¼‰</strong>ï¼šå‘é€ç«¯ä¼šåˆå§‹åŒ–ä¸€ä¸ªæ‹¥å¡çª—å£ï¼ˆcwndï¼‰ï¼Œä½†ä¸ä¼šé€šå‘Šç»™å¯¹æ–¹ã€‚æ¯æ¬¡å‘é€çš„æ•°æ®éƒ½æ˜¯cwndå’Œrwndçš„æœ€å°å€¼ã€‚</li>
<li><strong>æ…¢å¯åŠ¨</strong>ï¼šæ¯æ¬¡å»ºç«‹å®Œè¿æ¥ä¹‹åï¼Œé‡‡ç”¨é€æ­¥å¢å¤§æ‹¥å¡çª—å£å¤§å°çš„æ–¹å¼æ…¢æ…¢å¯åŠ¨ï¼Œæœ€åˆcwndä¸ºä¸€ä¸ªTCPæ®µï¼Œä¹‹åé‡‡ç”¨çš„æ˜¯â€æŒ‡æ•°å¢é•¿â€œçš„æ–¹å¼ï¼Œç›´åˆ°è¾¾åˆ°æ‹¥å¡é¢„é˜²æœºåˆ¶ç”Ÿæ•ˆä¸ºæ­¢ã€å› ä¸ºå¾ˆå¤šHTTPè¿æ¥éƒ½æ˜¯çŸ­æš‚çªå‘çš„è¿æ¥ï¼Œå¸¸å¸¸ä¼šå‡ºç°è¿˜æ²¡åˆ°è¾¾åˆ°æœ€å¤§é˜ˆå€¼å°±è¢«ç»ˆæ­¢çš„æƒ…å†µï¼Œå› ä¸ºæ…¢å¯åŠ¨ä¼šé™åˆ¶å¯ç”¨çš„ååé‡ï¼Œè€Œè¿™å¯¹äºå°æ–‡ä»¶ä¼ è¾“éå¸¸ä¸åˆ©ã€‚ã€‘</li>
</ul>
<blockquote>
<p>ç°åœ¨ç›®å‰å¤§å¤šæ•°æœåŠ¡å™¨ä¸­å¸¸è§çš„åˆå§‹æ‹¥å¡çª—å£ä¸ºï¼š4æ®µï¼ˆRFC 2581è§„å®šï¼‰ï¼Œä¸ºå‡å°‘æ…¢å¯åŠ¨çš„æ—¶é—´ï¼Œå¯ä»¥å°è¯•æŠŠåˆå§‹æ‹¥å¡çª—å£å¤§å°å¢åŠ åˆ°10æ®µï¼ˆRFC 9828è§„å®šï¼‰</p>
</blockquote>
<ul>
<li><strong>æ…¢å¯åŠ¨é‡å¯ï¼ˆSlow-Start Restart SSRï¼‰</strong>ï¼šè¿™ç§æœºåˆ¶ä¼šåœ¨è¿æ¥ç©ºé—²ä¸€å®šæ—¶é—´åé‡ç½®è¿æ¥çš„æ‹¥å¡çª—å£ã€‚é“ç†å¾ˆç®€å•ï¼Œ åœ¨è¿æ¥ç©ºé—²çš„åŒæ—¶ï¼Œç½‘ç»œçŠ¶å†µä¹Ÿå¯èƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸ºäº†é¿å…æ‹¥å¡ï¼Œç†åº”å°†æ‹¥å¡çª— å£é‡ç½®å›â€œå®‰å…¨çš„â€é»˜è®¤å€¼ã€‚</li>
</ul>
<blockquote>
<p>SSR å¯¹äºé‚£äº›ä¼šå‡ºç°çªå‘ç©ºé—²çš„é•¿å‘¨æœŸ TCP è¿æ¥(æ¯”å¦‚ HTTP çš„ keep-alive è¿æ¥)æœ‰å¾ˆå¤§çš„å½±å“ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å»ºè®®åœ¨æœåŠ¡å™¨ä¸Šç¦ç”¨ SSRã€‚åœ¨ Linux å¹³å°ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥æ£€æŸ¥å’Œç¦ç”¨ SSR:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$&gt; sysctl net.ipv4.tcp_slow_start_after_idle</div><div class="line">$&gt; sysctl -w net.ipv4.tcp_slow_start_after_idle=0</div></pre></td></tr></table></figure>
</blockquote>
<h3 id="æ‹¥å¡é¢„é˜²æœºåˆ¶"><a href="#æ‹¥å¡é¢„é˜²æœºåˆ¶" class="headerlink" title="æ‹¥å¡é¢„é˜²æœºåˆ¶"></a>æ‹¥å¡é¢„é˜²æœºåˆ¶</h3><ul>
<li><p><strong>æ‹¥å¡é˜ˆå€¼(ssthresh)çª—å£</strong>ï¼šæ…¢å¯åŠ¨ä»¥ä¿å®ˆçš„çª—å£åˆå§‹åŒ–è¿æ¥ï¼Œéšåçš„ æ¯æ¬¡å¾€è¿”éƒ½ä¼šæˆå€æé«˜ä¼ è¾“çš„æ•°æ®é‡ï¼Œç›´åˆ°è¶…è¿‡æ¥æ”¶ç«¯çš„æµé‡æ§åˆ¶çª—å£ï¼Œå³ç³»ç»Ÿ é…ç½®çš„æ‹¥å¡é˜ˆå€¼(ssthresh)çª—å£ï¼Œæˆ–è€…æœ‰åˆ†ç»„ä¸¢å¤±ä¸ºæ­¢ï¼Œæ­¤æ—¶æ‹¥å¡é¢„é˜²ç®—æ³•ä»‹å…¥</p>
<p>  &emsp; <strong>AIMD(Multiplicative Decrease and Additive Increaseï¼Œå€å‡åŠ å¢) ç®—æ³•</strong>ï¼šå³å‘ç”Ÿä¸¢åŒ…æ—¶ï¼Œå…ˆå°†æ‹¥å¡çª—å£å‡åŠï¼Œç„¶åæ¯æ¬¡å¾€è¿”å†ç¼“æ…¢åœ°ç»™çª—å£å¢åŠ ä¸€ ä¸ªå›ºå®šçš„å€¼ã€‚ä¸è¿‡ï¼Œå¾ˆå¤šæ—¶å€™ AIMD ç®—æ³•å¤ªè¿‡ä¿å®ˆï¼Œå› æ­¤åˆæœ‰äº†æ–°çš„ç®—æ³•ã€‚<br>  &emsp; <strong>PRR(Proportional Rate Reductionï¼Œæ¯”ä¾‹é™é€Ÿ)ç®—æ³•</strong>ï¼šå°±æ˜¯ RFC 6937 è§„å®šçš„ä¸€ä¸ªæ–°ç®—æ³•ï¼Œ å…¶ç›®æ ‡å°±æ˜¯æ”¹è¿›ä¸¢åŒ…åçš„æ¢å¤é€Ÿåº¦ã€‚æ”¹è¿›æ•ˆæœå¦‚ä½•å‘¢?æ ¹æ®è°·æ­Œçš„æµ‹é‡ï¼Œå®ç°æ–° ç®—æ³•åï¼Œå› ä¸¢åŒ…é€ æˆçš„å¹³å‡è¿æ¥å»¶è¿Ÿå‡å°‘äº† 3%~10%ã€‚</p>
<h4 id="TODO-PRRå¦‚ä½•æ”¹è¿›ä¸¢åŒ…çš„æ¢å¤é€Ÿåº¦çš„â€¦"><a href="#TODO-PRRå¦‚ä½•æ”¹è¿›ä¸¢åŒ…çš„æ¢å¤é€Ÿåº¦çš„â€¦" class="headerlink" title="TODO:PRRå¦‚ä½•æ”¹è¿›ä¸¢åŒ…çš„æ¢å¤é€Ÿåº¦çš„â€¦"></a>TODO:PRRå¦‚ä½•æ”¹è¿›ä¸¢åŒ…çš„æ¢å¤é€Ÿåº¦çš„â€¦</h4></li>
</ul>
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><ul>
<li><strong>å¸¦å®½å»¶è¿Ÿç§¯ï¼ˆBandwidth-delay productï¼ŒBDPï¼‰</strong>ï¼šä»»æ„æ—¶åˆ»å¤„äºåœ¨å‘é€é€”ä¸­è¿˜æœªæ”¶åˆ°ACKçŠ¶æ€çš„æœ€å¤§æ•°æ®é‡ = æ•°æ®é“¾è·¯çš„å®¹é‡ï¼ˆå¸¦å®½ï¼‰ *  ç«¯åˆ°ç«¯çš„å»¶è¿Ÿ</li>
<li><strong>é˜Ÿé¦–(HOLï¼ŒHead of Line)é˜»å¡</strong>ï¼šæ¯ä¸ªTCPåˆ†ç»„éƒ½ä¼šå¸¦ç€ä¸€ä¸ªå”¯ä¸€çš„åºåˆ—å·è¢«å‘ï¼Œè€Œå†å¯¹äºåº”ç”¨å±‚è€Œè¨€ï¼Œæ‰€æœ‰åˆ†ç»„å¿…é¡»æ˜¯æŒ‰é¡ºåºä¼ é€åˆ°æ¥æ”¶ç«¯ã€‚å¦‚æœTCPåœ¨æ¥æ”¶ä¸­ä¸­é€”æœ‰ä¸€ä¸ªåˆ†ç»„æ²¡èƒ½åˆ°è¾¾æ¥æ”¶ç«¯çš„ä¼ è¾“å±‚ï¼Œé‚£ä¹ˆåç»­åˆ†ç»„å¿…é¡»ä¿å­˜åœ¨æ¥æ”¶ç«¯çš„ TCP ç¼“å†²åŒºï¼Œç­‰å¾…ä¸¢å¤±çš„åˆ†ç»„é‡å‘å¹¶åˆ°è¾¾æ¥æ”¶ç«¯ï¼Œä¹‹åå†ä¸€èµ·æäº¤åˆ°åº”ç”¨å±‚ï¼Œè€Œåº”ç”¨å±‚åœ¨æ¥æ”¶ç«¯åªèƒ½æ„Ÿå—åˆ°è¿™ç§æ•´ä½“çš„å»¶è¿Ÿã€‚è¿™ç§æ•ˆåº”ç§°ä¸º TCP çš„é˜Ÿé¦–é˜»å¡</li>
<li><strong>æŠ–åŠ¨</strong>ï¼šç”±äºé˜Ÿé¦–é˜»å¡é€ æˆçš„å»¶è¿Ÿåˆ†ç»„é€ æˆç›¸åº”çš„é‡æ’å’Œé‡ç»„ï¼Œé€ æˆåˆ†ç»„åˆ°è¾¾å»¶è¿Ÿæ— æ³•é¢„çŸ¥ã€‚è¿™ä¸ªå»¶è¿Ÿæ—¶é—´çš„å˜åŒ–é€šå¸¸è¢«ç§°ä¸ºæŠ–åŠ¨ï¼Œä¹Ÿæ˜¯å½±å“åº”ç”¨ç¨‹åºæ€§èƒ½çš„ä¸€ä¸ªä¸»è¦å› ç´ <br>ã€æ— éœ€æŒ‰åºäº¤ä»˜æ•°æ®æˆ–èƒ½å¤Ÿå¤„ç†åˆ†ç»„ä¸¢å¤±çš„åº”ç”¨ç¨‹åºï¼Œä»¥åŠå¯¹å»¶è¿Ÿæˆ–æŠ–åŠ¨è¦æ±‚å¾ˆé«˜çš„åº”ç”¨ç¨‹åºï¼Œæœ€å¥½é€‰æ‹© UDP ç­‰åè®®ã€‚æ¯”å¦‚è¯­éŸ³å’Œæ¸¸æˆçŠ¶æ€é€šä¿¡ï¼š<br>&emsp; éŸ³é¢‘ç¼–è§£ç å™¨ï¼šå°±ç®—æœ‰ä¸ªåŒ…ä¸¢äº†ï¼Œåªè¦åœ¨éŸ³é¢‘ä¸­æ’å…¥ä¸€ä¸ªå°å°çš„é—´æ­‡ï¼Œå°±å¯ä»¥ç»§ç»­ å¤„ç†åæ¥çš„åŒ…ã€‚åªè¦é—´æ­‡å¤Ÿå°ï¼Œç”¨æˆ·å°±æ³¨æ„ä¸åˆ°ï¼Œè€Œç­‰å¾…ä¸¢å¤±çš„åŒ…åˆ™å¯èƒ½å¯¼è‡´éŸ³ é¢‘è¾“å‡ºäº§ç”Ÿæ— æ³•é¢„æ–™çš„æš‚åœã€‚ç›¸å¯¹æ¥è¯´ï¼Œåè€…çš„ç”¨æˆ·ä½“éªŒæ›´ç³Ÿç³•ã€‚&emsp; 3D æ¸¸æˆä¸­è§’è‰²æ›´æ–°çŠ¶æ€ä¹Ÿä¸€æ ·:æ”¶åˆ° T æ—¶åˆ»çš„åŒ…è€Œç­‰å¾… T-1 æ—¶åˆ»çš„ åŒ…é€šå¸¸æ¯«æ— å¿…è¦ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåº”è¯¥å¯ä»¥æ¥æ”¶æ‰€æœ‰çŠ¶æ€æ›´æ–°ï¼Œä½†ä¸ºé¿å…æ¸¸æˆå»¶è¿Ÿï¼Œ é—´æ­‡æ€§çš„ä¸¢åŒ…ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚ã€‘</li>
</ul>
<h3 id="TCPä¼˜åŒ–å»ºè®®ï¼š"><a href="#TCPä¼˜åŒ–å»ºè®®ï¼š" class="headerlink" title="TCPä¼˜åŒ–å»ºè®®ï¼š"></a>TCPä¼˜åŒ–å»ºè®®ï¼š</h3><ol>
<li>æœåŠ¡å™¨ä¼˜åŒ–ï¼š<ul>
<li>æ›´æ–°ç½®æœ€æ–°çš„å†…æ ¸</li>
<li>å¢å¤§TCPåˆå§‹æ‹¥å¡çª—å£</li>
<li>ç¦ç”¨æ…¢å¯åŠ¨é‡å¯</li>
<li>å¯ç”¨çª—å£ç¼©æ”¾</li>
<li>æ‰“å¼€TCPå¿«é€Ÿæ‰“å¼€</li>
</ul>
</li>
<li>åº”ç”¨ç¨‹åºè°ƒä¼˜<ul>
<li>é‡ç”¨å·²ç»å»ºç«‹çš„ TCP è¿æ¥</li>
<li>å‡å°‘ä¸‹è½½ä¸å¿…è¦çš„èµ„æº</li>
<li>é€šè¿‡å‹ç¼©ç®—æ³•æŠŠè¦å‘é€çš„æ¯”ç‰¹æ•°é™åˆ°æœ€ä½</li>
<li>åœ¨ä¸åŒçš„åœ°åŒºéƒ¨ç½²æœåŠ¡ å™¨(æ¯”å¦‚ï¼Œä½¿ç”¨ CDN)ï¼ŒæŠŠæ•°æ®æ”¾åˆ°æ¥è¿‘å®¢æˆ·ç«¯çš„åœ°æ–¹</li>
</ul>
</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç›®å½•ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç¬¬ä¸€éƒ¨åˆ† ç½‘ç»œæŠ€æœ¯æ¦‚è§ˆ&lt;ul&gt;
&lt;li&gt;ç¬¬ä¸€ç«  å»¶è¿Ÿä¸å¸¦å®½&lt;/li&gt;
&lt;li&gt;ç¬¬äºŒç«  TCPçš„æ„æˆ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="http://alfredzhenyu.github.io/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="ç½‘ç»œ" scheme="http://alfredzhenyu.github.io/tags/%E7%BD%91%E7%BB%9C/"/>
    
      <category term="TCP" scheme="http://alfredzhenyu.github.io/tags/TCP/"/>
    
  </entry>
  
  <entry>
    <title>èµ„æºç›®å½•æ•´ç†</title>
    <link href="http://alfredzhenyu.github.io/2016/12/22/%E8%B5%84%E6%BA%90%E7%9B%AE%E5%BD%95%E6%95%B4%E7%90%86/"/>
    <id>http://alfredzhenyu.github.io/2016/12/22/èµ„æºç›®å½•æ•´ç†/</id>
    <published>2016-12-22T06:22:40.000Z</published>
    <updated>2017-03-15T07:07:54.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¹³æ—¶æ¯å¤©éƒ½ä¼šæ‰“å¼€å‡ åä¸ªç½‘ç«™æ²¡æ—¶é—´ä¸€ä¸€æ¶ˆåŒ–ï¼Œå°±ä¸€ç›´æ™¾ç€è¶Šç§¯è¶Šå¤šï¼Œæ”¶è—å¤¹ä¹Ÿå¤ªå¤šï¼Œä¸€èˆ¬å¡è¿›å»å°±ä¸ä¼šç¿»å‡ºæ¥çœ‹ï¼Œæ‰€ä»¥ç®¡ç†èµ·æ¥ä¹Ÿæ˜¯éº»çƒ¦â€¦<br>æœ¬ç¯‡å°±ä¼šæŠŠä¹‹å‰è‡ªå·±æ¶‰åŠçš„é¢†åŸŸä½¿ç”¨åˆ°çš„æœ‰ç”¨çš„å­¦ä¹ ç½‘ç«™æ±‡æ€»èµ·æ¥ï¼Œåˆ†äº«ç»™å¤§å®¶ï¼Œä¹Ÿæ–¹ä¾¿è‡ªå·±çš„å­¦ä¹ ç®¡ç†ï¼š</p>
<a id="more"></a>
<h2 id="åè®®ã€ç½‘ç»œç›¸å…³"><a href="#åè®®ã€ç½‘ç»œç›¸å…³" class="headerlink" title="åè®®ã€ç½‘ç»œç›¸å…³"></a>åè®®ã€ç½‘ç»œç›¸å…³</h2><h3 id="å­¦ä¹ ç½‘ç«™"><a href="#å­¦ä¹ ç½‘ç«™" class="headerlink" title="å­¦ä¹ ç½‘ç«™"></a>å­¦ä¹ ç½‘ç«™</h3><ol>
<li><p><a href="http://www.iprotocolsec.com/category/protocol-analyze/" target="_blank" rel="external">åè®®åˆ†æã€ç½‘ç»œå®‰å…¨</a></p>
<p>â€‹</p>
</li>
</ol>
<h3 id="ä¼˜ç§€åšå®¢"><a href="#ä¼˜ç§€åšå®¢" class="headerlink" title="ä¼˜ç§€åšå®¢"></a>ä¼˜ç§€åšå®¢</h3><h2 id="OpenGLç›¸å…³"><a href="#OpenGLç›¸å…³" class="headerlink" title="OpenGLç›¸å…³"></a>OpenGLç›¸å…³</h2><h3 id="å­¦ä¹ ç½‘ç«™-1"><a href="#å­¦ä¹ ç½‘ç«™-1" class="headerlink" title="å­¦ä¹ ç½‘ç«™"></a>å­¦ä¹ ç½‘ç«™</h3><ol>
<li><p><a href="https://www.zhihu.com/question/29163054" target="_blank" rel="external">é€šä¿—è¯­è¨€è§£é‡ŠOpenGLä¸­ç€è‰²å™¨ï¼Œæ¸²æŸ“ç®¡çº¿ï¼Œå…‰æ …åŒ–</a></p>
<p>â€‹</p>
</li>
</ol>
<h3 id="ä¼˜ç§€åšå®¢-1"><a href="#ä¼˜ç§€åšå®¢-1" class="headerlink" title="ä¼˜ç§€åšå®¢"></a>ä¼˜ç§€åšå®¢</h3><h2 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h2><h3 id="å­¦ä¹ ç½‘ç«™-2"><a href="#å­¦ä¹ ç½‘ç«™-2" class="headerlink" title="å­¦ä¹ ç½‘ç«™"></a>å­¦ä¹ ç½‘ç«™</h3><ol>
<li><a href="https://opensource.apple.com" target="_blank" rel="external">Apple Open Source</a></li>
<li><a href="https://developer.apple.com/reference/corefoundation?language=objc" target="_blank" rel="external">Core Foundation API</a></li>
<li><a href="http://nshipster.com/" target="_blank" rel="external">å…³äºOCçš„æ¯å‘¨æ›´æ–°çš„å¤–æ–‡å¯¼èˆªç½‘ç«™</a></li>
<li><a href="http://zh-google-styleguide.readthedocs.io/en/latest/google-objc-styleguide/contents/" target="_blank" rel="external">google Objective-Cå¼€æºé¡¹ç›®é£æ ¼æŒ‡å—</a></li>
<li><a href="http://zh-google-styleguide.readthedocs.io/en/latest/google-cpp-styleguide/headers/" target="_blank" rel="external">google C++å¼€æºé¡¹ç›®é£æ ¼æŒ‡å—</a></li>
<li><a href="https://developer.apple.com/reference?changes=latest_minor&amp;language=objc" target="_blank" rel="external">iOS API Reference</a></li>
</ol>
<h3 id="ä¼˜ç§€åšå®¢-2"><a href="#ä¼˜ç§€åšå®¢-2" class="headerlink" title="ä¼˜ç§€åšå®¢"></a>ä¼˜ç§€åšå®¢</h3><ol>
<li><a href="http://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="external">RunLoopè§£æ(YYKitä½œè€…çš„blog)</a></li>
<li><a href="https://github.com/Draveness/iOS-Source-Code-Analyze" target="_blank" rel="external">iOSå¼€æºä»£ç è§£æ</a></li>
<li><a href="http://ciechanowski.me/blog/archives/" target="_blank" rel="external">NSArrayã€NSDictionaryåº•å±‚å®ç°</a></li>
<li><a href="http://tech.glowing.com/cn/" target="_blank" rel="external">GlowæŠ€æœ¯åšå®¢</a></li>
<li><a href="http://www.cocoawithlove.com/2009/11/performance-tests-replacing-core-data.html" target="_blank" rel="external">Matt Gallagherâ€™s blog</a></li>
</ol>
<h2 id="å…¶ä»–å­¦ä¹ è¯­è¨€"><a href="#å…¶ä»–å­¦ä¹ è¯­è¨€" class="headerlink" title="å…¶ä»–å­¦ä¹ è¯­è¨€"></a>å…¶ä»–å­¦ä¹ è¯­è¨€</h2><h3 id="å­¦ä¹ ç½‘ç«™-3"><a href="#å­¦ä¹ ç½‘ç«™-3" class="headerlink" title="å­¦ä¹ ç½‘ç«™"></a>å­¦ä¹ ç½‘ç«™</h3><ol>
<li><p><a href="http://www.runoob.com/" target="_blank" rel="external">èœé¸Ÿå­¦ä¹ ç½‘ç«™</a></p>
<p>â€‹</p>
</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¹³æ—¶æ¯å¤©éƒ½ä¼šæ‰“å¼€å‡ åä¸ªç½‘ç«™æ²¡æ—¶é—´ä¸€ä¸€æ¶ˆåŒ–ï¼Œå°±ä¸€ç›´æ™¾ç€è¶Šç§¯è¶Šå¤šï¼Œæ”¶è—å¤¹ä¹Ÿå¤ªå¤šï¼Œä¸€èˆ¬å¡è¿›å»å°±ä¸ä¼šç¿»å‡ºæ¥çœ‹ï¼Œæ‰€ä»¥ç®¡ç†èµ·æ¥ä¹Ÿæ˜¯éº»çƒ¦â€¦&lt;br&gt;æœ¬ç¯‡å°±ä¼šæŠŠä¹‹å‰è‡ªå·±æ¶‰åŠçš„é¢†åŸŸä½¿ç”¨åˆ°çš„æœ‰ç”¨çš„å­¦ä¹ ç½‘ç«™æ±‡æ€»èµ·æ¥ï¼Œåˆ†äº«ç»™å¤§å®¶ï¼Œä¹Ÿæ–¹ä¾¿è‡ªå·±çš„å­¦ä¹ ç®¡ç†ï¼š&lt;/p&gt;
    
    </summary>
    
      <category term="æ€»ç»“" scheme="http://alfredzhenyu.github.io/categories/%E6%80%BB%E7%BB%93/"/>
    
    
      <category term="æ€»ç»“" scheme="http://alfredzhenyu.github.io/tags/%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>ç¬¬ä¸€ç¯‡åšå®¢</title>
    <link href="http://alfredzhenyu.github.io/2016/12/21/%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/"/>
    <id>http://alfredzhenyu.github.io/2016/12/21/ç¬¬ä¸€ç¯‡åšå®¢/</id>
    <published>2016-12-21T06:44:34.000Z</published>
    <updated>2017-01-17T09:21:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>  ä¹‹å‰å°±ä¸€ç›´æƒ³æŠ½ç©ºæä¸‹è‡ªå·±çš„æŠ€æœ¯åšå®¢ï¼Œä½†æ˜¯ä¸€ç›´å¿™è¿™å¿™é‚£çš„ï¼Œæ²¡æ—¶é—´æï¼Œä½†å¼€blogï¼Œæ— è®ºå¯¹æ‰¾å·¥ä½œä¹Ÿå¥½ï¼Œæå‡è‡ªå·±çš„èƒ½åŠ›ï¼Œä¸°å¯Œè‡ªå·±çš„ç”Ÿæ´»ä¹Ÿç½¢ï¼Œæ„Ÿè§‰å¯¹è‡ªå·±éƒ½æœ‰å¥½å¤„ã€‚è€Œä¸”æœ€è¿‘å—åˆ°å„ç§åˆºæ¿€ï¼ŒæŠŠè‡ªå·±çš„æŠ€æœ¯æ²‰æ·€ä¸‹å»çš„è¿™ç§æœŸæœ›è¶Šæ¥è¶Šå¼ºï¼Œäºæ˜¯æŠŠæ—¶é—´è…¾å¼€æŠŠæƒ³æå·²ä¹…çš„blogå¼€èµ·æ¥â€¦ä¹Ÿå¸Œæœ›è‡ªå·±ä»¥åèƒ½å¤šå¤šæŠ½æ—¶é—´æŠŠè‡ªå·±äº†è§£åˆ°çš„æŠ€æœ¯ï¼Œéƒ½å½’çº³æ€»ç»“èµ·æ¥å§ï¼ˆè™½ç„¶æ„Ÿè§‰é¡¹ç›®ä¸€å¿™èµ·æ¥ï¼Œè¿™äº›éƒ½æ˜¯ç©ºè¯â€¦ï¼‰</p>
<p>æƒ³ç”¨ä¹‹å‰åŒäº‹è¯´çš„ä¸€å¥è¯ä½œä¸ºç»“å°¾ï¼Œæ€»ç»“æœ€è¿‘çš„ç”Ÿæ´»ï¼š</p>
<h3 id="ç”Ÿæ´»é™¤äº†çœ¼å‰çš„è‹Ÿä¸”â€¦"><a href="#ç”Ÿæ´»é™¤äº†çœ¼å‰çš„è‹Ÿä¸”â€¦" class="headerlink" title="ç”Ÿæ´»é™¤äº†çœ¼å‰çš„è‹Ÿä¸”â€¦"></a>ç”Ÿæ´»é™¤äº†çœ¼å‰çš„è‹Ÿä¸”â€¦</h3><a id="more"></a>
<h3 id="è¿˜æœ‰è¿œæ–¹çš„è‹Ÿä¸”â€¦"><a href="#è¿˜æœ‰è¿œæ–¹çš„è‹Ÿä¸”â€¦" class="headerlink" title="è¿˜æœ‰è¿œæ–¹çš„è‹Ÿä¸”â€¦"></a>è¿˜æœ‰è¿œæ–¹çš„è‹Ÿä¸”â€¦</h3>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;  ä¹‹å‰å°±ä¸€ç›´æƒ³æŠ½ç©ºæä¸‹è‡ªå·±çš„æŠ€æœ¯åšå®¢ï¼Œä½†æ˜¯ä¸€ç›´å¿™è¿™å¿™é‚£çš„ï¼Œæ²¡æ—¶é—´æï¼Œä½†å¼€blogï¼Œæ— è®ºå¯¹æ‰¾å·¥ä½œä¹Ÿå¥½ï¼Œæå‡è‡ªå·±çš„èƒ½åŠ›ï¼Œä¸°å¯Œè‡ªå·±çš„ç”Ÿæ´»ä¹Ÿç½¢ï¼Œæ„Ÿè§‰å¯¹è‡ªå·±éƒ½æœ‰å¥½å¤„ã€‚è€Œä¸”æœ€è¿‘å—åˆ°å„ç§åˆºæ¿€ï¼ŒæŠŠè‡ªå·±çš„æŠ€æœ¯æ²‰æ·€ä¸‹å»çš„è¿™ç§æœŸæœ›è¶Šæ¥è¶Šå¼ºï¼Œäºæ˜¯æŠŠæ—¶é—´è…¾å¼€æŠŠæƒ³æå·²ä¹…çš„blogå¼€èµ·æ¥â€¦ä¹Ÿå¸Œæœ›è‡ªå·±ä»¥åèƒ½å¤šå¤šæŠ½æ—¶é—´æŠŠè‡ªå·±äº†è§£åˆ°çš„æŠ€æœ¯ï¼Œéƒ½å½’çº³æ€»ç»“èµ·æ¥å§ï¼ˆè™½ç„¶æ„Ÿè§‰é¡¹ç›®ä¸€å¿™èµ·æ¥ï¼Œè¿™äº›éƒ½æ˜¯ç©ºè¯â€¦ï¼‰&lt;/p&gt;
&lt;p&gt;æƒ³ç”¨ä¹‹å‰åŒäº‹è¯´çš„ä¸€å¥è¯ä½œä¸ºç»“å°¾ï¼Œæ€»ç»“æœ€è¿‘çš„ç”Ÿæ´»ï¼š&lt;/p&gt;
&lt;h3 id=&quot;ç”Ÿæ´»é™¤äº†çœ¼å‰çš„è‹Ÿä¸”â€¦&quot;&gt;&lt;a href=&quot;#ç”Ÿæ´»é™¤äº†çœ¼å‰çš„è‹Ÿä¸”â€¦&quot; class=&quot;headerlink&quot; title=&quot;ç”Ÿæ´»é™¤äº†çœ¼å‰çš„è‹Ÿä¸”â€¦&quot;&gt;&lt;/a&gt;ç”Ÿæ´»é™¤äº†çœ¼å‰çš„è‹Ÿä¸”â€¦&lt;/h3&gt;
    
    </summary>
    
      <category term="ç”Ÿæ´»" scheme="http://alfredzhenyu.github.io/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
      <category term="ç”Ÿæ´»" scheme="http://alfredzhenyu.github.io/tags/%E7%94%9F%E6%B4%BB/"/>
    
  </entry>
  
</feed>
